<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-2.11 docs-doc-page docs-doc-id-docs/contributions/development/internal-architecture" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.2"><title data-rh=true>Internal architecture | Pantsbuild</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:image content=https://www.pantsbuild.org/img/social-card.png /><meta data-rh=true name=twitter:image content=https://www.pantsbuild.org/img/social-card.png /><meta data-rh=true property=og:url content=https://www.pantsbuild.org/2.11/docs/contributions/development/internal-architecture /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docusaurus_version content=2.11 /><meta data-rh=true name=docusaurus_tag content=docs-default-2.11 /><meta data-rh=true name=docsearch:version content=2.11 /><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-2.11 /><meta data-rh=true name=robots content="noindex, nofollow"/><meta data-rh=true property=og:title content="Internal architecture | Pantsbuild"/><meta data-rh=true name=description content=--- /><meta data-rh=true property=og:description content=--- /><link data-rh=true rel=icon href=/img/favicon.ico /><link data-rh=true rel=canonical href=https://www.pantsbuild.org/2.11/docs/contributions/development/internal-architecture /><link data-rh=true rel=alternate href=https://www.pantsbuild.org/2.11/docs/contributions/development/internal-architecture hreflang=en /><link data-rh=true rel=alternate href=https://www.pantsbuild.org/2.11/docs/contributions/development/internal-architecture hreflang=x-default /><link data-rh=true rel=preconnect href=https://QD9KY1TRVK-dsn.algolia.net crossorigin=anonymous /><script data-rh=true type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","item":"https://www.pantsbuild.org/2.11/docs/contributions/","name":"Contributions","position":1},{"@type":"ListItem","item":"https://www.pantsbuild.org/2.11/docs/contributions/development/","name":"Development","position":2},{"@type":"ListItem","item":"https://www.pantsbuild.org/2.11/docs/contributions/development/internal-architecture","name":"Internal architecture","position":3}]}</script><link rel=alternate type=application/rss+xml href=/blog/rss.xml title="Pantsbuild RSS Feed"><link rel=alternate type=application/atom+xml href=/blog/atom.xml title="Pantsbuild Atom Feed"><link rel=preconnect href=https://www.google-analytics.com><link rel=preconnect href=https://www.googletagmanager.com><script async src="https://www.googletagmanager.com/gtag/js?id=G-SEHBXJRF42"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-SEHBXJRF42",{anonymize_ip:!0})</script><link rel=search type=application/opensearchdescription+xml title=Pantsbuild href=/opensearch.xml><link rel=stylesheet href=/assets/css/styles.b71b45ed.css /><script src=/assets/js/runtime~main.43acf77f.js defer></script><script src=/assets/js/main.636c7439.js defer></script></head><body class=navigation-with-keyboard><svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_lucK href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/logo.svg alt="My Site Logo" class="themedComponent_x_jL themedComponent--light_WGb9"/><img src=/img/logo.svg alt="My Site Logo" class="themedComponent_x_jL themedComponent--dark_oBxQ"/></div><b class="navbar__title text--truncate">Pantsbuild</b></a><a aria-current=page class="navbar__item navbar__link navbar__link--active" href=/2.11/docs/introduction/welcome-to-pants>Docs</a><a class="navbar__item navbar__link" href=/2.11/reference/global-options>Reference</a><a class="navbar__item navbar__link" href=/blog>Blog</a><a class="navbar__item navbar__link" href=/sponsors>Sponsors</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button href=/2.11/docs/introduction/welcome-to-pants>2.11 (deprecated)</a><ul class=dropdown__menu><li><a class=dropdown__link href=/prerelease/docs/contributions/development/internal-architecture>2.31 (prerelease)</a><li><a class=dropdown__link href=/stable/docs/contributions/development/internal-architecture>2.30</a><li><a class=dropdown__link href=/2.29/docs/contributions/development/internal-architecture>2.29</a><li><a class=dropdown__link href=/2.28/docs/contributions/development/internal-architecture>2.28 (deprecated)</a><li class=""><hr class=dropdown-separator><li><a class=dropdown__link href=/versions>All Versions</a></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link>Slack</a><ul class=dropdown__menu><li><a href=https://pantsbuild.slack.com target=_blank rel="noopener noreferrer" class=dropdown__link>Workspace<svg width=12 height=12 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a><li><a href="https://docs.google.com/forms/d/e/1FAIpQLSf9zgf-MXRnVDJbrVEST3urqneq7LCcy0zw8qU-GH4hPMn52A/viewform?usp=sf_link" target=_blank rel="noopener noreferrer" class=dropdown__link>Workspace Invite<svg width=12 height=12 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a><li><a href=https://chat.pantsbuild.org target=_blank rel="noopener noreferrer" class=dropdown__link>Linen Mirror<svg width=12 height=12 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a></ul></div><a href=https://github.com/pantsbuild/pants target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a><div class=navbarSearchContainer_Mydu><button type=button class="DocSearch DocSearch-Button" aria-label="Search (Meta+k)" aria-keyshortcuts=Meta+k><span class=DocSearch-Button-Container><svg width=20 height=20 class=DocSearch-Search-Icon viewBox="0 0 24 24" aria-hidden=true><circle cx=11 cy=11 r=8 stroke=currentColor fill=none stroke-width=1.4 /><path d="m21 21-4.3-4.3" stroke=currentColor fill=none stroke-linecap=round stroke-linejoin=round /></svg><span class=DocSearch-Button-Placeholder>Search</span></span><span class=DocSearch-Button-Keys></span></button></div><div class="toggle_AwgP colorModeToggle_rXRM"><button class="clean-btn toggleButton_kTC9 toggleButtonDisabled_N4X8" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_X8HE lightToggleIcon_cay9"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_X8HE darkToggleIcon_B6hH"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_X8HE systemToggleIcon_k4zv"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_GzA5"><div class=docsWrapper_LbKj><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_bDNn" type=button></button><div class=docRoot_PpgM><aside class="theme-doc-sidebar-container docSidebarContainer_aj0D"><div class=sidebarViewport_pg77><div class=sidebar_Us5f><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_FPuF"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/2.11/docs/introduction/welcome-to-pants><span title=Introduction class=categoryLinkLabel_JmoG>Introduction</span></a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist" href=/2.11/docs/getting-started><span title="Getting Started" class=categoryLinkLabel_JmoG>Getting Started</span></a><button aria-label="Expand sidebar category 'Getting Started'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/2.11/docs/using-pants/command-line-help><span title="Using Pants" class=categoryLinkLabel_JmoG>Using Pants</span></a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/2.11/docs/python/overview><span title=Python class=categoryLinkLabel_JmoG>Python</span></a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist" href=/2.11/docs/go><span title=Go class=categoryLinkLabel_JmoG>Go</span></a><button aria-label="Expand sidebar category 'Go'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/2.11/docs/java-and-scala><span title="Java and Scala" class=linkLabel_BwCR>Java and Scala</span></a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist" href=/2.11/docs/shell><span title=Shell class=categoryLinkLabel_JmoG>Shell</span></a><button aria-label="Expand sidebar category 'Shell'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist" href=/2.11/docs/docker><span title=Docker class=categoryLinkLabel_JmoG>Docker</span></a><button aria-label="Expand sidebar category 'Docker'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/2.11/docs/writing-plugins/overview><span title="Writing Plugins" class=categoryLinkLabel_JmoG>Writing Plugins</span></a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist menu__link--sublist-caret" role=button aria-expanded=false href=/2.11/docs/releases/deprecation-policy><span title=Releases class=categoryLinkLabel_JmoG>Releases</span></a></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist menu__link--active" href=/2.11/docs/contributions><span title=Contributions class=categoryLinkLabel_JmoG>Contributions</span></a><button aria-label="Collapse sidebar category 'Contributions'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist menu__link--active" tabindex=0 href=/2.11/docs/contributions/development><span title=Development class=categoryLinkLabel_JmoG>Development</span></a><button aria-label="Collapse sidebar category 'Development'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/2.11/docs/contributions/development/setting-up-pants><span title="Setting up Pants" class=linkLabel_BwCR>Setting up Pants</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/2.11/docs/contributions/development/style-guide><span title="Style guide" class=linkLabel_BwCR>Style guide</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/2.11/docs/contributions/development/developing-rust><span title="Developing Rust" class=linkLabel_BwCR>Developing Rust</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/2.11/docs/contributions/development/internal-architecture><span title="Internal architecture" class=linkLabel_BwCR>Internal architecture</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/2.11/docs/contributions/development/debugging-and-benchmarking><span title="Debugging and benchmarking" class=linkLabel_BwCR>Debugging and benchmarking</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class=menu__link tabindex=0 href=/2.11/docs/contributions/development/running-pants-from-sources><span title="Running Pants from sources" class=linkLabel_BwCR>Running Pants from sources</span></a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_cnt8 menu__link menu__link--sublist" tabindex=0 href=/2.11/docs/contributions/releases><span title=Releases class=categoryLinkLabel_JmoG>Releases</span></a><button aria-label="Expand sidebar category 'Releases'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div></ul><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 margin-vert--none"><hr/><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/2.11/reference/global-options><span title=Reference class=linkLabel_BwCR>Reference</span></a></ul></nav></div></div></aside><main class=docMainContainer_oWFJ><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_b2qu"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role=alert><div>This is documentation for <!-- -->Pantsbuild<!-- --> <b>2.11 (deprecated)</b>, which is no longer actively maintained.</div><div class=margin-top--md>For up-to-date documentation, see the <b><a href=/stable/docs/contributions/development/internal-architecture>latest version</a></b> (<!-- -->2.30<!-- -->).</div></div><div class=docItemContainer_TkYX><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_nJ9e" aria-label=Breadcrumbs><ul class=breadcrumbs><li class=breadcrumbs__item><a aria-label="Home page" class=breadcrumbs__link href=/><svg viewBox="0 0 24 24" class=breadcrumbHomeIcon_WW1h><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill=currentColor /></svg></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/2.11/docs/contributions><span>Contributions</span></a><li class=breadcrumbs__item><a class=breadcrumbs__link href=/2.11/docs/contributions/development><span>Development</span></a><li class="breadcrumbs__item breadcrumbs__item--active"><span class=breadcrumbs__link>Internal architecture</span></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: 2.11 (deprecated)</span><div class="tocCollapsible_hk9T theme-doc-toc-mobile tocMobile_cNpz"><button type=button class="clean-btn tocCollapsibleButton_ljii">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Internal architecture</h1></header><hr/>
<h2 class="anchor anchorTargetStickyNavbar_UrHV" id=rule-graph-construction>Rule Graph Construction<a href=#rule-graph-construction class=hash-link aria-label="Direct link to Rule Graph Construction" title="Direct link to Rule Graph Construction" translate=no>​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_UrHV" id=overview>Overview<a href=#overview class=hash-link aria-label="Direct link to Overview" title="Direct link to Overview" translate=no>​</a></h3>
<p>Build logic in <a href=https://www.pantsbuild.org/ target=_blank rel="noopener noreferrer" class="">Pants</a> is declared using collections of <code>@rules</code> with recursively memoized and invalidated results. This framework (known as Pants' "Engine") has similar goals to Bazel's <a href=https://bazel.build/designs/skyframe.html target=_blank rel="noopener noreferrer" class="">Skyframe</a> and the <a href=https://github.com/salsa-rs/salsa target=_blank rel="noopener noreferrer" class="">Salsa</a> framework: users define logic using a particular API, and the framework manages tracking the dependencies between nodes in a runtime graph.</p>
<p>In order to maximize the amount of work that can be reused at runtime, Pants statically computes the memoization keys for the nodes of the runtime graph from the user specified <code>@rules</code> during startup: this process is known as "rule graph construction". See the <code>Goals</code> section for more information on the strategy and reasoning for this.</p>
<p>Concepts used in compilers, including live variable analysis and monomorphization, can also be useful in rule graph construction to minimize rule identities and pre-decide which versions of their dependencies they will use.</p>
<h3 class="anchor anchorTargetStickyNavbar_UrHV" id=concepts>Concepts<a href=#concepts class=hash-link aria-label="Direct link to Concepts" title="Direct link to Concepts" translate=no>​</a></h3>
<p>A successfully constructed <code>RuleGraph</code> contains a graph where nodes have one of three types, <code>Rule</code>s, <code>Query</code>s, and <code>Param</code>s, which map fairly closely to what a Pants <code>@rule</code> author consumes. The edges between nodes represent dependencies: <code>Query</code>s are always roots of the graph, <code>Param</code>s are always leaves, and <code>Rule</code>s represent the end user logic making up all of the internal nodes of the graph.</p>
<h4 class="anchor anchorTargetStickyNavbar_UrHV" id=rules>Rules<a href=#rules class=hash-link aria-label="Direct link to Rules" title="Direct link to Rules" translate=no>​</a></h4>
<p>A <code>Rule</code> is a function or coroutine with all of its inputs declared as part of its type signature. The end user type signature is made up of:</p>
<ol>
<li class="">the return type of the <code>Rule</code></li>
<li class="">the positional arguments to the <code>Rule</code></li>
<li class="">a set of <code>Get</code>s which declare the runtime requirements of a coroutine, of the form <code>Get(output_type, input_type)</code></li>
</ol>
<p>In the <code>RuleGraph</code>, these are encoded in a <a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/rules.rs#L76-L95 target=_blank rel="noopener noreferrer" class="">Rule</a> trait, with a <a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/rules.rs#L21-L41 target=_blank rel="noopener noreferrer" class="">DependencyKey</a> trait representing both the positional arguments (which have no provided <code>Param</code>) and the <code>Get</code>s (which provide their input type as a <code>Param</code>).</p>
<p><code>Rule</code>s never refer to one another by name (i.e., they do not call one another by name): instead, their signature declares their requirements in terms of input/output types, and rule graph construction decides which potential dependencies will provide those requirements.</p>
<h4 class="anchor anchorTargetStickyNavbar_UrHV" id=queries>Queries<a href=#queries class=hash-link aria-label="Direct link to Queries" title="Direct link to Queries" translate=no>​</a></h4>
<p>The roots/entrypoints of a <code>RuleGraph</code> are <code>Query</code>s, which should correspond one-to-one to external callsites that use the engine to request that values are computed. A <code>Query</code> has an output type, and a series of input types: <code>Query(output_type, (*input_types))</code>.</p>
<p>If a user makes a request to the engine that does not have a corresponding <code>Query</code> declared, the engine fails rather than attempting to dynamically determine which <code>Rules</code> to use to answer the <code>Query</code>: how a <code>RuleGraph</code> is constructed should show why that is the case.</p>
<h4 class="anchor anchorTargetStickyNavbar_UrHV" id=params>Params<a href=#params class=hash-link aria-label="Direct link to Params" title="Direct link to Params" translate=no>​</a></h4>
<p><code>Params</code> are typed, comparable (<code>eq</code>/<code>hash</code>) values that represent both the inputs to <code>Rules</code>, and the building block of the runtime memoization key for a <code>Rule</code>. The set of <code>Params</code> (unique by type) that are consumed to create a <code>Rule</code>'s inputs (plus the <code>Rule</code>'s own identity) make up the memoization key for a runtime instance of the <code>Rule</code>.</p>
<p><code>Param</code>s are eventually used as positional args to <code>Rule</code>s, but it's important to note that the <code>Param</code>s in a <code>Rule</code> instance's identity/memoization-key will not always become the positional arguments to <em>that</em> <code>Rule</code>: in many cases, a <code>Param</code> will be used by a <code>Rule</code>'s transitive dependencies in order to produce an output value that becomes either a positional argument to the <code>Rule</code> as it starts, or the result of a <code>Get</code> while a coroutine <code>Rule</code> runs.</p>
<p>The <code>Param</code>s that are available to a <code>Rule</code> are made available by the <code>Rule</code>'s dependees (its "callers"), but similar to how <code>Rule</code>s are not called by name, neither are all of their <code>Param</code>s passed explicitly at each use site. A <code>Rule</code> will be used to compute the output value for a <code>DependencyKey</code>: i.e., a positional argument, <code>Get</code> result, or <code>Query</code> result. Of these usage sites, only <code>Query</code> specifies the complete set of <code>Params</code> that will be available: the other two usages (positional arguments and <code>Get</code>s) are able to use any Param that will be "in scope" at the use site.</p>
<p><code>Params</code> flow down the graph from <code>Query</code>s and the provided <code>Param</code>s of <code>Get</code>s: their presence does not need to be re-declared at each intermediate callsite. When a <code>Rule</code> consumes a <code>Param</code> as a positional argument, that <code>Param</code> will no longer be available to that <code>Rule</code>'s dependencies (but it might still be present in other subgraphs adjacent to that <code>Rule</code>).</p>
<h3 class="anchor anchorTargetStickyNavbar_UrHV" id=goals>Goals<a href=#goals class=hash-link aria-label="Direct link to Goals" title="Direct link to Goals" translate=no>​</a></h3>
<p>The goals of <code>RuleGraph</code> construction are:</p>
<ol>
<li class="">decide which <code>Rule</code>s to use to answer <code>Query</code>s (transitively, since <code>Rule</code>s do not call one another by name); and</li>
<li class="">determine the minimum set of <code>Param</code> inputs needed to satisfy the <code>Rule</code>s below those <code>Query</code>s</li>
</ol>
<p>If either of the goals were removed, <code>RuleGraph</code> construction might be more straightforward:</p>
<ol>
<li class="">If rather than being type-driven, <code>Rule</code>s called one another by name, you could statically determine their input <code>Params</code> by walking the call graph of <code>Rule</code>s by name, and collecting their transitive input <code>Params</code>.</li>
<li class="">If rather than needing to compute a minimum set of <code>Param</code> inputs for the memoization key, we instead required that all usage sites explicitly declared all <code>Param</code>s that their dependencies might need, we could relatively easily eliminate candidates based on the combination of <code>Param</code> types at a use site. And if we were willing to have very large memoization keys, we could continue to have simple callsites, but skip pruning the <code>Params</code> that pass from a dependee to a dependency at runtime, and include any <code>Params</code> declared in any of a <code>Rule</code>s transitive dependees to be part of its identity.</li>
</ol>
<p>But both of the goals are important because together they allow for an API that is easy to write <code>Rule</code>s for, with minimal boilerplate required to get the inputs needed for a <code>Rule</code> to compute a value, and minimal invalidation. Because the identity of a <code>Rule</code> is computed from its transitive input <code>Param</code>s rather than from its positional arguments, <code>Rule</code>s can accept arbitrarily-many large input values (which don't need to implement hash) with no impact on its memoization hit rate.</p>
<h3 class="anchor anchorTargetStickyNavbar_UrHV" id=constraints>Constraints<a href=#constraints class=hash-link aria-label="Direct link to Constraints" title="Direct link to Constraints" translate=no>​</a></h3>
<p>There are a few constraints that decide which <code>Rule</code>s are able to provide dependencies for one another:</p>
<ul>
<li class=""><code>param_consumption</code> - When a <code>Rule</code> directly uses a <code>Param</code> as a positional argument, that <code>Param</code> is removed from scope for any of that <code>Rule</code>'s dependencies.<!-- -->
<ul>
<li class="">For example, for a <code>Rule</code> <code>y</code> with a positional argument <code>A</code> and a <code>Get(B, C)</code>: if there is a <code>Param</code> <code>A</code> in scope at <code>y</code> and it is used to satisfy the positional argument, it cannot also be used to (transitively) to satisfy the <code>Get(B, C)</code> (i.e., a hyptothetical rule that consumes both <code>A</code> and <code>C</code> would not be eligible in that position).</li>
<li class="">On the other hand, for a <code>Rule</code> <code>w</code> with <code>Get(B, C)</code> and <code>Get(D, E)</code>, if there is a <code>Param</code> <code>A</code> in scope at <code>w</code>, two dependency <code>Rule</code>s that consume <code>A</code> (transitively) <em>can</em> be used to satisfy those <code>Get</code>s. Only consuming a <code>Param</code> as a positional argument removes it from scope.</li>
</ul>
</li>
<li class=""><code>provided_params</code> - When deciding whether one <code>Rule</code> can use another <code>Rule</code> to provide the output type of a <code>Get</code>, a constraint is applied that the candidate depedency must (transitively) consume the <code>Param</code> that is provided by the <code>Get</code>.<!-- -->
<ul>
<li class="">For example: if a <code>Rule</code> <code>z</code> has a <code>Get(A, B)</code>, only <code>Rule</code>s that compute an <code>A</code> and (transitively) consume a <code>B</code> are eligible to be used. This also means that a <code>Param</code> <code>A</code> which is already in scope for <code>Rule</code> <code>z</code> is not eligible to be used, because it would trivially not consume <code>B</code>.</li>
</ul>
</li>
</ul>
<h3 class="anchor anchorTargetStickyNavbar_UrHV" id=implementation>Implementation<a href=#implementation class=hash-link aria-label="Direct link to Implementation" title="Direct link to Implementation" translate=no>​</a></h3>
<p>As of <a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/builder.rs#L202-L219 target=_blank rel="noopener noreferrer" class="">3a188a1e06</a>, we construct a <code>RuleGraph</code> using a combination of data flow analysis and some homegrown (and likely problematic: see the "Issue Overview") node splitting on the call graph of <code>Rule</code>s.</p>
<p>The construction algorithm is broken up into phases:</p>
<ol>
<li class=""><a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/builder.rs#L221 target=_blank rel="noopener noreferrer" class="">initial_polymorphic</a> - Builds a polymorphic graph while computing an "out-set" for each node in the graph by accounting for which <code>Param</code>s are available at each use site. During this phase, nodes may have multiple dependency edges per <code>DependencyKey</code>, which is what makes them "polymorphic". Each of the possible ways to compute a dependency will likely have different input <code>Param</code> requirements, and each node in this phase represents all of those possibilities.</li>
<li class=""><a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/builder.rs#L749-L754 target=_blank rel="noopener noreferrer" class="">live_param_labeled</a> - Run <a href=https://en.wikipedia.org/wiki/Live_variable_analysis target=_blank rel="noopener noreferrer" class="">live variable analysis</a> on the polymorphic graph to compute the initial "in-set" of <code>Params</code> used by each node in the graph. Because nodes in the polymorphic graph have references to all possible sources of a particular dependency type, the computed set is conservative (i.e., overly large).<!-- -->
<ul>
<li class="">For example: if a <code>Rule</code> <code>x</code> has exactly one <code>DependencyKey</code>, but there are two potential dependencies to provide that <code>DependencyKey</code> with input <code>Param</code>s <code>{A,B}</code> and <code>{B,C}</code> (respectively), then at this phase the input <code>Param</code>s for <code>x</code> must be the union of all possibilities: <code>{A,B,C}</code>.</li>
<li class="">If we were to stop <code>RuleGraph</code> construction at this phase, it would be necessary to do a form of <a href=https://en.wikipedia.org/wiki/Dynamic_dispatch target=_blank rel="noopener noreferrer" class="">dynamic dispatch</a> at runtime to decide which source of a dependency to use based on the <code>Param</code>s that were currently in scope. And the sets of <code>Param</code>s used in the memoization key for each <code>Rule</code> would still be overly large, causing excess invalidation.</li>
</ul>
</li>
<li class=""><a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/builder.rs#L325-L353 target=_blank rel="noopener noreferrer" class="">monomorphize</a> - "Monomorphize" the polymorphic graph by using the out-set of available <code>Param</code>s (initialized during <code>initial_polymorphic</code>) and the in-set of consumed <code>Param</code>s (computed during <code>live_param_labeled</code>) to partition nodes (and their dependees) for each valid combination of their dependencies. Combinations of dependencies that would be invalid (see the Constraints section) are not generated, which causes some pruning of the graph to happen during this phase.<!-- -->
<ul>
<li class="">Continuing the example from above: the goal of monomorphize is to create one copy of <code>Rule</code> <code>x</code> per legal combination of its <code>DependencyKey</code>. Assuming that both of <code>x</code>'s dependencies remain legal (i.e. that all of <code>{A,B,C}</code> are still in scope in the dependees of <code>x</code>, etc), then two copies of <code>x</code> will be created: one that uses the first dependency and has an in-set of <code>{A,B}</code>, and another that uses the second dependency and has an in-set of <code>{B,C}</code>.</li>
</ul>
</li>
<li class=""><a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/builder.rs#L836-L845 target=_blank rel="noopener noreferrer" class="">prune_edges</a> - Once the monomorphic graph has <a href=https://en.wikipedia.org/wiki/Data-flow_analysis#Convergence target=_blank rel="noopener noreferrer" class="">converged</a>, each node in the graph will ideally have exactly one source of each <code>DependencyKey</code> (with the exception of <code>Query</code>s, which are not monomorphized). This phase validates that, and chooses the smallest input <code>Param</code> set to use for each <code>Query</code>. In cases where a node has more that one dependency per <code>DependencyKey</code>, it is because given a particular set of input <code>Params</code> there was more than one valid way to compute a dependency. This can happen either because there were too many <code>Param</code>s in scope, or because there were multiple <code>Rule</code>s with the same <code>Param</code> requirements.<!-- -->
<ul>
<li class="">This phase is the only phase that renders errors: all of the other phases mark nodes and edges "deleted" for particular reasons, and this phase consumes that record. A node that has been deleted indicates that that node is unsatisfiable for some reason, while an edge that has been deleted indicates that the source node was not able to consume the target node for some reason.</li>
<li class="">If a node has too many sources of a <code>DependencyKey</code>, this phase will recurse to attempt to locate the node in the <code>Rule</code> graph where the ambiguity was introduced. Likewise, if a node has no source of a <code>DependencyKey</code>, this phase will recurse on deleted nodes (which are preserved by the other phases) to attempt to locate the bottom-most <code>Rule</code> that was missing a <code>DependencyKey</code>.</li>
</ul>
</li>
<li class=""><a href=https://github.com/pantsbuild/pants/blob/3a188a1e06d8c27ff86d8c311ff1b2bdea0d39ff/src/rust/engine/rule_graph/src/builder.rs#L1064-L1068 target=_blank rel="noopener noreferrer" class="">finalize</a> - After <code>prune_edges</code> the graph is known to be valid, and this phase generates the final static <code>RuleGraph</code> for all <code>Rule</code>s reachable from <code>Query</code>s.</li>
</ol></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_eWnd"><a href=https://github.com/pantsbuild/pants/edit/main/docs/docs/contributions/development/internal-architecture.mdx target=_blank rel="noopener noreferrer" class=theme-edit-this-page><svg fill=currentColor height=20 width=20 viewBox="0 0 40 40" class=iconEdit_HmrO aria-hidden=true><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"/></g></svg>Edit this page</a></div><div class="col lastUpdated_F4iS"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/2.11/docs/contributions/development/developing-rust><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Developing Rust</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/2.11/docs/contributions/development/debugging-and-benchmarking><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Debugging and benchmarking</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_ZBPU thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#rule-graph-construction class="table-of-contents__link toc-highlight">Rule Graph Construction</a><ul><li><a href=#overview class="table-of-contents__link toc-highlight">Overview</a><li><a href=#concepts class="table-of-contents__link toc-highlight">Concepts</a><li><a href=#goals class="table-of-contents__link toc-highlight">Goals</a><li><a href=#constraints class="table-of-contents__link toc-highlight">Constraints</a><li><a href=#implementation class="table-of-contents__link toc-highlight">Implementation</a></ul></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Spotlight</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/spotlight/users>Users</a><li class=footer__item><a class=footer__link-item href=/spotlight/testimonials>Testimonials</a><li class=footer__item><a class=footer__link-item href=/spotlight/media>Media</a><li class=footer__item><a class=footer__link-item href=/spotlight/service-providers>Service Providers</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Connect</div><ul class="footer__items clean-list"><li class=footer__item><a href=https://github.com/pantsbuild/pants target=_blank rel="noopener noreferrer" class=footer__link-item>GitHub<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://twitter.com/pantsbuild target=_blank rel="noopener noreferrer" class=footer__link-item>Twitter<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://www.youtube.com/@pantsbuild target=_blank rel="noopener noreferrer" class=footer__link-item>YouTube<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a href=https://groups.google.com/forum/#!forum/pants-devel target=_blank rel="noopener noreferrer" class=footer__link-item>Mailing List<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_QvT7><use href=#theme-svg-external-link /></svg></a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>More</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/blog>Blog</a><li class=footer__item><a class=footer__link-item href=/sponsors>Sponsors</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Community</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/community/getting-help>Getting Help</a><li class=footer__item><a class=footer__link-item href=/community/members>Members</a><li class=footer__item><a class=footer__link-item href=/community/code-of-conduct>Code of Conduct</a><li class=footer__item><a class=footer__link-item href=/community/meet-the-team>Meet the Team</a><li class=footer__item><a class=footer__link-item href=/community/maintainers>Maintainers</a><li class=footer__item><a class=footer__link-item href=/community/contentious-decisions>Contentious Decisions</a></ul></div></div><div class="footer__bottom text--center"><div class=footer__copyright>Copyright © Pants project contributors. <a href=https://github.com/pantsbuild/pantsbuild.org>Website source</a> @ <a href=https://github.com/pantsbuild/pantsbuild.org/commit/a274212dfdcfe1657dd5eae4836420db8cdf9099>a27421</a>.</div></div></div></footer></div></body>