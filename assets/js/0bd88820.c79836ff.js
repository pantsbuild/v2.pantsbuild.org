"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["260288"],{210506(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>p,frontMatter:()=>c,metadata:()=>i,toc:()=>h});var i=r(447626),t=r(886070),s=r(848193),a=r(685008),o=r(637180);let c={title:"Docker overview",sidebar_position:0},l,d={},h=[{value:"Enabling the Docker backend",id:"enabling-the-docker-backend",level:2},{value:"Adding <code>docker_image</code> targets",id:"adding-docker_image-targets",level:2},{value:"Adding dependencies to your <code>docker_image</code> targets",id:"adding-dependencies-to-your-docker_image-targets",level:2},{value:"Dependency inference support",id:"dependency-inference-support",level:3},{value:"Building a Docker image",id:"building-a-docker-image",level:2},{value:"Build arguments",id:"build-arguments",level:3},{value:"Target build stage",id:"target-build-stage",level:3},{value:"Build time secrets",id:"build-time-secrets",level:3},{value:"Buildx Support",id:"buildx-support",level:3},{value:"Using buildx with Kubernetes drivers",id:"using-buildx-with-kubernetes-drivers",level:3},{value:"Environment configuration",id:"environment-configuration",level:4},{value:"Buildx driver and namespace configuration",id:"buildx-driver-and-namespace-configuration",level:4},{value:"Image output configuration",id:"image-output-configuration",level:4},{value:"Build Docker image example",id:"build-docker-image-example",level:3},{value:"Running a Docker image",id:"running-a-docker-image",level:2},{value:"Publishing images",id:"publishing-images",level:2},{value:"Docker configuration",id:"docker-configuration",level:2},{value:"Docker authentication",id:"docker-authentication",level:2},{value:"Linting Dockerfiles",id:"linting-dockerfiles",level:2},{value:"Linting Dockerfiles with Hadolint",id:"linting-dockerfiles-with-hadolint",level:3},{value:"Linting Dockerfiles with Trivy",id:"linting-dockerfiles-with-trivy",level:3}];function u(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.p,{children:"How to build Docker images containing artifacts built by Pants"}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.p,{children:"Docker images typically bundle build artifacts, such as PEX files, wheels, loose files, and so on, with other runtime requirements, such as a Python interpreter."}),"\n",(0,t.jsxs)(n.p,{children:["Pants ",(0,t.jsx)(n.a,{href:"https://blog.pantsbuild.org/pants-pex-and-docker/",children:"makes it easy to embed the artifacts Pants builds into your Docker images"}),", for easy deployment."]}),"\n",(0,t.jsx)(n.h2,{id:"enabling-the-docker-backend",children:"Enabling the Docker backend"}),"\n",(0,t.jsx)(n.p,{children:"To use Pants's Docker support you must enable the appropriate backend:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'backend_packages = [\n  ...\n  "pants.backend.docker",\n  ...\n]\n'})}),"\n",(0,t.jsxs)(n.h2,{id:"adding-docker_image-targets",children:["Adding ",(0,t.jsx)(n.code,{children:"docker_image"})," targets"]}),"\n",(0,t.jsxs)(n.p,{children:["A Docker image is built from a recipe specified by a ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/builder/",children:"Dockerfile"}),". When you build Docker images with Pants, instead of running ",(0,t.jsx)(n.code,{children:"docker build"})," on the Dockerfile directly, you let Pants do that for you."]}),"\n",(0,t.jsxs)(n.p,{children:["Pants uses ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image",children:(0,t.jsx)(n.code,{children:"docker_image"})})," ",(0,t.jsx)(n.a,{href:"/2.27/docs/using-pants/key-concepts/targets-and-build-files",children:"targets"})," to indicate which Dockerfiles you want Pants to know about, and to add any necessary metadata."]}),"\n",(0,t.jsxs)(n.p,{children:["You can generate initial BUILD files for your Docker images, using ",(0,t.jsx)(n.a,{href:"/2.27/docs/getting-started/initial-configuration#5-generate-build-files",children:"tailor"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F pants tailor ::\nCreated src/docker/app1/BUILD:\n  - Add docker_image target docker\nCreated src/docker/app2/BUILD:\n  - Add docker_image target docker\n"})}),"\n",(0,t.jsx)(n.p,{children:"Or you can add them manually, such as:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'title="src/docker/app1/BUILD"',children:'docker_image(name="docker")\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Alternatively you may provide the Docker build instructions inline in your BUILD file as ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image#instructions",children:(0,t.jsx)(n.code,{children:"instructions"})})," on your ",(0,t.jsx)(n.code,{children:"docker_image"})," if you don't want to create a ",(0,t.jsx)(n.code,{children:"Dockerfile"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'title="src/docker/app1/BUILD"',children:'docker_image(\n  name="docker",\n  instructions=[\n    "FROM python:3.8",\n    "RUN ..",\n  ]\n)\n'})}),"\n",(0,t.jsxs)(n.admonition,{type:"caution",children:[(0,t.jsxs)(n.mdxAdmonitionTitle,{children:["The ",(0,t.jsx)(n.code,{children:"docker_image"})," ",(0,t.jsx)(n.code,{children:"instructions"})," field"]}),(0,t.jsxs)(n.p,{children:["Each ",(0,t.jsx)(n.code,{children:"docker_image"})," uses a ",(0,t.jsx)(n.code,{children:"Dockerfile"})," referred to by the ",(0,t.jsx)(n.code,{children:"source"})," field, unless you have provided a value to the ",(0,t.jsx)(n.code,{children:"instructions"})," field."]})]}),"\n",(0,t.jsxs)(n.h2,{id:"adding-dependencies-to-your-docker_image-targets",children:["Adding dependencies to your ",(0,t.jsx)(n.code,{children:"docker_image"})," targets"]}),"\n",(0,t.jsxs)(n.p,{children:["A Dockerfile is built in a ",(0,t.jsx)(n.em,{children:"context"})," - a set of files that the commands in the Dockerfile can reference, e.g., by copying them into the image."]}),"\n",(0,t.jsxs)(n.p,{children:["When you run ",(0,t.jsx)(n.code,{children:"docker build"})," directly, the context is usually a directory within your repo containing the Dockerfile (typically at the root of the context) and any files that the build requires. If those files were themselves the product of a build step, or if they were sources from elsewhere in the repo, then you would have to copy them into the context."]}),"\n",(0,t.jsxs)(n.p,{children:["Pants, however, takes care of assembling the context for you. It does so using the dependencies of the ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image",children:(0,t.jsx)(n.code,{children:"docker_image"})})," target, which can include:"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Loose files specified using ",(0,t.jsxs)(n.a,{href:"/2.27/docs/using-pants/assets-and-archives#files",children:[(0,t.jsx)(n.code,{children:"file"})," / ",(0,t.jsx)(n.code,{children:"files"})," targets"]}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Artifacts packaged from a variety of targets, such as ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/pex_binary",children:(0,t.jsx)(n.code,{children:"pex_binary"})})," , ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/python_distribution",children:(0,t.jsx)(n.code,{children:"python_distribution"})}),", ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/archive",children:(0,t.jsx)(n.code,{children:"archive"})}),", and any other target that can be built via the ",(0,t.jsx)(n.a,{href:"/2.27/reference/goals/package",children:"package"})," goal, including other docker images."]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"The context is assembled as follows:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The sources of ",(0,t.jsx)(n.code,{children:"file"})," / ",(0,t.jsx)(n.code,{children:"files"})," targets are assembled at their relative path from the repo root."]}),"\n",(0,t.jsxs)(n.li,{children:["The artifacts of any packaged targets are built, as if by running ",(0,t.jsx)(n.code,{children:"pants package"}),", and placed in the context using the artifact's ",(0,t.jsx)(n.code,{children:"output_path"})," field.","\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["The ",(0,t.jsx)(n.code,{children:"output_path"})," defaults to the scheme ",(0,t.jsx)(n.code,{children:"path.to.directory/tgt_name.ext"}),", e.g. ",(0,t.jsx)(n.code,{children:"src.python.helloworld/bin.pex"}),"."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"dependency-inference-support",children:"Dependency inference support"}),"\n",(0,t.jsxs)(n.p,{children:["When you ",(0,t.jsx)(n.code,{children:"COPY"})," PEX binaries into your image, the dependency on the ",(0,t.jsx)(n.code,{children:"pex_binary"})," target will be inferred, so you don't have to add that explicitly to the list of ",(0,t.jsx)(n.code,{children:"dependencies"})," on your ",(0,t.jsx)(n.code,{children:"docker_image"})," target. For example, the ",(0,t.jsx)(n.code,{children:"pex_binary"})," target ",(0,t.jsx)(n.code,{children:"src/python/helloworld/bin.pex"})," has the default ",(0,t.jsx)(n.code,{children:"output_path"})," of ",(0,t.jsx)(n.code,{children:"src.python.helloworld/bin.pex"}),". So, Pants can infer a dependency based on the line ",(0,t.jsx)(n.code,{children:"COPY src.python.helloworld/bin.pex /bin/helloworld"}),". This inference is also done for targets referenced by their target address in build arguments, for example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:"FROM python:3.9\nARG PEX_BIN=src:my_target\nCOPY $PEX_BIN /app/my_app\n"})}),"\n",(0,t.jsx)(n.p,{children:"Inference for Go binaries and artifacts of other packaged targets is similar."}),"\n",(0,t.jsxs)(n.p,{children:["Inference on ",(0,t.jsx)(n.code,{children:"file"}),"/",(0,t.jsx)(n.code,{children:"files"})," targets is also done on files, for example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:"FROM python:3.9\nCOPY src/file.txt /app/\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Inference is also supported for ",(0,t.jsx)(n.code,{children:"docker_image"})," targets specified in build arguments, for example:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:"ARG BASE_IMAGE=:base\nFROM $BASE_IMAGE\n"})}),"\n",(0,t.jsxs)(n.p,{children:["In the example, ",(0,t.jsx)(n.code,{children:":base"})," is the base image target address specified using a relative path. Pants will provide the built Docker image name for that target as the ",(0,t.jsx)(n.code,{children:"BASE_IMAGE"})," build arg to the Docker build command."]}),"\n",(0,t.jsx)(n.h2,{id:"building-a-docker-image",children:"Building a Docker image"}),"\n",(0,t.jsxs)(n.p,{children:["You build Docker images using the ",(0,t.jsx)(n.code,{children:"package"})," goal:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F pants package path/to/Dockerfile\n"})}),"\n",(0,t.jsx)(n.h3,{id:"build-arguments",children:"Build arguments"}),"\n",(0,t.jsxs)(n.p,{children:["To provide values to any ",(0,t.jsxs)(n.a,{href:"https://docs.docker.com/engine/reference/builder/#arg",children:["build ",(0,t.jsx)(n.code,{children:"ARG"}),"s"]})," in the Dockerfile, you can list them in the ",(0,t.jsx)(n.code,{children:"[docker].build_args"})," option, which will apply for all images. You can also list any image-specific build args in the field ",(0,t.jsx)(n.code,{children:"extra_build_args"})," for the ",(0,t.jsx)(n.code,{children:"docker_image"})," target."]}),"\n",(0,t.jsxs)(n.p,{children:["The build args use the same syntax as the ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/commandline/build/#set-build-time-variables---build-arg",children:"docker build --build-arg"})," command line option: ",(0,t.jsx)(n.code,{children:"VARNAME=VALUE"}),", where the value is optional, and if left out, the value is taken from the environment instead."]}),"\n",(0,t.jsxs)(a.A,{groupId:"code-examples",children:[(0,t.jsx)(o.A,{value:"pants.toml",label:"pants.toml",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'tab={"label":"pants.toml"}',children:'[docker]\nbuild_args = [\n  "VAR1=value1",\n  "VAR2"\n]\n'})})}),(0,t.jsx)(o.A,{value:"example/build",label:"example/BUILD",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"example/BUILD"}',children:'docker_image(\n  name="docker",\n  extra_build_args=["VAR1=my_value", "VAR3"]\n)\n'})})}),(0,t.jsx)(o.A,{value:"example/dockerfile",label:"example/Dockerfile",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",metastring:'tab={"label":"example/Dockerfile"}',children:"FROM python:3.8\nARG VAR1\nARG VAR2\nARG VAR3=default\n...\n"})})})]}),"\n",(0,t.jsx)(n.h3,{id:"target-build-stage",children:"Target build stage"}),"\n",(0,t.jsxs)(n.p,{children:["When your ",(0,t.jsx)(n.code,{children:"Dockerfile"})," is a multi-stage build file, you may specify which stage to build with the ",(0,t.jsx)(n.a,{href:"/2.27/reference/subsystems/docker#build_target_stage",children:(0,t.jsx)(n.code,{children:"--docker-build-target-stage"})})," for all images, or provide a per image setting with the ",(0,t.jsx)(n.code,{children:"docker_image"})," field ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image#target_stage",children:(0,t.jsx)(n.code,{children:"target_stage"})}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:"FROM python:3.8 AS base\nRUN <install required tools>\n\nFROM base AS img\nCOPY files /\n"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F pants package --docker-build-target-stage=base Dockerfile\n"})}),"\n",(0,t.jsxs)(n.p,{children:["See this ",(0,t.jsx)(n.a,{href:"https://blog.pantsbuild.org/optimizing-python-docker-deploys-using-pants/",children:"blog post"})," for more examples using multi-stage builds."]}),"\n",(0,t.jsx)(n.h3,{id:"build-time-secrets",children:"Build time secrets"}),"\n",(0,t.jsxs)(n.p,{children:["Secrets are supported for ",(0,t.jsx)(n.code,{children:"docker_image"})," targets with the ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image#secrets",children:(0,t.jsx)(n.code,{children:"secrets"})})," field. The defined secrets may then be mounted in the ",(0,t.jsx)(n.code,{children:"Dockerfile"})," as ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/develop/develop-images/build_enhancements/#new-docker-build-secret-information",children:"usual"}),"."]}),"\n",(0,t.jsx)(a.A,{groupId:"code-examples",children:(0,t.jsx)(o.A,{value:"build",label:"BUILD",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"BUILD"}',children:'docker_image(\n  secrets={\n    "mysecret": "mysecret.txt",\n  }\n)\n'})})})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",children:"FROM python:3.8\n\n# shows secret from default secret location:\nRUN --mount=type=secret,id=mysecret cat /run/secrets/mysecret\n\n# shows secret from custom secret location:\nRUN --mount=type=secret,id=mysecret,dst=/foobar cat /foobar\n"})}),"\n",(0,t.jsx)(a.A,{groupId:"code-examples",children:(0,t.jsx)(o.A,{value:"mysecret.txt",label:"mysecret.txt",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",metastring:'tab={"label":"mysecret.txt"}',children:"very-secret-value\n"})})})}),"\n",(0,t.jsxs)(n.admonition,{title:"Secret file path",type:"note",children:[(0,t.jsxs)(n.p,{children:["Secrets should not be checked into version control. Use absolute paths to reference a file that is not in the project source tree. However, to keep the BUILD file as hermetic as possible, the files may be placed within the project source tree at build time for instance, and referenced with a path relative to the project root by default, or relative to the directory of the BUILD file when prefixed with ",(0,t.jsx)(n.code,{children:"./"}),"."]}),(0,t.jsxs)(n.p,{children:["See the example for the ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image#secrets",children:(0,t.jsx)(n.code,{children:"secrets"})})," field."]})]}),"\n",(0,t.jsx)(n.h3,{id:"buildx-support",children:"Buildx Support"}),"\n",(0,t.jsxs)(n.p,{children:["Buildx (using BuildKit) supports exporting build cache to an external location, making it possible to import in future builds. Cache backends can be configured using the ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image#cache_to",children:(0,t.jsx)(n.code,{children:"cache_to"})})," and ",(0,t.jsx)(n.a,{href:"/2.27/reference/targets/docker_image#cache_from",children:(0,t.jsx)(n.code,{children:"cache_from"})})," fields."]}),"\n",(0,t.jsxs)(n.p,{children:["To use BuildKit with Pants, enable the ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/desktop/containerd/",children:"Containerd Image Store"}),", either via ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/storage/containerd/",children:"Docker Desktop settings"})," or by ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/storage/containerd/#enable-containerd-image-store-on-docker-engine",children:"setting daemon config"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "features": {\n    "containerd-snapshotter": true\n  }\n}\n'})}),"\n",(0,t.jsx)(n.p,{children:"Optionally, run a build with the Docker CLI directly to validate buildx support on your system:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F docker buildx build -t pants-cache-test:latest \\\n  --cache-to type=local,dest=/tmp/docker/pants-test-cache \\\n  --cache-from type=local,src=/tmp/docker/pants-test-cache .\n"})}),"\n",(0,t.jsx)(n.p,{children:"Configure Pants to use buildx:"}),"\n",(0,t.jsxs)(a.A,{groupId:"code-examples",children:[(0,t.jsx)(o.A,{value:"pants.toml",label:"pants.toml",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'tab={"label":"pants.toml"}',children:"[docker]\nuse_buildx = true\n"})})}),(0,t.jsx)(o.A,{value:"example/build",label:"example/BUILD",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"example/BUILD"}',children:'docker_image(\n    name="with-local-cache-backend",\n    cache_to={\n        "type": "local",\n        "dest": "/tmp/docker-cache/pants-example"\n    },\n    cache_from=[{\n        "type": "local",\n        "src": "/tmp/docker-cache/pants-example"\n    }]\n)\n'})})})]}),"\n",(0,t.jsxs)(n.p,{children:["For working examples, including multi-platform builds with GitHub Actions, refer to the ",(0,t.jsx)(n.a,{href:"https://github.com/pantsbuild/example-docker",children:"example-docker"})," repository."]}),"\n",(0,t.jsx)(n.h3,{id:"using-buildx-with-kubernetes-drivers",children:"Using buildx with Kubernetes drivers"}),"\n",(0,t.jsx)(n.p,{children:"When using a buildx Kubernetes driver instead of a local Docker engine, you'll need to configure Pants to work with your Kubernetes cluster. Here are the key considerations:"}),"\n",(0,t.jsx)(n.h4,{id:"environment-configuration",children:"Environment configuration"}),"\n",(0,t.jsxs)(n.p,{children:["Pass along Kubernetes service environment variables to the ",(0,t.jsx)(n.code,{children:"[docker]"})," backend config in ",(0,t.jsx)(n.code,{children:"pants.toml"})," to enable in-cluster configuration discovery:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[docker]\nenv_vars = [\n  "KUBERNETES_SERVICE_HOST",\n  "KUBERNETES_SERVICE_PORT",\n  "KUBERNETES_SERVICE_PORT_HTTPS",\n]\n'})}),"\n",(0,t.jsxs)(n.p,{children:["If you're not running in-cluster, ensure a ",(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/configuration/organize-cluster-access-kubeconfig/",children:"kubeconfig file"})," is available and accessible to the Docker CLI."]}),"\n",(0,t.jsx)(n.h4,{id:"buildx-driver-and-namespace-configuration",children:"Buildx driver and namespace configuration"}),"\n",(0,t.jsx)(n.p,{children:"Consider explicitly setting the buildx driver and namespace in the same environment variables configuration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[docker]\nenv_vars = [\n  "KUBERNETES_SERVICE_HOST",\n  "KUBERNETES_SERVICE_PORT", \n  "KUBERNETES_SERVICE_PORT_HTTPS",\n  "BUILDX_BUILDER=your-k8s-buildx-driver-name",\n  "BUILDKIT_NAMESPACE=your-namespace",\n]\n'})}),"\n",(0,t.jsx)(n.h4,{id:"image-output-configuration",children:"Image output configuration"}),"\n",(0,t.jsxs)(n.p,{children:["On your ",(0,t.jsx)(n.code,{children:"docker_image"})," target, set ",(0,t.jsx)(n.code,{children:'output={"type": "registry"}'}),'. The default output type is "docker," which attempts to load the image into the local Docker engine\'s image store.']}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'title="example/BUILD"',children:'docker_image(\n    name="docker",\n    output={"type": "registry"},\n)\n'})}),"\n",(0,t.jsxs)(n.admonition,{type:"info",children:[(0,t.jsxs)(n.mdxAdmonitionTitle,{children:["The ",(0,t.jsx)(n.code,{children:"pants publish"})," goal"]}),(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"pants publish"})," will not succeed on a ",(0,t.jsx)(n.code,{children:"docker_image"})," target when using a Kubernetes buildx driver. ",(0,t.jsx)(n.code,{children:"pants package"})," will upload the image directly to the registry due to the output type. The ",(0,t.jsx)(n.code,{children:"pants publish"})," goal is designed for uploading local images to a registry, which isn't applicable when using remote buildx drivers."]})]}),"\n",(0,t.jsx)(n.h3,{id:"build-docker-image-example",children:"Build Docker image example"}),"\n",(0,t.jsxs)(n.p,{children:["This example copies both a ",(0,t.jsx)(n.code,{children:"file"})," and ",(0,t.jsx)(n.code,{children:"pex_binary"}),". The file is specified as an explicit dependency in the ",(0,t.jsx)(n.code,{children:"BUILD"})," file, whereas the ",(0,t.jsx)(n.code,{children:"pex_binary"})," dependency is inferred from the path in the ",(0,t.jsx)(n.code,{children:"Dockerfile"}),"."]}),"\n",(0,t.jsxs)(a.A,{groupId:"code-examples",children:[(0,t.jsx)(o.A,{value:"src/docker/hw/build",label:"src/docker/hw/BUILD",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/docker/hw/BUILD"}',children:'file(name="msg", source="msg.txt")\n\ndocker_image(\n    name="helloworld",\n    dependencies=[":msg"],\n)\n'})})}),(0,t.jsx)(o.A,{value:"src/docker/hw/dockerfile",label:"src/docker/hw/Dockerfile",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-dockerfile",metastring:'tab={"label":"src/docker/hw/Dockerfile"}',children:'FROM python:3.8\nENTRYPOINT ["/bin/helloworld"]\nCOPY src/docker/hw/msg.txt /var/msg\nCOPY src.python.hw/bin.pex /bin/helloworld\n'})})}),(0,t.jsx)(o.A,{value:"src/docker/hw/msg.txt",label:"src/docker/hw/msg.txt",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",metastring:'tab={"label":"src/docker/hw/msg.txt"}',children:"Hello, Docker!\n"})})}),(0,t.jsx)(o.A,{value:"src/python/hw/build",label:"src/python/hw/BUILD",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/python/hw/BUILD"}',children:'python_sources(name="lib")\n\npex_binary(name="bin", entry_point="main.py")\n'})})}),(0,t.jsx)(o.A,{value:"src/python/hw/main.py",label:"src/python/hw/main.py",children:(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/python/hw/main.py"}',children:'import os\n\nmsg = "Hello"\nif os.path.exists("/var/msg"):\n    with open("/var/msg") as fp:\n        msg = fp.read().strip()\n\nprint(msg)\n'})})})]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F pants package src/docker/hw/Dockerfile\n08:09:22.86 [INFO] Completed: Building local_dists.pex\n08:09:23.80 [INFO] Completed: Building src.python.hw/bin.pex\n08:10:42.51 [INFO] Completed: Building docker image helloworld:latest\n08:10:42.51 [INFO] Built docker image: helloworld:latest\nDocker image ID: 1fe744d52222\n"})}),"\n",(0,t.jsx)(n.h2,{id:"running-a-docker-image",children:"Running a Docker image"}),"\n",(0,t.jsxs)(n.p,{children:["You can ask Pants to run a Docker image on your local system with the ",(0,t.jsx)(n.code,{children:"run"})," goal:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F pants run src/docker/hw/Dockerfile\nHello, Docker!\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Any arguments for the Docker container may be provided as pass through args to the ",(0,t.jsx)(n.code,{children:"run"})," goal, as usual. That is, use either the ",(0,t.jsx)(n.code,{children:"--args"})," option or after all other arguments after a separating double-dash:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F pants run src/docker/hw/Dockerfile -- arguments for the container\nHello, Docker!\n"})}),"\n",(0,t.jsxs)(n.p,{children:["To provide any command line arguments to the ",(0,t.jsx)(n.code,{children:"docker run"})," command, you may use the ",(0,t.jsx)(n.code,{children:"--docker-run-args"})," option:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'\u276F pants run --docker-run-args="-p 8080 --name demo" src/docker/hw/Dockerfile\n'})}),"\n",(0,t.jsxs)(n.p,{children:["As with all configuration options, this is not limited to the command line, but may be configured in a Pants rc file (such as ",(0,t.jsx)(n.code,{children:"pants.toml"}),") in the ",(0,t.jsx)(n.code,{children:"[docker].run_args"})," section or as an environment variable, ",(0,t.jsx)(n.code,{children:"PANTS_DOCKER_RUN_ARGS"})," as well."]}),"\n",(0,t.jsx)(n.h2,{id:"publishing-images",children:"Publishing images"}),"\n",(0,t.jsxs)(n.p,{children:["Pants can push your images to registries using ",(0,t.jsx)(n.code,{children:"pants publish"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-shell",children:"\u276F pants publish src/docker/hw:helloworld\n# Will build the image and push it to all registries, with all tags.\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Publishing may be skipped per registry or entirely per ",(0,t.jsx)(n.code,{children:"docker_image"})," using ",(0,t.jsx)(n.code,{children:"skip_push"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"/2.27/docs/docker/tagging-docker-images",children:"here"})," for how to set up registries."]}),"\n",(0,t.jsx)(n.h2,{id:"docker-configuration",children:"Docker configuration"}),"\n",(0,t.jsxs)(n.p,{children:["To configure the Docker binary, set ",(0,t.jsx)(n.code,{children:"[docker].env_vars"})," in your ",(0,t.jsx)(n.code,{children:"pants.toml"})," configuration file. You use that key to list environment variables such as ",(0,t.jsx)(n.code,{children:"DOCKER_CONTEXT"})," or ",(0,t.jsx)(n.code,{children:"DOCKER_HOST"}),", that will be set in the environment of the ",(0,t.jsx)(n.code,{children:"docker"})," binary when Pants runs it. Each listed value can be of the form ",(0,t.jsx)(n.code,{children:"NAME=value"}),", or just ",(0,t.jsx)(n.code,{children:"NAME"}),", in which case the value will be inherited from the Pants process's own environment."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[docker]\nenv_vars = [\n  "DOCKER_CONTEXT=pants_context",\n  "DOCKER_HOST"\n]\n'})}),"\n",(0,t.jsx)(n.admonition,{title:"Docker environment variables",type:"note",children:(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/commandline/cli/#environment-variables",children:"Docker documentation"})," for the authoritative table of environment variables for the Docker CLI."]})}),"\n",(0,t.jsx)(n.h2,{id:"docker-authentication",children:"Docker authentication"}),"\n",(0,t.jsx)(n.p,{children:"To authenticate, you usually will need to:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["Set up a Docker config file, e.g. ",(0,t.jsx)(n.code,{children:"~/.docker/config.json"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Tell Pants about the config file by setting ",(0,t.jsx)(n.code,{children:"[docker].env_vars"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Tell Pants about any tools needed for authentication to work by setting ",(0,t.jsx)(n.code,{children:"[docker].tools"}),"."]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:["For example, a config file using the ",(0,t.jsx)(n.a,{href:"https://cloud.google.com/container-registry/docs/advanced-authentication#gcloud-helper",children:"GCloud helper"})," might look like this:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'{\n	"credHelpers": {\n		"europe-north1-docker.pkg.dev": "gcloud"\n	}\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Then, tell Pants to use this config by setting ",(0,t.jsx)(n.code,{children:'[docker].env_vars =  ["DOCKER_CONFIG=%(homedir)s/.docker"]'})," in ",(0,t.jsx)(n.code,{children:"pants.toml"}),", for example."]}),"\n",(0,t.jsxs)(n.p,{children:["Most authentication mechanisms will also require tools exposed on the ",(0,t.jsx)(n.code,{children:"$PATH"})," to work. Teach Pants about those by setting the names of the tools in ",(0,t.jsx)(n.code,{children:"[docker].tools"}),", and ensuring that they show up on your ",(0,t.jsx)(n.code,{children:"$PATH"}),". For example, GCloud authentication requires ",(0,t.jsx)(n.code,{children:"dirname"}),", ",(0,t.jsx)(n.code,{children:"readlink"})," and ",(0,t.jsx)(n.code,{children:"python3"}),"."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'# Example GCloud authentication.\n\n[docker]\nenv_vars = ["DOCKER_CONFIG=%(homedir)s/.docker"]\ntools = [\n  "docker-credential-gcr", # or docker-credential-gcloud when using artifact registry\n  "dirname",\n  "readlink",\n  "python3",\n  # These may be necessary if using Pyenv-installed Python.\n  "cut",\n  "sed",\n  "bash",\n]\n'})}),"\n",(0,t.jsxs)(n.p,{children:["You may need to set additional environment variables with ",(0,t.jsx)(n.code,{children:"[docker].env_vars"}),"."]}),"\n",(0,t.jsxs)(n.admonition,{title:"How to troubleshoot authentication",type:"note",children:[(0,t.jsx)(n.p,{children:"It can be tricky to figure out what environment variables and tools are missing, as the output often has indirection."}),(0,t.jsxs)(n.p,{children:["It can help to simulate a hermetic environment by using ",(0,t.jsx)(n.code,{children:"env -i"}),". With credential helpers, it also helps to directly invoke the helper without Docker and Pants. For example, you can symlink the tools you think you need into a directory like ",(0,t.jsx)(n.code,{children:"/some/isolated/directory"}),", then run the below:"]}),(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:'\u276F echo europe-north1-docker.pkg.dev | env -i PATH=/some/isolated/directory docker-credential-gcr get\n{\n  "Secret": "ya29.A0ARrdaM-...-ZhScVscwTVtQ",\n  "Username": "_dcgcloud_token"\n}\n'})})]}),"\n",(0,t.jsx)(n.h2,{id:"linting-dockerfiles",children:"Linting Dockerfiles"}),"\n",(0,t.jsx)(n.p,{children:"Once Docker linting backends are enabled, lint Dockerfiles with"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u276F pants lint src/docker/hw/Dockerfile\n"})}),"\n",(0,t.jsx)(n.h3,{id:"linting-dockerfiles-with-hadolint",children:"Linting Dockerfiles with Hadolint"}),"\n",(0,t.jsxs)(n.p,{children:["Pants can run ",(0,t.jsx)(n.a,{href:"https://github.com/hadolint/hadolint",children:"Hadolint"})," on your Dockerfiles to check for errors and mistakes.\nThis must first be enabled by activating the Hadolint backend:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = ["pants.backend.docker.lint.hadolint"]\n'})}),"\n",(0,t.jsx)(n.h3,{id:"linting-dockerfiles-with-trivy",children:"Linting Dockerfiles with Trivy"}),"\n",(0,t.jsxs)(n.p,{children:["Pants can run ",(0,t.jsx)(n.a,{href:"https://github.com/aquasecurity/trivy",children:"Trivy"})," on your Dockerfiles to check for security vulnerabilities.\nThis must first be enabled by activating the Trivy backend:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = ["pants.backend.docker.lint.trivy"]\n'})})]})}function p(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(u,{...e})}):u(e)}},753348(e,n,r){r.d(n,{A:()=>i});let i={tabItem:"tabItem_mHvh"}},618264(e,n,r){r.d(n,{A:()=>i});let i={tabList:"tabList_sFbf",tabItem:"tabItem_UVfV"}},637180(e,n,r){r.d(n,{A:()=>a});var i=r(886070);r(830758);var t=r(313526),s=r(753348);function a({children:e,hidden:n,className:r}){return(0,i.jsx)("div",{role:"tabpanel",className:(0,t.A)(s.A.tabItem,r),hidden:n,children:e})}},685008(e,n,r){r.d(n,{A:()=>g});var i=r(886070),t=r(830758),s=r(313526),a=r(911212),o=r(274875),c=r(106632),l=r(189223),d=r(618264);function h({className:e,block:n,selectedValue:r,selectValue:t,tabValues:a}){let c=[],{blockElementScrollPositionUntilNextRender:l}=(0,o.a_)(),h=e=>{let n=e.currentTarget,i=a[c.indexOf(n)].value;i!==r&&(l(n),t(i))},u=e=>{let n=null;switch(e.key){case"Enter":h(e);break;case"ArrowRight":{let r=c.indexOf(e.currentTarget)+1;n=c[r]??c[0];break}case"ArrowLeft":{let r=c.indexOf(e.currentTarget)-1;n=c[r]??c[c.length-1]}}n?.focus()};return(0,i.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":n},e),children:a.map(({value:e,label:n,attributes:t})=>(0,i.jsx)("li",{role:"tab",tabIndex:r===e?0:-1,"aria-selected":r===e,ref:e=>{c.push(e)},onKeyDown:u,onClick:h,...t,className:(0,s.A)("tabs__item",d.A.tabItem,t?.className,{"tabs__item--active":r===e}),children:n??e},e))})}function u({lazy:e,children:n,selectedValue:r}){let a=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){let e=a.find(e=>e.props.value===r);return e?(0,t.cloneElement)(e,{className:(0,s.A)("margin-top--md",e.props.className)}):null}return(0,i.jsx)("div",{className:"margin-top--md",children:a.map((e,n)=>(0,t.cloneElement)(e,{key:n,hidden:e.props.value!==r}))})}function p(e){let n=(0,c.u)(e);return(0,i.jsxs)("div",{className:(0,s.A)(a.G.tabs.container,"tabs-container",d.A.tabList),children:[(0,i.jsx)(h,{...n,...e}),(0,i.jsx)(u,{...n,...e})]})}function g(e){let n=(0,l.A)();return(0,i.jsx)(p,{...e,children:(0,c.v)(e.children)},String(n))}},106632(e,n,r){r.d(n,{u:()=>h,v:()=>l});var i=r(830758),t=r(325557),s=r(363717),a=r(125740),o=r(574229),c=r(270367);function l(e){return i.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,i.isValidElement)(e)&&function(e){let{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function d({value:e,tabValues:n}){return n.some(n=>n.value===e)}function h(e){let n,{defaultValue:r,queryString:h=!1,groupId:u}=e,p=function(e){let{values:n,children:r}=e;return(0,i.useMemo)(()=>{let e=n??l(r).map(({props:{value:e,label:n,attributes:r,default:i}})=>({value:e,label:n,attributes:r,default:i})),i=(0,o.XI)(e,(e,n)=>e.value===n.value);if(i.length>0)throw Error(`Docusaurus error: Duplicate values "${i.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[n,r])}(e),[g,m]=(0,i.useState)(()=>(function({defaultValue:e,tabValues:n}){if(0===n.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!d({value:e,tabValues:n}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let r=n.find(e=>e.default)??n[0];if(!r)throw Error("Unexpected error: 0 tabValues");return r.value})({defaultValue:r,tabValues:p})),[x,f]=function({queryString:e=!1,groupId:n}){let r=(0,t.W6)(),s=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,a.aZ)(s),(0,i.useCallback)(e=>{if(!s)return;let n=new URLSearchParams(r.location.search);n.set(s,e),r.replace({...r.location,search:n.toString()})},[s,r])]}({queryString:h,groupId:u}),[j,b]=function({groupId:e}){let n=e?`docusaurus.tab.${e}`:null,[r,t]=(0,c.Dv)(n);return[r,(0,i.useCallback)(e=>{n&&t.set(e)},[n,t])]}({groupId:u}),k=d({value:n=x??j,tabValues:p})?n:null;return(0,s.A)(()=>{k&&m(k)},[k]),{selectedValue:g,selectValue:(0,i.useCallback)(e=>{if(!d({value:e,tabValues:p}))throw Error(`Can't select invalid tab value=${e}`);m(e),f(e),b(e)},[f,b,p]),tabValues:p}}},848193(e,n,r){r.d(n,{R:()=>a,x:()=>o});var i=r(830758);let t={},s=i.createContext(t);function a(e){let n=i.useContext(s);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),i.createElement(s.Provider,{value:n},e.children)}},447626(e){e.exports=JSON.parse('{"id":"docs/docker/index","title":"Docker overview","description":"How to build Docker images containing artifacts built by Pants","source":"@site/versioned_docs/version-2.27/docs/docker/index.mdx","sourceDirName":"docs/docker","slug":"/docs/docker/","permalink":"/2.27/docs/docker/","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/docker/index.mdx","tags":[],"version":"2.27","sidebarPosition":0,"frontMatter":{"title":"Docker overview","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"Self-extractable archives","permalink":"/2.27/docs/shell/self-extractable-archives"},"next":{"title":"Tagging Docker images","permalink":"/2.27/docs/docker/tagging-docker-images"}}')}}]);