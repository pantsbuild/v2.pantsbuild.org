"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["617929"],{466752(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>a});var t=s(850959),l=s(886070),i=s(848193);let r={title:"Add a linter",sidebar_position:0},o,c={},a=[{value:"1. Install your linter",id:"1-install-your-linter",level:2},{value:"2. Set up a <code>FieldSet</code> and <code>LintRequest</code>",id:"2-set-up-a-fieldset-and-lintrequest",level:2},{value:"3. Create a rule for your linter logic",id:"3-create-a-rule-for-your-linter-logic",level:2},{value:"4. Add tests (optional)",id:"4-add-tests-optional",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n.p,{children:["How to add a new linter to the ",(0,l.jsx)(n.code,{children:"lint"})," goal."]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.admonition,{title:"Example repository",type:"note",children:(0,l.jsxs)(n.p,{children:["This guide walks through each step of adding Shellcheck. See ",(0,l.jsx)(n.a,{href:"https://github.com/pantsbuild/example-plugin/blob/main/pants-plugins/examples/bash/lint/shellcheck",children:"here"})," for the final result."]})}),"\n",(0,l.jsx)(n.p,{children:"This guide assumes that you are running a linter that already exists outside of Pants as a stand-alone binary, such as running Shellcheck, Pylint, Checkstyle, or ESLint."}),"\n",(0,l.jsxs)(n.p,{children:["If you are instead writing your own linting logic inline, you can skip Step 1. In Step 3, you will not need to use ",(0,l.jsx)(n.code,{children:"Process"}),". You may find Pants's ",(0,l.jsxs)(n.a,{href:"https://github.com/pantsbuild/pants/blob/master/src/python/pants/backend/project_info/source_file_validator.py",children:[(0,l.jsx)(n.code,{children:"validate"})," goal implementation"]})," helpful for how to integrate custom linting logic into Pants."]}),"\n",(0,l.jsx)(n.h2,{id:"1-install-your-linter",children:"1. Install your linter"}),"\n",(0,l.jsxs)(n.p,{children:["There are several ways for Pants to install your linter. See ",(0,l.jsx)(n.a,{href:"/2.1/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),". This example will use ",(0,l.jsx)(n.code,{children:"ExternalTool"})," because there is already a pre-compiled binary for Shellcheck."]}),"\n",(0,l.jsxs)(n.p,{children:["You will also likely want to register some options, like ",(0,l.jsx)(n.code,{children:"--config"}),", ",(0,l.jsx)(n.code,{children:"--skip"}),", and ",(0,l.jsx)(n.code,{children:"--args"}),". Options are registered through a ",(0,l.jsx)(n.a,{href:"/2.1/docs/writing-plugins/the-rules-api/options-and-subsystems",children:(0,l.jsx)(n.code,{children:"Subsystem"})}),". If you are using ",(0,l.jsx)(n.code,{children:"ExternalTool"}),", this is already a subclass of ",(0,l.jsx)(n.code,{children:"Subsystem"}),". Otherwise, create a subclass of ",(0,l.jsx)(n.code,{children:"Subsystem"}),". Then, set the class property ",(0,l.jsx)(n.code,{children:"options_scope"})," to the name of the tool, e.g. ",(0,l.jsx)(n.code,{children:'"shellcheck"'})," or ",(0,l.jsx)(n.code,{children:'"eslint"'}),". Finally, add options via the class method ",(0,l.jsx)(n.code,{children:"register_options()"}),"."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'from pants.core.util_rules.external_tool import ExternalTool\nfrom pants.engine.platform import Platform\nfrom pants.option.custom_types import file_option, shell_str\n\n\nclass Shellcheck(ExternalTool):\n    """A linter for shell scripts."""\n\n    options_scope = "shellcheck"\n    default_version = "v0.7.1"\n    default_known_versions = [\n        "v0.7.1|darwin|b080c3b659f7286e27004aa33759664d91e15ef2498ac709a452445d47e3ac23|1348272",\n        "v0.7.1|linux|64f17152d96d7ec261ad3086ed42d18232fcb65148b44571b564d688269d36c8|1443836",\n    ]\n\n    @classmethod\n    def register_options(cls, register):\n        super().register_options(register)\n        register(\n            "--skip",\n            type=bool,\n            default=False,\n            help="Don\'t use Shellcheck when running `./pants lint`.",\n        )\n        register(\n            "--args",\n            type=list,\n            member_type=shell_str,\n            help=(\n                "Arguments to pass directly to Shellcheck, e.g. `--shellcheck-args=\'-e SC20529\'`.\'"\n            ),\n        )\n        register(\n            "--config",\n            type=list,\n            member_type=file_option,\n            advanced=True,\n            help="Path to `.shellcheckrc`. This must be relative to the build root.",\n        )\n\n    def generate_url(self, plat: Platform) -> str:\n        plat_str = "linux" if plat == Platform.linux else "darwin"\n        return (\n            f"https://github.com/koalaman/shellcheck/releases/download/{self.version}/"\n            f"shellcheck-{self.version}.{plat_str}.x86_64.tar.xz"\n        )\n\n    def generate_exe(self, _: Platform) -> str:\n        return f"./shellcheck-{self.version}/shellcheck"\n\n'})}),"\n",(0,l.jsx)(n.p,{children:"Lastly, register your Subsystem with the engine:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import collect_rules\n\n...\n\ndef rules():\n    return collect_rules()\n"})}),"\n",(0,l.jsxs)(n.h2,{id:"2-set-up-a-fieldset-and-lintrequest",children:["2. Set up a ",(0,l.jsx)(n.code,{children:"FieldSet"})," and ",(0,l.jsx)(n.code,{children:"LintRequest"})]}),"\n",(0,l.jsxs)(n.p,{children:["As described in ",(0,l.jsx)(n.a,{href:"/2.1/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Rules and the Target API"}),", a ",(0,l.jsx)(n.code,{children:"FieldSet"})," is a way to tell Pants which ",(0,l.jsx)(n.code,{children:"Field"}),"s you care about targets having for your plugin to work."]}),"\n",(0,l.jsxs)(n.p,{children:["Usually, you should add a subclass of the ",(0,l.jsx)(n.code,{children:"Sources"})," field to the class property ",(0,l.jsx)(n.code,{children:"required_fields"}),", such as ",(0,l.jsx)(n.code,{children:"BashSources"})," or ",(0,l.jsx)(n.code,{children:"PythonSources"}),". This means that your linter will run on any target with that sources field or a subclass of it."]}),"\n",(0,l.jsxs)(n.p,{children:["Create a new dataclass that subclasses ",(0,l.jsx)(n.code,{children:"FieldSet"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.engine.target import Dependencies, FieldSet\n\n...\n\n@dataclass(frozen=True)\nclass ShellcheckFieldSet(FieldSet):\n    required_fields = (BashSources,)\n\n    sources: BashSources\n    dependencies: Dependencies\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Then, hook this up to a new subclass of ",(0,l.jsx)(n.code,{children:"LintRequest"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from pants.core.goals.lint import LintRequest\n\n...\n\nclass ShellcheckRequest(LintRequest):\n    field_set_type = ShellcheckFieldSet\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Finally, register your new ",(0,l.jsx)(n.code,{children:"LintRequest"})," with a ",(0,l.jsx)(n.a,{href:"/2.1/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,l.jsx)(n.code,{children:"UnionRule"})})," so that Pants knows your linter exists:"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(LintRequest, ShellcheckRequest),\n    ]\n"})}),"\n",(0,l.jsx)(n.h2,{id:"3-create-a-rule-for-your-linter-logic",children:"3. Create a rule for your linter logic"}),"\n",(0,l.jsxs)(n.p,{children:["Your rule should take as a parameter the ",(0,l.jsx)(n.code,{children:"LintRequest"})," from step 2 and the ",(0,l.jsx)(n.code,{children:"Subsystem"})," (or ",(0,l.jsx)(n.code,{children:"ExternalTool"}),") from step 1. It should return ",(0,l.jsx)(n.code,{children:"LintResults"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import rule\nfrom pants.core.goals.lint import LintRequest, LintResult, LintResults\n\n...\n\n@rule\nasync def run_shellcheck(\n    request: ShellcheckRequest, shellcheck: Shellcheck\n) -> LintResults:\n    return LintResults()\n"})}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.code,{children:"LintRequest"})," has a property called ",(0,l.jsx)(n.code,{children:".field_sets"}),", which stores a collection of the ",(0,l.jsx)(n.code,{children:"FieldSet"}),"s defined in step 2. Each ",(0,l.jsx)(n.code,{children:"FieldSet"})," corresponds to a single target. Pants will have already validated that there is at least one valid ",(0,l.jsx)(n.code,{children:"FieldSet"}),", so you can expect ",(0,l.jsx)(n.code,{children:"LintRequest.field_sets"})," to have 1-n ",(0,l.jsx)(n.code,{children:"FieldSet"})," instances."]}),"\n",(0,l.jsxs)(n.p,{children:["The rule should return ",(0,l.jsx)(n.code,{children:"LintResults"}),", which is a collection of multiple ",(0,l.jsx)(n.code,{children:"LintResult"})," objects. Normally, you will only have one single ",(0,l.jsx)(n.code,{children:"LintResult"}),". Sometimes, however, you may want to group your targets in a certain way and return a ",(0,l.jsx)(n.code,{children:"LintResult"})," for each group, such as grouping Python targets by their interpreter compatibility."]}),"\n",(0,l.jsxs)(n.p,{children:["If you have a ",(0,l.jsx)(n.code,{children:"--skip"})," option, you should check if it was used at the beginning of your rule and, if so, to early return an empty ",(0,l.jsx)(n.code,{children:"LintResults()"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["If you used ",(0,l.jsx)(n.code,{children:"ExternalTool"})," in step 1, you will use ",(0,l.jsx)(n.code,{children:"Get(DownloadedExternalTool, ExternalToolRequest)"})," to install the tool."]}),"\n",(0,l.jsxs)(n.p,{children:["Typically, you will use ",(0,l.jsx)(n.code,{children:"Get(SourceFiles, SourceFilesRequest)"})," to get all the sources you want to run your linter on."]}),"\n",(0,l.jsxs)(n.p,{children:["If you have a ",(0,l.jsx)(n.code,{children:"--config"})," option, you should use ",(0,l.jsx)(n.code,{children:"Get(Digest, PathGlobs)"})," to find the config file and include it in the ",(0,l.jsx)(n.code,{children:"input_digest"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["Use ",(0,l.jsx)(n.code,{children:"Get(Digest, MergeDigests)"})," to combine the different inputs together, such as merging the source files, config file, and downloaded tool."]}),"\n",(0,l.jsxs)(n.p,{children:["Usually, you will use ",(0,l.jsx)(n.code,{children:"Get(FallibleProcessResult, Process)"})," to run a subprocess (see ",(0,l.jsx)(n.a,{href:"/2.1/docs/writing-plugins/the-rules-api/processes",children:"Processes"}),"). We use ",(0,l.jsx)(n.code,{children:"Fallible"})," because Pants should not throw an exception if the linter returns a non-zero exit code. Then, you can use ",(0,l.jsx)(n.code,{children:"LintResult.from_fallible_process_result()"})," to convert this into a ",(0,l.jsx)(n.code,{children:"LintResult"}),"."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'from pants.core.goals.lint import LintRequest, LintResult, LintResults\nfrom pants.core.util_rules.determine_source_files import (\n    SourceFilesRequest,\n    SourceFiles,\n)\nfrom pants.core.util_rules.external_tool import (\n    DownloadedExternalTool,\n    ExternalTool,\n    ExternalToolRequest,\n)\nfrom pants.engine.fs import (\n    Digest,\n    GlobMatchErrorBehavior,\n    MergeDigests,\n    PathGlobs,\n)\nfrom pants.engine.platform import Platform\nfrom pants.engine.process import FallibleProcessResult, Process\nfrom pants.engine.rules import rule\nfrom pants.engine.selectors import Get, MultiGet\nfrom pants.util.logging import LogLevel\nfrom pants.util.strutil import pluralize\n\n...\n\n@rule\nasync def run_shellcheck(\n    request: ShellcheckRequest, shellcheck: Shellcheck\n) -> LintResults:\n    if shellcheck.options.skip:\n        return LintResults()\n\n    download_shellcheck_request = Get(\n        DownloadedExternalTool,\n        ExternalToolRequest,\n        shellcheck.get_request(Platform.current),\n    )\n\n    sources_request = Get(\n        SourceFiles,\n        SourceFilesRequest(field_set.sources for field_set in request.field_sets),\n    )\n\n    # If the user specified `--shellcheck-config`, we must search for the file they specified with\n    # `PathGlobs` to include it in the `input_digest`. We error if the file cannot be found.\n    config_digest_request = Get(\n        Digest,\n        PathGlobs(\n            globs=[shellcheck.options.config] if shellcheck.options.config else [],\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n            description_of_origin="the option `--shellcheck-config`",\n        ),\n    )\n\n    downloaded_shellcheck, sources, config_digest = await MultiGet(\n        download_shellcheck_request, sources_request, config_digest_request\n    )\n\n    # The Process needs one single `Digest`, so we merge everything together.\n    input_digest = await Get(\n        Digest,\n        MergeDigests(\n            (\n                downloaded_shellcheck.digest,\n                sources.snapshot.digest,\n                config_digest,\n            )\n        ),\n    )\n\n    process_result = await Get(\n        FallibleProcessResult,\n        Process(\n            argv=[\n                downloaded_shellcheck.exe,\n                *shellcheck.options.args,\n                *sources.snapshot.files,\n            ],\n            input_digest=input_digest,\n            description=f"Run Shellcheck on {pluralize(len(request.field_sets), \'file\')}.",\n            level=LogLevel.DEBUG,\n        ),\n    )\n    result = LintResult.from_fallible_process_result(\n        process_result, linter_name="Shellcheck"\n    )\n    return LintResults([result])\n\n'})}),"\n",(0,l.jsxs)(n.p,{children:["Finally, update your plugin's ",(0,l.jsx)(n.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/bash/register.py"',children:"from bash import shellcheck\n\n\ndef rules():\n    return [*shellcheck.rules()]\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Now, when you run ",(0,l.jsx)(n.code,{children:"./pants lint ::"}),", your new linter should run."]}),"\n",(0,l.jsx)(n.h2,{id:"4-add-tests-optional",children:"4. Add tests (optional)"}),"\n",(0,l.jsxs)(n.p,{children:["Refer to ",(0,l.jsx)(n.a,{href:"/2.1/docs/writing-plugins/the-rules-api/testing-plugins",children:"Testing rules"}),". TODO"]})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},848193(e,n,s){s.d(n,{R:()=>r,x:()=>o});var t=s(830758);let l={},i=t.createContext(l);function r(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),t.createElement(i.Provider,{value:n},e.children)}},850959(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-linter","title":"Add a linter","description":"How to add a new linter to the lint goal.","source":"@site/versioned_docs/version-2.1/docs/writing-plugins/common-plugin-tasks/add-a-linter.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-linter","permalink":"/2.1/docs/writing-plugins/common-plugin-tasks/add-a-linter","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-linter.mdx","tags":[],"version":"2.1","sidebarPosition":0,"frontMatter":{"title":"Add a linter","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"Common plugin tasks","permalink":"/2.1/docs/writing-plugins/common-plugin-tasks/"},"next":{"title":"Add a formatter","permalink":"/2.1/docs/writing-plugins/common-plugin-tasks/add-a-formatter"}}')}}]);