"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["553746"],{251983(e,s,i){i.r(s),i.d(s,{assets:()=>o,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>n,toc:()=>p});var n=i(152947),t=i(886070),r=i(848193);let l={title:"Add a publisher",sidebar_position:6},a,o={},p=[{value:"1. Define target fields",id:"1-define-target-fields",level:2},{value:"2. Create <code>PublishRequest</code> and <code>PublishFieldSet</code>",id:"2-create-publishrequest-and-publishfieldset",level:2},{value:"3. Implement the publish rule",id:"3-implement-the-publish-rule",level:2},{value:"4. Register your publisher",id:"4-register-your-publisher",level:2},{value:"5. Optimize with preemptive skip checking (optional)",id:"5-optimize-with-preemptive-skip-checking-optional",level:2},{value:"6. Real-world examples",id:"6-real-world-examples",level:2}];function c(e){let s={a:"a",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(s.p,{children:["How to add a new publisher to the ",(0,t.jsx)(s.code,{children:"publish"})," goal."]}),"\n",(0,t.jsx)(s.hr,{}),"\n",(0,t.jsx)(s.p,{children:"In Pants, publishers are responsible for taking built artifacts and pushing them to remote registries or repositories."}),"\n",(0,t.jsx)(s.p,{children:"This guide walks through implementing a publisher for artifacts that you can build in Pants (e.g., Docker images, Helm charts, Python distributions, or custom artifacts)."}),"\n",(0,t.jsx)(s.h2,{id:"1-define-target-fields",children:"1. Define target fields"}),"\n",(0,t.jsx)(s.p,{children:"Before implementing the publisher, define the fields that targets need to specify for publishing. These typically include:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"A field for the registries/repositories to publish to (required)"}),"\n",(0,t.jsx)(s.li,{children:"A field to skip publishing (optional but recommended)"}),"\n",(0,t.jsx)(s.li,{children:"Any publisher-specific configuration fields"}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"For example, if you're creating a publisher for a custom artifact type:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'from pants.engine.target import BoolField, StringSequenceField\n\n\nclass MyRepositoriesField(StringSequenceField):\n    alias = "repositories"\n    help = "The registries to push this artifact to."\n\n\nclass MySkipPushField(BoolField):\n    alias = "skip_push"\n    default = False\n    help = "If true, do not push this artifact to registries when running `pants publish`."\n'})}),"\n",(0,t.jsxs)(s.p,{children:["If you're adding a publisher for an existing target type (like ",(0,t.jsx)(s.code,{children:"python_distribution"}),"), you may need to register these fields on the target type:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"MyTargetType.register_plugin_field(MyRepositoriesField)\nMyTargetType.register_plugin_field(MySkipPushField)\n"})}),"\n",(0,t.jsxs)(s.h2,{id:"2-create-publishrequest-and-publishfieldset",children:["2. Create ",(0,t.jsx)(s.code,{children:"PublishRequest"})," and ",(0,t.jsx)(s.code,{children:"PublishFieldSet"})]}),"\n",(0,t.jsxs)(s.p,{children:["A ",(0,t.jsx)(s.code,{children:"PublishFieldSet"})," tells Pants which fields your publisher needs for targets to be publishable. Similar to other plugin patterns, you'll create two related classes:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'from dataclasses import dataclass\n\nfrom pants.core.goals.publish import PublishFieldSet, PublishRequest\n\n\nclass MyPublishRequest(PublishRequest):\n    """Request to publish an artifact."""\n    pass\n\n\n@dataclass(frozen=True)\nclass MyPublishFieldSet(PublishFieldSet):\n    publish_request_type = MyPublishRequest\n    required_fields = (MyRepositoriesField,)\n\n    repositories: MyRepositoriesField\n    skip_push: MySkipPushField\n'})}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"PublishFieldSet"})," base class provides a ",(0,t.jsx)(s.code,{children:"get_output_data()"})," method that you can optionally override to include publisher-specific metadata in the output:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'def get_output_data(self) -> PublishOutputData:\n    return PublishOutputData({\n        "publisher": "my_publisher",\n        **super().get_output_data(),\n    })\n'})}),"\n",(0,t.jsx)(s.h2,{id:"3-implement-the-publish-rule",children:"3. Implement the publish rule"}),"\n",(0,t.jsxs)(s.p,{children:["Create a rule that takes your ",(0,t.jsx)(s.code,{children:"PublishRequest"})," and returns ",(0,t.jsx)(s.code,{children:"PublishProcesses"}),". This rule builds the processes that will actually publish your artifacts:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'from pants.core.goals.publish import PublishPackages, PublishProcesses\nfrom pants.engine.process import InteractiveProcess, Process, ProcessCacheScope\nfrom pants.engine.rules import rule\n\n\n@rule\nasync def publish_my_artifacts(request: MyPublishRequest) -> PublishProcesses:\n    # Access the built artifacts\n    artifacts = []\n    for package in request.packages:\n        for artifact in package.artifacts:\n            if artifact.relpath:\n                artifacts.append(artifact.relpath)\n\n    # Check if publishing should be skipped\n    if request.field_set.skip_push.value:\n        return PublishProcesses([\n            PublishPackages(\n                names=tuple(artifacts),\n                description=f"(by `{request.field_set.skip_push.alias}` on {request.field_set.address})",\n            )\n        ])\n\n    # Build a process for each repository\n    processes = []\n    for repository in request.field_set.repositories.value:\n        process = Process(\n            argv=["push-tool", "--repo", repository, *artifacts],\n            cache_scope=ProcessCacheScope.PER_SESSION,\n            description=f"Push artifacts to {repository}",\n        )\n\n        processes.append(PublishPackages(\n            names=tuple(artifacts),\n            process=process,\n            description=repository,\n        ))\n\n    return PublishProcesses(processes)\n'})}),"\n",(0,t.jsx)(s.p,{children:"Key points:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:["Use ",(0,t.jsx)(s.code,{children:"request.packages"})," to access the built artifacts"]}),"\n",(0,t.jsxs)(s.li,{children:["Use ",(0,t.jsx)(s.code,{children:"request.field_set"})," to access target configuration"]}),"\n",(0,t.jsxs)(s.li,{children:["Return ",(0,t.jsx)(s.code,{children:"PublishProcesses"})," containing one or more ",(0,t.jsx)(s.code,{children:"PublishPackages"})]}),"\n",(0,t.jsxs)(s.li,{children:["Each ",(0,t.jsx)(s.code,{children:"PublishPackages"})," represents a single publish operation"]}),"\n",(0,t.jsxs)(s.li,{children:["If ",(0,t.jsx)(s.code,{children:"process"})," is ",(0,t.jsx)(s.code,{children:"None"}),", the artifacts are marked as skipped"]}),"\n",(0,t.jsxs)(s.li,{children:["Set ",(0,t.jsx)(s.code,{children:"cache_scope=ProcessCacheScope.PER_SESSION"})," to prevent caching publish operations"]}),"\n",(0,t.jsxs)(s.li,{children:["Use ",(0,t.jsx)(s.code,{children:"InteractiveProcess"})," if your publisher requires user interaction (e.g., authentication)"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"4-register-your-publisher",children:"4. Register your publisher"}),"\n",(0,t.jsx)(s.p,{children:"At the bottom of your file, register your rules and field set:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"def rules():\n    return [\n        *collect_rules(),\n        *MyPublishFieldSet.rules(),  # Auto-registers the union rules\n    ]\n"})}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"PublishFieldSet.rules()"})," helper automatically registers the necessary union rules."]}),"\n",(0,t.jsxs)(s.p,{children:["Then update your plugin's ",(0,t.jsx)(s.code,{children:"register.py"}),":"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"from mybackend import publish\n\n\ndef rules():\n    return [*publish.rules()]\n"})}),"\n",(0,t.jsx)(s.h2,{id:"5-optimize-with-preemptive-skip-checking-optional",children:"5. Optimize with preemptive skip checking (optional)"}),"\n",(0,t.jsxs)(s.p,{children:["If your publisher has expensive packaging steps, you can use ",(0,t.jsx)(s.code,{children:"check_skip_request"})," to preemptively skip packaging when you know the publish will be skipped:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'from pants.core.goals.publish import CheckSkipRequest, CheckSkipResult\nfrom pants.core.goals import package\n\n\n@dataclass(frozen=True)\nclass MyPublishFieldSet(PublishFieldSet):\n    publish_request_type = MyPublishRequest\n    required_fields = (MyRepositoriesField,)\n\n    repositories: MyRepositoriesField\n    skip_push: MySkipPushField\n\n    def check_skip_request(self, package_fs: package.PackageFieldSet) -> CheckSkipRequest[Self] | None:\n        """Return a request to check if we should skip packaging."""\n        return MyPublishSkipRequest(publish_fs=self, package_fs=package_fs)\n'})}),"\n",(0,t.jsx)(s.p,{children:"Then implement a rule to handle the skip check:"}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:'class MyPublishSkipRequest(CheckSkipRequest[MyPublishFieldSet]):\n    """Request to check if we should skip packaging."""\n    pass\n\n\n@rule\nasync def check_my_publish_skip(request: MyPublishSkipRequest) -> CheckSkipResult:\n    """Check if publishing should be skipped, and return the result."""\n\n    # Skip if no repositories configured\n    if not request.publish_fs.repositories.value:\n        return CheckSkipResult.skip(\n            names=[],\n            data=request.publish_fs.get_output_data(),\n        )\n\n    # Skip both packaging and publishing if explicitly set\n    if request.publish_fs.skip_push.value:\n        return CheckSkipResult.skip(\n            names=["example-artifact"],\n            description=f"(by `{request.publish_fs.skip_push.alias}`)",\n            data=request.publish_fs.get_output_data(),\n        )\n\n    # Skip packaging only (we already have artifacts)\n    if some_condition:\n        return CheckSkipResult.skip(skip_packaging_only=True)\n\n    # Don\'t skip anything\n    return CheckSkipResult.no_skip()\n'})}),"\n",(0,t.jsxs)(s.p,{children:["Register the union rule in your ",(0,t.jsx)(s.code,{children:"rules()"})," function:"]}),"\n",(0,t.jsx)(s.pre,{children:(0,t.jsx)(s.code,{className:"language-python",children:"def rules():\n    return [\n        *collect_rules(),\n        *MyPublishFieldSet.rules(),\n        UnionRule(CheckSkipRequest, MyPublishSkipRequest),  # Register the skip request\n    ]\n"})}),"\n",(0,t.jsxs)(s.p,{children:["The ",(0,t.jsx)(s.code,{children:"CheckSkipResult"})," class provides three modes:"]}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"CheckSkipResult.no_skip()"})," - Proceed with both packaging and publishing"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"CheckSkipResult.skip(skip_packaging_only=True)"})," - Skip packaging but still run the publish rule"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.code,{children:"CheckSkipResult.skip(names=..., description=..., data=...)"})," - Skip both packaging and publishing"]}),"\n"]}),"\n",(0,t.jsx)(s.h2,{id:"6-real-world-examples",children:"6. Real-world examples"}),"\n",(0,t.jsx)(s.p,{children:"For complete implementations, see these existing publishers:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Docker"})," (",(0,t.jsx)(s.a,{href:"https://github.com/pantsbuild/pants/blob/main/src/python/pants/backend/docker/goals/publish.py",children:"source"}),"): Supports pushing Docker images to multiple registries"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Helm"})," (",(0,t.jsx)(s.a,{href:"https://github.com/pantsbuild/pants/blob/main/src/python/pants/backend/helm/goals/publish.py",children:"source"}),"): Pushes Helm charts to OCI registries"]}),"\n",(0,t.jsxs)(s.li,{children:[(0,t.jsx)(s.strong,{children:"Python/Twine"})," (",(0,t.jsx)(s.a,{href:"https://github.com/pantsbuild/pants/blob/main/src/python/pants/backend/python/goals/publish.py",children:"source"}),"): Uploads Python distributions to PyPI or other repositories using Twine"]}),"\n"]}),"\n",(0,t.jsx)(s.p,{children:"Each demonstrates different patterns:"}),"\n",(0,t.jsxs)(s.ul,{children:["\n",(0,t.jsx)(s.li,{children:"Multiple registries/repositories in a single publish operation"}),"\n",(0,t.jsx)(s.li,{children:"Different credential handling approaches"}),"\n",(0,t.jsx)(s.li,{children:"Interactive vs non-interactive process execution"}),"\n",(0,t.jsx)(s.li,{children:"Skip logic at different levels (target, registry, subsystem)"}),"\n"]})]})}function u(e={}){let{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,t.jsx)(s,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},848193(e,s,i){i.d(s,{R:()=>l,x:()=>a});var n=i(830758);let t={},r=n.createContext(t);function l(e){let s=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),n.createElement(r.Provider,{value:s},e.children)}},152947(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-publisher","title":"Add a publisher","description":"How to add a new publisher to the publish goal.","source":"@site/docs/docs/writing-plugins/common-plugin-tasks/add-a-publisher.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-publisher","permalink":"/dev/docs/writing-plugins/common-plugin-tasks/add-a-publisher","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-publisher.mdx","tags":[],"version":"current","sidebarPosition":6,"frontMatter":{"title":"Add a publisher","sidebar_position":6},"sidebar":"docsSidebar","previous":{"title":"Add a REPL","permalink":"/dev/docs/writing-plugins/common-plugin-tasks/add-a-repl"},"next":{"title":"Run tests","permalink":"/dev/docs/writing-plugins/common-plugin-tasks/run-tests"}}')}}]);