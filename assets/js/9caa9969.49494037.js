"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["200053"],{621377(e,n,t){t.r(n),t.d(n,{assets:()=>h,contentTitle:()=>r,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var s=t(414183),a=t(886070),i=t(848193);let o={title:"GitHub Actions aarch64 runners",sidebar_position:3},r,h={},c=[{value:"The Custom AMI",id:"the-custom-ami",level:2},{value:"Create a temporary EC2 instance on the standard AMI",id:"create-a-temporary-ec2-instance-on-the-standard-ami",level:3},{value:"SSH into the temporary EC2 instance",id:"ssh-into-the-temporary-ec2-instance",level:3},{value:"Install Pythons on the instance",id:"install-pythons-on-the-instance",level:3},{value:"Create an AMI from the instance",id:"create-an-ami-from-the-instance",level:3},{value:"Terminate the temporary instance",id:"terminate-the-temporary-instance",level:3},{value:"Update the RunsOn config",id:"update-the-runson-config",level:3},{value:"Deregister the old AMI",id:"deregister-the-old-ami",level:3}];function l(e){let n={a:"a",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.hr,{}),"\n",(0,a.jsx)(n.p,{children:"GitHub Actions does not have affordable hosted aarch64 runners."}),"\n",(0,a.jsx)(n.p,{children:"For a while we enjoyed hardware donated by the Works on ARM program, but that has now been terminated,\nso we instead rely on self-hosted EC2 instances."}),"\n",(0,a.jsxs)(n.p,{children:["We use ",(0,a.jsx)(n.a,{href:"https://runs-on.com/",children:"RunsOn"})," to simplify the management of these instances. RunsOn monitors\nrequests for runners, launches EC2 instances on the fly to satify those requests, and terminates them\nwhen the workflows complete."]}),"\n",(0,a.jsx)(n.h2,{id:"the-custom-ami",children:"The Custom AMI"}),"\n",(0,a.jsx)(n.p,{children:"We configure RunsOn to launch these instances with a custom AMI that pre-installs the Python interpreters\nneeded to bootstrap and test Pants on aarch64. This custom AMI is built on top of the standard RunsOn\nUbuntu 22 ARM64 AMI."}),"\n",(0,a.jsx)(n.p,{children:"It may occasionally be necessary to update this AMI, for example to pick up updates to the underlying standard\nAMI."}),"\n",(0,a.jsxs)(n.p,{children:["To do so with Packer, see instructions in ",(0,a.jsx)(n.code,{children:"build-support/packer/runson/runson.pkr.hcl"})]}),"\n",(0,a.jsx)(n.p,{children:"To do so manually:"}),"\n",(0,a.jsx)(n.h3,{id:"create-a-temporary-ec2-instance-on-the-standard-ami",children:"Create a temporary EC2 instance on the standard AMI"}),"\n",(0,a.jsx)(n.p,{children:"In the AWS web console, initiate creation of a temporary instance that we use just to build the custom AMI."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:"Any ARM64 instance type will do, t4g.nano for example."}),"\n",(0,a.jsxs)(n.li,{children:['To select the base AMI for the instance, click on "Browse more AMIs", then the "Community AMIs" tab,\nthen search for ',(0,a.jsx)(n.code,{children:"runs-on-v2.2-ubuntu22-full-arm64"})," and pick the latest standard AMI, as described in\nthe RunsOn ",(0,a.jsx)(n.a,{href:"https://github.com/runs-on/runner-images-for-aws",children:"images repo"}),"."]}),"\n",(0,a.jsxs)(n.li,{children:["Select ",(0,a.jsx)(n.code,{children:"pantsbuild.org.bastion"})," as the instance's SSH keypair."]}),"\n",(0,a.jsx)(n.li,{children:"Allow the wizard to create a security group."}),"\n",(0,a.jsx)(n.li,{children:"The default storage settings are fine."}),"\n",(0,a.jsx)(n.li,{children:"Open the Advanced section, scroll all the way down, and set the instance's User Data to:"}),"\n"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"#!/bin/bash\nsystemctl start ssh\n"})}),"\n",(0,a.jsx)(n.p,{children:"to ensure that its SSH daemon runs on startup."}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsx)(n.li,{children:'Click "Launch instance"'}),"\n"]}),"\n",(0,a.jsx)(n.h3,{id:"ssh-into-the-temporary-ec2-instance",children:"SSH into the temporary EC2 instance"}),"\n",(0,a.jsxs)(n.p,{children:['Once the instance is running, navigate to its details page and click on "Connect" to get SSH instructions.\nYou will need the ',(0,a.jsx)(n.code,{children:"pantsbuild.org.bastion"})," private key, which is in our 1Password account."]}),"\n",(0,a.jsx)(n.h3,{id:"install-pythons-on-the-instance",children:"Install Pythons on the instance"}),"\n",(0,a.jsx)(n.p,{children:"Once you are in a bash prompt on the instance, run the following:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"sudo apt-get install -y software-properties-common\nsudo add-apt-repository -y ppa:deadsnakes/ppa\nsudo apt-get update\nsudo apt-get install -y \\\n  python3.7 python3.7-dev python3.7-venv \\\n  python3.8 python3.8-dev python3.8-venv \\\n  python3.9 python3.9-dev python3.9-venv \\\n  python3.10 python3.10-dev python3.10-venv \\\n  python3.11 python3.11-dev python3.11-venv \\\n  python3.12 python3.12-dev python3.12-venv \\\n  python3.13 python3.13-dev python3.13-venv\n"})}),"\n",(0,a.jsx)(n.p,{children:"to install the necessary Pythons."}),"\n",(0,a.jsx)(n.h3,{id:"create-an-ami-from-the-instance",children:"Create an AMI from the instance"}),"\n",(0,a.jsxs)(n.p,{children:['From the instance\'s actions menu in the web console select "Images" and then "Create image".\nThe image name doesn\'t strictly matter, but ',(0,a.jsx)(n.code,{children:"ubuntu22-full-arm64-python3.7-3.13-{{timestamp}}"}),"\nis a good name for consistency with the Packer-generated AMIs, where ",(0,a.jsx)(n.code,{children:"{{timestamp}}"})," is a\nrecent POSIX time, e.g., as returned by ",(0,a.jsx)(n.code,{children:"date +%s"}),"."]}),"\n",(0,a.jsx)(n.h3,{id:"terminate-the-temporary-instance",children:"Terminate the temporary instance"}),"\n",(0,a.jsxs)(n.p,{children:['Once the AMI status shows as "Available", terminate the temporary instance and delete its security group\n(whose name will match ',(0,a.jsx)(n.code,{children:"launch-wizard-*"}),")."]}),"\n",(0,a.jsx)(n.h3,{id:"update-the-runson-config",children:"Update the RunsOn config"}),"\n",(0,a.jsxs)(n.p,{children:["Edit ",(0,a.jsx)(n.code,{children:".github/runs-on.yml"})," and update the ",(0,a.jsx)(n.code,{children:"ami"})," field. Note that the logical image name in this file\nhappens to be a prefix of the AMI name, but doesn't strictly have to be. This is the name that we\ntarget in the ",(0,a.jsx)(n.code,{children:"runs-on"})," stanza of a CI job in ",(0,a.jsx)(n.code,{children:"generate_github_workflows.py"}),"."]}),"\n",(0,a.jsx)(n.p,{children:"Note that the new AMI will only be used in PR CI jobs after the config change is merged into main,\nso the CI job for the update itself will still use the old AMI."}),"\n",(0,a.jsx)(n.h3,{id:"deregister-the-old-ami",children:"Deregister the old AMI"}),"\n",(0,a.jsxs)(n.p,{children:["After the config update has been merged into ",(0,a.jsx)(n.code,{children:"main"})," and any release branches it needs to be in,\nwe can deregister the old AMI via the AWS web console, to avoid confusion."]})]})}function d(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(l,{...e})}):l(e)}},848193(e,n,t){t.d(n,{R:()=>o,x:()=>r});var s=t(830758);let a={},i=s.createContext(a);function o(e){let n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),s.createElement(i.Provider,{value:n},e.children)}},414183(e){e.exports=JSON.parse('{"id":"docs/contributions/releases/github-actions-linux-aarch64-runners","title":"GitHub Actions aarch64 runners","description":"---","source":"@site/versioned_docs/version-2.26/docs/contributions/releases/github-actions-linux-aarch64-runners.mdx","sourceDirName":"docs/contributions/releases","slug":"/docs/contributions/releases/github-actions-linux-aarch64-runners","permalink":"/2.26/docs/contributions/releases/github-actions-linux-aarch64-runners","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/contributions/releases/github-actions-linux-aarch64-runners.mdx","tags":[],"version":"2.26","sidebarPosition":3,"frontMatter":{"title":"GitHub Actions aarch64 runners","sidebar_position":3},"sidebar":"docsSidebar","previous":{"title":"GitHub Actions macOS runners","permalink":"/2.26/docs/contributions/releases/github-actions-macos-arm64-runners"},"next":{"title":"Testing plugins","permalink":"/2.26/docs/tutorials/testing-plugins"}}')}}]);