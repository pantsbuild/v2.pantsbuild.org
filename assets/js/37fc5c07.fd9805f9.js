"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["915784"],{739262(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var s=t(492514),i=t(886070),r=t(848193);let o={title:"Union rules (advanced)",sidebar_position:7},l,a={},c=[{value:"How to create a new Union",id:"how-to-create-a-new-union",level:2}];function u(e){let n={a:"a",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Polymorphism for the engine."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:"Union rules solve the same problem that polymorphism solves in general: how to write generic code that operates on types not known about at the time of writing."}),"\n",(0,i.jsxs)(n.p,{children:["For example, Pants has many generic goals like ",(0,i.jsx)(n.code,{children:"lint"})," and ",(0,i.jsx)(n.code,{children:"test"}),". Those ",(0,i.jsx)(n.code,{children:"@goal_rule"})," definitions cannot know about every concrete linter or test implementation ahead-of-time."]}),"\n",(0,i.jsxs)(n.p,{children:["Unions allow a specific linter to be registered with ",(0,i.jsx)(n.code,{children:"UnionRule(LintTargetsRequest, ShellcheckRequest)"}),", and then for ",(0,i.jsx)(n.code,{children:"lint.py"})," to access its type:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="pants/core/goals/lint.py"',children:"from pants.engine.rules import Get, MultiGet, goal_rule\nfrom pants.engine.target import Targets\nfrom pants.engine.unions import UnionMembership\n\n..\n\n@goal_rule\nasync def lint(..., targets: Targets, union_membership: UnionMembership) -> Lint:\n    lint_request_types = union_membership[LintTargetsRequest]\n    concrete_requests = [\n        request_type(\n            request_type.field_set_type.create(target)\n            for target in targets\n            if request_type.field_set_type.is_valid(target)\n        )\n        for request_type in lint_request_types\n    ]\n    results = await MultiGet(\n        Get(LintResults, LintTargetsRequest, concrete_request)\n        for concrete_request in concrete_requests\n    )\n"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/bash/shellcheck.py"',children:"from pants.core.goals.lint import LintTargetsRequest\n\n\nclass ShellcheckRequest(LintTargetsRequest):\n    ...\n\n\n...\n\n\ndef rules():\n    return [*ShellcheckRequest.rules()]\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This example will find all registered linter implementations by looking up ",(0,i.jsx)(n.code,{children:"union_membership[LintTargetsRequest]"}),", which returns a tuple of all ",(0,i.jsx)(n.code,{children:"LintTargetsRequest "})," types that were registered with a ",(0,i.jsx)(n.code,{children:"UnionRule"}),", such as ",(0,i.jsx)(n.code,{children:"ShellcheckRequest"})," and ",(0,i.jsx)(n.code,{children:"Flake8Request"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"how-to-create-a-new-union",children:"How to create a new Union"}),"\n",(0,i.jsxs)(n.p,{children:['To set up a new union, create a class for the union "base". Typically, this should be an ',(0,i.jsx)(n.a,{href:"https://docs.python.org/3/library/abc.html",children:"abstract class"})," that is subclassed by the union members, but it does not need to be. Mark the class with ",(0,i.jsx)(n.code,{children:"@union"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from abc import ABC, abstractmethod\n\nfrom pants.engine.unions import union\n\n@union\nclass Vehicle(ABC):\n   @abstractmethod\n   def num_wheels(self) -> int:\n        pass\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then, register every implementation of your union with ",(0,i.jsx)(n.code,{children:"UnionRule"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"class Truck(Vehicle):\n    def num_wheels(self) -> int:\n        return 4\n\ndef rules():\n    return [UnionRule(Vehicle, Truck)]\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now, your rules can request ",(0,i.jsx)(n.code,{children:"UnionMembership"})," as a parameter in the ",(0,i.jsx)(n.code,{children:"@rule"}),", and then look up ",(0,i.jsx)(n.code,{children:"union_membership[Vehicle]"})," to get a tuple of all relevant types that are registered via ",(0,i.jsx)(n.code,{children:"UnionRule"}),"."]})]})}function d(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},848193(e,n,t){t.d(n,{R:()=>o,x:()=>l});var s=t(830758);let i={},r=s.createContext(i);function o(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},492514(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-rules-api/union-rules-advanced","title":"Union rules (advanced)","description":"Polymorphism for the engine.","source":"@site/versioned_docs/version-2.25/docs/writing-plugins/the-rules-api/union-rules-advanced.mdx","sourceDirName":"docs/writing-plugins/the-rules-api","slug":"/docs/writing-plugins/the-rules-api/union-rules-advanced","permalink":"/2.25/docs/writing-plugins/the-rules-api/union-rules-advanced","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-rules-api/union-rules-advanced.mdx","tags":[],"version":"2.25","sidebarPosition":7,"frontMatter":{"title":"Union rules (advanced)","sidebar_position":7},"sidebar":"docsSidebar","previous":{"title":"Rules and the Target API","permalink":"/2.25/docs/writing-plugins/the-rules-api/rules-and-the-target-api"},"next":{"title":"Logging and dynamic output","permalink":"/2.25/docs/writing-plugins/the-rules-api/logging-and-dynamic-output"}}')}}]);