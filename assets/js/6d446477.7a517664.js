"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["328194"],{936948(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>r,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>l});var t=s(625380),i=s(886070),o=s(848193);let a={title:"Using Pants in CI",sidebar_position:6},r,c={},l=[{value:"<code>pants.ci.toml</code>",id:"pantscitoml",level:2},{value:"Directories to cache",id:"directories-to-cache",level:2},{value:"Recommended commands",id:"recommended-commands",level:2},{value:"Approach #1: only run over changes files",id:"approach-1-only-run-over-changes-files",level:3},{value:"Approach #2: run over everything",id:"approach-2-run-over-everything",level:3}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Suggestions for how to use Pants to speed up your CI (continuous integration)."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.mdxAdmonitionTitle,{children:["Example ",(0,i.jsx)(n.code,{children:".travis.yml"})]}),(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/example-python/blob/master/.travis.yml",children:"https://github.com/pantsbuild/example-python/blob/master/.travis.yml"})," for an example of how to configure Pants with Travis CI."]})]}),"\n",(0,i.jsx)(n.h2,{id:"pantscitoml",children:(0,i.jsx)(n.code,{children:"pants.ci.toml"})}),"\n",(0,i.jsxs)(n.p,{children:["We recommend creating a ",(0,i.jsx)(n.code,{children:"pants.ci.toml"})," config file with options specific to your CI setup."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-toml",metastring:'title="pants.ci.toml"',children:"[GLOBAL]\n# The Pants daemon is not very useful in CI, given that it\n# will be restarted every run.\npantsd = false\n\ndynamic_ui = false\n# Ensure colors are used (if your CI provider supports it).\ncolors = true\n\n# Limit the maximum number of concurrent processes. Change this\n# to a number that makes sense for your CI setup, based on\n# the number of cores/threads.\nprocess_execution_local_parallelism = 4\n\n[python-setup]\n# Limit the maximum number of concurrent jobs used to resolve third\n# party dependencies. The max level of parallelism will be\n# `process_execution_local_parallelism x resolver_jobs`, but\n# often you will have one resolve process at a time.\nresolver_jobs = 2\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then, in your CI script or config, set the environment variable ",(0,i.jsx)(n.code,{children:"PANTS_CONFIG_FILES"})," to use this new config file, in addition to the default ",(0,i.jsx)(n.code,{children:"pants.toml"}),". For example:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="ci.sh"',children:"export PANTS_CONFIG_FILES=pants.ci.toml\n\n# Then, your normal CI setup\n./pants test ::\n...\n"})}),"\n",(0,i.jsx)(n.h2,{id:"directories-to-cache",children:"Directories to cache"}),"\n",(0,i.jsx)(n.p,{children:"In your CI's config file, we recommend caching these directories:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$HOME/.cache/pants/setup"}),": the initial bootstrapping of Pants."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$HOME/.cache/pants/named_caches"}),": caches of tools like pip and PEX."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"$HOME/.cache/pants/lmdb_store"}),": cached content for prior Pants runs."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"/2.0/docs/using-pants/troubleshooting-common-issues/#how-to-change-your-cache-directory",children:"Troubleshooting"})," for how to change these cache locations."]}),"\n",(0,i.jsxs)(n.admonition,{title:"Nuking the cache when too big",type:"note",children:[(0,i.jsx)(n.p,{children:"In CI, the cache must be uploaded and downloaded every run. This takes time, so there is a tradeoff where too large of a cache will slow down your CI."}),(0,i.jsx)(n.p,{children:"You can use this script to nuke the cache when it gets too big:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'function nuke_if_too_big() {\n  path=$1\n  limit_mb=$2\n  size_mb=$(du -m -d0 ${path} | cut -f 1)\n  if (( ${size_mb} > ${limit_mb} )); then\n    echo "${path} is too large (${size_mb}mb), nuking it."\n    rm -rf ${path}\n  fi\n}\n\nnuke_if_too_big ~/.cache/pants/lmdb_store 2048\nnuke_if_too_big ~/.cache/pants/setup 768\nnuke_if_too_big ~/.cache/pants/named_caches 1024\n'})})]}),"\n",(0,i.jsx)(n.h2,{id:"recommended-commands",children:"Recommended commands"}),"\n",(0,i.jsx)(n.h3,{id:"approach-1-only-run-over-changes-files",children:"Approach #1: only run over changes files"}),"\n",(0,i.jsx)(n.p,{children:"Because Pants understands the dependencies of your code, you can use Pants to speed up your CI by only running tests and linters over files that actually made changes."}),"\n",(0,i.jsx)(n.p,{children:"We recommend running these commands in CI:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="ci.sh"',children:"$ ./pants --version  # This will bootstrap Pants\n$ ./pants --changed-since=origin/main lint\n$ ./pants \\\n  --changed-since=origin/main \\\n  --changed-dependees=transitive \\\n  typecheck test\n"})}),"\n",(0,i.jsx)(n.p,{children:"Because most linters do not care about a target's dependencies, we lint all changed targets, but not any dependees of those changed targets."}),"\n",(0,i.jsxs)(n.p,{children:["Meanwhile, tests should be rerun when any changes are made to the tests ",(0,i.jsx)(n.em,{children:"or"})," to dependencies of those tests, so we use the option ",(0,i.jsx)(n.code,{children:"--changed-dependees=transitive"}),". ",(0,i.jsx)(n.code,{children:"typecheck"})," should also run on any transitive changes."]}),"\n",(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"/2.0/docs/using-pants/advanced-target-selection",children:"Advanced target selection"})," for more information on ",(0,i.jsx)(n.code,{children:"--changed-since"})," and alternative techniques to select targets to run in CI."]}),"\n",(0,i.jsxs)(n.admonition,{title:"This will not handle all cases, like hooking up a new linter",type:"caution",children:[(0,i.jsx)(n.p,{children:"For example, if you add a new plugin to Flake8, Pants will still only run over changed files, meaning you may miss some new lint issues."}),(0,i.jsxs)(n.p,{children:["For absolute correctness, you may want to use Approach #2. Alternatively, add conditional logic to your CI, e.g. that any changes to ",(0,i.jsx)(n.code,{children:"pants.toml"})," trigger using Approach #2."]})]}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.mdxAdmonitionTitle,{children:["GitHub Actions: use ",(0,i.jsx)(n.code,{children:"Checkout"})]}),(0,i.jsxs)(n.p,{children:["To use ",(0,i.jsx)(n.code,{children:"--changed-since"}),", you may want to use the ",(0,i.jsx)(n.a,{href:"https://github.com/actions/checkout",children:"Checkout action"}),"."]}),(0,i.jsxs)(n.p,{children:["By default, Checkout will only fetch the latest commit, so you should set ",(0,i.jsx)(n.code,{children:"fetch-depth: 0"}),"."]})]}),"\n",(0,i.jsx)(n.h3,{id:"approach-2-run-over-everything",children:"Approach #2: run over everything"}),"\n",(0,i.jsx)(n.p,{children:"Alternatively, you can simply run over all your code. Pants's caching means that you will not need to rerun on changed files."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",metastring:'title="ci.sh"',children:"$ ./pants --version  # This will bootstrap Pants\n$ ./pants lint typecheck test ::\n"})}),"\n",(0,i.jsx)(n.p,{children:'However, when the cache gets too big, it should be nuked (see "Directories to cache"), so your CI may end up doing more work than Approach #1.'})]})}function h(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},848193(e,n,s){s.d(n,{R:()=>a,x:()=>r});var t=s(830758);let i={},o=t.createContext(i);function a(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),t.createElement(o.Provider,{value:n},e.children)}},625380(e){e.exports=JSON.parse('{"id":"docs/using-pants/using-pants-in-ci","title":"Using Pants in CI","description":"Suggestions for how to use Pants to speed up your CI (continuous integration).","source":"@site/versioned_docs/version-2.0/docs/using-pants/using-pants-in-ci.mdx","sourceDirName":"docs/using-pants","slug":"/docs/using-pants/using-pants-in-ci","permalink":"/2.0/docs/using-pants/using-pants-in-ci","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/using-pants/using-pants-in-ci.mdx","tags":[],"version":"2.0","sidebarPosition":6,"frontMatter":{"title":"Using Pants in CI","sidebar_position":6},"sidebar":"docsSidebar","previous":{"title":"Resources and archives","permalink":"/2.0/docs/using-pants/resources-and-archives"},"next":{"title":"Adopting Pants in existing repos","permalink":"/2.0/docs/using-pants/adopting-pants-in-existing-repos"}}')}}]);