"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["840155"],{60674(e,t,n){n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>s,toc:()=>h});var s=n(334043),r=n(886070),i=n(848193),l=n(685008),o=n(637180);let a={title:"test",sidebar_position:5},c,d={},h=[{value:"Examples",id:"examples",level:2},{value:"Pytest version and plugins",id:"pytest-version-and-plugins",level:2},{value:"Controlling output",id:"controlling-output",level:2},{value:"Passing arguments to Pytest",id:"passing-arguments-to-pytest",level:2},{value:"Setting environment variables",id:"setting-environment-variables",level:2},{value:"Ignore the cache with <code>--force</code>",id:"ignore-the-cache-with---force",level:2},{value:"Running tests interactively",id:"running-tests-interactively",level:2},{value:"Using timeouts",id:"using-timeouts",level:2},{value:"<code>conftest.py</code>",id:"conftestpy",level:2},{value:"Depending on test utilities, resources, and built packages",id:"depending-on-test-utilities-resources-and-built-packages",level:2},{value:"Depending on test utilities",id:"depending-on-test-utilities",level:3},{value:"Depending on resources",id:"depending-on-resources",level:3},{value:"Depending on packages",id:"depending-on-packages",level:3},{value:"Coverage",id:"coverage",level:2},{value:"Saving JUnit XML results",id:"saving-junit-xml-results",level:2}];function p(e){let t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"Run tests with Pytest."}),"\n",(0,r.jsx)(t.hr,{}),"\n",(0,r.jsxs)(t.p,{children:["Pants uses the popular ",(0,r.jsx)(t.a,{href:"https://docs.pytest.org/en/latest/",children:"Pytest"})," test runner to run Python tests. You may write your tests in Pytest-style, unittest-style, or mix and match both."]}),"\n",(0,r.jsxs)(t.admonition,{title:"Benefit of Pants: runs each file in parallel",type:"tip",children:[(0,r.jsx)(t.p,{children:"Each file gets run as a separate process, which gives you fine-grained caching and better parallelism. Given enough cores, Pants will be able to run all your tests at the same time."}),(0,r.jsxs)(t.p,{children:["This also gives you fine-grained caching. If you run ",(0,r.jsx)(t.code,{children:"./pants test ::"}),", and then you only change one file, then only tests that depended on that changed file will need to rerun."]})]}),"\n",(0,r.jsx)(t.h2,{id:"examples",children:"Examples"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:" # Run all tests in the repository.\n./pants test ::\n\n# Run all the tests in this target.\n./pants test helloworld/util:test\n\n# Run just the tests in this file.\n./pants test helloworld/util/lang_test.py\n\n # Run just one test.\n./pants test helloworld/util/lang_test.py -- -k test_language_translator\n"})}),"\n",(0,r.jsx)(t.h2,{id:"pytest-version-and-plugins",children:"Pytest version and plugins"}),"\n",(0,r.jsxs)(t.p,{children:["To change the Pytest version, set the ",(0,r.jsx)(t.code,{children:"version"})," option in the ",(0,r.jsx)(t.code,{children:"[pytest]"})," scope."]}),"\n",(0,r.jsxs)(t.p,{children:["To install any ",(0,r.jsx)(t.a,{href:"https://docs.pytest.org/en/latest/plugins.html",children:"plugins"}),", add the pip requirement string to ",(0,r.jsx)(t.code,{children:"pytest_plugins"})," in the ",(0,r.jsx)(t.code,{children:"[pytest]"})," scope, like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[pytest]\nversion = "pytest>=5.4"\npytest_plugins.add = [\n  "pytest-django>=3.9.0,<4",\n  "pytest-rerunfailures==9.0",\n]\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Alternatively, if you only want to install the plugin for certain tests, you can add the plugin to the ",(0,r.jsx)(t.code,{children:"dependencies"})," field of your ",(0,r.jsx)(t.code,{children:"python_tests"}),". See ",(0,r.jsx)(t.a,{href:"/2.0/docs/python/overview/third-party-dependencies",children:"Third-party dependencies"})," for how to install Python dependencies. For example:"]}),"\n",(0,r.jsxs)(l.A,{groupId:"code-examples",children:[(0,r.jsx)(o.A,{value:"requirements.txt",label:"requirements.txt",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-text",metastring:'tab={"label":"requirements.txt"}',children:"pytest-django==3.10.0\n"})})}),(0,r.jsx)(o.A,{value:"helloworld/util/build",label:"helloworld/util/BUILD",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"helloworld/util/BUILD"}',children:'python_tests(\n   name="tests",\n   # Normally, Pants infers dependencies based on imports.\n   # Here, we don\'t actually import our plugin, though, so\n   # we need to explicitly list it.\n   dependencies=["//:pytest-django"],\n)\n'})})})]}),"\n",(0,r.jsx)(t.admonition,{title:"Testing Python 2 code? Use Pytest 4.x",type:"caution",children:(0,r.jsxs)(t.p,{children:["By default, Pants uses Pytest 6.x, which only supports Python 3 code. If you need to run Python 2 tests, set the option ",(0,r.jsx)(t.code,{children:"version"})," in the scope ",(0,r.jsx)(t.code,{children:"pytest"})," to ",(0,r.jsx)(t.code,{children:"pytest>=4.6,<5"}),"."]})}),"\n",(0,r.jsxs)(t.admonition,{type:"caution",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["Avoid the ",(0,r.jsx)(t.code,{children:"pytest-xdist"})," plugin"]}),(0,r.jsxs)(t.p,{children:["We do not recommend using this plugin because its concurrency conflicts with Pants' own parallelism. Using Pants will bring you similar benefits to ",(0,r.jsx)(t.code,{children:"pytest-xdist"})," already: Pants will run each test target in parallel."]})]}),"\n",(0,r.jsx)(t.admonition,{title:"Tip: plugins for better Pytest output",type:"note",children:(0,r.jsxs)(t.p,{children:["Add ",(0,r.jsx)(t.a,{href:"https://github.com/hjwp/pytest-icdiff#usage",children:(0,r.jsx)(t.code,{children:"pytest-icdiff"})})," and ",(0,r.jsx)(t.a,{href:"https://github.com/pygments/pygments",children:(0,r.jsx)(t.code,{children:"pygments"})})," to the option ",(0,r.jsx)(t.code,{children:"pytest_plugins"})," for better error messages and diffs from Pytest."]})}),"\n",(0,r.jsx)(t.h2,{id:"controlling-output",children:"Controlling output"}),"\n",(0,r.jsxs)(t.p,{children:["By default, Pants only shows output for failed tests. You can change this by setting ",(0,r.jsx)(t.code,{children:"--test-output"})," to one of ",(0,r.jsx)(t.code,{children:"all"}),", ",(0,r.jsx)(t.code,{children:"failed"}),", or ",(0,r.jsx)(t.code,{children:"never"}),", e.g. ",(0,r.jsx)(t.code,{children:"./pants test --output=all ::"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["You can permanently set the output format in your ",(0,r.jsx)(t.code,{children:"pants.toml"})," like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[test]\noutput = "all"\n'})}),"\n",(0,r.jsxs)(t.admonition,{title:"Tip: Use Pytest options to make output more or less verbose",type:"note",children:[(0,r.jsxs)(t.p,{children:["See ",(0,r.jsx)(t.a,{href:"#passing-arguments-to-pytest",children:'"Passing arguments to Pytest"'}),"."]}),(0,r.jsx)(t.p,{children:"For example:"}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"$ ./pants test project/app_test.py -- -q\n"})}),(0,r.jsxs)(t.p,{children:["You may want to permanently set the Pytest option ",(0,r.jsx)(t.code,{children:"--no-header"})," to avoid printing the Pytest version for each test run:"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:'[pytest]\nargs = ["--no-header"]\n'})})]}),"\n",(0,r.jsx)(t.h2,{id:"passing-arguments-to-pytest",children:"Passing arguments to Pytest"}),"\n",(0,r.jsxs)(t.p,{children:["To pass arguments to Pytest, put them at the end after ",(0,r.jsx)(t.code,{children:"--"}),", like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"$ ./pants test project/app_test.py -- -k test_function1 -vv -s\n"})}),"\n",(0,r.jsxs)(t.p,{children:["You can also use the ",(0,r.jsx)(t.code,{children:"args"})," option in the ",(0,r.jsx)(t.code,{children:"[pytest]"})," scope, like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[pytest]\nargs = ["-vv"]\n'})}),"\n",(0,r.jsxs)(t.admonition,{title:"Tip: some useful Pytest arguments",type:"note",children:[(0,r.jsxs)(t.p,{children:["See ",(0,r.jsx)(t.a,{href:"https://docs.pytest.org/en/latest/usage.html",children:"https://docs.pytest.org/en/latest/usage.html"})," for more information."]}),(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"-k expression"}),": only run tests matching the expression."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"-v"}),": verbose mode."]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"-s"}),": always print the stdout and stderr of your code, even if a test passes."]}),"\n"]})]}),"\n",(0,r.jsxs)(t.admonition,{type:"caution",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["How to use Pytest's ",(0,r.jsx)(t.code,{children:"--pdb"})," option"]}),(0,r.jsxs)(t.p,{children:["You must run ",(0,r.jsx)(t.code,{children:"./pants test --debug"}),' for this to work properly. See the section "Running tests interactively" for more information.']})]}),"\n",(0,r.jsx)(t.h2,{id:"setting-environment-variables",children:"Setting environment variables"}),"\n",(0,r.jsxs)(t.p,{children:["Test runs are ",(0,r.jsx)(t.em,{children:"hermetic"}),", meaning that they are stripped of the parent ",(0,r.jsx)(t.code,{children:"./pants"})," process's environment variables. This is important for reproducibility, and it also increases cache hits."]}),"\n",(0,r.jsxs)(t.p,{children:["To add any arbitrary environment variable back to the process, use the option ",(0,r.jsx)(t.code,{children:"extra_env_vars"})," in the ",(0,r.jsx)(t.code,{children:"[test]"}),' options scope. You can hardcode a value for the option, or leave off a value to "allowlist" it and read from the parent ',(0,r.jsx)(t.code,{children:"./pants"})," process's environment."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[test]\nextra_env_vars = ["VAR1", "VAR2=hardcoded_value"]\n'})}),"\n",(0,r.jsxs)(t.h2,{id:"ignore-the-cache-with---force",children:["Ignore the cache with ",(0,r.jsx)(t.code,{children:"--force"})]}),"\n",(0,r.jsxs)(t.p,{children:["To force your tests to run again, rather than reading from the cache, run ",(0,r.jsx)(t.code,{children:"./pants test --force path/to/test.py"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"running-tests-interactively",children:"Running tests interactively"}),"\n",(0,r.jsx)(t.p,{children:"Because Pants runs multiple test targets in parallel, you will not see your test results appear on the screen until the test has completely finished. This means that you cannot use debuggers normally; the breakpoint will never show up on your screen and the test will hang indefinitely (or timeout, if timeouts are enabled)."}),"\n",(0,r.jsxs)(t.p,{children:["Instead, if you want to run a test interactively\u2014such as to use a debugger like ",(0,r.jsx)(t.code,{children:"pdb"}),"\u2014run your tests with ",(0,r.jsx)(t.code,{children:"./pants test --debug"}),". For example:"]}),"\n",(0,r.jsxs)(l.A,{groupId:"code-examples",children:[(0,r.jsx)(o.A,{value:"test_debug_example.py",label:"test_debug_example.py",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"test_debug_example.py"}',children:"def test_debug():\n    import pdb; pdb.set_trace()\n    assert 1 + 1 == 2\n"})})}),(0,r.jsx)(o.A,{value:"shell",label:"Shell",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-text",metastring:'tab={"label":"Shell"}',children:"$ <<pantscmd>> test --debug test_debug_example.py\n\n===================================================== test session starts =====================================================\nplatform darwin -- Python 3.6.10, pytest-5.3.5, py-1.8.1, pluggy-0.13.1\nrootdir: /private/var/folders/sx/pdpbqz4x5cscn9hhfpbsbqvm0000gn/T/.tmpn2li0z\nplugins: cov-2.8.1, timeout-1.3.4\ncollected 6 items\n\ntest_debug_example.py\n>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>> PDB set_trace (IO-capturing turned off) >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>\n> /private/var/folders/sx/pdpbqz4x5cscn9hhfpbsbqvm0000gn/T/.tmpn2li0z/test_debug_example.py(11)test_debug()\n-> assert 1 + 1 == 2\n(Pdb) 1 + 1\n2\n"})})})]}),"\n",(0,r.jsxs)(t.p,{children:["If you use multiple files with ",(0,r.jsx)(t.code,{children:"test --debug"}),", they will run sequentially rather than in parallel."]}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["Tip: using ",(0,r.jsx)(t.code,{children:"ipdb"})," in tests"]}),(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"https://github.com/gotcha/ipdb",children:(0,r.jsx)(t.code,{children:"ipdb"})})," integrates IPython with the normal ",(0,r.jsx)(t.code,{children:"pdb"})," debugger for enhanced features like autocomplete and improved syntax highlighting. ",(0,r.jsx)(t.code,{children:"ipdb"})," is very helpful when debugging tests."]}),(0,r.jsxs)(t.p,{children:["To be able to access ",(0,r.jsx)(t.code,{children:"ipdb"})," when running tests, add this to your ",(0,r.jsx)(t.code,{children:"pants.toml"}),":"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:'[pytest]\npytest_plugins.add = ["ipdb"]\n'})}),(0,r.jsxs)(t.p,{children:["Then, you can use ",(0,r.jsx)(t.code,{children:"import ipdb; ipdb.set_trace()"})," in your tests."]})]}),"\n",(0,r.jsxs)(t.admonition,{title:"Tip: using the IntelliJ/PyCharm remote debugger in tests",type:"note",children:[(0,r.jsx)(t.p,{children:"First, add the following target in some BUILD file (e.g., the one containing your other 3rd-party dependencies):"}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:'python_requirement_library(\n  name = "pydevd-pycharm",\n  requirements=["pydevd-pycharm==203.5419.8"],  # Or whatever version you choose.\n)\n'})}),(0,r.jsx)(t.p,{children:"You can check this into your repo, for convenience."}),(0,r.jsx)(t.p,{children:"Now, use the remote debugger as usual:"}),(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:"Start a Python remote debugging session in PyCharm, say on port 5000."}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsx)(t.p,{children:"Add the following code at the point where you want execution to pause and connect to the debugger:"}),"\n"]}),"\n"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"import pydevd_pycharm\npydevd_pycharm.settrace('localhost', port=5000, stdoutToServer=True, stderrToServer=True)\n"})}),(0,r.jsxs)(t.p,{children:["Run your test with ",(0,r.jsx)(t.code,{children:"./pants test --debug"})," as usual."]}),(0,r.jsxs)(t.p,{children:["Note: The first time you do so you may see some extra dependency resolution work, as ",(0,r.jsx)(t.code,{children:"pydevd-pycharm"})," has now been added to the test's dependencies, via inference. If you have dependency inference turned off in your repo, you will have to manually add a temporary explicit dependency in your test target on the pydevd-pycharm target."]})]}),"\n",(0,r.jsx)(t.h2,{id:"using-timeouts",children:"Using timeouts"}),"\n",(0,r.jsx)(t.p,{children:"Pants can cancel tests which take too long. This is useful to prevent tests from hanging indefinitely."}),"\n",(0,r.jsxs)(t.p,{children:["To add a timeout for a particular ",(0,r.jsx)(t.code,{children:"python_tests"})," target, set the ",(0,r.jsx)(t.code,{children:"timeout"})," field to an integer value of seconds, like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="BUILD"',children:'python_tests(\n    name="tests",\n    timeout=120, # seconds.\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["This timeout will apply to each file belonging to the ",(0,r.jsx)(t.code,{children:"python_tests"})," target, meaning that ",(0,r.jsx)(t.code,{children:"test_f1.py"})," will have a timeout of 120 seconds and ",(0,r.jsx)(t.code,{children:"test_f2.py"})," will have a timeout of 120 seconds. If you want finer-grained timeouts, create a dedicated ",(0,r.jsx)(t.code,{children:"python_tests"})," target for each file:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="BUILD"',children:'python_tests(\n    name="test_f1",\n    sources=["test_f1.py"],\n    timeout=20,\n)\n\npython_tests(\n    name="test_f2",\n    sources=["test_f2.py"],\n    timeout=35,\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["You can also set a default value and a maximum value in ",(0,r.jsx)(t.code,{children:"pants.toml"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:"[pytest]\ntimeout_default = 60\ntimeout_maximum = 600\n"})}),"\n",(0,r.jsxs)(t.p,{children:["If a target sets its ",(0,r.jsx)(t.code,{children:"timeout"})," higher than ",(0,r.jsx)(t.code,{children:"--pytest-timeout-maximum"}),", Pants will use the value in ",(0,r.jsx)(t.code,{children:"--pytest-timeout-maximum"}),"."]}),"\n",(0,r.jsxs)(t.admonition,{title:"Tip: temporarily ignoring timeouts",type:"note",children:[(0,r.jsxs)(t.p,{children:["When debugging locally, such as with ",(0,r.jsx)(t.code,{children:"pdb"}),", you might want to temporarily disable timeouts. To do this, set ",(0,r.jsx)(t.code,{children:"--no-pytest-timeouts"}),":"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"$ ./pants test project/app_test.py --no-pytest-timeouts\n"})})]}),"\n",(0,r.jsx)(t.h2,{id:"conftestpy",children:(0,r.jsx)(t.code,{children:"conftest.py"})}),"\n",(0,r.jsxs)(t.p,{children:["Pytest uses ",(0,r.jsxs)(t.a,{href:"https://docs.pytest.org/en/stable/fixture.html#conftest-py-sharing-fixture-functions",children:[(0,r.jsx)(t.code,{children:"conftest.py"})," files"]})," to share fixtures and config across multiple distinct test files."]}),"\n",(0,r.jsxs)(t.p,{children:["The default ",(0,r.jsx)(t.code,{children:"sources"})," value for a ",(0,r.jsx)(t.code,{children:"python_tests"})," target includes ",(0,r.jsx)(t.code,{children:"conftest.py"}),". So, if you declare a BUILD file like this, the ",(0,r.jsx)(t.code,{children:"conftest.py"})," will be included:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'python_tests(\n    name="tests",\n    timeout=120,\n    # We leave off `sources` to use the default value.\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Otherwise, you can explicitly include the ",(0,r.jsx)(t.code,{children:"conftest.py"})," in the ",(0,r.jsx)(t.code,{children:"sources"})," field of a ",(0,r.jsx)(t.code,{children:"python_tests()"})," target."]}),"\n",(0,r.jsxs)(t.p,{children:["Pants will also infer dependencies on any ",(0,r.jsx)(t.code,{children:"confest.py"})," files in the current directory ",(0,r.jsx)(t.em,{children:"and"})," any ancestor directories, which mirrors how Pytest behaves. This requires that each ",(0,r.jsx)(t.code,{children:"conftest.py"})," has a target referring to it. You can verify this is working correctly by running ",(0,r.jsx)(t.code,{children:"./pants dependencies path/to/my_test.py"})," and confirming that each ",(0,r.jsx)(t.code,{children:"conftest.py"})," file shows up. (You can turn off this feature by setting ",(0,r.jsx)(t.code,{children:"conftests = false"})," in the ",(0,r.jsx)(t.code,{children:"[python-infer]"})," scope.)"]}),"\n",(0,r.jsx)(t.h2,{id:"depending-on-test-utilities-resources-and-built-packages",children:"Depending on test utilities, resources, and built packages"}),"\n",(0,r.jsx)(t.h3,{id:"depending-on-test-utilities",children:"Depending on test utilities"}),"\n",(0,r.jsxs)(t.p,{children:["Use the target type ",(0,r.jsx)(t.code,{children:"python_library"})," for test utilities, rather than ",(0,r.jsx)(t.code,{children:"python_tests"}),"."]}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsxs)(l.A,{groupId:"code-examples",children:[(0,r.jsx)(o.A,{value:"helloworld/build",label:"helloworld/BUILD",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"helloworld/BUILD"}',children:'python_library(\n    name="testutils",\n    sources=["testutils.py"]\n)\n\n# We leave off the `dependencies` field because Pants will infer\n# it based on import statements.\npython_tests(name="tests")\n'})})}),(0,r.jsx)(o.A,{value:"helloworld/testutils.py",label:"helloworld/testutils.py",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"helloworld/testutils.py"}',children:"...\n\n@contextmanager\ndef setup_tmpdir(files: Mapping[str, str]) -> Iterator[str]:\n    with temporary_dir() as tmpdir:\n        ...\n        yield rel_tmpdir\n"})})}),(0,r.jsx)(o.A,{value:"helloworld/app_test.py",label:"helloworld/app_test.py",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"helloworld/app_test.py"}',children:'from helloworld.testutils import setup_tmpdir\n\ndef test_app() -> None:\n    with setup_tmpdir({"f.py": "print(\'hello\')"}):\n       assert ...\n'})})})]}),"\n",(0,r.jsx)(t.h3,{id:"depending-on-resources",children:"Depending on resources"}),"\n",(0,r.jsxs)(t.p,{children:["Refer to ",(0,r.jsx)(t.a,{href:"/2.0/docs/using-pants/resources-and-archives",children:"Resources"})," for how to include resource files in your tests."]}),"\n",(0,r.jsxs)(t.p,{children:["It's often most convenient to use ",(0,r.jsx)(t.code,{children:"files"})," and ",(0,r.jsx)(t.code,{children:"relocated_files"})," targets in your test code, although you can also use ",(0,r.jsx)(t.code,{children:"resources"}),"."]}),"\n",(0,r.jsx)(t.h3,{id:"depending-on-packages",children:"Depending on packages"}),"\n",(0,r.jsxs)(t.p,{children:["For integration tests, you may want to include the result of ",(0,r.jsx)(t.code,{children:"./pants package"})," in your test, such as a generated ",(0,r.jsx)(t.code,{children:".pex"})," file. You can then, for example, use it with ",(0,r.jsx)(t.code,{children:"subprocess.run()"})," or unzip the package."]}),"\n",(0,r.jsxs)(t.p,{children:["To depend on a built package, use the ",(0,r.jsx)(t.code,{children:"runtime_package_dependencies"})," field on the ",(0,r.jsx)(t.code,{children:"python_tests"})," target, which is a list of addresses to targets that can be built with ",(0,r.jsx)(t.code,{children:"./pants package"}),", such as ",(0,r.jsx)(t.code,{children:"pex_binary"}),", ",(0,r.jsx)(t.code,{children:"python_awslambda"}),", and ",(0,r.jsx)(t.code,{children:"archive"})," targets. Pants will build the package before running your test, and insert the file into the test's chroot. It will use the same name it would normally use with ",(0,r.jsx)(t.code,{children:"./pants package"}),", except without the ",(0,r.jsx)(t.code,{children:"dist/"})," prefix."]}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsxs)(l.A,{groupId:"code-examples",children:[(0,r.jsx)(o.A,{value:"helloworld/build",label:"helloworld/BUILD",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"helloworld/BUILD"}',children:'pex_binary(\n    name="bin",\n    sources=["say_hello.py"],\n)\n\npython_tests(\n    name="tests",\n    runtime_package_dependencies=[":bin"],\n)\n'})})}),(0,r.jsx)(o.A,{value:"helloworld/say_hello.py",label:"helloworld/say_hello.py",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"helloworld/say_hello.py"}',children:'print("Hello, test!")\n'})})}),(0,r.jsx)(o.A,{value:"helloworld/test_binary.py",label:"helloworld/test_binary.py",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"helloworld/test_binary.py"}',children:"import subprocess\n\ndef test_say_hello():\n    assert  b\"Hello, test!\" in subprocess.run(args=['helloworld/bin.pex'])\n"})})})]}),"\n",(0,r.jsx)(t.h2,{id:"coverage",children:"Coverage"}),"\n",(0,r.jsxs)(t.p,{children:["To report coverage using ",(0,r.jsx)(t.a,{href:"https://coverage.readthedocs.io/en/coverage-5.1/",children:(0,r.jsx)(t.code,{children:"Coverage.py"})}),", set the option ",(0,r.jsx)(t.code,{children:"--test-use-coverage"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"$ ./pants test --use-coverage helloworld/util/lang_test.py\n"})}),"\n",(0,r.jsx)(t.p,{children:"Or to permanently use coverage, set in your config file:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.ci.toml"',children:"[test]\nuse_coverage = true\n"})}),"\n",(0,r.jsxs)(t.admonition,{title:"Failure to parse files?",type:"caution",children:[(0,r.jsx)(t.p,{children:"Coverage defaults to running with Python 3.6+ when generating a report, which means it may fail to parse Python 2 syntax and Python 3.8+ syntax. You can fix this by changing the interpreter constraints for running Coverage:"}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:'# pants.toml\n[coverage-py]\ninterpreter_constraints = [">=3.8"]\n'})}),(0,r.jsxs)(t.p,{children:["However, if your repository has some Python 2-only code and some Python 3-only code, you will not be able to choose an interpreter that works with both versions. So, you will need to set up a ",(0,r.jsx)(t.code,{children:".coveragerc"})," config file and set ",(0,r.jsx)(t.code,{children:"ignore_errors = True"})," under ",(0,r.jsx)(t.code,{children:"[report]"}),", like this:"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{children:"# .coveragerc\n[report]\nignore_errors = True\n"})}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",children:'# pants.toml\n[coverage-py]\nconfig = ".coveragerc"\n'})}),(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.code,{children:"ignore_errors = True"})," means that those files will simply be left off of the final coverage report."]}),(0,r.jsxs)(t.p,{children:["There's a proposal for Pants to fix this by generating multiple reports when necessary: ",(0,r.jsx)(t.a,{href:"https://github.com/pantsbuild/pants/issues/11137",children:"https://github.com/pantsbuild/pants/issues/11137"}),". We'd appreciate your feedback."]})]}),"\n",(0,r.jsxs)(t.p,{children:["Coverage will report data on any files encountered during the tests. You can filter down the results by using the option ",(0,r.jsx)(t.code,{children:"--coverage-py-filter"})," and passing the name(s) of modules you want coverage data for. Each module name is recursive, meaning submodules will be included. For example:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:'$ ./pants test --use-coverage helloworld/util/lang_test.py --coverage-py=helloworld.util\n$ ./pants test --use-coverage helloworld/util/lang_test.py --coverage-py=\'["helloworld.util.lang", "helloworld.util.lang_test"]\'\n'})}),"\n",(0,r.jsxs)(t.admonition,{title:"Coverage will not report on unencountered files",type:"caution",children:[(0,r.jsx)(t.p,{children:"Coverage will only report on files encountered during the tests' run. This means that your coverage score may be misleading; even with a score of 100%, you may have files without any tests."}),(0,r.jsx)(t.p,{children:"This is a shortcoming of Coverage itself."})]}),"\n",(0,r.jsx)(t.p,{children:"Pants will default to writing the results to the console, but you can also output in HTML, XML, JSON, or the raw SQLite file:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[coverage-py]\nreport_type = ["raw", "xml", "html", "json", "console"]\n'})}),"\n",(0,r.jsxs)(t.p,{children:["You can change the output dir with the ",(0,r.jsx)(t.code,{children:"output_dir"})," option in the ",(0,r.jsx)(t.code,{children:"[coverage-py]"})," scope."]}),"\n",(0,r.jsxs)(t.p,{children:["You may use a custom ",(0,r.jsx)(t.code,{children:".coveragerc"})," config file by setting the option ",(0,r.jsx)(t.code,{children:"coverage"})," in the ",(0,r.jsx)(t.code,{children:"[coverage-py]"})," scope. You must include ",(0,r.jsx)(t.code,{children:"relative_files = True"})," in the ",(0,r.jsx)(t.code,{children:"[run]"})," section for Pants to work."]}),"\n",(0,r.jsxs)(l.A,{groupId:"code-examples",children:[(0,r.jsx)(o.A,{value:"pants.toml",label:"pants.toml",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'tab={"label":"pants.toml"}',children:'[coverage-py]\nconfig = ".coveragerc"\n'})})}),(0,r.jsx)(o.A,{value:".coveragerc",label:".coveragerc",children:(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-text",metastring:'tab={"label":".coveragerc"}',children:"[run]\nrelative_files = True\nbranch = True\n"})})})]}),"\n",(0,r.jsxs)(t.p,{children:["When generating HTML, XML, and JSON reports, you can automatically open the reports through the option ",(0,r.jsx)(t.code,{children:"--test-open-coverage"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"saving-junit-xml-results",children:"Saving JUnit XML results"}),"\n",(0,r.jsxs)(t.p,{children:["Pytest can generate ",(0,r.jsx)(t.a,{href:"https://docs.pytest.org/en/latest/usage.html#creating-junitxml-format-files",children:"JUnit XML result files"}),". This allows you to hook up your results, for example, to dashboards."]}),"\n",(0,r.jsxs)(t.p,{children:["To save JUnit XML result files, set the option ",(0,r.jsx)(t.code,{children:"junit_xml_dir"})," in the ",(0,r.jsx)(t.code,{children:"[pytest]"})," scope, like this:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[pytest]\njunit_xml_dir = "dist/pytest_results"\n'})}),"\n",(0,r.jsxs)(t.p,{children:["You may also want to set the option ",(0,r.jsx)(t.code,{children:"junit_family"})," in the ",(0,r.jsx)(t.code,{children:"[pytest]"})," scope to change the format. Run ",(0,r.jsx)(t.code,{children:"./pants help-advanced pytest"})," for more information."]})]})}function u(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},753348(e,t,n){n.d(t,{A:()=>s});let s={tabItem:"tabItem_mHvh"}},618264(e,t,n){n.d(t,{A:()=>s});let s={tabList:"tabList_sFbf",tabItem:"tabItem_UVfV"}},637180(e,t,n){n.d(t,{A:()=>l});var s=n(886070);n(830758);var r=n(313526),i=n(753348);function l({children:e,hidden:t,className:n}){return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.A)(i.A.tabItem,n),hidden:t,children:e})}},685008(e,t,n){n.d(t,{A:()=>g});var s=n(886070),r=n(830758),i=n(313526),l=n(911212),o=n(274875),a=n(106632),c=n(189223),d=n(618264);function h({className:e,block:t,selectedValue:n,selectValue:r,tabValues:l}){let a=[],{blockElementScrollPositionUntilNextRender:c}=(0,o.a_)(),h=e=>{let t=e.currentTarget,s=l[a.indexOf(t)].value;s!==n&&(c(t),r(s))},p=e=>{let t=null;switch(e.key){case"Enter":h(e);break;case"ArrowRight":{let n=a.indexOf(e.currentTarget)+1;t=a[n]??a[0];break}case"ArrowLeft":{let n=a.indexOf(e.currentTarget)-1;t=a[n]??a[a.length-1]}}t?.focus()};return(0,s.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":t},e),children:l.map(({value:e,label:t,attributes:r})=>(0,s.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{a.push(e)},onKeyDown:p,onClick:h,...r,className:(0,i.A)("tabs__item",d.A.tabItem,r?.className,{"tabs__item--active":n===e}),children:t??e},e))})}function p({lazy:e,children:t,selectedValue:n}){let l=(Array.isArray(t)?t:[t]).filter(Boolean);if(e){let e=l.find(e=>e.props.value===n);return e?(0,r.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,s.jsx)("div",{className:"margin-top--md",children:l.map((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==n}))})}function u(e){let t=(0,a.u)(e);return(0,s.jsxs)("div",{className:(0,i.A)(l.G.tabs.container,"tabs-container",d.A.tabList),children:[(0,s.jsx)(h,{...t,...e}),(0,s.jsx)(p,{...t,...e})]})}function g(e){let t=(0,c.A)();return(0,s.jsx)(u,{...e,children:(0,a.v)(e.children)},String(t))}},106632(e,t,n){n.d(t,{u:()=>h,v:()=>c});var s=n(830758),r=n(325557),i=n(363717),l=n(125740),o=n(574229),a=n(270367);function c(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){let{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function d({value:e,tabValues:t}){return t.some(t=>t.value===e)}function h(e){let t,{defaultValue:n,queryString:h=!1,groupId:p}=e,u=function(e){let{values:t,children:n}=e;return(0,s.useMemo)(()=>{let e=t??c(n).map(({props:{value:e,label:t,attributes:n,default:s}})=>({value:e,label:t,attributes:n,default:s})),s=(0,o.XI)(e,(e,t)=>e.value===t.value);if(s.length>0)throw Error(`Docusaurus error: Duplicate values "${s.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[t,n])}(e),[g,x]=(0,s.useState)(()=>(function({defaultValue:e,tabValues:t}){if(0===t.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!d({value:e,tabValues:t}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let n=t.find(e=>e.default)??t[0];if(!n)throw Error("Unexpected error: 0 tabValues");return n.value})({defaultValue:n,tabValues:u})),[m,y]=function({queryString:e=!1,groupId:t}){let n=(0,r.W6)(),i=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,l.aZ)(i),(0,s.useCallback)(e=>{if(!i)return;let t=new URLSearchParams(n.location.search);t.set(i,e),n.replace({...n.location,search:t.toString()})},[i,n])]}({queryString:h,groupId:p}),[j,f]=function({groupId:e}){let t=e?`docusaurus.tab.${e}`:null,[n,r]=(0,a.Dv)(t);return[n,(0,s.useCallback)(e=>{t&&r.set(e)},[t,r])]}({groupId:p}),v=d({value:t=m??j,tabValues:u})?t:null;return(0,i.A)(()=>{v&&x(v)},[v]),{selectedValue:g,selectValue:(0,s.useCallback)(e=>{if(!d({value:e,tabValues:u}))throw Error(`Can't select invalid tab value=${e}`);x(e),y(e),f(e)},[y,f,u]),tabValues:u}}},848193(e,t,n){n.d(t,{R:()=>l,x:()=>o});var s=n(830758);let r={},i=s.createContext(r);function l(e){let t=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(i.Provider,{value:t},e.children)}},334043(e){e.exports=JSON.parse('{"id":"docs/python/goals/test","title":"test","description":"Run tests with Pytest.","source":"@site/versioned_docs/version-2.0/docs/python/goals/test.mdx","sourceDirName":"docs/python/goals","slug":"/docs/python/goals/test","permalink":"/2.0/docs/python/goals/test","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/python/goals/test.mdx","tags":[],"version":"2.0","sidebarPosition":5,"frontMatter":{"title":"test","sidebar_position":5},"sidebar":"docsSidebar","previous":{"title":"package","permalink":"/2.0/docs/python/goals/package"},"next":{"title":"typecheck","permalink":"/2.0/docs/python/goals/typecheck"}}')}}]);