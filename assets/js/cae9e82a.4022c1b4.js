"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["157866"],{265477(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>t,toc:()=>c});var t=s(535700),l=s(886070),i=s(848193);let r={title:"Add a linter",sidebar_position:0},o,a={},c=[{value:"1. Install your linter",id:"1-install-your-linter",level:2},{value:"Set up a <code>FieldSet</code> and <code>LintTargetsRequest</code>",id:"set-up-a-fieldset-and-linttargetsrequest",level:2},{value:"3. Create a rule for your linter logic",id:"3-create-a-rule-for-your-linter-logic",level:2},{value:"4. Add tests (optional)",id:"4-add-tests-optional",level:2}];function d(e){let n={a:"a",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)(n.p,{children:["How to add a new linter to the ",(0,l.jsx)(n.code,{children:"lint"})," goal."]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.p,{children:"This guide assumes that you are running a linter that already exists outside of Pants as a stand-alone binary, such as running Shellcheck, Pylint, Checkstyle, or ESLint."}),"\n",(0,l.jsxs)(n.p,{children:["If you are instead writing your own linting logic inline, you can skip Step 1. In Step 3, you will not need to use ",(0,l.jsx)(n.code,{children:"Process"}),". You may find Pants's ",(0,l.jsxs)(n.a,{href:"https://github.com/pantsbuild/pants/blob/main/src/python/pants/backend/project_info/regex_lint.py",children:[(0,l.jsx)(n.code,{children:"regex-lint"})," implementation"]})," helpful for how to integrate custom linting logic into Pants."]}),"\n",(0,l.jsx)(n.h2,{id:"1-install-your-linter",children:"1. Install your linter"}),"\n",(0,l.jsxs)(n.p,{children:["There are several ways for Pants to install your linter. See ",(0,l.jsx)(n.a,{href:"/2.17/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),". This example will use ",(0,l.jsx)(n.code,{children:"ExternalTool"})," because there is already a pre-compiled binary for Shellcheck."]}),"\n",(0,l.jsxs)(n.p,{children:["You will also likely want to register some options, like ",(0,l.jsx)(n.code,{children:"--config"}),", ",(0,l.jsx)(n.code,{children:"--skip"}),", and ",(0,l.jsx)(n.code,{children:"--args"}),". Options are registered through a ",(0,l.jsx)(n.a,{href:"/2.17/docs/writing-plugins/the-rules-api/options-and-subsystems",children:(0,l.jsx)(n.code,{children:"Subsystem"})}),". If you are using ",(0,l.jsx)(n.code,{children:"ExternalTool"}),", this is already a subclass of ",(0,l.jsx)(n.code,{children:"Subsystem"}),". Otherwise, create a subclass of ",(0,l.jsx)(n.code,{children:"Subsystem"}),". Then, set the class property ",(0,l.jsx)(n.code,{children:"options_scope"})," to the name of the tool, e.g. ",(0,l.jsx)(n.code,{children:'"shellcheck"'})," or ",(0,l.jsx)(n.code,{children:'"eslint"'}),". Finally, add options from ",(0,l.jsx)(n.code,{children:"pants.option.option_types"}),"."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'from pants.core.util_rules.external_tool import ExternalTool\nfrom pants.engine.platform import Platform\nfrom pants.option.option_types import ArgsListOption, SkipOption\n\n\nclass Shellcheck(ExternalTool):\n    """A linter for shell scripts."""\n\n    options_scope = "shellcheck"\n    name = "ShellCheck"\n    default_version = "v0.8.0"\n    default_known_versions = [\n        "v0.8.0|macos_arm64 |e065d4afb2620cc8c1d420a9b3e6243c84ff1a693c1ff0e38f279c8f31e86634|4049756",\n        "v0.8.0|macos_x86_64|e065d4afb2620cc8c1d420a9b3e6243c84ff1a693c1ff0e38f279c8f31e86634|4049756",\n        "v0.8.0|linux_arm64 |9f47bbff5624babfa712eb9d64ece14c6c46327122d0c54983f627ae3a30a4ac|2996468",\n        "v0.8.0|linux_x86_64|ab6ee1b178f014d1b86d1e24da20d1139656c8b0ed34d2867fbb834dad02bf0a|1403852",\n    ]\n\n    skip = SkipOption("lint")\n    args = ArgsListOption(example="-e SC20529")\n\n    def generate_url(self, plat: Platform) -> str:\n        plat_str = {\n            "macos_arm64": "darwin.x86_64",\n            "macos_x86_64": "darwin.x86_64",\n            "linux_arm64": "linux.aarch64",\n            "linux_x86_64": "linux.x86_64",\n        }[plat.value]\n        return (\n            f"https://github.com/koalaman/shellcheck/releases/download/{self.version}/"\n            f"shellcheck-{self.version}.{plat_str}.tar.xz"\n        )\n\n    def generate_exe(self, _: Platform) -> str:\n        return f"./shellcheck-{self.version}/shellcheck"\n\n'})}),"\n",(0,l.jsxs)(n.h2,{id:"set-up-a-fieldset-and-linttargetsrequest",children:["Set up a ",(0,l.jsx)(n.code,{children:"FieldSet"})," and ",(0,l.jsx)(n.code,{children:"LintTargetsRequest"})]}),"\n",(0,l.jsxs)(n.p,{children:["As described in ",(0,l.jsx)(n.a,{href:"/2.17/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Rules and the Target API"}),", a ",(0,l.jsx)(n.code,{children:"FieldSet"})," is a way to tell Pants which ",(0,l.jsx)(n.code,{children:"Field"}),"s you care about targets having for your plugin to work."]}),"\n",(0,l.jsxs)(n.p,{children:["Usually, you should add a subclass of the ",(0,l.jsx)(n.code,{children:"Sources"})," field to the class property ",(0,l.jsx)(n.code,{children:"required_fields"}),", such as ",(0,l.jsx)(n.code,{children:"BashSources"})," or ",(0,l.jsx)(n.code,{children:"PythonSources"}),". This means that your linter will run on any target with that sources field or a subclass of it."]}),"\n",(0,l.jsxs)(n.p,{children:["Create a new dataclass that subclasses ",(0,l.jsx)(n.code,{children:"FieldSet"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.engine.target import Dependencies, FieldSet\n\n...\n\n@dataclass(frozen=True)\nclass ShellcheckFieldSet(FieldSet):\n    required_fields = (BashSources,)\n\n    sources: BashSources\n    dependencies: Dependencies\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Then, hook this up to a new subclass of ",(0,l.jsx)(n.code,{children:"LintTargetsRequest"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from pants.core.goals.lint import LintTargetsRequest\n\n...\n\nclass ShellcheckRequest(LintTargetsRequest):\n    field_set_type = ShellcheckFieldSet\n    tool_subsystem = Shellcheck\n"})}),"\n",(0,l.jsx)(n.h2,{id:"3-create-a-rule-for-your-linter-logic",children:"3. Create a rule for your linter logic"}),"\n",(0,l.jsxs)(n.p,{children:["Your rule should take as a parameter ",(0,l.jsx)(n.code,{children:"ShellcheckRequest.Batch"})," and the ",(0,l.jsx)(n.code,{children:"Subsystem"})," (or ",(0,l.jsx)(n.code,{children:"ExternalTool"}),") from step 1 (a ",(0,l.jsx)(n.code,{children:"Batch"})," is an object containing a subset of all the matched field sets for your tool). It should return a ",(0,l.jsx)(n.code,{children:"LintResult"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import rule\nfrom pants.core.goals.lint import LintResult\n\n...\n\n@rule\nasync def run_shellcheck(\n    request: ShellcheckRequest, shellcheck: Shellcheck\n) -> LintResult:\n    return LintResult.create(...)\n"})}),"\n",(0,l.jsxs)(n.p,{children:["The ",(0,l.jsx)(n.code,{children:"ShellcheckRequest.Batch"})," instance has a property called ",(0,l.jsx)(n.code,{children:".elements"}),", which in this case, stores a collection of the ",(0,l.jsx)(n.code,{children:"FieldSet"}),"s defined in step 2. Each ",(0,l.jsx)(n.code,{children:"FieldSet"})," corresponds to a single target. Pants will have already validated that there is at least one valid ",(0,l.jsx)(n.code,{children:"FieldSet"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["If you used ",(0,l.jsx)(n.code,{children:"ExternalTool"})," in step 1, you will use ",(0,l.jsx)(n.code,{children:"Get(DownloadedExternalTool, ExternalToolRequest)"})," to install the tool."]}),"\n",(0,l.jsxs)(n.p,{children:["Typically, you will use ",(0,l.jsx)(n.code,{children:"Get(SourceFiles, SourceFilesRequest)"})," to get all the sources you want to run your linter on."]}),"\n",(0,l.jsxs)(n.p,{children:["If you have a ",(0,l.jsx)(n.code,{children:"--config"})," option, you should use ",(0,l.jsx)(n.code,{children:"Get(Digest, PathGlobs)"})," to find the config file and include it in the ",(0,l.jsx)(n.code,{children:"input_digest"}),"."]}),"\n",(0,l.jsxs)(n.p,{children:["Use ",(0,l.jsx)(n.code,{children:"Get(Digest, MergeDigests)"})," to combine the different inputs together, such as merging the source files, config file, and downloaded tool."]}),"\n",(0,l.jsxs)(n.p,{children:["Usually, you will use ",(0,l.jsx)(n.code,{children:"Get(FallibleProcessResult, Process)"})," to run a subprocess (see ",(0,l.jsx)(n.a,{href:"/2.17/docs/writing-plugins/the-rules-api/processes",children:"Processes"}),"). We use ",(0,l.jsx)(n.code,{children:"Fallible"})," because Pants should not throw an exception if the linter returns a non-zero exit code. Then, you can use ",(0,l.jsx)(n.code,{children:"LintResult.from_fallible_process_result()"})," to convert this into a ",(0,l.jsx)(n.code,{children:"LintResult"}),"."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:'from pants.core.goals.lint import LintTargetsRequest, LintResult, LintResults\nfrom pants.core.util_rules.source_files import (\n    SourceFilesRequest,\n    SourceFiles,\n)\nfrom pants.core.util_rules.external_tool import (\n    DownloadedExternalTool,\n    ExternalTool,\n    ExternalToolRequest,\n)\nfrom pants.engine.fs import (\n    Digest,\n    GlobMatchErrorBehavior,\n    MergeDigests,\n    PathGlobs,\n)\nfrom pants.engine.platform import Platform\nfrom pants.engine.process import FallibleProcessResult, Process\nfrom pants.engine.rules import Get, MultiGet, rule\nfrom pants.util.logging import LogLevel\nfrom pants.util.strutil import pluralize\n\n...\n\n@rule\nasync def run_shellcheck(\n    request: ShellcheckRequest.Batch, shellcheck: Shellcheck, platform: Platform\n) -> LintResult:\n    download_shellcheck_request = Get(\n        DownloadedExternalTool,\n        ExternalToolRequest,\n        shellcheck.get_request(platform),\n    )\n\n    sources_request = Get(\n        SourceFiles,\n        SourceFilesRequest(field_set.sources for field_set in request.elements),\n    )\n\n    # If the user specified `--shellcheck-config`, we must search for the file they specified with\n    # `PathGlobs` to include it in the `input_digest`. We error if the file cannot be found.\n    config_digest_request = Get(\n        Digest,\n        PathGlobs(\n            globs=[shellcheck.config] if shellcheck.config else [],\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n            description_of_origin="the option `[shellcheck].config`",\n        ),\n    )\n\n    downloaded_shellcheck, sources, config_digest = await MultiGet(\n        download_shellcheck_request, sources_request, config_digest_request\n    )\n\n    # The Process needs one single `Digest`, so we merge everything together.\n    input_digest = await Get(\n        Digest,\n        MergeDigests(\n            (\n                downloaded_shellcheck.digest,\n                sources.snapshot.digest,\n                config_digest,\n            )\n        ),\n    )\n\n    process_result = await Get(\n        FallibleProcessResult,\n        Process(\n            argv=[\n                downloaded_shellcheck.exe,\n                *shellcheck.args,\n                *sources.snapshot.files,\n            ],\n            input_digest=input_digest,\n            description=f"Run Shellcheck on {pluralize(len(request.elements), \'file\')}.",\n            level=LogLevel.DEBUG,\n        ),\n    )\n    return LintResult.create(request, process_result)\n\n'})}),"\n",(0,l.jsx)(n.p,{children:"At the bottom of your file, tell Pants about your rules:"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",children:"def rules():\n    return [\n      	*collect_rules(),\n        ShellcheckRequest.rules(partitioner_type=PartitionerType.DEFAULT_SINGLE_PARTITION),\n    ]\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Finally, update your plugin's ",(0,l.jsx)(n.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/bash/register.py"',children:"from bash import shellcheck\n\n\ndef rules():\n    return [*shellcheck.rules()]\n"})}),"\n",(0,l.jsxs)(n.p,{children:["Now, when you run ",(0,l.jsx)(n.code,{children:"pants lint ::"}),", your new linter should run."]}),"\n",(0,l.jsx)(n.h2,{id:"4-add-tests-optional",children:"4. Add tests (optional)"}),"\n",(0,l.jsxs)(n.p,{children:["Refer to ",(0,l.jsx)(n.a,{href:"/2.17/docs/writing-plugins/the-rules-api/testing-plugins",children:"Testing rules"}),"."]})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(d,{...e})}):d(e)}},848193(e,n,s){s.d(n,{R:()=>r,x:()=>o});var t=s(830758);let l={},i=t.createContext(l);function r(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:r(e.components),t.createElement(i.Provider,{value:n},e.children)}},535700(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-linter","title":"Add a linter","description":"How to add a new linter to the lint goal.","source":"@site/versioned_docs/version-2.17/docs/writing-plugins/common-plugin-tasks/add-a-linter.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-linter","permalink":"/2.17/docs/writing-plugins/common-plugin-tasks/add-a-linter","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-linter.mdx","tags":[],"version":"2.17","sidebarPosition":0,"frontMatter":{"title":"Add a linter","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"Common plugin tasks","permalink":"/2.17/docs/writing-plugins/common-plugin-tasks/"},"next":{"title":"Add a formatter","permalink":"/2.17/docs/writing-plugins/common-plugin-tasks/add-a-formatter"}}')}}]);