"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["875395"],{860687(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>r,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>d});var t=s(644176),i=s(886070),l=s(848193);let o={title:"Maintenance tasks and scripts",sidebar_position:6},r,a={},d=[{value:"Update the default/known versions of a built-in tool/subsystem",id:"update-the-defaultknown-versions-of-a-built-in-toolsubsystem",level:2},{value:"External tools (downloaded executables)",id:"external-tools-downloaded-executables",level:3},{value:"PEX",id:"pex",level:4},{value:"Terraform",id:"terraform",level:4},{value:"Python tools",id:"python-tools",level:3},{value:"JVM tools",id:"jvm-tools",level:3},{value:"JS tools",id:"js-tools",level:3},{value:"Python Build Standalone known versions",id:"python-build-standalone-known-versions",level:3},{value:"Update or create FaaS complete platforms files",id:"update-or-create-faas-complete-platforms-files",level:2},{value:"AWS Lambda",id:"aws-lambda",level:3},{value:"Google Cloud Functions",id:"google-cloud-functions",level:3},{value:"Cherry-pick a pull request to an older version",id:"cherry-pick-a-pull-request-to-an-older-version",level:2},{value:"Cherry-picking a new pull request",id:"cherry-picking-a-new-pull-request",level:3},{value:"Cherry-picking a merged pull request",id:"cherry-picking-a-merged-pull-request",level:3}];function c(e){let n={a:"a",code:"code",em:"em",h2:"h2",h3:"h3",h4:"h4",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"There's a variety of maintenance tasks that happen on different frequencies."}),"\n",(0,i.jsx)(n.h2,{id:"update-the-defaultknown-versions-of-a-built-in-toolsubsystem",children:"Update the default/known versions of a built-in tool/subsystem"}),"\n",(0,i.jsx)(n.h3,{id:"external-tools-downloaded-executables",children:"External tools (downloaded executables)"}),"\n",(0,i.jsxs)(n.p,{children:["Some tools use ",(0,i.jsxs)(n.a,{href:"../../writing-plugins/the-rules-api/installing-tools#externaltool-install-pre-compiled-binaries",children:["the ",(0,i.jsx)(n.code,{children:"ExternalTool"})," class"]})," to download a binary from the internet, verify its size and hash, and then execute it."]}),"\n",(0,i.jsx)(n.p,{children:"To update these:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["For each platform and version to add:","\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Download the archive/binary."}),"\n",(0,i.jsx)(n.li,{children:"Verify it: check signatures and/or hashes if available."}),"\n",(0,i.jsxs)(n.li,{children:["Compute the sha256 hash and byte length. For example, if it's called ",(0,i.jsx)(n.code,{children:"archive.zip"}),": ",(0,i.jsx)(n.code,{children:"tee >(shasum -a 256) >(wc -c) > /dev/null < archive.zip"}),"."]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["Apply the new values:","\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Adjust ",(0,i.jsx)(n.code,{children:"default_version"})," to the new version."]}),"\n",(0,i.jsxs)(n.li,{children:["Add or replace to ",(0,i.jsx)(n.code,{children:"default_known_versions"})," using the hashes and lengths above (for some tools we don't preserve older versions, especially if they have strong backwards compatibility guarantees, while for others we do retain older versions)."]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Example: ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/pull/20469",children:"#20469"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"pex",children:"PEX"}),"\n",(0,i.jsxs)(n.p,{children:["The PEX external tool is a bit special, because it also appears as a requirement of the Pants project itself in ",(0,i.jsx)(n.code,{children:"3rdparty/python/requirements.txt"}),". To update pex, do both:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Update the ",(0,i.jsx)(n.code,{children:"pex-cli"})," subsystem, as above (in ",(0,i.jsx)(n.code,{children:"src/python/pants/backend/python/util_rules/pex_cli.py"}),")."]}),"\n",(0,i.jsxs)(n.li,{children:["Update the requirements file and run ",(0,i.jsx)(n.code,{children:"pants generate-lockfiles --resolve=python-default"})," to update Pants' own lockfile."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Example: ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/pull/20782",children:"#20782"}),"."]}),"\n",(0,i.jsx)(n.h4,{id:"terraform",children:"Terraform"}),"\n",(0,i.jsxs)(n.p,{children:["The ",(0,i.jsx)(n.code,{children:"build-support/bin/terraform_tool_versions.py"})," script can help update Terraform versions."]}),"\n",(0,i.jsx)(n.h3,{id:"python-tools",children:"Python tools"}),"\n",(0,i.jsxs)(n.p,{children:["Some tools use ",(0,i.jsx)(n.code,{children:"PythonToolBase"})," to install executable PyPI packages, using a lockfile. Pants packages a default lockfile with a specific version of the package. To update these:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Adjust ",(0,i.jsx)(n.code,{children:"default_requirements"})," and/or ",(0,i.jsx)(n.code,{children:"default_interpreter_constraints"})," as required."]}),"\n",(0,i.jsxs)(n.li,{children:["Run ",(0,i.jsx)(n.code,{children:"build-support/bin/generate_builtin_lockfiles.py $scope"}),", where ",(0,i.jsx)(n.code,{children:"$scope"})," is the ",(0,i.jsx)(n.code,{children:"options_scope"})," of the subsystem class."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Example: ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/pull/20924",children:"#20924"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"jvm-tools",children:"JVM tools"}),"\n",(0,i.jsxs)(n.p,{children:["Some tools use ",(0,i.jsx)(n.code,{children:"JVMToolBase"})," to install executable JVM packages, using a lockfile. Pants packages a default lockfile with a specific version of the package. To update these:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Adjust ",(0,i.jsx)(n.code,{children:"default_version"})," and/or ",(0,i.jsx)(n.code,{children:"default_artifacts"})," as required."]}),"\n",(0,i.jsxs)(n.li,{children:["Run ",(0,i.jsx)(n.code,{children:"build-support/bin/generate_builtin_lockfiles.py $scope"}),", where ",(0,i.jsx)(n.code,{children:"$scope"})," is the ",(0,i.jsx)(n.code,{children:"options_scope"})," of the subsystem class."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Example: none yet."}),"\n",(0,i.jsx)(n.h3,{id:"js-tools",children:"JS tools"}),"\n",(0,i.jsxs)(n.p,{children:["Some tools use ",(0,i.jsx)(n.code,{children:"NodeJSToolBase"})," to install executable npm packages. To update these:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Update ",(0,i.jsx)(n.code,{children:"default_version"}),". That's all."]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Example: ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/pull/21007",children:"#21007"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"python-build-standalone-known-versions",children:"Python Build Standalone known versions"}),"\n",(0,i.jsxs)(n.p,{children:["The Python Build Standalone providers needs to be updated with new upstream releases.  There are ",(0,i.jsx)(n.em,{children:"many"})," artifacts here, so the hashes are stored in a json file that is updated by running:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"pants run src/python/pants/backend/python/providers/python_build_standalone/scripts/generate_urls.py\n"})}),"\n",(0,i.jsx)(n.h2,{id:"update-or-create-faas-complete-platforms-files",children:"Update or create FaaS complete platforms files"}),"\n",(0,i.jsx)(n.p,{children:"The function-as-a-service (FaaS) subsystems provide some built-in PEX complete platforms JSON files, for specific runtimes. To update or create these:"}),"\n",(0,i.jsx)(n.h3,{id:"aws-lambda",children:"AWS Lambda"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Adjust ",(0,i.jsx)(n.code,{children:"PythonAwsLambdaRuntime.known_runtimes"})," as required"]}),"\n",(0,i.jsxs)(n.li,{children:["Run ",(0,i.jsx)(n.code,{children:"build-support/bin/generate_faas_complete_platforms.py"})," to create any new files and update the existing ones, using AWS's published docker images"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Example: ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/pull/21004",children:"#21004"}),"."]}),"\n",(0,i.jsx)(n.h3,{id:"google-cloud-functions",children:"Google Cloud Functions"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Adjust ",(0,i.jsx)(n.code,{children:"PythonGoogleCloudFunctionRuntime.known_runtimes"})," as required"]}),"\n",(0,i.jsxs)(n.li,{children:["Run ",(0,i.jsx)(n.code,{children:"build-support/bin/generate_faas_complete_platforms.py"})," to create any new files and update the existing ones, using GCF's published docker images"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["Example: ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/pull/21248",children:"#21248"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"cherry-pick-a-pull-request-to-an-older-version",children:"Cherry-pick a pull request to an older version"}),"\n",(0,i.jsxs)(n.p,{children:["We maintain multiple versions, with ",(0,i.jsx)(n.code,{children:"main"})," being our development branch, and various ",(0,i.jsx)(n.code,{children:"2.*.x"})," branches for the stable versions (see ",(0,i.jsx)(n.a,{href:"/2.24/docs/contributions/releases/release-strategy",children:"Release strategy"})," for more details)."]}),"\n",(0,i.jsx)(n.h3,{id:"cherry-picking-a-new-pull-request",children:"Cherry-picking a new pull request"}),"\n",(0,i.jsxs)(n.p,{children:["When a change needs to land in ",(0,i.jsx)(n.code,{children:"main"})," but also one or more older versions, the usual process is:"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Create or review the pull request against ",(0,i.jsx)(n.code,{children:"main"})," as usual"]}),"\n",(0,i.jsxs)(n.li,{children:["Label it as ",(0,i.jsx)(n.code,{children:"needs-cherrypick"})," and set milestone to the oldest release to which it should be cherry-picked"]}),"\n",(0,i.jsx)(n.li,{children:"Merge the pull request as normal"}),"\n",(0,i.jsx)(n.li,{children:"At this point, automation kicks in and attempts to cherrypick the merged commit to the release in the milestone and any newer ones."}),"\n",(0,i.jsxs)(n.li,{children:["The automation opens pull requests targeting each of the relevant ",(0,i.jsx)(n.code,{children:"2.*.x"})," branches for which cherry-picking succeeds."]}),"\n",(0,i.jsxs)(n.li,{children:["If the automation fails to do a cherry-pick, it will mark the PR as ",(0,i.jsx)(n.code,{children:"auto-cherry-picking-failed"})]}),"\n",(0,i.jsx)(n.li,{children:"In either case, the automation will add a comment describing what happened to the original pull request."}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:["For example, suppose ",(0,i.jsx)(n.code,{children:"main"})," is for ",(0,i.jsx)(n.code,{children:"2.23.x"})," and we're still maintaining ",(0,i.jsx)(n.code,{children:"2.20.x"}),", ",(0,i.jsx)(n.code,{children:"2.21.x"})," and ",(0,i.jsx)(n.code,{children:"2.22.x"}),". If a pull request is labelled ",(0,i.jsx)(n.code,{children:"needs-cherrypick"})," and has milestone ",(0,i.jsx)(n.code,{children:"2.21.x"}),", then merging it will attempt to cherry pick to ",(0,i.jsx)(n.code,{children:"2.21.x"})," and ",(0,i.jsx)(n.code,{children:"2.22.x"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"The process may fail in one of two ways:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["The cherry-picking process failed, and tagged the PR with ",(0,i.jsx)(n.code,{children:"auto-cherry-picking-failed"}),": follow the instructions in the comment on the pull request. (This likely means there are merge conflicts that require manual resolution.)"]}),"\n",(0,i.jsxs)(n.li,{children:["the cherry-pick hasn't (yet) run: trigger the automation manually by going to ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/actions/workflows/auto-cherry-picker.yaml",children:"the GitHub Action"}),', clicking on the "Run workflow" button, and providing the PR number.']}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"cherry-picking-a-merged-pull-request",children:"Cherry-picking a merged pull request"}),"\n",(0,i.jsx)(n.p,{children:"A pull request might merged without being configured for cherry-picking, and we decide later that it should be. To cherry-pick in this case:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Label the pull request as ",(0,i.jsx)(n.code,{children:"needs-cherrypick"})," and set milestone to the oldest release to which it should be cherry-picked"]}),"\n",(0,i.jsxs)(n.li,{children:["Trigger the automation manually by going to ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/actions/workflows/auto-cherry-picker.yaml",children:"the GitHub Action"}),', clicking on the "Run workflow" button, and providing the PR number.']}),"\n",(0,i.jsx)(n.li,{children:"As above, the automation may (partially) succeed or fail, and will leave a comment describing what happened."}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},848193(e,n,s){s.d(n,{R:()=>o,x:()=>r});var t=s(830758);let i={},l=t.createContext(i);function o(e){let n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(l.Provider,{value:n},e.children)}},644176(e){e.exports=JSON.parse('{"id":"docs/contributions/development/maintenance-tasks-and-scripts","title":"Maintenance tasks and scripts","description":"There\'s a variety of maintenance tasks that happen on different frequencies.","source":"@site/versioned_docs/version-2.24/docs/contributions/development/maintenance-tasks-and-scripts.mdx","sourceDirName":"docs/contributions/development","slug":"/docs/contributions/development/maintenance-tasks-and-scripts","permalink":"/2.24/docs/contributions/development/maintenance-tasks-and-scripts","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/contributions/development/maintenance-tasks-and-scripts.mdx","tags":[],"version":"2.24","sidebarPosition":6,"frontMatter":{"title":"Maintenance tasks and scripts","sidebar_position":6},"sidebar":"docsSidebar","previous":{"title":"Running Pants from sources","permalink":"/2.24/docs/contributions/development/running-pants-from-sources"},"next":{"title":"Releases","permalink":"/2.24/docs/contributions/releases/"}}')}}]);