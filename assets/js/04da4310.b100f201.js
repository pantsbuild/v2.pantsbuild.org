"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["357443"],{133686(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>c});var t=s(976710),r=s(886070),i=s(848193);let o={title:"Add a REPL",sidebar_position:6},l,a={},c=[{value:"1. Install your REPL",id:"1-install-your-repl",level:2},{value:"2. Set up a subclass of <code>ReplImplementation</code>",id:"2-set-up-a-subclass-of-replimplementation",level:2},{value:"3. Create a rule for your REPL logic",id:"3-create-a-rule-for-your-repl-logic",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["How to add a new implementation to the ",(0,r.jsx)(n.code,{children:"repl"})," goal."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"repl"})," goal opens up an interactive Read-Eval-Print Loop that runs in the foreground."]}),"\n",(0,r.jsx)(n.p,{children:"Typically, the REPL is loaded with the transitive closure of the files and targets that the user provided, so that users may import their code and resources in the REPL."}),"\n",(0,r.jsx)(n.admonition,{title:"Example repository",type:"note",children:(0,r.jsxs)(n.p,{children:["This guide walks through adding a simple ",(0,r.jsx)(n.code,{children:"repl"})," implementation for Bash that runs ",(0,r.jsx)(n.code,{children:"/bin/bash"})," and ensures all relevant files are included in the temporary directory. See ",(0,r.jsx)(n.a,{href:"https://github.com/pantsbuild/example-plugin/blob/main/pants-plugins/examples/bash/repl.py",children:"here"})," for the final implementation."]})}),"\n",(0,r.jsx)(n.h2,{id:"1-install-your-repl",children:"1. Install your REPL"}),"\n",(0,r.jsxs)(n.p,{children:["There are several ways for Pants to install your REPL. See ",(0,r.jsx)(n.a,{href:"/2.2/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["In this example, we simply find the program ",(0,r.jsx)(n.code,{children:"bash"})," on the user's machine, but often you will want to install a tool like Ammonite or iPython instead."]}),"\n",(0,r.jsxs)(n.p,{children:["You may want to also add options for your REPL implementation, such as allowing users to change the version of the tool. See ",(0,r.jsx)(n.a,{href:"/2.2/docs/writing-plugins/the-rules-api/options-and-subsystems",children:"Options and subsystems"}),"."]}),"\n",(0,r.jsxs)(n.h2,{id:"2-set-up-a-subclass-of-replimplementation",children:["2. Set up a subclass of ",(0,r.jsx)(n.code,{children:"ReplImplementation"})]}),"\n",(0,r.jsxs)(n.p,{children:["Subclass ",(0,r.jsx)(n.code,{children:"ReplImplementation"})," and define the class property ",(0,r.jsx)(n.code,{children:"name: str"})," with the name of your REPL, e.g. ",(0,r.jsx)(n.code,{children:'"bash"'})," or ",(0,r.jsx)(n.code,{children:'"ipython"'}),". Users can then set the option ",(0,r.jsx)(n.code,{children:"--repl-shell"})," to this option to choose your REPL implementation."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from pants.core.goals.repl import ReplImplementation\n\nclass BashRepl(ReplImplementation):\n    name = "bash"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Then, register your new ",(0,r.jsx)(n.code,{children:"ReplImplementation"})," with a ",(0,r.jsx)(n.a,{href:"/2.2/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,r.jsx)(n.code,{children:"UnionRule"})})," so that Pants knows your REPL implementation exists:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import collect_rules\nfrom pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(ReplImplementation, BashRepl),\n    ]\n"})}),"\n",(0,r.jsx)(n.h2,{id:"3-create-a-rule-for-your-repl-logic",children:"3. Create a rule for your REPL logic"}),"\n",(0,r.jsxs)(n.p,{children:["Your rule should take as a parameter the ",(0,r.jsx)(n.code,{children:"ReplImplementation "})," from Step 2, which has a field ",(0,r.jsx)(n.code,{children:"targets: Targets"})," containing the transitive closure of the targets/files provided by the user. You can then filter these targets to only include the ",(0,r.jsx)(n.code,{children:"Sources"})," you care about."]}),"\n",(0,r.jsxs)(n.p,{children:["Your rule should return ",(0,r.jsx)(n.code,{children:"ReplRequest"}),", which has the fields ",(0,r.jsx)(n.code,{children:"digest: Digest"}),", ",(0,r.jsx)(n.code,{children:"args: Iterable[str]"}),", and ",(0,r.jsx)(n.code,{children:"extra_env: Optional[Mapping[str, str]]"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"ReplRequest "})," will get converted into an ",(0,r.jsx)(n.code,{children:"InteractiveProcess"})," that will run in the foreground."]}),"\n",(0,r.jsxs)(n.p,{children:["The process will run in a temporary directory in the build root, which means that the script/program can access files that would normally need to be declared by adding a ",(0,r.jsx)(n.code,{children:"files"})," or ",(0,r.jsx)(n.code,{children:"resources"})," target to the ",(0,r.jsx)(n.code,{children:"dependencies"})," field."]}),"\n",(0,r.jsxs)(n.p,{children:["The process's environment will not be hermetic, meaning that it will inherit the environment used by the ",(0,r.jsx)(n.code,{children:"./pants process"}),". Any values you set in ",(0,r.jsx)(n.code,{children:"extra_env"})," will add or update the specified environment variables."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from dataclasses import dataclass\n\nfrom pants.core.goals.repl import ReplRequest\nfrom pants.core.target_types import FilesSources, ResourcesSources\nfrom pants.core.util_rules.source_files import SourceFiles, SourceFilesRequest\nfrom pants.engine.rules import Get, rule\nfrom pants.engine.target import Sources\nfrom pants.util.logging import LogLevel\n\n...\n\n@rule(level=LogLevel.DEBUG)\nasync def create_bash_repl_request(repl: BashRepl) -> ReplRequest:\n    # First, we find the `bash` program.\n    bash_program_paths =  await Get(\n        BinaryPaths, BinaryPathRequest(binary_name="bash", search_path=("/bin", "/usr/bin")),\n    )\n    if not bash_program_paths.first_path:\n        raise EnvironmentError("Could not find the `bash` program on /bin or /usr/bin.")\n    bash_program = bash_program_paths.first_path\n\n    # `repl.targets` already includes the transitive closure of the input targets. We filter out\n    # irrelevant soures.\n    sources = await Get(\n        SourceFiles,\n        SourceFilesRequest(\n            (tgt.get(Sources) for tgt in repl.targets),\n            for_sources_types=(BashSources, FilesSources, ResourcesSources),\n        ),\n    )\n    return ReplRequest(\n        digest=sources.snapshot.digest, args=(bash_program.exe,)\n    )\n\n'})}),"\n",(0,r.jsxs)(n.p,{children:["If you use any relative paths in ",(0,r.jsx)(n.code,{children:"args"})," or ",(0,r.jsx)(n.code,{children:"extra_env"}),", you should call ",(0,r.jsx)(n.code,{children:'repl.in_chroot("./example_relative_path")'})," on the values. This ensures that you run on the correct file in the temporary directory created by Pants."]}),"\n",(0,r.jsxs)(n.p,{children:["Finally, update your plugin's ",(0,r.jsx)(n.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/bash/register.py"',children:"from bash import repl\n\n\ndef rules():\n    return [*repl.rules()]\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Now, when you run ",(0,r.jsx)(n.code,{children:"./pants repl --shell=bash ::"}),", your new REPL should be used."]})]})}function p(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},848193(e,n,s){s.d(n,{R:()=>o,x:()=>l});var t=s(830758);let r={},i=t.createContext(r);function o(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}},976710(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-repl","title":"Add a REPL","description":"How to add a new implementation to the repl goal.","source":"@site/versioned_docs/version-2.2/docs/writing-plugins/common-plugin-tasks/add-a-repl.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-repl","permalink":"/2.2/docs/writing-plugins/common-plugin-tasks/add-a-repl","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-repl.mdx","tags":[],"version":"2.2","sidebarPosition":6,"frontMatter":{"title":"Add a REPL","sidebar_position":6},"sidebar":"docsSidebar","previous":{"title":"Package code","permalink":"/2.2/docs/writing-plugins/common-plugin-tasks/package-code"},"next":{"title":"Run tests","permalink":"/2.2/docs/writing-plugins/common-plugin-tasks/run-tests"}}')}}]);