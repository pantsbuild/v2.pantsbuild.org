"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["516857"],{567220(e,r,n){n.r(r),n.d(r,{assets:()=>i,contentTitle:()=>s,default:()=>h,frontMatter:()=>d,metadata:()=>a,toc:()=>l});var a=n(275610),o=n(886070),t=n(848193);let d={title:"Terraform Overview",sidebar_position:999},s,i={},l=[{value:"Initial setup",id:"initial-setup",level:2},{value:"Adding Terraform targets",id:"adding-terraform-targets",level:3},{value:"Modules",id:"modules",level:4},{value:"Deployments",id:"deployments",level:4},{value:"Lockfiles",id:"lockfiles",level:4},{value:"Basic Operations",id:"basic-operations",level:3},{value:"Formatting",id:"formatting",level:4},{value:"Validate",id:"validate",level:4},{value:"Deploying",id:"deploying",level:4}];function c(e){let r={a:"a",admonition:"admonition",blockquote:"blockquote",code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,t.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(r.hr,{}),"\n",(0,o.jsxs)(r.admonition,{title:"Terraform support is in alpha stage",type:"caution",children:[(0,o.jsx)(r.p,{children:"Pants is currently building support for developing and deploying Terraform. Simple use cases might be supported, but many options are missing."}),(0,o.jsxs)(r.p,{children:["Please share feedback for what you need to use Pants with your Terraform modules and deployments by either ",(0,o.jsx)(r.a,{href:"https://github.com/pantsbuild/pants/issues/new/choose",children:"opening a GitHub issue"})," or ",(0,o.jsx)(r.a,{href:"/community/getting-help",children:"joining our Slack"}),"!"]})]}),"\n",(0,o.jsx)(r.h2,{id:"initial-setup",children:"Initial setup"}),"\n",(0,o.jsxs)(r.p,{children:["First, activate the relevant backend in ",(0,o.jsx)(r.code,{children:"pants.toml"}),":"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = [\n  ...\n  "pants.backend.experimental.terraform",\n  ...\n]\n'})}),"\n",(0,o.jsxs)(r.p,{children:["The Terraform backend also needs Python to run Pants's analysers. The setting ",(0,o.jsx)(r.code,{children:"[python].interpreter_constraints"})," will need to be set."]}),"\n",(0,o.jsxs)(r.p,{children:["Terraform needs git to download modules. Many providers and provisioners need additional binaries to be available on the PATH. Currently, you can forward your PATH by adding ",(0,o.jsx)(r.code,{children:'"PATH"'})," to ",(0,o.jsx)(r.code,{children:"[download-terraform].extra_env_vars"})," in ",(0,o.jsx)(r.code,{children:"pants.toml"}),", like:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-toml",metastring:"pants.toml",children:'[download-terraform]\nextra_env_vars = [\n  "PATH"\n]\n'})}),"\n",(0,o.jsx)(r.h3,{id:"adding-terraform-targets",children:"Adding Terraform targets"}),"\n",(0,o.jsx)(r.p,{children:"The Terraform backend has 2 target types:"}),"\n",(0,o.jsxs)(r.ul,{children:["\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"terraform_module"})," for Terraform source code"]}),"\n",(0,o.jsxs)(r.li,{children:[(0,o.jsx)(r.code,{children:"terraform_deployment"})," for deployments that can be deployed with the ",(0,o.jsx)(r.code,{children:"experimental-deploy"})," goal"]}),"\n"]}),"\n",(0,o.jsx)(r.h4,{id:"modules",children:"Modules"}),"\n",(0,o.jsxs)(r.p,{children:["The ",(0,o.jsx)(r.code,{children:"tailor"})," goal will automatically generate ",(0,o.jsx)(r.code,{children:"terraform_module"}),", ",(0,o.jsx)(r.code,{children:"terraform_backend"}),", and ",(0,o.jsx)(r.code,{children:"terraform_var_files"})," targets. Run ",(0,o.jsx)(r.a,{href:"/2.21/docs/getting-started/initial-configuration#5-generate-build-files",children:(0,o.jsx)(r.code,{children:"pants tailor ::"})}),". For example:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"\u276F pants tailor ::\nCreated src/terraform/root/BUILD:\n  - Add terraform_module target root\n"})}),"\n",(0,o.jsxs)(r.blockquote,{children:["\n",(0,o.jsxs)(r.p,{children:["\u{1F6A7} ",(0,o.jsx)(r.code,{children:"terraform_module"}),"s must be defined in a BUILD file in the same directory as the module sources"]}),"\n",(0,o.jsx)(r.p,{children:"Terraform only uses files in a single directory. The Pants Terraform plugin uses the directory of the BUILD file for this."}),"\n"]}),"\n",(0,o.jsx)(r.h4,{id:"deployments",children:"Deployments"}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"terraform_deployment"}),"s must be manually created. The deployment points to a ",(0,o.jsx)(r.code,{children:"terraform_module"})," target as its ",(0,o.jsx)(r.code,{children:"root_module"}),' field. This module will be the "root" module that Terraform operations will be run on. Identify backend configs with a ',(0,o.jsx)(r.code,{children:"terraform_backend"})," target, and var files with a ",(0,o.jsx)(r.code,{children:"terraform_var_files"})," target. Pants will automatically use ",(0,o.jsx)(r.code,{children:"terraform_backend"}),"s and ",(0,o.jsx)(r.code,{children:"terraform_var_files"})," in the same directory as a ",(0,o.jsx)(r.code,{children:"terraform_deployment"}),"."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:'terraform_module(name="root")\nterraform_deployment(name="prod", root_module=":root")\nterraform_backend(name="tfbackend", source="main.tfbackend")\nterraform_var_files(name="tfvars")\n'})}),"\n",(0,o.jsxs)(r.p,{children:["You can override this behaviour by explicitly specifying these in the ",(0,o.jsx)(r.code,{children:"dependencies"})," field."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:'terraform_module(name="root")\nterraform_backend(name="prod_backend", source="prod.tfbackend")\nterraform_deployment(name="prod", root_module=":root", dependencies=["prod_backend"])\nterraform_backend(name="test_backend", source="test.tfbackend")\nterraform_deployment(name="test", root_module=":root", dependencies=["test_backend"])\n'})}),"\n",(0,o.jsx)(r.h4,{id:"lockfiles",children:"Lockfiles"}),"\n",(0,o.jsxs)(r.p,{children:["Lockfiles will be loaded from the directory of the root module of a deployment, just like with the ",(0,o.jsx)(r.code,{children:"terraform"})," command."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-prod/BUILD",children:'terraform_deployment(name="prod", root_module="//tf:infrastructure")\n'})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-tf/BUILD",children:'terraform_module(name="infrastructure")\n'})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-tf/main.tf",children:'resource "null_resource" "dep" {}\n'})}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{className:"language-tf/.terraform.lock.hcl",children:'# This file is maintained automatically by "terraform init".\n# Manual edits may be lost in future updates.\n\nprovider "registry.terraform.io/hashicorp/null" {\n  version = "3.2.2"\n  hashes = [\n    "h1:zT1ZbegaAYHwQa+QwIFugArWikRJI9dqohj8xb0GY88=",\n    "zh:3248aae6a2198f3ec8394218d05bd5e42be59f43a3a7c0b71c66ec0df08b69e7",\n    "zh:32b1aaa1c3013d33c245493f4a65465eab9436b454d250102729321a44c8ab9a",\n    "zh:38eff7e470acb48f66380a73a5c7cdd76cc9b9c9ba9a7249c7991488abe22fe3",\n    "zh:4c2f1faee67af104f5f9e711c4574ff4d298afaa8a420680b0cb55d7bbc65606",\n    "zh:544b33b757c0b954dbb87db83a5ad921edd61f02f1dc86c6186a5ea86465b546",\n    "zh:696cf785090e1e8cf1587499516b0494f47413b43cb99877ad97f5d0de3dc539",\n    "zh:6e301f34757b5d265ae44467d95306d61bef5e41930be1365f5a8dcf80f59452",\n    "zh:78d5eefdd9e494defcb3c68d282b8f96630502cac21d1ea161f53cfe9bb483b3",\n    "zh:913a929070c819e59e94bb37a2a253c228f83921136ff4a7aa1a178c7cce5422",\n    "zh:aa9015926cd152425dbf86d1abdbc74bfe0e1ba3d26b3db35051d7b9ca9f72ae",\n    "zh:bb04798b016e1e1d49bcc76d62c53b56c88c63d6f2dfe38821afef17c416a0e1",\n    "zh:c23084e1b23577de22603cff752e59128d83cfecc2e6819edadd8cf7a10af11e",\n  ]\n}\n'})}),"\n",(0,o.jsxs)(r.p,{children:["Pants can generate and update lockfiles with the ",(0,o.jsx)(r.code,{children:"generate-lockfiles"})," command. Use the target of the ",(0,o.jsx)(r.code,{children:"terraform_module"}),"'s address as the resolve name. For example, ",(0,o.jsx)(r.code,{children:"pants generate-lockfiles --resolve=tf:infrastructure"}),"."]}),"\n",(0,o.jsx)(r.h3,{id:"basic-operations",children:"Basic Operations"}),"\n",(0,o.jsx)(r.h4,{id:"formatting",children:"Formatting"}),"\n",(0,o.jsxs)(r.p,{children:["Run ",(0,o.jsx)(r.code,{children:"terraform fmt"})," as part of the ",(0,o.jsx)(r.code,{children:"fix"}),", ",(0,o.jsx)(r.code,{children:"fmt"}),", or ",(0,o.jsx)(r.code,{children:"lint"})," goals."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"pants fix ::\n[INFO] Completed: pants.backend.terraform.lint.tffmt.tffmt.tffmt_fmt - terraform-fmt made no changes.\n\n\u2713 terraform-fmt made no changes.\n"})}),"\n",(0,o.jsx)(r.h4,{id:"validate",children:"Validate"}),"\n",(0,o.jsxs)(r.p,{children:["Run ",(0,o.jsx)(r.code,{children:"terraform validate"})," as part of the ",(0,o.jsx)(r.code,{children:"check"})," goal."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"pants check ::\n[INFO] Completed: pants.backend.terraform.goals.check.terraform_check - terraform-validate succeeded.\nSuccess! The configuration is valid.\n\n\u2713 terraform-validate succeeded.\n\n"})}),"\n",(0,o.jsxs)(r.p,{children:[(0,o.jsx)(r.code,{children:"terraform validate"}),' isn\'t valid for all Terraform modules. Some child modules, in particular those using aliased providers, need to have their providers provided by a "root" module. You can opt these modules out of ',(0,o.jsx)(r.code,{children:"validate"})," by setting ",(0,o.jsx)(r.code,{children:"skip_terraform_validate=True"}),". For example:"]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"terraform_module(skip_terraform_validate=True)\n"})}),"\n",(0,o.jsx)(r.h4,{id:"deploying",children:"Deploying"}),"\n",(0,o.jsx)(r.admonition,{title:"Terraform deployment support is in alpha stage",type:"caution",children:(0,o.jsx)(r.p,{children:"Many options and features aren't supported yet.\nFor the local state backend, use an absolute path."})}),"\n",(0,o.jsxs)(r.p,{children:["Run ",(0,o.jsx)(r.code,{children:"terraform apply"})," as part of the ",(0,o.jsx)(r.code,{children:"experimental-deploy"})," goal. The process is run interactively, so you will be prompted for variables and confirmation as usual."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"pants experimental-deploy ::\n[INFO] Deploying targets...\n--- 8< ---\nDo you want to perform these actions?\n  Terraform will perform the actions described above.\n  Only 'yes' will be accepted to approve.\n\n  Enter a value: yes\n--- 8< ---\nApply complete! Resources: 4 added, 0 changed, 0 destroyed.\n\n\u2713 testprojects/src/terraform/root:root deployed\n"})}),"\n",(0,o.jsxs)(r.p,{children:["You can set auto approve by adding ",(0,o.jsx)(r.code,{children:"-auto-approve"})," to the ",(0,o.jsx)(r.code,{children:"[download-terraform].args"})," setting in ",(0,o.jsx)(r.code,{children:"pants.toml"}),". You can also set it for a single pants invocation with ",(0,o.jsx)(r.code,{children:"--download-terraform-args='-auto-approve'"}),", for example ",(0,o.jsx)(r.code,{children:"pants experimental-deploy \"--download-terraform-args='-auto-approve'\""}),"."]}),"\n",(0,o.jsxs)(r.p,{children:["To run ",(0,o.jsx)(r.code,{children:"terraform plan"}),", use the ",(0,o.jsx)(r.code,{children:"--dry-run"})," flag of the ",(0,o.jsx)(r.code,{children:"experimental-deploy"})," goal."]}),"\n",(0,o.jsx)(r.pre,{children:(0,o.jsx)(r.code,{children:"pants experimental-deploy --dry-run ::\n"})})]})}function h(e={}){let{wrapper:r}={...(0,t.R)(),...e.components};return r?(0,o.jsx)(r,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},848193(e,r,n){n.d(r,{R:()=>d,x:()=>s});var a=n(830758);let o={},t=a.createContext(o);function d(e){let r=a.useContext(t);return a.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function s(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:d(e.components),a.createElement(t.Provider,{value:r},e.children)}},275610(e){e.exports=JSON.parse('{"id":"docs/terraform/index","title":"Terraform Overview","description":"---","source":"@site/versioned_docs/version-2.21/docs/terraform/index.mdx","sourceDirName":"docs/terraform","slug":"/docs/terraform/","permalink":"/2.21/docs/terraform/","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/terraform/index.mdx","tags":[],"version":"2.21","sidebarPosition":999,"frontMatter":{"title":"Terraform Overview","sidebar_position":999},"sidebar":"docsSidebar","previous":{"title":"Kubeconform","permalink":"/2.21/docs/helm/kubeconform"},"next":{"title":"Integrating new tools without plugins","permalink":"/2.21/docs/ad-hoc-tools/integrating-new-tools-without-plugins"}}')}}]);