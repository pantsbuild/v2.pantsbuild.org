"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["850161"],{967430(e,t,n){n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>s,toc:()=>c});var s=n(614772),i=n(886070),r=n(848193);let a={authors:["grihabor"],tags:[]},o="Simple versioning with git tags",l={authorsImageUrls:[void 0]},c=[];function h(e){let t={a:"a",code:"code",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["A frequently asked question on ",(0,i.jsx)(t.a,{href:"/community/getting-help",children:"Pants Slack"})," is how to\nset a version - such as for a docker image, helm chart or Python distribution -\nbased on git state."]}),"\n","\n",(0,i.jsx)(t.p,{children:"Pants does have various solutions for this, but they tend to be too\ncomplicated, or too limited:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/docs/using-pants/generating-version-tags-from-git",children:"Generating version tags from Git"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsxs)(t.a,{href:"https://www.pantsbuild.org/2.20/docs/writing-plugins/common-plugin-tasks/custom-python-artifact-kwargs",children:["Custom ",(0,i.jsx)(t.code,{children:"python_artifact()"})," kwargs"]})}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/reference/targets/vcs_version",children:"vcs_version"})," target"]}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/docs/docker/tagging-docker-images#using-env-vars-to-include-dynamic-data-in-tags",children:"Using env vars to include dynamic data in tags"})}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["It turns out there is a hack that elegantly solves this problem. To make it\nwork we need one more pants feature ",(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/docs/using-pants/key-concepts/options#pantsbootstrap-file",children:"hidden in the\ndocs"}),"\n\u2014 the ",(0,i.jsx)(t.code,{children:".pants.bootstrap"})," file. It makes it possible to automatically set the\n",(0,i.jsx)(t.code,{children:"VERSION"})," env var right before pants starts:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-bash",metastring:'title=".pants.bootstrap"',children:'#!/bin/sh\n\nVERSION="${VERSION:-$(git describe --tags --dirty --match "[0-9\\.]*" || echo 0.0.1)}"\nexport VERSION\n'})}),"\n",(0,i.jsx)(t.p,{children:"Now we can use the env var everywhere!"}),"\n",(0,i.jsxs)(t.p,{children:["To set ",(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/reference/targets/python_distribution",children:"docker_image"})," tag:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",metastring:'file="BUILD"',children:'docker_image(\n    name="image",\n    image_tags=[env("VERSION")],\n)\n'})}),"\n",(0,i.jsxs)(t.p,{children:["To pass ",(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/reference/targets/python_distribution",children:"docker_image"})," build arg:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",metastring:'file="BUILD"',children:'docker_image(\n    name="image",\n    extra_build_args=["VERSION=" + env("VERSION")],\n)\n'})}),"\n",(0,i.jsxs)(t.p,{children:["To set ",(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/reference/targets/python_distribution",children:"python_distribution"})," version:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",metastring:'file="BUILD"',children:'python_distribution(\n    name="mydist",\n    provides=python_artifact(\n        name="mydist",\n        version=env("VERSION"),\n    ),\n)\n'})}),"\n",(0,i.jsxs)(t.p,{children:["To set ",(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/2.20/reference/targets/helm_chart",children:"helm_chart"})," version:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",metastring:'file="BUILD"',children:'helm_chart(\n    version=env("VERSION"),\n)\n'})})]})}function d(e={}){let{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(h,{...e})}):h(e)}},848193(e,t,n){n.d(t,{R:()=>a,x:()=>o});var s=n(830758);let i={},r=s.createContext(i);function a(e){let t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),s.createElement(r.Provider,{value:t},e.children)}},614772(e){e.exports=JSON.parse('{"permalink":"/blog/2024/04/27/simple-versioning-with-git-tags","editUrl":"https://github.com/pantsbuild/pantsbuild.org/edit/main/blog/2024-04-27-simple-versioning-with-git-tags/index.mdx","source":"@site/blog/2024-04-27-simple-versioning-with-git-tags/index.mdx","title":"Simple versioning with git tags","description":"A frequently asked question on Pants Slack is how to","date":"2024-04-27T00:00:00.000Z","tags":[],"readingTime":1.38,"hasTruncateMarker":true,"authors":[{"name":"Gregory Borodin","title":"Pants Contributor","url":"https://github.com/grihabor","imageURL":"https://github.com/grihabor.png","key":"grihabor","page":null}],"frontMatter":{"authors":["grihabor"],"tags":[]},"unlisted":false,"prevItem":{"title":"Pants 2.21.0 is released!","permalink":"/blog/2024/05/29/pants-2-21"},"nextItem":{"title":"Pants 2.20.0 is released!","permalink":"/blog/2024/03/27/pants-2-20"}}')}}]);