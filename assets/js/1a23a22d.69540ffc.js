"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["351696"],{712173(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>t,toc:()=>h});var t=s(153880),r=s(886070),i=s(848193);let a={title:"GitHub Actions macOS ARM64 runners",sidebar_position:2},o,l={},h=[{value:"The machine",id:"the-machine",level:2},{value:"Connecting to the machine",id:"connecting-to-the-machine",level:2},{value:"SSH",id:"ssh",level:3},{value:"VNC",id:"vnc",level:3},{value:"Setting up the machine",id:"setting-up-the-machine",level:2},{value:"Change the initial password",id:"change-the-initial-password",level:3},{value:"SSH",id:"ssh-1",level:4},{value:"VNC",id:"vnc-1",level:4},{value:"Ensure smooth restarts",id:"ensure-smooth-restarts",level:3},{value:"SSH",id:"ssh-2",level:4},{value:"VNC",id:"vnc-2",level:4},{value:"Install software",id:"install-software",level:3},{value:"Create a role user",id:"create-a-role-user",level:3},{value:"SSH",id:"ssh-3",level:4},{value:"VNC",id:"vnc-3",level:4},{value:"Set up auto-login",id:"set-up-auto-login",level:3},{value:"Set up the role user",id:"set-up-the-role-user",level:3},{value:"Setting up the self-hosted runner",id:"setting-up-the-self-hosted-runner",level:2},{value:"Installing the runner",id:"installing-the-runner",level:3},{value:"Runner setup",id:"runner-setup",level:3},{value:"Testing it all out",id:"testing-it-all-out",level:2}];function c(e){let n={a:"a",br:"br",code:"code",h2:"h2",h3:"h3",h4:"h4",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:"Apple is phasing out their X86_64 hardware, and all new macOS systems are based on the M1 ARM64 processor. Pants must run on these systems, which means we need an M1 CI machine on which to test and package Pants."}),"\n",(0,r.jsxs)(n.p,{children:["Unfortunately, GitHub Actions does not yet have hosted runners for MacOS ARM64. So we must run our own self-hosted runner. This document describes how to set one up. It is intended primarily for Pants maintainers who have to maintain our CI infrastructure, but since there is not much information online about how to set up self-hosted runners on M1, it may be useful as a reference to other projects as well. One useful resource we did find is ",(0,r.jsx)(n.a,{href:"https://betterprogramming.pub/run-github-actions-self-hosted-macos-runners-on-apple-m1-mac-b559acd6d783",children:"this blog post"})," by Soumya Mahunt, so our thanks to them."]}),"\n",(0,r.jsxs)(n.p,{children:["If you find any errors or omissions in this page, please let us know on ",(0,r.jsx)(n.a,{href:"/community/getting-help#slack",children:"Slack"}),' or provide corrections via the "Suggest Edits" link above.']}),"\n",(0,r.jsx)(n.h2,{id:"the-machine",children:"The machine"}),"\n",(0,r.jsx)(n.p,{children:"As yet there aren't many options for a hosted M1 system:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["AWS has a ",(0,r.jsx)(n.a,{href:"https://aws.amazon.com/about-aws/whats-new/2021/12/amazon-ec2-m1-mac-instances-macos/",children:"preview program"}),", which you can sign up for and hope to get into. Once these instances are generally available we can evaluate them as a solution."]}),"\n",(0,r.jsxs)(n.li,{children:["You can buy an M1 machine and stick it in a closet. You take on the risk of compromising your",(0,r.jsx)(n.br,{}),"\n","network if the machine is compromised by a rogue CI job."]}),"\n",(0,r.jsxs)(n.li,{children:["You can rent a cloud-hosted M1 machine by the month from ",(0,r.jsx)(n.a,{href:"https://www.macstadium.com/",children:"MacStadium"}),"."]}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"We've gone with the MacStadium approach for now."}),"\n",(0,r.jsx)(n.h2,{id:"connecting-to-the-machine",children:"Connecting to the machine"}),"\n",(0,r.jsxs)(n.p,{children:["Since this is machine is ",(0,r.jsx)(n.a,{href:"https://iamondemand.com/blog/devops-concepts-pets-vs-cattle/",children:"a pet, not cattle"}),", we allow ourselves a somewhat manual, bespoke setup process (we can script this up if it becomes necessary). There are two ways to connect to the machine:"]}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Via VNC remote desktop from another macOS machine (not necessarily an M1)"}),"\n",(0,r.jsx)(n.li,{children:"Via SSH"}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["In both cases, the first few setup steps will be done as the user ",(0,r.jsx)(n.code,{children:"administrator"})," and the initial password for that user is provided by MacStadium. Once we create a role user, the subsequent steps will be run as that user."]}),"\n",(0,r.jsx)(n.h3,{id:"ssh",children:"SSH"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",metastring:'title="Shell"',children:"$ ssh administrator@XXX.XXX.XXX.XXX\n(administrator@XXX.XXX.XXX.XXX) Password:\n%\n"})}),"\n",(0,r.jsx)(n.h3,{id:"vnc",children:"VNC"}),"\n",(0,r.jsxs)(n.p,{children:["Enter ",(0,r.jsx)(n.code,{children:"vnc://XXX.XXX.XXX.XXX"})," on the local machine's Safari address bar, substituting the machine's IP address, as given to you by MacStadium. Safari will prompt you to allow it to open the Screen Sharing app."]}),"\n",(0,r.jsx)(n.p,{children:"Screen Sharing will give you a login prompt. Once logged in, you can control the remote machine's desktop in the Screen Sharing window, and even share the clipboard across the two machines."}),"\n",(0,r.jsx)(n.p,{children:"In this mode you can use the remote machine's desktop UI to make changes, or you can open a terminal and issue the same commands you would via SSH."}),"\n",(0,r.jsx)(n.p,{children:"A few of the steps below will have both SSH and VNC options, others only SSH (or terminal window in a remote desktop), or only VNC."}),"\n",(0,r.jsx)(n.h2,{id:"setting-up-the-machine",children:"Setting up the machine"}),"\n",(0,r.jsx)(n.h3,{id:"change-the-initial-password",children:"Change the initial password"}),"\n",(0,r.jsxs)(n.p,{children:["The first step is to change the initial ",(0,r.jsx)(n.code,{children:"administrator"})," password to something secure, since the initial password appears as cleartext in the MacStadium ticket"]}),"\n",(0,r.jsx)(n.h4,{id:"ssh-1",children:"SSH"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:"# Will prompt for both the new and old passwords\n% dscl . -passwd /Users/administrator\n"})}),"\n",(0,r.jsx)(n.h4,{id:"vnc-1",children:"VNC"}),"\n",(0,r.jsx)(n.p,{children:'Go to \uF8FF > System Preferences > Users & Groups, select the administrator user, click "Change Password..." and select a strong password.'}),"\n",(0,r.jsx)(n.h3,{id:"ensure-smooth-restarts",children:"Ensure smooth restarts"}),"\n",(0,r.jsx)(n.h4,{id:"ssh-2",children:"SSH"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",metastring:'title="Shell"',children:"# Ensure that this shows a value of 1\n% pmset -g | grep autorestart\n# If it does not, run this\n% sudo pmset -a autorestart 1\n"})}),"\n",(0,r.jsx)(n.h4,{id:"vnc-2",children:"VNC"}),"\n",(0,r.jsx)(n.p,{children:"Go to \uF8FF > System Preferences > Energy Saver and ensure that Restart After Power Failure is checked."}),"\n",(0,r.jsx)(n.h3,{id:"install-software",children:"Install software"}),"\n",(0,r.jsxs)(n.p,{children:["Perform the following setup steps as ",(0,r.jsx)(n.code,{children:"administrator"}),", some steps may request your password:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",metastring:'title="Shell"',children:'# Install Rosetta 2, will prompt to accept a license agreement\n% softwareupdate --install-rosetta\n\n# Install XCode command-line tools\n# IMPORTANT: This pops up a license agreement window on the desktop,\n#  so you must use VNC to accept the license and complete the installation.\n% xcode-select --install\n\n# Install Homebrew\n% /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"\n% echo \'eval "$(/opt/homebrew/bin/brew shellenv)"\' >> /Users/administrator/.zshenv\n% eval "$(/opt/homebrew/bin/brew shellenv)"\n\n# Install pyenv\n% brew install pyenv\n\n# Set up pyenv\n% echo \'export PYENV_ROOT="$HOME/.pyenv"\' >> ~/.zshenv\n% echo \'command -v pyenv >/dev/null || export PATH="$PYENV_ROOT/bin:$PATH"\' >> ~/.zshenv\n% echo \'eval "$(pyenv init -)"\' >> ~/.zshenv\n% source ~/.zshenv\n\n# Install the AWS CLI\n% brew install awscli\n\n\n\n'})}),"\n",(0,r.jsx)(n.h3,{id:"create-a-role-user",children:"Create a role user"}),"\n",(0,r.jsx)(n.p,{children:"We don't want to run actions as the administrator user, so we create a role account."}),"\n",(0,r.jsx)(n.h4,{id:"ssh-3",children:"SSH"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-shell",children:'# Will prompt for password\n% sudo sysadminctl  -addUser gha -fullName "GitHub Actions Runner" -password -\n\n# Allow ssh\'ing as gha\n% sudo dseditgroup -o edit -a gha -t user com.apple.access_ssh\n'})}),"\n",(0,r.jsx)(n.h4,{id:"vnc-3",children:"VNC"}),"\n",(0,r.jsxs)(n.p,{children:["Go to \uF8FF > System Preferences > Users & Groups and create a Standard account with the full name ",(0,r.jsx)(n.code,{children:"GitHub Actions Runner"}),", the account name ",(0,r.jsx)(n.code,{children:"gha"})," and a strong password."]}),"\n",(0,r.jsx)(n.h3,{id:"set-up-auto-login",children:"Set up auto-login"}),"\n",(0,r.jsxs)(n.p,{children:["This must be done from the remote desktop, via VNC, as ",(0,r.jsx)(n.code,{children:"administrator"}),"."]}),"\n",(0,r.jsx)(n.p,{children:"Go to \uF8FF > System Preferences > Users & Groups, and click the lock to make changes."}),"\n",(0,r.jsxs)(n.p,{children:["Click on Login Options and for Automatic login choose Github Actions Runner. Enter the ",(0,r.jsx)(n.code,{children:"gha"})," user's password when prompted."]}),"\n",(0,r.jsx)(n.h3,{id:"set-up-the-role-user",children:"Set up the role user"}),"\n",(0,r.jsxs)(n.p,{children:["Perform the following setup steps after SSHing in as the ",(0,r.jsx)(n.code,{children:"gha"})," role user:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"# Set up Homebrew\n% echo 'export PATH=$PATH:/opt/homebrew/bin/' >> ~/.zshenv\n...\n# Set up pyenv\n% echo 'export PYENV_ROOT=\"$HOME/.pyenv\"' >> ~/.zshenv\n% echo 'command -v pyenv >/dev/null || export PATH=\"$PYENV_ROOT/bin:$PATH\"' >> ~/.zshenv\n% echo 'eval \"$(pyenv init -)\"' >> ~/.zshenv\n% source ~/.zshenv\n...\n# Install Python 3.9\n% pyenv install 3.9.13\n% pyenv global 3.9.13\n...\n# Install rustup\n% curl https://sh.rustup.rs -sSf | sh -s -- -y\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Note that we use ",(0,r.jsx)(n.code,{children:".zshenv"})," because the runner will not execute in an interactive shell."]}),"\n",(0,r.jsx)(n.h2,{id:"setting-up-the-self-hosted-runner",children:"Setting up the self-hosted runner"}),"\n",(0,r.jsx)(n.h3,{id:"installing-the-runner",children:"Installing the runner"}),"\n",(0,r.jsxs)(n.p,{children:["On the GitHub repo's page, go to ",(0,r.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/settings/actions/runners",children:"Settings > Actions > Runners"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:['Click "New self-hosted runner", select macOS and run all the Download and Configure commands it displays, as ',(0,r.jsx)(n.code,{children:"gha"}),", on the remote machine. Set the labels to [",(0,r.jsx)(n.code,{children:"self-hosted"}),", ",(0,r.jsx)(n.code,{children:"macOS"}),", ",(0,r.jsx)(n.code,{children:"ARM64"}),", ",(0,r.jsx)(n.code,{children:"macOS11"}),"]."]}),"\n",(0,r.jsx)(n.p,{children:"Accept the default values for other settings."}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Note:"})," The ARM64 GitHub Actions runner binary is still in pre-release status. If you don't want to rely on it, you can use the stable X86_64 binary under Rosetta. However in this case its subprocesses will run in X86_64 mode by default as well. So CI processes that care about platform (such as those that build and package native code) must be invoked with the ",(0,r.jsx)(n.code,{children:"arch -arm64"})," prefix. Note that in this case GHA will always set the ",(0,r.jsx)(n.code,{children:"X64"})," label on the runner, so be careful not to use that label for runner selection in your workflows if you also have X86_64 self-hosted runners."]}),"\n",(0,r.jsx)(n.h3,{id:"runner-setup",children:"Runner setup"}),"\n",(0,r.jsxs)(n.p,{children:["As ",(0,r.jsx)(n.code,{children:"gha"}),", run:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"% cd actions-runner\n\n# Ensure that the runner starts when the machine starts.\n% ./svc.sh install\n\n# Set up some env vars the runner requires.\n% echo 'ImageOS=macos11' >> .env\n% echo \"XCODE_11_DEVELOPER_DIR=$(xcode-select -p)\" >> .env\n"})}),"\n",(0,r.jsx)(n.h2,{id:"testing-it-all-out",children:"Testing it all out"}),"\n",(0,r.jsxs)(n.p,{children:["Now use the MacStadium web UI to restart the machine. Once it comes back up it",(0,r.jsx)(n.br,{}),"\n","should be able to pick up any job with this setting:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"    runs-on:\n      - self-hosted\n      - macOS11\n      - ARM64\n"})})]})}function d(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},848193(e,n,s){s.d(n,{R:()=>a,x:()=>o});var t=s(830758);let r={},i=t.createContext(r);function a(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),t.createElement(i.Provider,{value:n},e.children)}},153880(e){e.exports=JSON.parse('{"id":"docs/contributions/releases/github-actions-macos-arm64-runners","title":"GitHub Actions macOS ARM64 runners","description":"---","source":"@site/versioned_docs/version-2.15/docs/contributions/releases/github-actions-macos-arm64-runners.mdx","sourceDirName":"docs/contributions/releases","slug":"/docs/contributions/releases/github-actions-macos-arm64-runners","permalink":"/2.15/docs/contributions/releases/github-actions-macos-arm64-runners","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/contributions/releases/github-actions-macos-arm64-runners.mdx","tags":[],"version":"2.15","sidebarPosition":2,"frontMatter":{"title":"GitHub Actions macOS ARM64 runners","sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"Release process","permalink":"/2.15/docs/contributions/releases/release-process"}}')}}]);