"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["325785"],{73391(e,t,s){s.r(t),s.d(t,{assets:()=>d,contentTitle:()=>l,default:()=>h,frontMatter:()=>a,metadata:()=>n,toc:()=>o});var n=s(461528),r=s(886070),i=s(848193);let a={title:"Targets and BUILD files",sidebar_position:1},l,d={},o=[{value:"BUILD files",id:"build-files",level:2},{value:"Environment variables",id:"environment-variables",level:3},{value:"Multiple BUILD files in a directory",id:"multiple-build-files-in-a-directory",level:3},{value:"Target addresses",id:"target-addresses",level:2},{value:"<code>source</code> and <code>sources</code> field",id:"source-and-sources-field",level:2},{value:"<code>dependencies</code> field",id:"dependencies-field",level:2},{value:"Using the generic <code>target</code>",id:"using-the-generic-target",level:2},{value:"Referring to a group of targets",id:"referring-to-a-group-of-targets",level:3},{value:"Creating aliases for targets",id:"creating-aliases-for-targets",level:3},{value:"Field default values",id:"field-default-values",level:2},{value:"Supporting optional plugin fields",id:"supporting-optional-plugin-fields",level:3},{value:"Extending field defaults",id:"extending-field-defaults",level:3},{value:"Target generation",id:"target-generation",level:2},{value:"Parametrizing targets",id:"parametrizing-targets",level:2}];function c(e){let t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.p,{children:"Metadata for your code."}),"\n",(0,r.jsx)(t.hr,{}),"\n",(0,r.jsx)(t.p,{children:"Most goals require metadata about your code. For example, to run a test, you need to know about all the transitive dependencies of that test. You may also want to set a timeout on that test."}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.em,{children:"Targets"})," are an ",(0,r.jsx)(t.em,{children:"addressable"})," set of metadata describing your code."]}),"\n",(0,r.jsx)(t.p,{children:"For example:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"shell_source"})," and ",(0,r.jsx)(t.code,{children:"python_test"})," describe first-party code"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"python_requirement"})," describes third-party requirements"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"pex_binary"})," and ",(0,r.jsx)(t.code,{children:"archive"})," describe artifacts you'd like Pants to build"]}),"\n"]}),"\n",(0,r.jsx)(t.p,{children:"To reduce boilerplate, some targets also generate other targets:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"python_tests"})," -> ",(0,r.jsx)(t.code,{children:"python_test"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"shell_sources"})," -> ",(0,r.jsx)(t.code,{children:"shell_source"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"go_mod"})," -> ",(0,r.jsx)(t.code,{children:"go_third_party_package"})]}),"\n"]}),"\n",(0,r.jsx)(t.h2,{id:"build-files",children:"BUILD files"}),"\n",(0,r.jsxs)(t.p,{children:["Targets are defined in files with the name ",(0,r.jsx)(t.code,{children:"BUILD"}),". For example:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="helloworld/greet/BUILD"',children:'python_tests(\n    name="tests",\n    timeout=120,\n)\n\npex_binary(\n    name="bin",\n    entry_point="app.py:main",\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Each target type has different ",(0,r.jsx)(t.em,{children:"fields"}),", or individual metadata values. Run ",(0,r.jsx)(t.code,{children:"pants help $target"})," to see which fields a particular target type has, e.g. ",(0,r.jsx)(t.code,{children:"pants help file"}),". Most fields are optional and use sensible defaults. See ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/key-concepts/targets-and-build-files#field-default-values",children:"Field default values"})," for how you may override a field's default value."]}),"\n",(0,r.jsxs)(t.p,{children:["All target types have a ",(0,r.jsx)(t.code,{children:"name"})," field, which is used to identify the target. Target names must be unique within a directory."]}),"\n",(0,r.jsxs)(t.p,{children:["You can autoformat ",(0,r.jsx)(t.code,{children:"BUILD"})," files by enabling a ",(0,r.jsx)(t.code,{children:"BUILD"})," file formatter by adding it to ",(0,r.jsx)(t.code,{children:"[GLOBAL].backend_packages"})," in ",(0,r.jsx)(t.code,{children:"pants.toml"})," (such as ",(0,r.jsx)(t.code,{children:"pants.backend.build_files.fmt.black"})," ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/key-concepts/backends",children:"or others"}),"). Then to format, run ",(0,r.jsx)(t.code,{children:"pants fmt '**/BUILD'"})," or ",(0,r.jsx)(t.code,{children:"pants fmt ::"})," (formats everything)."]}),"\n",(0,r.jsx)(t.h3,{id:"environment-variables",children:"Environment variables"}),"\n",(0,r.jsxs)(t.p,{children:["BUILD files are very hermetic in nature with no support for using ",(0,r.jsx)(t.code,{children:"import"})," or other I/O operations. In order to have dynamic data in BUILD files, you may inject values from the local environment using the ",(0,r.jsx)(t.code,{children:"env()"})," function. It takes the variable name and optional default value as arguments."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="helloworld/pkg/BUILD"',children:'python_distribution(\n  name="helloworld-dist",\n  description=env("DIST_DESC", "Set the `DIST_DESC` env variable to override this value."),\n  provides=python_artifact(\n    name="helloworld",\n    version=env("HELLO_WORLD_VERSION"),\n  ),\n)\n'})}),"\n",(0,r.jsx)(t.h3,{id:"multiple-build-files-in-a-directory",children:"Multiple BUILD files in a directory"}),"\n",(0,r.jsx)(t.p,{children:"Typically, there would be one BUILD file in every directory containing source code and any other resources you\nmay want to use as part of your builds. Most likely, having just one BUILD file in a directory is also what you would want.\nHowever, you can have multiple BUILD files in a single directory, if desired. When running a Pants goal, the contents\nof the BUILD files will be merged making it possible to better group your targets."}),"\n",(0,r.jsx)(t.p,{children:"Storing targets in multiple BUILD files also makes it possible to dynamically include or exclude targets from your\nbuilds. For example, you could include some experimental targets when running a Pants goal from a command line by\nextending the list of recognized BUILD file patterns:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"$ pants --build-patterns=\"+['BUILD.experimental']\" package project:app\n"})}),"\n",(0,r.jsx)(t.h2,{id:"target-addresses",children:"Target addresses"}),"\n",(0,r.jsxs)(t.p,{children:["A target is identified by its unique address, in the form ",(0,r.jsx)(t.code,{children:"path/to/dir:name"}),". The above example has the addresses ",(0,r.jsx)(t.code,{children:"helloworld/greet:tests"})," and ",(0,r.jsx)(t.code,{children:"helloworld/greet:bin"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Addresses are used in the ",(0,r.jsx)(t.code,{children:"dependencies"})," field to depend on other targets. Addresses can also be used as command-line arguments, such as ",(0,r.jsx)(t.code,{children:"pants fmt path/to:tgt"}),"."]}),"\n",(0,r.jsx)(t.p,{children:'(Both "generated targets" and "parametrized targets" have a variant of this syntax; see the below sections.)'}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["Default for the ",(0,r.jsx)(t.code,{children:"name"})," field"]}),(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"name"})," field defaults to the directory name. So, this target has the address ",(0,r.jsx)(t.code,{children:"helloworld/greet:greet"}),"."]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:"# helloworld/greet/BUILD\npython_sources()\n"})})]}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["Use ",(0,r.jsx)(t.code,{children:"//:tgt"})," for the root of your repository"]}),(0,r.jsxs)(t.p,{children:["Addresses defined in the ",(0,r.jsx)(t.code,{children:"BUILD"})," file at the root of your repository are prefixed with ",(0,r.jsx)(t.code,{children:"//"}),", e.g. ",(0,r.jsx)(t.code,{children:"//:my_tgt"}),"."]})]}),"\n",(0,r.jsxs)(t.h2,{id:"source-and-sources-field",children:[(0,r.jsx)(t.code,{children:"source"})," and ",(0,r.jsx)(t.code,{children:"sources"})," field"]}),"\n",(0,r.jsxs)(t.p,{children:["Targets like ",(0,r.jsx)(t.code,{children:"python_test"})," and ",(0,r.jsx)(t.code,{children:"resource"})," have a ",(0,r.jsx)(t.code,{children:"source: str"})," field, while target generators like ",(0,r.jsx)(t.code,{children:"python_tests"})," and ",(0,r.jsx)(t.code,{children:"resources"})," have a ",(0,r.jsx)(t.code,{children:"sources: list[str]"})," field. This determines which source files belong to the target."]}),"\n",(0,r.jsxs)(t.p,{children:["Values are relative to the BUILD file's directory. Sources must be in or below this directory, i.e. ",(0,r.jsx)(t.code,{children:"../"})," is not allowed."]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"sources"})," field also supports ",(0,r.jsx)(t.code,{children:"_"})," and ",(0,r.jsx)(t.code,{children:"**"})," as globs. To exclude a file or glob, prefix with ",(0,r.jsx)(t.code,{children:"!"}),". For example, ",(0,r.jsx)(t.code,{children:'["_.py", "!exclude_*.py"]'})," will include ",(0,r.jsx)(t.code,{children:"f.py"})," but not ",(0,r.jsx)(t.code,{children:"exclude_me.py"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="BUILD"',children:'resource(name="logo", source="logo.png")\n\npython_tests(\n    name="tests",\n    sources=["*_test.py"],\n)\n'})}),"\n",(0,r.jsxs)(t.admonition,{type:"caution",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["Be careful with overlapping ",(0,r.jsx)(t.code,{children:"source"})," fields"]}),(0,r.jsxs)(t.p,{children:["It's legal to include the same file in the ",(0,r.jsx)(t.code,{children:"source"})," / ",(0,r.jsx)(t.code,{children:"sources"})," field for multiple targets."]}),(0,r.jsxs)(t.p,{children:["When would you do this? Sometimes you may have conflicting metadata for the same source file, such as wanting to check that a Shell test works with multiple shells. Normally, you should prefer Pants's ",(0,r.jsx)(t.code,{children:"parametrize"}),' mechanism to do this. See the below section "Parametrizing Targets".']}),(0,r.jsxs)(t.p,{children:["Often, however, it is not intentional when multiple targets own the same file. For example, this often happens when using ",(0,r.jsx)(t.code,{children:"**"})," globs, like this:"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'# project/BUILD\npython_sources(sources=["**/*.py"])\n\n# project/subdir/BUILD\npython_sources(sources=["**/*.py"])\n'})}),(0,r.jsxs)(t.p,{children:["Including the same file in the ",(0,r.jsx)(t.code,{children:"source"})," / ",(0,r.jsx)(t.code,{children:"sources"})," field for multiple targets can result in two confusing behaviors:"]}),(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["File arguments will run over all owning targets, e.g. ",(0,r.jsx)(t.code,{children:"pants test path/to/test.ext"})," would run both test targets as two separate subprocesses, even though you might only expect a single subprocess."]}),"\n",(0,r.jsxs)(t.li,{children:["Pants will sometimes no longer be able to infer dependencies on this file because it cannot disambiguate which of the targets you want to use. You must use explicit dependencies instead. (For some blessed fields, like the ",(0,r.jsx)(t.code,{children:"resolve"})," field, if the targets have different values, then there will not be ambiguity.)"]}),"\n"]}),(0,r.jsxs)(t.p,{children:["You can run ",(0,r.jsx)(t.code,{children:"pants list path/to/file.ext"}),' to see all "owning" targets to check if >1 target has the file in its ',(0,r.jsx)(t.code,{children:"source"})," field."]})]}),"\n",(0,r.jsxs)(t.h2,{id:"dependencies-field",children:[(0,r.jsx)(t.code,{children:"dependencies"})," field"]}),"\n",(0,r.jsx)(t.p,{children:"A target's dependencies determines which other first-party code and third-party requirements to include when building the target."}),"\n",(0,r.jsxs)(t.p,{children:["Usually, you leave off the ",(0,r.jsx)(t.code,{children:"dependencies"})," field thanks to ",(0,r.jsx)(t.em,{children:"dependency inference"}),". Pants will read your import statements and map those imports back to your first-party code and your third-party requirements. You can run ",(0,r.jsx)(t.code,{children:"pants dependencies path/to:target"})," to see what dependencies Pants infers."]}),"\n",(0,r.jsxs)(t.p,{children:["However, dependency inference cannot infer everything, such as dependencies on ",(0,r.jsx)(t.code,{children:"resource"})," and ",(0,r.jsx)(t.code,{children:"file"})," targets."]}),"\n",(0,r.jsxs)(t.p,{children:["To add an explicit dependency, add the target's address to the ",(0,r.jsx)(t.code,{children:"dependencies"})," field. This augments any dependencies that were inferred."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="helloworld/greet/BUILD"',children:'python_sources(\n    name="lib",\n    dependencies=[\n        "3rdparty/python:ansicolors",\n        "assets:logo",\n    ],\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["You only need to declare direct dependencies. Pants will pull in ",(0,r.jsx)(t.em,{children:"transitive dependencies"}),"\u2014i.e. the dependencies of your dependencies\u2014for you."]}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["Relative addresses, ",(0,r.jsx)(t.code,{children:":tgt"})]}),(0,r.jsxs)(t.p,{children:["When depending on a target defined in the same BUILD file, you can simply use ",(0,r.jsx)(t.code,{children:":tgt_name"}),", rather than ",(0,r.jsx)(t.code,{children:"helloworld/greet:tgt_name"}),", for example."]}),(0,r.jsxs)(t.p,{children:["Addresses for generated targets also support relative addresses in the ",(0,r.jsx)(t.code,{children:"dependencies"}),' field, as explained in the "Target Generation" section below.']})]}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:["Ignore dependencies with ",(0,r.jsx)(t.code,{children:"!"})," and ",(0,r.jsx)(t.code,{children:"!!"})]}),(0,r.jsxs)(t.p,{children:["If you don't like that Pants inferred a certain dependency\u2014as reported by ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/project-introspection",children:(0,r.jsx)(t.code,{children:"pants dependencies path/to:tgt"})}),"\u2014tell Pants to ignore it with ",(0,r.jsx)(t.code,{children:"!"}),":"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'python_sources(\n    name="lib",\n    dependencies=["!3rdparty/python:numpy"],\n)\n'})}),(0,r.jsxs)(t.p,{children:["You can use the prefix ",(0,r.jsx)(t.code,{children:"!!"})," to transitively exclude a dependency, meaning that even if a target's dependencies include the bad dependency, the final result will not include the value."]}),(0,r.jsxs)(t.p,{children:["Transitive excludes can only be used in target types that conventionally are not depended upon by other targets, such as ",(0,r.jsx)(t.code,{children:"pex_binary"}),", ",(0,r.jsx)(t.code,{children:"python_distribution"}),", and ",(0,r.jsx)(t.code,{children:"python_test"})," / ",(0,r.jsx)(t.code,{children:"python_tests"}),". This is meant to limit confusion, as using ",(0,r.jsx)(t.code,{children:"!!"})," in something like a ",(0,r.jsx)(t.code,{children:"python_source"})," / ",(0,r.jsx)(t.code,{children:"python_sources"})," target could result in surprising behavior for everything that depends on it. (Pants will print a helpful error when using ",(0,r.jsx)(t.code,{children:"!!"})," when it's not legal.)"]})]}),"\n",(0,r.jsxs)(t.h2,{id:"using-the-generic-target",children:["Using the generic ",(0,r.jsx)(t.code,{children:"target"})]}),"\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"../../..reference/targets/target",children:(0,r.jsx)(t.code,{children:"target"})})," is a generic target with no specific type.\nIt can be used as a generic collection of targets to group related, but distinct targets into one single target."]}),"\n",(0,r.jsx)(t.h3,{id:"referring-to-a-group-of-targets",children:"Referring to a group of targets"}),"\n",(0,r.jsxs)(t.p,{children:["You could use the generic ",(0,r.jsx)(t.code,{children:"target"})," when you need to group multiple targets to refer to them as a unit\n(a single dependency) to reduce repetition:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="BUILD"',children:'target(\n    name="python-libs",\n    dependencies=["src/python/libraries/libA", "src/python/libraries/libB"],\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["If declared in the root of your workspace, you can now address the Python libraries by ",(0,r.jsx)(t.code,{children:"//:python-libs"}),":"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"$ pants dependencies //:python-libs\n"})}),"\n",(0,r.jsx)(t.h3,{id:"creating-aliases-for-targets",children:"Creating aliases for targets"}),"\n",(0,r.jsx)(t.p,{children:"If you have some targets declared in BUILD files that are stored deep within the directory structure of your workspace,\nyou can make it easier to refer to that target when listing that target among dependencies of other targets."}),"\n",(0,r.jsx)(t.p,{children:"For example, you can simplify accessing a target by creating another target that will serve as an alias definition in\na BUILD file stored in a more convenient location in the workspace, for instance, in the build root directory:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="BUILD"',children:'target(\n    name="deployment-bins",\n    dependencies=["src/golang/production/cloud/deployment/binaries:tools"]\n)\n'})}),"\n",(0,r.jsx)(t.p,{children:"You can now refer to that target more concisely in BUILD files:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="BUILD"',children:'python_sources(dependencies=["//:deployment-bins"])\n'})}),"\n",(0,r.jsx)(t.h2,{id:"field-default-values",children:"Field default values"}),"\n",(0,r.jsxs)(t.p,{children:["As mentioned above in ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/key-concepts/targets-and-build-files#build-files",children:"BUILD files"}),", most target fields have sensible defaults. And it's easy to override those values on a specific target. But applying the same non-default value on many targets can get unwieldy, error-prone and hard to maintain. Enter ",(0,r.jsx)(t.code,{children:"__defaults__"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Alternative default field values are set using the ",(0,r.jsx)(t.code,{children:"__defaults__"})," BUILD file symbol, and apply to targets in the filesystem tree under that BUILD file's directory."]}),"\n",(0,r.jsx)(t.p,{children:"The defaults are provided as a dictionary mapping target types to the default field values. Multiple target types may share the same set of default field values, when grouped together in parentheses (as a Python tuple)."}),"\n",(0,r.jsxs)(t.p,{children:["Use the ",(0,r.jsx)(t.code,{children:"all"})," keyword argument to provide default field values that should apply to all targets."]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"extend=True"})," keyword argument allows to add to any existing default field values set by a previous ",(0,r.jsx)(t.code,{children:"__defaults__"})," call rather than replacing them."]}),"\n",(0,r.jsxs)(t.p,{children:["Default fields and values are validated against their target types, except when provided using the ",(0,r.jsx)(t.code,{children:"all"})," keyword, in which case only values for fields applicable to each target are validated. Use ",(0,r.jsx)(t.code,{children:"ignore_unknown_fields=True"})," to ignore invalid fields."]}),"\n",(0,r.jsxs)(t.p,{children:["This means, that it is legal to provide a default value for ",(0,r.jsx)(t.code,{children:"all"})," targets, even if it is only a subset of targets that actually supports that particular field."]}),"\n",(0,r.jsxs)(t.admonition,{type:"note",children:[(0,r.jsxs)(t.mdxAdmonitionTitle,{children:[(0,r.jsx)(t.code,{children:"__defaults__"})," does not apply to environment targets."]}),(0,r.jsxs)(t.p,{children:["The environment targets (such as ",(0,r.jsx)(t.code,{children:"local_environment"})," and ",(0,r.jsx)(t.code,{children:"docker_environment"})," etc) are special and used during a bootstrap phase before any targets are defined and as such can not be targeted by the ",(0,r.jsx)(t.code,{children:"__defaults__"})," construct."]})]}),"\n",(0,r.jsx)(t.p,{children:"Examples:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="src/example/BUILD"',children:'    # Provide default `tags` to all targets in this subtree, and skip black, where applicable.\n    __defaults__(all=dict(tags=["example"], skip_black=True))\n'})}),"\n",(0,r.jsx)(t.p,{children:"Subdirectories may override defaults from a parent BUILD file:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="src/example/override/BUILD"',children:'    # For `files` and `resources` targets, we want to use some other defaults.\n    __defaults__({\n      (files, resources): dict(tags=["example", "overridden"], description="Our assets")\n    })\n'})}),"\n",(0,r.jsxs)(t.p,{children:["Use the ",(0,r.jsx)(t.code,{children:"extend=True"})," keyword to update defaults rather than replace them, for any given target."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="src/example/extend/BUILD"',children:'    # Add a default description to all types, in addition to the inherited default tags.\n    __defaults__(extend=True, all=dict(description="Add default description to the defaults."))\n'})}),"\n",(0,r.jsx)(t.p,{children:"To reset any modified defaults, simply override with the empty dict:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="src/example/nodefaults/BUILD"',children:"    __defaults__(all={})\n"})}),"\n",(0,r.jsx)(t.h3,{id:"supporting-optional-plugin-fields",children:"Supporting optional plugin fields"}),"\n",(0,r.jsxs)(t.p,{children:["Normally Pants presents an error message when attempting to provide a default value for a field that doesn't exist for the target. However, some fields comes from plugins, and to support disabling a plugin without having to remove any default values referencing any plugin fields it was providing, there is a ",(0,r.jsx)(t.code,{children:"ignore_unknown_fields"})," option to use:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="example/BUILD"',children:"    __defaults__(\n      {\n        # Defaults...\n      },\n      ignore_unknown_fields=True,\n    )\n"})}),"\n",(0,r.jsx)(t.h3,{id:"extending-field-defaults",children:"Extending field defaults"}),"\n",(0,r.jsxs)(t.p,{children:["To add to a default value rather than replacing it, the current default value for a target field is available in the BUILD file using ",(0,r.jsx)(t.code,{children:"<target>.<field>.default"}),". This allows you to augment a field's default value with much more precision. As an example, if you want to make the default sources for a ",(0,r.jsx)(t.code,{children:"python_sources"})," target to work recursively you may specify a target augmenting the default sources field:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="BUILD"',children:'python_sources(\n  name="my-one-top-level-target",\n  sources=[\n    f"{pattern[0] if pattern.startswith("!") else ""}**/{pattern.lstrip("!")}"\n    for pattern in python_sources.sources.default\n  ]\n)\n'})}),"\n",(0,r.jsx)(t.h2,{id:"target-generation",children:"Target generation"}),"\n",(0,r.jsx)(t.p,{children:"To reduce boilerplate, Pants provides target types that generate other targets. For example:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"files"})," -> ",(0,r.jsx)(t.code,{children:"file"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"python_tests"})," -> ",(0,r.jsx)(t.code,{children:"python_test"})]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"go_mod"})," -> ",(0,r.jsx)(t.code,{children:"go_third_party_package"})]}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["Usually, prefer these target generators. ",(0,r.jsx)(t.a,{href:"/2.28/docs/getting-started/initial-configuration#5-generate-build-files",children:(0,r.jsx)(t.code,{children:"pants tailor ::"})})," will automatically add them for you."]}),"\n",(0,r.jsxs)(t.p,{children:["Run ",(0,r.jsx)(t.code,{children:"pants help targets"})," to see how the target determines what to generate. Targets for first-party code, like ",(0,r.jsx)(t.code,{children:"resources"})," and ",(0,r.jsx)(t.code,{children:"python_tests"}),", will generate one target for each file in their ",(0,r.jsx)(t.code,{children:"sources"})," field."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",children:'python_sources(\n    name="lib",\n    # Will generate two `python_source` targets.\n    sources=["app.py", "util.py"],\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["(Usually, you can leave off the ",(0,r.jsx)(t.code,{children:"sources"})," field. When possible, it defaults to all relevant files in the current directory.)"]}),"\n",(0,r.jsxs)(t.p,{children:["Typically, fields declared in the target generator will be inherited by each generated target. For example, if you set ",(0,r.jsx)(t.code,{children:"timeout=120"})," in a ",(0,r.jsx)(t.code,{children:"python_tests"})," target, each generated ",(0,r.jsx)(t.code,{children:"python_test"})," target will have ",(0,r.jsx)(t.code,{children:"timeout=120"}),". You can instead use the ",(0,r.jsx)(t.code,{children:"overrides"})," field for more granular metadata:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="helloworld/BUILD"',children:'python_tests(\n    name="tests",\n    # This applies to every generated target.\n    extra_env_vars=["MY_ENV_VAR"],\n    # These only apply to the relevant generated targets.\n    overrides={\n        "dirutil_test.py": {"timeout": 30},\n        ("osutil_test.py", "strutil_test.py"): {"timeout": 15},\n    },\n)\n'})}),"\n",(0,r.jsx)(t.p,{children:"The address for generated targets depends if the generated target is for first-party code or not:"}),"\n",(0,r.jsxs)(t.table,{children:[(0,r.jsx)(t.thead,{children:(0,r.jsxs)(t.tr,{children:[(0,r.jsx)(t.th,{style:{textAlign:"left"},children:"Generated target type"}),(0,r.jsx)(t.th,{style:{textAlign:"left"},children:"Generated address syntax"})]})}),(0,r.jsxs)(t.tbody,{children:[(0,r.jsxs)(t.tr,{children:[(0,r.jsxs)(t.td,{style:{textAlign:"left"},children:["First-party, e.g. ",(0,r.jsx)(t.code,{children:"python_source"})," and ",(0,r.jsx)(t.code,{children:"file"})]}),(0,r.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,r.jsx)(t.code,{children:"path/to/file.ext:tgt_generator"})," ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"Example: ",(0,r.jsx)(t.code,{children:"src/py/app.py:lib"})," ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"The address always starts with the path to the file. ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"If the file lives in the same directory as the target generator and the target generator left off the ",(0,r.jsx)(t.code,{children:"name"})," field, you can use just the file path. For example, ",(0,r.jsx)(t.code,{children:"src/py/app.py"})," (without the ",(0,r.jsx)(t.code,{children:":lib"})," suffix). ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"If the file lives in a subdirectory of the target generator, the suffix will look like ",(0,r.jsx)(t.code,{children:"../tgt_generator"}),". For example, ",(0,r.jsx)(t.code,{children:"src/py/subdir/f.py:../lib"}),", where the target generator is ",(0,r.jsx)(t.code,{children:"src/py:lib"}),". ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"With the ",(0,r.jsx)(t.code,{children:"dependencies"})," field, you can use relative addresses by prefixing the path with ",(0,r.jsx)(t.code,{children:"./"}),", so long as the path is in the same directory or below the current BUILD file. For example, ",(0,r.jsx)(t.code,{children:"./app.py:lib"})," rather than ",(0,r.jsx)(t.code,{children:"src/py/app.py:lib"}),"."]})]}),(0,r.jsxs)(t.tr,{children:[(0,r.jsxs)(t.td,{style:{textAlign:"left"},children:["All other targets, e.g. ",(0,r.jsx)(t.code,{children:"go_third_party_package"})]}),(0,r.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,r.jsx)(t.code,{children:"path/to:tgt_generator#generated_name"})," ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"Example: ",(0,r.jsx)(t.code,{children:"3rdparty/py:reqs#django"})," ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"Run ",(0,r.jsx)(t.code,{children:"pants help $target_type"})," on the target generator to see how it sets the generated name. For example, ",(0,r.jsx)(t.code,{children:"go_mod"})," uses the Go package's name. ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"If the target generator left off the ",(0,r.jsx)(t.code,{children:"name"})," field, you can leave it off for the generated address too, e.g. ",(0,r.jsx)(t.code,{children:"3rdparty/py#django"})," (without the ",(0,r.jsx)(t.code,{children:":reqs"})," portion). ",(0,r.jsx)("br",{})," ",(0,r.jsx)("br",{}),"With the ",(0,r.jsx)(t.code,{children:"dependencies"})," field, you can use relative addresses to reference generated targets in the same BUILD file, e.g. ",(0,r.jsx)(t.code,{children:":generator#generated_name"})," instead of ",(0,r.jsx)(t.code,{children:"src/py:generated#generated_name"}),". If the target generator uses the default ",(0,r.jsx)(t.code,{children:"name"}),", you can simply use ",(0,r.jsx)(t.code,{children:"#generated_name"}),"."]})]})]})]}),"\n",(0,r.jsxs)(t.p,{children:["Run ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/project-introspection",children:(0,r.jsx)(t.code,{children:"pants list dir:"})})," in the directory of the target generator to see all generated target addresses, and ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/project-introspection",children:(0,r.jsx)(t.code,{children:"pants peek dir:"})})," to see all their metadata."]}),"\n",(0,r.jsxs)(t.p,{children:["You can use the address for the target generator as an alias for all of its generated targets. For example, if you have the ",(0,r.jsx)(t.code,{children:"files"})," target ",(0,r.jsx)(t.code,{children:"assets:logos"}),", adding ",(0,r.jsx)(t.code,{children:'dependencies=["assets:logos"]'}),"to another target will add a dependency on each generated ",(0,r.jsx)(t.code,{children:"file"})," target. Likewise, if you have a ",(0,r.jsx)(t.code,{children:"python_tests"})," target ",(0,r.jsx)(t.code,{children:"project:tests"}),", then ",(0,r.jsx)(t.code,{children:"pants test project:tests"})," will run on each generated ",(0,r.jsx)(t.code,{children:"python_test"})," target."]}),"\n",(0,r.jsxs)(t.admonition,{title:"Tip: one BUILD file per directory",type:"note",children:[(0,r.jsx)(t.p,{children:"Target generation means that it is technically possible to put everything in a single BUILD file."}),(0,r.jsxs)(t.p,{children:["However, we've found that it usually scales much better to use a single BUILD file per directory. Even if you start with using the defaults for everything, projects usually need to change some metadata over time, like adding a ",(0,r.jsx)(t.code,{children:"timeout"})," to a test file or adding ",(0,r.jsx)(t.code,{children:"dependencies"})," on resources."]}),(0,r.jsxs)(t.p,{children:["It's useful for metadata to be as fine-grained as feasible, such as by using the ",(0,r.jsx)(t.code,{children:"overrides"})," field to only change the files you need to. Fine-grained metadata is key to having smaller cache keys (resulting in more cache hits), and allows you to more accurately reflect the status of your project. We have found that using one BUILD file per directory encourages fine-grained metadata by defining the metadata adjacent to where the code lives."]}),(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.a,{href:"/2.28/docs/getting-started/initial-configuration#5-generate-build-files",children:(0,r.jsx)(t.code,{children:"pants tailor ::"})})," will automatically create targets that only apply metadata for the directory."]})]}),"\n",(0,r.jsx)(t.h2,{id:"parametrizing-targets",children:"Parametrizing targets"}),"\n",(0,r.jsx)(t.p,{children:"It can be useful to create multiple targets describing the same entity, each with different metadata. For example:"}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Run the same tests with different interpreter constraints, e.g. Python 2 vs Python 3."}),"\n",(0,r.jsx)(t.li,{children:'Declare that a file should work with multiple "resolves" (lockfiles).'}),"\n"]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"parametrize"})," builtin creates a distinct target per parametrized field value. All values other than the parametrized field(s) are the same for each target. For example:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="example/BUILD"',children:'# Creates two targets:\n#\n#    example:tests@shell=bash\n#    example:tests@shell=zsh\n\nshunit2_test(\n    name="tests",\n    source="tests.sh",\n    shell=parametrize("bash", "zsh"),\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["If multiple fields are parametrized, a target will be created for each value in the Cartesian product, with ",(0,r.jsx)(t.code,{children:","})," as the delimiter in the address. See the next example."]}),"\n",(0,r.jsxs)(t.p,{children:["If the field value is not a string\u2014or it is a string but includes spaces\u2014you can give it an alias, like the ",(0,r.jsx)(t.code,{children:"interpreter_constraints"})," field below:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="example/BUILD"',children:'# Creates four targets:\n#\n#    example:tests@interpreter_constraints=py2,resolve=lock-a\n#    example:tests@interpreter_constraints=py2,resolve=lock-b\n#    example:tests@interpreter_constraints=py3,resolve=lock-a\n#    example:tests@interpreter_constraints=py3,resolve=lock-b\n\npython_test(\n    name="tests",\n    source="tests.py",\n    interpreter_constraints=parametrize(py2=["==2.7.*"], py3=[">=3.6,<3.7"]),\n    resolve=parametrize("lock-a", "lock-b"),\n)\n'})}),"\n",(0,r.jsx)(t.p,{children:"To parametrize multiple fields together as one parametrization, unpack a parametrize object with the field values to use for that group as the parametrization keyword arguments. The parametrization must be named by providing one positional string argument as the name. (See example below.) This is useful to avoid a full cartesian product if not every combination of field values makes sense. i.e. The previous example uses the same resolve (lockfile) for both interpreter constraints, however if you want to use a different resolve per interpreter, then grouping the resolve value with the interpreter constraint may be the way to go."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="example/BUILD"',children:'# Creates two targets:\n#\n#    example:tests@parametrize=py2\n#    example:tests@parametrize=py3\n\npython_test(\n    name="tests",\n    source="tests.py",\n    **parametrize("py2", interpreter_constraints=["==2.7.*"], resolve="lock-a"),\n    **parametrize("py3", interpreter_constraints=[">=3.6,<3.7"], resolve="lock-b"),\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["(Using ",(0,r.jsx)(t.code,{children:"parametrize"})," on grouped fields is also supported. For instance, if there is two resolves to use for Python 3.10, these can be provided within the py310 group: ",(0,r.jsx)(t.code,{children:'**parametrize("py310", interpreter_constraints=[">=3.10,<3.11"], resolve=parametrize("lock-b", "lock-c"))'}),".)"]}),"\n",(0,r.jsxs)(t.p,{children:["The targets' addresses will have ",(0,r.jsx)(t.code,{children:"@key=value"})," at the end, as shown above. Run ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/project-introspection",children:(0,r.jsx)(t.code,{children:"pants list dir:"})})," in the directory of the parametrized target to see all parametrized target addresses, and ",(0,r.jsx)(t.a,{href:"/2.28/docs/using-pants/project-introspection",children:(0,r.jsx)(t.code,{children:"pants peek dir:"})})," to see all their metadata."]}),"\n",(0,r.jsxs)(t.p,{children:["Generally, you can use the address without the ",(0,r.jsx)(t.code,{children:"@"})," suffix as an alias to all the parametrized targets. For example, ",(0,r.jsx)(t.code,{children:"pants test example:tests"})," will run all the targets in parallel. Use the more precise address if you only want to use one parameter value, e.g. ",(0,r.jsx)(t.code,{children:"pants test example:tests@shell=bash"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["Parametrization can be combined with target generation. The ",(0,r.jsx)(t.code,{children:"@key=value"})," will be added to the end of the address for each generated target. For example:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="example/BUILD"',children:'# Generates four `shunit2_test` targets:\n#\n#    example/test1.sh:tests@shell=bash\n#    example/test1.sh:tests@shell=zsh\n#    example/test2.sh:tests@shell=bash\n#    example/test2.sh:tests@shell=zsh\n#\n# Also creates two `shunit2_tests` target\n# generators, which can be used as aliases\n# to their generated targets:\n#\n#    example:tests@shell=bash\n#    example:tests@shell=zsh\n#\n# Generally, you can still use `example:tests`\n# without the `@` suffix as an alias to all the\n# created targets.\n\nshunit2_tests(\n    name="tests",\n    sources=["test1.sh", "test2.sh"],\n    shell=parametrize("bash", "zsh"),\n)\n'})}),"\n",(0,r.jsxs)(t.p,{children:["You can combine ",(0,r.jsx)(t.code,{children:"parametrize"})," with the ",(0,r.jsx)(t.code,{children:"overrides"})," field to set more granular metadata for generated targets:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-python",metastring:'title="example/BUILD"',children:'# Generates three `shunit2_test` targets:\n#\n#    example/test1.sh:tests\n#    example/test2.sh:tests@shell=bash\n#    example/test2.sh:tests@shell=zsh\n#\n# The `shunit2_tests` target generator\n# `example:tests` can be used as an alias\n# to all 3 created targets.\n\nshunit2_tests(\n    name="tests",\n    sources=["test1.sh", "test2.sh"],\n    overrides={\n        "test2.sh": {"shell": parametrize("bash", "zsh")},\n    },\n)\n'})})]})}function h(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},848193(e,t,s){s.d(t,{R:()=>a,x:()=>l});var n=s(830758);let r={},i=n.createContext(r);function a(e){let t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),n.createElement(i.Provider,{value:t},e.children)}},461528(e){e.exports=JSON.parse('{"id":"docs/using-pants/key-concepts/targets-and-build-files","title":"Targets and BUILD files","description":"Metadata for your code.","source":"@site/versioned_docs/version-2.28/docs/using-pants/key-concepts/targets-and-build-files.mdx","sourceDirName":"docs/using-pants/key-concepts","slug":"/docs/using-pants/key-concepts/targets-and-build-files","permalink":"/2.28/docs/using-pants/key-concepts/targets-and-build-files","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/using-pants/key-concepts/targets-and-build-files.mdx","tags":[],"version":"2.28","sidebarPosition":1,"frontMatter":{"title":"Targets and BUILD files","sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Goals","permalink":"/2.28/docs/using-pants/key-concepts/goals"},"next":{"title":"Options","permalink":"/2.28/docs/using-pants/key-concepts/options"}}')}}]);