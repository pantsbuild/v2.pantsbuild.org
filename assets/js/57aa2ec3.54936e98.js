"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["750741"],{707721(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>t,toc:()=>d});var t=n(483220),i=n(886070),r=n(848193);let o={title:"Custom `setup_py()` kwargs",sidebar_position:8},a,l={},d=[{value:"1. Set up a subclass of <code>SetupKwargsRequest</code>",id:"1-set-up-a-subclass-of-setupkwargsrequest",level:2},{value:"2. Create a rule with your logic",id:"2-create-a-rule-with-your-logic",level:2}];function c(e){let s={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(s.p,{children:["How to add your own logic to ",(0,i.jsx)(s.code,{children:"setup_py()"}),"."]}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.p,{children:["By default, Pants will simply copy the kwargs (keyword arguments) used in the ",(0,i.jsx)(s.code,{children:"provides=setup_py()"})," field in the BUILD file when ",(0,i.jsxs)(s.a,{href:"/2.7/docs/python/overview/building-distributions",children:["running the ",(0,i.jsx)(s.code,{children:"package"})," goal on a ",(0,i.jsx)(s.code,{children:"python_distribution"})]}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["You can instead write a plugin to add your own logic to what kwargs are used for the ",(0,i.jsx)(s.code,{children:"setup()"})," function to do any of these things:"]}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsx)(s.li,{children:"Reduce boilerplate by hardcoding common kwargs."}),"\n",(0,i.jsxs)(s.li,{children:["Read from the file system to dynamically determine kwargs, such as the ",(0,i.jsx)(s.code,{children:"long_description"})," or ",(0,i.jsx)(s.code,{children:"version"}),"."]}),"\n",(0,i.jsxs)(s.li,{children:["Run processes like ",(0,i.jsx)(s.code,{children:"git"})," to dynamically determine kwargs like ",(0,i.jsx)(s.code,{children:"version"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(s.p,{children:["Note: regardless of if you wrote a plugin or not, Pants will automatically set some kwargs like ",(0,i.jsx)(s.code,{children:"install_requires"})," and ",(0,i.jsx)(s.code,{children:"namespace_packages"})," based on analyzing your code."]}),"\n",(0,i.jsxs)(s.p,{children:["Note: there may only be at most one applicable plugin per target customizing the kwargs for the ",(0,i.jsx)(s.code,{children:"setup()"})," function."]}),"\n",(0,i.jsx)(s.admonition,{title:"Example",type:"note",children:(0,i.jsxs)(s.p,{children:["See ",(0,i.jsx)(s.a,{href:"https://github.com/pantsbuild/pants/blob/master/pants-plugins/internal_plugins/releases/register.py",children:"here"})," for an example that Pants uses internally for its ",(0,i.jsx)(s.code,{children:"python_distribution"})," targets. This plugin demonstrates reading from the file system to set the ",(0,i.jsx)(s.code,{children:"version"})," and ",(0,i.jsx)(s.code,{children:"long_description"})," kwargs, along with adding hardcoded kwargs."]})}),"\n",(0,i.jsxs)(s.h2,{id:"1-set-up-a-subclass-of-setupkwargsrequest",children:["1. Set up a subclass of ",(0,i.jsx)(s.code,{children:"SetupKwargsRequest"})]}),"\n",(0,i.jsxs)(s.p,{children:["Set the class method ",(0,i.jsx)(s.code,{children:"is_applicable()"})," to determine whether your implementation should be used for the particular ",(0,i.jsx)(s.code,{children:"python_distribution"})," target. If ",(0,i.jsx)(s.code,{children:"False"}),", Pants will use the default implementation which simply uses the explicitly provided ",(0,i.jsx)(s.code,{children:"setup_py"})," from the BUILD file."]}),"\n",(0,i.jsx)(s.p,{children:"In this example, we will always use our custom implementation:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:"from pants.backend.python.goals.setup_py import SetupKwargsRequest\nfrom pants.engine.target import Target\n\nclass CustomSetupKwargsRequest(SetupKwargsRequest):\n    @classmethod\n    def is_applicable(cls, _: Target) -> bool:\n        return True\n"})}),"\n",(0,i.jsxs)(s.p,{children:["This example will only use our plugin implementation for ",(0,i.jsx)(s.code,{children:"python_distribution"})," targets defined in the folder ",(0,i.jsx)(s.code,{children:"src/python/project1"}),"."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'class CustomSetupKwargsRequest(SetupKwargsRequest):\n    @classmethod\n    def is_applicable(cls, target: Target) -> bool:\n        return target.address.spec.startswith("src/python/project1")\n'})}),"\n",(0,i.jsxs)(s.p,{children:["Then, register your new ",(0,i.jsx)(s.code,{children:"SetupKwargsRequest "})," with a ",(0,i.jsx)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,i.jsx)(s.code,{children:"UnionRule"})})," so that Pants knows your implementation exists:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:"from pants.engine.rules import collect_rules\nfrom pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(SetupKwargsRequest, CustomSetupKwargsRequest),\n    ]\n"})}),"\n",(0,i.jsxs)(s.admonition,{type:"note",children:[(0,i.jsxs)(s.mdxAdmonitionTitle,{children:["Consider defining custom ",(0,i.jsx)(s.code,{children:"python_distribution"})," target types"]}),(0,i.jsxs)(s.p,{children:["If you don't want to always use a single custom implementation, an effective approach could be to create custom ",(0,i.jsx)(s.code,{children:"python_distribution"})," target types so that your users decide which implementation they want to use in their BUILD files."]}),(0,i.jsx)(s.p,{children:"For example, a user could do this:"}),(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'pants_python_distribution(\n   name="my-dist",\n   dependencies=[...],\n   provides=setup_py(...)\n)\n\npants_contrib_python_distribution(\n   name="my-dist",\n   dependencies=[...],\n   provides=setup_py(...)\n)\n'})}),(0,i.jsxs)(s.p,{children:["To support this workflow, ",(0,i.jsx)(s.a,{href:"/2.7/docs/writing-plugins/the-target-api/creating-new-targets",children:"create new target types"}),"."]}),(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'class PantsPythonDistribution(Target):\n   alias = "pants_python_distribution"\n   core_fields = PythonDistribution.core_fields\n\nclass PantsContribPythonDistribution(Target):\n   alias = "pants_contrib_python_distribution"\n   core_fields = PythonDistribution.core_fields\n'})}),(0,i.jsxs)(s.p,{children:["Then, for each ",(0,i.jsx)(s.code,{children:"SetupKwargsRequest"})," subclass, check which target type was used:"]}),(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:"class PantsSetupKwargsRequest(SetupKwargsRequest):\n    @classmethod\n    def is_applicable(cls, target: Target) -> bool:\n        return isinstance(target, PantsPythonDistribution)\n"})})]}),"\n",(0,i.jsx)(s.h2,{id:"2-create-a-rule-with-your-logic",children:"2. Create a rule with your logic"}),"\n",(0,i.jsxs)(s.p,{children:["Your rule should take as a parameter the ",(0,i.jsx)(s.code,{children:"SetupKwargsRequest "})," from step 1. This type has two fields: ",(0,i.jsx)(s.code,{children:"target: Target"})," and ",(0,i.jsx)(s.code,{children:"explicit_kwargs: Dict[str, Any]"}),". You can use these fields to get more information on the target you are generating a ",(0,i.jsx)(s.code,{children:"setup.py"})," for."]}),"\n",(0,i.jsxs)(s.p,{children:["Your rule should return ",(0,i.jsx)(s.code,{children:"SetupKwargs"}),", which takes two arguments: ",(0,i.jsx)(s.code,{children:"kwargs: Dict[str, Any]"})," and ",(0,i.jsx)(s.code,{children:"address: Address"}),"."]}),"\n",(0,i.jsx)(s.p,{children:"For example, this will simply hardcode a kwarg:"}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'from pants.backend.python.goals.setup_py import SetupKwargs\nfrom pants.engine.rules import rule\n\n@rule\nasync def setup_kwargs_plugin(request: CustomSetupKwargsRequest) -> SetupKwargs:\n    return SetupKwargs(\n        {**request.explicit_kwargs, "plugin_demo": "hello world"}, address=request.target.address\n    )\n'})}),"\n",(0,i.jsxs)(s.p,{children:["Update your plugin's ",(0,i.jsx)(s.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",metastring:'title="pants-plugins/python_plugins/register.py"',children:"from python_plugins import custom_setup_py\n\ndef rules():\n   return custom_setup_py.rules()\n"})}),"\n",(0,i.jsxs)(s.p,{children:["Then, temporarily delete any ",(0,i.jsx)(s.code,{children:"setup_py_commands"})," from the ",(0,i.jsx)(s.code,{children:"python_distribution"})," target, run ",(0,i.jsx)(s.code,{children:"./pants package path/to:python_distribution"}),", and inspect the generated ",(0,i.jsx)(s.code,{children:"setup.py"})," in the resulting folder to confirm that your plugin worked correctly."]}),"\n",(0,i.jsxs)(s.p,{children:["Often, you will want to read from a file in your project to set kwargs like ",(0,i.jsx)(s.code,{children:"version"})," or ",(0,i.jsx)(s.code,{children:"long_description"}),". Use ",(0,i.jsx)(s.code,{children:"await Get(DigestContents, PathGlobs)"})," to do this (see ",(0,i.jsx)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/file-system",children:"File system"}),"):"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'from pants.backend.python.goals.setup_py import SetupKwargs\nfrom pants.engine.fs import DigestContents, GlobMatchErrorBehavior, PathGlobs\nfrom pants.engine.rules import rule\n\n@rule\nasync def setup_kwargs_plugin(request: CustomSetupKwargsRequest) -> SetupKwargs:\n    digest_contents = await Get(\n        DigestContents,\n        PathGlobs(\n            ["project/ABOUT.rst"],\n            description_of_origin="`setup_py()` plugin",\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n        ),\n    )\n    about_page_content = digest_contents[0].content.decode()\n    return SetupKwargs(\n        {**request.explicit_kwargs, "long_description": "\\n".join(about_page_content)},\n        address=request.target.address\n    )\n'})}),"\n",(0,i.jsxs)(s.p,{children:["It can be helpful to allow users to add additional kwargs to their BUILD files for you to consume in your plugin. For example, this plugin adds a custom ",(0,i.jsx)(s.code,{children:"long_description_path"})," field, which gets popped and replaced by the plugin with a normalized ",(0,i.jsx)(s.code,{children:"long_description"})," kwarg:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'python_distribution(\n    name="mydist",\n    dependencies=[...],\n    provides=setup_py(\n        name="mydist",\n        ...\n        long_description_path="README.md",\n    ),\n    setup_py_commands=["sdist"]\n)\n'})}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'import os.path\n\nfrom pants.backend.python.goals.setup_py import SetupKwargs\nfrom pants.engine.fs import DigestContents, GlobMatchErrorBehavior, PathGlobs\nfrom pants.engine.rules import rule\n\n@rule\nasync def setup_kwargs_plugin(request: CustomSetupKwargsRequest) -> SetupKwargs:\n    original_kwargs = request.explicit_kwargs.copy()\n    long_description_relpath = original_kwargs.pop("long_description_file", None)\n    if not long_description_relpath:\n        raise ValueError(\n            f"The python_distribution target {request.target.address} did not include "\n            "`long_description_file` in its setup_py\'s kwargs. Our plugin requires this! "\n            "Please set to a path relative to the BUILD file, e.g. `ABOUT.md`."\n        )\n\n    build_file_path = request.target.address.spec_path\n    long_description_path = os.path.join(build_file_path, long_description_relpath)\n    digest_contents = await Get(\n        DigestContents,\n        PathGlobs(\n            [long_description_path],\n            description_of_origin=f"the \'long_description_file\' kwarg in {request.target.address}",\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n        ),\n    )\n    description_content = digest_contents[0].content.decode()\n    return SetupKwargs(\n        {**original_kwargs, "long_description": "\\n".join(description_content)},\n        address=request.target.address\n    )\n'})}),"\n",(0,i.jsx)(s.p,{children:"Refer to these guides for additional things you may want to do in your plugin:"}),"\n",(0,i.jsxs)(s.ul,{children:["\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/options-and-subsystems",children:"Read from options"}),". Also see ",(0,i.jsx)(s.a,{href:"https://github.com/pantsbuild/pants/blob/master/pants-plugins/internal_plugins/releases/register.py",children:"here"})," for an example."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsx)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Read values from the target"})," using the Target API."]}),"\n",(0,i.jsxs)(s.li,{children:[(0,i.jsxs)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/processes",children:["Run a ",(0,i.jsx)(s.code,{children:"Process"})]}),", such as ",(0,i.jsx)(s.code,{children:"git"}),". Also see ",(0,i.jsx)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),"."]}),"\n"]})]})}function p(e={}){let{wrapper:s}={...(0,r.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},848193(e,s,n){n.d(s,{R:()=>o,x:()=>a});var t=n(830758);let i={},r=t.createContext(i);function o(e){let s=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function a(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),t.createElement(r.Provider,{value:s},e.children)}},483220(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/custom-setup-py-kwargs","title":"Custom `setup_py()` kwargs","description":"How to add your own logic to setup_py().","source":"@site/versioned_docs/version-2.7/docs/writing-plugins/common-plugin-tasks/custom-setup-py-kwargs.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/custom-setup-py-kwargs","permalink":"/2.7/docs/writing-plugins/common-plugin-tasks/custom-setup-py-kwargs","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/custom-setup-py-kwargs.mdx","tags":[],"version":"2.7","sidebarPosition":8,"frontMatter":{"title":"Custom `setup_py()` kwargs","sidebar_position":8},"sidebar":"docsSidebar","previous":{"title":"Run tests","permalink":"/2.7/docs/writing-plugins/common-plugin-tasks/run-tests"},"next":{"title":"Plugin upgrade guide","permalink":"/2.7/docs/writing-plugins/common-plugin-tasks/plugin-upgrade-guide"}}')}}]);