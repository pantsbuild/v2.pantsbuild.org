"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["488816"],{518322(n,e,t){t.r(e),t.d(e,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>l,metadata:()=>i,toc:()=>d});var i=t(559436),s=t(886070),r=t(848193);let l={title:"Debugging and benchmarking",sidebar_position:4},o,c={},d=[{value:"Benchmarking Pants runs with <code>multitime</code>",id:"benchmarking-pants-runs-with-multitime",level:2},{value:"Doing ... with PySpy",id:"doing--with-pyspy",level:2},{value:"Obtaining Full Thread Backtraces",id:"obtaining-full-thread-backtraces",level:2}];function a(n){let e={code:"code",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",strong:"strong",ul:"ul",...(0,r.R)(),...n.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(e.p,{children:"Some techniques to figure out why Pants is behaving the way it is."}),"\n",(0,s.jsx)(e.hr,{}),"\n",(0,s.jsxs)(e.h2,{id:"benchmarking-pants-runs-with-multitime",children:["Benchmarking Pants runs with ",(0,s.jsx)(e.code,{children:"multitime"})]}),"\n",(0,s.jsx)(e.h2,{id:"doing--with-pyspy",children:"Doing ... with PySpy"}),"\n",(0,s.jsx)(e.h2,{id:"obtaining-full-thread-backtraces",children:"Obtaining Full Thread Backtraces"}),"\n",(0,s.jsx)(e.p,{children:"Pants runs as a Python program that calls into a native Rust library. In debugging locking and deadlock issues, it is useful to capture dumps of the thread stacks in order to figure out where a deadlock may be occurring."}),"\n",(0,s.jsx)(e.p,{children:"One-time setup:"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"Ensure that gdb is installed."}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Ubuntu: ",(0,s.jsx)(e.code,{children:"sudo apt install gdb"})]}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsx)(e.li,{children:"Ensure that the kernel is configured to allow debuggers to attach to processes that are not in the same parent/child process hierarchy."}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsx)(e.li,{children:(0,s.jsx)(e.code,{children:"echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope"})}),"\n",(0,s.jsxs)(e.li,{children:["To make the change permanent, add a file to /etc/sysctl.d named ",(0,s.jsx)(e.code,{children:"99-ptrace.conf"})," with contents ",(0,s.jsx)(e.code,{children:"kernel.yama.ptrace_scope = 0"}),". ",(0,s.jsx)(e.strong,{children:"Note: This is a security exposure if you are not normally debugging processes across the process hierarchy."})]}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsx)(e.li,{children:"Ensure that the debug info for your system Python binary is installed."}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Ubuntu: ",(0,s.jsx)(e.code,{children:"sudo apt install python3-dbg"})]}),"\n"]}),"\n",(0,s.jsx)(e.p,{children:"Dumping thread stacks:"}),"\n",(0,s.jsxs)(e.ol,{children:["\n",(0,s.jsx)(e.li,{children:"Find the pants binary (which may include pantsd if pantsd is enabled)."}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Run: ",(0,s.jsx)(e.code,{children:"ps -ef | grep pants"})]}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"2",children:["\n",(0,s.jsx)(e.li,{children:"Invoke gdb with the python binary and the process ID:"}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:["Run: ",(0,s.jsx)(e.code,{children:"gdb /path/to/python/binary PROCESS_ID"})]}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"3",children:["\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsxs)(e.p,{children:["Enable logging to write the thread dump to ",(0,s.jsx)(e.code,{children:"gdb.txt"}),": ",(0,s.jsx)(e.code,{children:"set logging on"})]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsxs)(e.p,{children:["Dump all thread backtraces: ",(0,s.jsx)(e.code,{children:"thread apply all bt"})]}),"\n"]}),"\n",(0,s.jsxs)(e.li,{children:["\n",(0,s.jsx)(e.p,{children:"If you use pyenv to mange your Python install, a gdb script will exist in the same directory as the Python binary. Source it into gdb:"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(e.ul,{children:["\n",(0,s.jsxs)(e.li,{children:[(0,s.jsx)(e.code,{children:"source ~/.pyenv/versions/3.8.5/bin/python3.8-gdb.py"})," (if using version 3.8.5)"]}),"\n"]}),"\n",(0,s.jsxs)(e.ol,{start:"6",children:["\n",(0,s.jsxs)(e.li,{children:["Dump all Python stacks: ",(0,s.jsx)(e.code,{children:"thread apply all py-bt"})]}),"\n"]})]})}function h(n={}){let{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,s.jsx)(e,{...n,children:(0,s.jsx)(a,{...n})}):a(n)}},848193(n,e,t){t.d(e,{R:()=>l,x:()=>o});var i=t(830758);let s={},r=i.createContext(s);function l(n){let e=i.useContext(r);return i.useMemo(function(){return"function"==typeof n?n(e):{...e,...n}},[e,n])}function o(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(s):n.components||s:l(n.components),i.createElement(r.Provider,{value:e},n.children)}},559436(n){n.exports=JSON.parse('{"id":"docs/contributions/development/debugging-and-benchmarking","title":"Debugging and benchmarking","description":"Some techniques to figure out why Pants is behaving the way it is.","source":"@site/versioned_docs/version-2.0/docs/contributions/development/debugging-and-benchmarking.mdx","sourceDirName":"docs/contributions/development","slug":"/docs/contributions/development/debugging-and-benchmarking","permalink":"/2.0/docs/contributions/development/debugging-and-benchmarking","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/contributions/development/debugging-and-benchmarking.mdx","tags":[],"version":"2.0","sidebarPosition":4,"frontMatter":{"title":"Debugging and benchmarking","sidebar_position":4},"sidebar":"docsSidebar","previous":{"title":"Internal Architecture","permalink":"/2.0/docs/contributions/development/internal-architecture"},"next":{"title":"Committers","permalink":"/2.0/docs/contributions/committers"}}')}}]);