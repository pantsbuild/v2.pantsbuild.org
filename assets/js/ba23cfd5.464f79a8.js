"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["978268"],{577594(e,n,i){i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>t,toc:()=>l});var t=i(971323),s=i(886070),r=i(848193);let o={title:"Debugging and benchmarking",sidebar_position:4},c,a={},l=[{value:"Benchmarking with <code>hyperfine</code>",id:"benchmarking-with-hyperfine",level:2},{value:"Profiling with PySpy (TODO)",id:"profiling-with-pyspy-todo",level:2},{value:"Identifying the impact of Python&#39;s GIL (on macOS)",id:"identifying-the-impact-of-pythons-gil-on-macos",level:2},{value:"Obtaining Full Thread Backtraces",id:"obtaining-full-thread-backtraces",level:2}];function d(e){let n={a:"a",code:"code",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Some techniques to figure out why Pants is behaving the way it is."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h2,{id:"benchmarking-with-hyperfine",children:["Benchmarking with ",(0,s.jsx)(n.code,{children:"hyperfine"})]}),"\n",(0,s.jsxs)(n.p,{children:["We use ",(0,s.jsx)(n.code,{children:"hyperfine"})," to benchmark, especially comparing before and after to see the impact of a change: ",(0,s.jsx)(n.a,{href:"https://github.com/sharkdp/hyperfine",children:"https://github.com/sharkdp/hyperfine"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["When benchmarking, you must decide if you care about cold cache performance vs. warm cache (or both). If cold, use ",(0,s.jsx)(n.code,{children:"--no-pantsd --no-process-execution-local-cache"}),". If warm, use hyperfine's option ",(0,s.jsx)(n.code,{children:"--warmup=1"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u276F hyperfine --warmup=1 --runs=5 './pants list ::`\n\u276F hyperfine --runs=5 './pants --no-pantsd --no-process-execution-local-cache lint ::'\n"})}),"\n",(0,s.jsx)(n.h2,{id:"profiling-with-pyspy-todo",children:"Profiling with PySpy (TODO)"}),"\n",(0,s.jsx)(n.h2,{id:"identifying-the-impact-of-pythons-gil-on-macos",children:"Identifying the impact of Python's GIL (on macOS)"}),"\n",(0,s.jsx)("iframe",{class:"embedly-embed",src:"//cdn.embedly.com/widgets/media.html?src=https%3A%2F%2Fwww.youtube.com%2Fembed%2FzALr3zFIQJo%3Ffeature%3Doembed&display_name=YouTube&url=https%3A%2F%2Fwww.youtube.com%2Fwatch%3Fv%3DzALr3zFIQJo&image=https%3A%2F%2Fi.ytimg.com%2Fvi%2FzALr3zFIQJo%2Fhqdefault.jpg&key=f2aa6fc3595946d0afc3d76cbbd25dc3&type=text%2Fhtml&schema=youtube",width:"640",height:"480",scrolling:"no",title:"YouTube embed",frameborder:"0",allow:"autoplay; fullscreen",allowfullscreen:"true"}),"\n",(0,s.jsx)(n.h2,{id:"obtaining-full-thread-backtraces",children:"Obtaining Full Thread Backtraces"}),"\n",(0,s.jsx)(n.p,{children:"Pants runs as a Python program that calls into a native Rust library. In debugging locking and deadlock issues, it is useful to capture dumps of the thread stacks in order to figure out where a deadlock may be occurring."}),"\n",(0,s.jsx)(n.p,{children:"One-time setup:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Ensure that gdb is installed.","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ubuntu: ",(0,s.jsx)(n.code,{children:"sudo apt install gdb"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Ensure that the kernel is configured to allow debuggers to attach to processes that are not in the same parent/child process hierarchy.","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.code,{children:"echo 0 | sudo tee /proc/sys/kernel/yama/ptrace_scope"})}),"\n",(0,s.jsxs)(n.li,{children:["To make the change permanent, add a file to /etc/sysctl.d named ",(0,s.jsx)(n.code,{children:"99-ptrace.conf"})," with contents ",(0,s.jsx)(n.code,{children:"kernel.yama.ptrace_scope = 0"}),". ",(0,s.jsx)(n.strong,{children:"Note: This is a security exposure if you are not normally debugging processes across the process hierarchy."})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Ensure that the debug info for your system Python binary is installed.","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Ubuntu: ",(0,s.jsx)(n.code,{children:"sudo apt install python3-dbg"})]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Dumping thread stacks:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Find the pants binary (which may include pantsd if pantsd is enabled).","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Run: ",(0,s.jsx)(n.code,{children:"ps -ef | grep pants"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Invoke gdb with the python binary and the process ID:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["Run: ",(0,s.jsx)(n.code,{children:"gdb /path/to/python/binary PROCESS_ID"})]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Enable logging to write the thread dump to ",(0,s.jsx)(n.code,{children:"gdb.txt"}),": ",(0,s.jsx)(n.code,{children:"set logging on"})]}),"\n",(0,s.jsxs)(n.li,{children:["Dump all thread backtraces: ",(0,s.jsx)(n.code,{children:"thread apply all bt"})]}),"\n",(0,s.jsxs)(n.li,{children:["If you use pyenv to mange your Python install, a gdb script will exist in the same directory as the Python binary. Source it into gdb:","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"source ~/.pyenv/versions/3.8.5/bin/python3.8-gdb.py"})," (if using version 3.8.5)"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["Dump all Python stacks: ",(0,s.jsx)(n.code,{children:"thread apply all py-bt"})]}),"\n"]})]})}function h(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},848193(e,n,i){i.d(n,{R:()=>o,x:()=>c});var t=i(830758);let s={},r=t.createContext(s);function o(e){let n=t.useContext(r);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:n},e.children)}},971323(e){e.exports=JSON.parse('{"id":"docs/contributions/development/debugging-and-benchmarking","title":"Debugging and benchmarking","description":"Some techniques to figure out why Pants is behaving the way it is.","source":"@site/versioned_docs/version-2.8/docs/contributions/development/debugging-and-benchmarking.mdx","sourceDirName":"docs/contributions/development","slug":"/docs/contributions/development/debugging-and-benchmarking","permalink":"/2.8/docs/contributions/development/debugging-and-benchmarking","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/contributions/development/debugging-and-benchmarking.mdx","tags":[],"version":"2.8","sidebarPosition":4,"frontMatter":{"title":"Debugging and benchmarking","sidebar_position":4},"sidebar":"docsSidebar","previous":{"title":"Internal Architecture","permalink":"/2.8/docs/contributions/development/internal-architecture"},"next":{"title":"Running Pants from sources","permalink":"/2.8/docs/contributions/development/running-pants-from-sources"}}')}}]);