"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["17790"],{800488(e,t,o){o.r(t),o.d(t,{assets:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>l,metadata:()=>r,toc:()=>p});var r=o(538614),n=o(886070),i=o(848193),s=o(685008),a=o(637180);let l={title:"Protobuf and gRPC",sidebar_position:0},d,c={},p=[{value:"Step 1: Activate the Protobuf Python backend",id:"step-1-activate-the-protobuf-python-backend",level:2},{value:"Step 2: Set up the <code>protobuf</code> and/or <code>grpcio</code> runtime libraries",id:"step-2-set-up-the-protobuf-andor-grpcio-runtime-libraries",level:2},{value:"Step 3: Define a <code>protobuf_library</code> target",id:"step-3-define-a-protobuf_library-target",level:2},{value:"Step 4: Use the <code>protobuf_library</code> in your Python code",id:"step-4-use-the-protobuf_library-in-your-python-code",level:2},{value:"Protobuf and source roots",id:"protobuf-and-source-roots",level:2}];function h(e){let t={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.p,{children:"How to generate Python from Protocol Buffers."}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsxs)(t.p,{children:["When you depend on a ",(0,n.jsx)(t.code,{children:"protobuf_library"})," in a Python target (like a ",(0,n.jsx)(t.code,{children:"python_library"}),"), Pants will run the Protoc compiler to generate Python code that you can import and use like normal Python code."]}),"\n",(0,n.jsx)(t.admonition,{title:"Example repository",type:"note",children:(0,n.jsxs)(t.p,{children:["See ",(0,n.jsx)(t.a,{href:"https://github.com/pantsbuild/example-python",children:"the Python example repository"})," for an example of using Protobuf to generate Python."]})}),"\n",(0,n.jsx)(t.h2,{id:"step-1-activate-the-protobuf-python-backend",children:"Step 1: Activate the Protobuf Python backend"}),"\n",(0,n.jsxs)(t.p,{children:["Add this to your ",(0,n.jsx)(t.code,{children:"pants.toml"}),":"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages.add = [\n  "pants.backend.codegen.protobuf.python",\n  "pants.backend.python",\n]\n'})}),"\n",(0,n.jsxs)(t.p,{children:["This adds the new ",(0,n.jsx)(t.code,{children:"protobuf_library"})," target, which you can confirm by running ",(0,n.jsx)(t.code,{children:"./pants help protobuf_library"}),"."]}),"\n",(0,n.jsxs)(t.admonition,{title:"Enable the MyPy Protobuf plugin",type:"note",children:[(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.a,{href:"https://github.com/dropbox/mypy-protobuf",children:"MyPy Protobuf plugin"})," generates ",(0,n.jsxs)(t.a,{href:"https://mypy.readthedocs.io/en/stable/stubs.html",children:[(0,n.jsx)(t.code,{children:".pyi"})," type stubs"]}),". If you use MyPy through Pants's ",(0,n.jsx)(t.a,{href:"/2.0/docs/python/goals/typecheck",children:"typecheck goal"}),", this will ensure MyPy understands your generated code."]}),(0,n.jsxs)(t.p,{children:["To activate, set ",(0,n.jsx)(t.code,{children:"mypy_plugin = true"})," in the ",(0,n.jsx)(t.code,{children:"[python-protobuf]"})," scope:"]}),(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-toml",children:"[python-protobuf]\nmypy_plugin = true\n"})}),(0,n.jsxs)(t.p,{children:["MyPy will use the generated ",(0,n.jsx)(t.code,{children:".pyi"})," type stub file, rather than looking at the ",(0,n.jsx)(t.code,{children:".py"})," implementation file."]})]}),"\n",(0,n.jsx)(t.admonition,{title:"Want to use other protocols, like Thrift?",type:"caution",children:(0,n.jsxs)(t.p,{children:["Please message us on ",(0,n.jsx)(t.a,{href:"/community/members",children:"Slack"})," if you would like support for more protocols. We would be happy to either add support to the core Pants distribution or to help you to write a plugin."]})}),"\n",(0,n.jsxs)(t.h2,{id:"step-2-set-up-the-protobuf-andor-grpcio-runtime-libraries",children:["Step 2: Set up the ",(0,n.jsx)(t.code,{children:"protobuf"})," and/or ",(0,n.jsx)(t.code,{children:"grpcio"})," runtime libraries"]}),"\n",(0,n.jsxs)(t.p,{children:["Generated Python files require the ",(0,n.jsxs)(t.a,{href:"https://pypi.org/project/protobuf/",children:[(0,n.jsx)(t.code,{children:"protobuf"})," library"]})," for their imports to work properly. If you're using gRPC, you also need the ",(0,n.jsxs)(t.a,{href:"https://pypi.org/project/grpcio/",children:[(0,n.jsx)(t.code,{children:"grpcio"})," library"]}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["First, add ",(0,n.jsx)(t.code,{children:"protobuf"}),"\u2014and ",(0,n.jsx)(t.code,{children:"grpcio"}),", if relevant\u2014 to your ",(0,n.jsx)(t.code,{children:"requirements.txt"})," (see ",(0,n.jsx)(t.a,{href:"/2.0/docs/python/overview/third-party-dependencies",children:"Third-party dependencies"}),")."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-text",metastring:'title="requirements.txt"',children:"grpcio==1.32.0\nprotobuf>=3.12.1\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Then, add the targets' addresses to the option ",(0,n.jsx)(t.code,{children:"runtime_dependencies"})," in the ",(0,n.jsx)(t.code,{children:"[python-protobuf]"})," scope. Pants will use this to automatically add the target(s) to the ",(0,n.jsx)(t.code,{children:"dependencies"})," field for every ",(0,n.jsx)(t.code,{children:"protobuf_library()"})," target you write."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[python-protobuf]\n# Use the path to your 3rd-party requirements,\n# e.g. `3rdparty/python:protobuf`.\nruntime_dependencies = ["//:grpcio", "//:protobuf"]\n'})}),"\n",(0,n.jsxs)(t.h2,{id:"step-3-define-a-protobuf_library-target",children:["Step 3: Define a ",(0,n.jsx)(t.code,{children:"protobuf_library"})," target"]}),"\n",(0,n.jsxs)(t.p,{children:["Wherever you create your ",(0,n.jsx)(t.code,{children:".proto"})," files, add a ",(0,n.jsx)(t.code,{children:"protobuf_library"}),"."]}),"\n",(0,n.jsxs)(s.A,{groupId:"code-examples",children:[(0,n.jsx)(a.A,{value:"src/proto/example/build",label:"src/proto/example/BUILD",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"src/proto/example/BUILD"}',children:"# `sources` defaults to `['*.proto']`.\nprotobuf_library()\n"})})}),(0,n.jsx)(a.A,{value:"src/proto/example/f.proto",label:"src/proto/example/f.proto",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-text",metastring:'tab={"label":"src/proto/example/f.proto"}',children:'syntax = "proto3";\n\npackage example;\n\nmessage Example {\n  ...\n}\n'})})})]}),"\n",(0,n.jsxs)(t.p,{children:["Your ",(0,n.jsx)(t.code,{children:"protobuf_library"})," can optionally depend on other ",(0,n.jsx)(t.code,{children:"protobuf_library"})," targets through the ",(0,n.jsx)(t.code,{children:"dependencies"})," field, if its ",(0,n.jsx)(t.code,{children:".proto"})," files need to import definitions from other",(0,n.jsx)(t.code,{children:".proto"})," files."]}),"\n",(0,n.jsxs)(t.p,{children:["If you want gRPC code generated, set ",(0,n.jsx)(t.code,{children:"grpc=True"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",metastring:'title="src/proto/example/BUILD"',children:"protobuf_library(grpc=True)\n"})}),"\n",(0,n.jsxs)(t.h2,{id:"step-4-use-the-protobuf_library-in-your-python-code",children:["Step 4: Use the ",(0,n.jsx)(t.code,{children:"protobuf_library"})," in your Python code"]}),"\n",(0,n.jsxs)(t.p,{children:["Now, you can add the ",(0,n.jsx)(t.code,{children:"protobuf_library"})," to the ",(0,n.jsx)(t.code,{children:"dependencies"})," field of your Python targets. Pants will generate the Python code automatically for you."]}),"\n",(0,n.jsxs)(t.p,{children:["In your Python file, import the module with the name ",(0,n.jsx)(t.code,{children:"_pb2"})," at the end, e.g. ",(0,n.jsx)(t.code,{children:"protos/example.proto"})," becomes ",(0,n.jsx)(t.code,{children:"proto.example_pb2"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["If gRPC is activated, you can also import the module with ",(0,n.jsx)(t.code,{children:"_pb2_grpc"})," at the end, e.g. ",(0,n.jsx)(t.code,{children:"proto.example_pb2_grpc"}),"."]}),"\n",(0,n.jsxs)(s.A,{groupId:"code-examples",children:[(0,n.jsx)(a.A,{value:"src/python/example/build",label:"src/python/example/BUILD",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"src/python/example/BUILD"}',children:'python_library(\n    dependencies=[\n        "src/proto/example",\n    ],\n)\n'})})}),(0,n.jsx)(a.A,{value:"src/python/example/app.py",label:"src/python/example/app.py",children:(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",metastring:'tab={"label":"src/python/example/app.py"}',children:"from example.f_pb2 import Message\n\n# See https://developers.google.com/protocol-buffers/docs/pythontutorial\n# for how to use the generated code in your project.\n"})})})]}),"\n",(0,n.jsxs)(t.p,{children:[(0,n.jsx)(t.a,{href:"/2.0/docs/using-pants/concepts/targets-and-build-files",children:"Dependency inference"})," does not work with Protobuf. You must explicitly declare all dependencies on ",(0,n.jsx)(t.code,{children:"protobuf_library"})," targets."]}),"\n",(0,n.jsxs)(t.admonition,{type:"caution",children:[(0,n.jsxs)(t.mdxAdmonitionTitle,{children:["You likely need to add empty ",(0,n.jsx)(t.code,{children:"__init__.py"})," files"]}),(0,n.jsxs)(t.p,{children:["By default, Pants will generate the Python files in the same directory as the ",(0,n.jsx)(t.code,{children:".proto"})," file. To get Python imports working properly, you will likely need to add an empty ",(0,n.jsx)(t.code,{children:"__init__.py"})," in the same location, and possibly in ancestor directories. You do not need to add a ",(0,n.jsx)(t.code,{children:"python_library()"})," target; Pants will automatically include the file."]}),(0,n.jsxs)(t.p,{children:['See the below section "Protobuf and source roots" for how to generate into a different directory. If you use this option, you will still likely need an empty ',(0,n.jsx)(t.code,{children:"__init__.py"})," file in the destination directory."]})]}),"\n",(0,n.jsxs)(t.admonition,{type:"tip",children:[(0,n.jsxs)(t.mdxAdmonitionTitle,{children:["Upcoming feature: ",(0,n.jsx)(t.code,{children:"export-codegen"})," goal"]}),(0,n.jsxs)(t.p,{children:["Pants 2.1 adds an ",(0,n.jsx)(t.code,{children:"export-codegen"})," rule to write the files to the ",(0,n.jsx)(t.code,{children:"dist/"})," dir."]}),(0,n.jsxs)(t.p,{children:["If you are not yet able to upgrade to 2.1, for now, you can add the ",(0,n.jsx)(t.code,{children:"protobuf_library()"})," as a dependency of a ",(0,n.jsx)(t.code,{children:"pex_binary()"}),", then run ",(0,n.jsx)(t.code,{children:"./pants package"})," on the binary target, and finally inspect the built PEX by using ",(0,n.jsx)(t.code,{children:"unzip"}),"."]})]}),"\n",(0,n.jsxs)(t.admonition,{title:"Upcoming feature: dependency inference for Protobuf",type:"tip",children:[(0,n.jsx)(t.p,{children:"Pants 2.2 adds support for dependency inference of:"}),(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Python imports of Protobuf files, including gRPC files."}),"\n",(0,n.jsx)(t.li,{children:"Protobuf dependencies on other Protobuf files."}),"\n"]})]}),"\n",(0,n.jsx)(t.h2,{id:"protobuf-and-source-roots",children:"Protobuf and source roots"}),"\n",(0,n.jsxs)(t.p,{children:["By default, generated code goes into the same ",(0,n.jsx)(t.a,{href:"/2.0/docs/using-pants/concepts/source-roots",children:"source root"})," as the ",(0,n.jsx)(t.code,{children:".proto"})," file from which it was generated. For example, a file ",(0,n.jsx)(t.code,{children:"src/proto/example/f.proto"})," will generate ",(0,n.jsx)(t.code,{children:"src/proto/example/f_pb2.py"}),"."]}),"\n",(0,n.jsxs)(t.p,{children:["However this may not always be what you want. In particular, you may not want to have to add ",(0,n.jsx)(t.code,{children:"__init__py"})," files under ",(0,n.jsx)(t.code,{children:"src/proto"})," just so you can import Python code generated to that source root."]}),"\n",(0,n.jsxs)(t.p,{children:["You can configure a different source root for generated code by setting the ",(0,n.jsx)(t.code,{children:"python_source_root"})," field:"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-python",metastring:'title="src/proto/example/BUILD"',children:"protobuf_library(\n  python_source_root='src/python'\n)\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Now ",(0,n.jsx)(t.code,{children:"src/proto/example/f.proto"})," will generate ",(0,n.jsx)(t.code,{children:"src/python/example/f_pb2.py"}),", i.e., the generated files will share a source root with your other Python code."]}),"\n",(0,n.jsxs)(t.admonition,{title:"Set packages relative to the source root",type:"note",children:[(0,n.jsxs)(t.p,{children:["Remember that the ",(0,n.jsx)(t.code,{children:"package"})," directive in your ",(0,n.jsx)(t.code,{children:".proto"})," file should be relative to the source root."]}),(0,n.jsxs)(t.p,{children:["For example, if you have a file at ",(0,n.jsx)(t.code,{children:"src/proto/example/subdir/f.proto"}),", you'd set its ",(0,n.jsx)(t.code,{children:"package"})," to ",(0,n.jsx)(t.code,{children:"example.subdir"}),"; and in your Python code, ",(0,n.jsx)(t.code,{children:"from example.subdir import f_pb2"}),"."]})]})]})}function u(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(h,{...e})}):h(e)}},753348(e,t,o){o.d(t,{A:()=>r});let r={tabItem:"tabItem_mHvh"}},618264(e,t,o){o.d(t,{A:()=>r});let r={tabList:"tabList_sFbf",tabItem:"tabItem_UVfV"}},637180(e,t,o){o.d(t,{A:()=>s});var r=o(886070);o(830758);var n=o(313526),i=o(753348);function s({children:e,hidden:t,className:o}){return(0,r.jsx)("div",{role:"tabpanel",className:(0,n.A)(i.A.tabItem,o),hidden:t,children:e})}},685008(e,t,o){o.d(t,{A:()=>f});var r=o(886070),n=o(830758),i=o(313526),s=o(911212),a=o(274875),l=o(106632),d=o(189223),c=o(618264);function p({className:e,block:t,selectedValue:o,selectValue:n,tabValues:s}){let l=[],{blockElementScrollPositionUntilNextRender:d}=(0,a.a_)(),p=e=>{let t=e.currentTarget,r=s[l.indexOf(t)].value;r!==o&&(d(t),n(r))},h=e=>{let t=null;switch(e.key){case"Enter":p(e);break;case"ArrowRight":{let o=l.indexOf(e.currentTarget)+1;t=l[o]??l[0];break}case"ArrowLeft":{let o=l.indexOf(e.currentTarget)-1;t=l[o]??l[l.length-1]}}t?.focus()};return(0,r.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":t},e),children:s.map(({value:e,label:t,attributes:n})=>(0,r.jsx)("li",{role:"tab",tabIndex:o===e?0:-1,"aria-selected":o===e,ref:e=>{l.push(e)},onKeyDown:h,onClick:p,...n,className:(0,i.A)("tabs__item",c.A.tabItem,n?.className,{"tabs__item--active":o===e}),children:t??e},e))})}function h({lazy:e,children:t,selectedValue:o}){let s=(Array.isArray(t)?t:[t]).filter(Boolean);if(e){let e=s.find(e=>e.props.value===o);return e?(0,n.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,r.jsx)("div",{className:"margin-top--md",children:s.map((e,t)=>(0,n.cloneElement)(e,{key:t,hidden:e.props.value!==o}))})}function u(e){let t=(0,l.u)(e);return(0,r.jsxs)("div",{className:(0,i.A)(s.G.tabs.container,"tabs-container",c.A.tabList),children:[(0,r.jsx)(p,{...t,...e}),(0,r.jsx)(h,{...t,...e})]})}function f(e){let t=(0,d.A)();return(0,r.jsx)(u,{...e,children:(0,l.v)(e.children)},String(t))}},106632(e,t,o){o.d(t,{u:()=>p,v:()=>d});var r=o(830758),n=o(325557),i=o(363717),s=o(125740),a=o(574229),l=o(270367);function d(e){return r.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){let{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function c({value:e,tabValues:t}){return t.some(t=>t.value===e)}function p(e){let t,{defaultValue:o,queryString:p=!1,groupId:h}=e,u=function(e){let{values:t,children:o}=e;return(0,r.useMemo)(()=>{let e=t??d(o).map(({props:{value:e,label:t,attributes:o,default:r}})=>({value:e,label:t,attributes:o,default:r})),r=(0,a.XI)(e,(e,t)=>e.value===t.value);if(r.length>0)throw Error(`Docusaurus error: Duplicate values "${r.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[t,o])}(e),[f,y]=(0,r.useState)(()=>(function({defaultValue:e,tabValues:t}){if(0===t.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!c({value:e,tabValues:t}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let o=t.find(e=>e.default)??t[0];if(!o)throw Error("Unexpected error: 0 tabValues");return o.value})({defaultValue:o,tabValues:u})),[x,b]=function({queryString:e=!1,groupId:t}){let o=(0,n.W6)(),i=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,s.aZ)(i),(0,r.useCallback)(e=>{if(!i)return;let t=new URLSearchParams(o.location.search);t.set(i,e),o.replace({...o.location,search:t.toString()})},[i,o])]}({queryString:p,groupId:h}),[m,g]=function({groupId:e}){let t=e?`docusaurus.tab.${e}`:null,[o,n]=(0,l.Dv)(t);return[o,(0,r.useCallback)(e=>{t&&n.set(e)},[t,n])]}({groupId:h}),j=c({value:t=x??m,tabValues:u})?t:null;return(0,i.A)(()=>{j&&y(j)},[j]),{selectedValue:f,selectValue:(0,r.useCallback)(e=>{if(!c({value:e,tabValues:u}))throw Error(`Can't select invalid tab value=${e}`);y(e),b(e),g(e)},[b,g,u]),tabValues:u}}},848193(e,t,o){o.d(t,{R:()=>s,x:()=>a});var r=o(830758);let n={},i=r.createContext(n);function s(e){let t=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:s(e.components),r.createElement(i.Provider,{value:t},e.children)}},538614(e){e.exports=JSON.parse('{"id":"docs/codegen/protobuf-and-grpc","title":"Protobuf and gRPC","description":"How to generate Python from Protocol Buffers.","source":"@site/versioned_docs/version-2.0/docs/codegen/protobuf-and-grpc.mdx","sourceDirName":"docs/codegen","slug":"/docs/codegen/protobuf-and-grpc","permalink":"/2.0/docs/codegen/protobuf-and-grpc","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/codegen/protobuf-and-grpc.mdx","tags":[],"version":"2.0","sidebarPosition":0,"frontMatter":{"title":"Protobuf and gRPC","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"typecheck","permalink":"/2.0/docs/python/goals/typecheck"},"next":{"title":"Python support","permalink":"/2.0/docs/aws-lambda/python-support"}}')}}]);