"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["812788"],{225734(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>t,toc:()=>c});var t=s(489230),i=s(886070),o=s(848193);let r={title:"Common subsystem tasks",sidebar_position:999},l,a={},c=[{value:"Skipping individual targets",id:"skipping-individual-targets",level:2},{value:"Making subsystems exportable with their default lockfile",id:"making-subsystems-exportable-with-their-default-lockfile",level:2},{value:"Loading config files",id:"loading-config-files",level:2}];function d(e){let n={admonition:"admonition",code:"code",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Common tasks for Subsystems"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"skipping-individual-targets",children:"Skipping individual targets"}),"\n",(0,i.jsxs)(n.p,{children:["Many subsystems allow skipping specific targets. For example, you might have Python files that you want to not typecheck with mypy. In Pants, this is achieved with a ",(0,i.jsx)(n.code,{children:"skip_*"})," field on the target. This is simple to implement."]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Create a field for skipping your tool"}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from pants.engine.target import BoolField\n\nclass SkipFortranLintField(BoolField):\n	alias = "skip_fortran_lint"\n	default = False\n	help = "If true, don\'t run fortran-lint on this target\'s code."\n'})}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Register this field on the appropriate targets."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"def rules():\n	return [\n		FortranSourceTarget.register_plugin_field(SkipFortranLintField),\n	]\n"})}),"\n",(0,i.jsxs)(n.ol,{start:"3",children:["\n",(0,i.jsxs)(n.li,{children:["Add this field as part of your subsystems ",(0,i.jsx)(n.code,{children:"opt_out"})," method:"]}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.engine.target import FieldSet, Target\n\n\n@dataclass\nclass FortranLintFieldSet(FieldSet):\n    required_fields = (FortranSourceField,)\n\n    source: FortranSourceField\n\n    @classmethod\n    def opt_out(cls, tgt: Target) -> bool:\n        return tgt.get(SkipFortranLintField).value\n"})}),"\n",(0,i.jsx)(n.h2,{id:"making-subsystems-exportable-with-their-default-lockfile",children:"Making subsystems exportable with their default lockfile"}),"\n",(0,i.jsx)(n.admonition,{title:"Support depends on language backend of the subsystem",type:"note",children:(0,i.jsxs)(n.p,{children:["Only some language backends support ",(0,i.jsx)(n.code,{children:"pants export"}),". These include the Python and JVM backends. Only tools which are themselves written to use a backend with this feature can be exported. For example, a Python-based tool which operates on a different language is exportable."]})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Make the subsystem a subclass of ",(0,i.jsx)(n.code,{children:"ExportableTool"})]}),"\n",(0,i.jsx)(n.admonition,{title:"Language backends may have done this in their Tool base class.",type:"note",children:(0,i.jsxs)(n.p,{children:["For example, the Python backend with ",(0,i.jsx)(n.code,{children:"PythonToolRequirementsBase"})," and JVM with ",(0,i.jsx)(n.code,{children:"JvmToolBase"})," are already subclasses."]})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from pants.backend.python.subsystems.python_tool_base import PythonToolBase\nfrom pants.core.goals.resolves import ExportableTool\n\nclass FortranLint(PythonToolBase, ExportableTool):\n    ...\n"})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Register your class with a ",(0,i.jsx)(n.code,{children:"UnionRule"})," with ",(0,i.jsx)(n.code,{children:"ExportableTool"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"def rules():\n    return [\n        UnionRule(ExportableTool, FortranLint)\n    ]\n"})}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"loading-config-files",children:"Loading config files"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsx)(n.p,{children:"Add an option to toggle config discovery:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from pants.option.subsystem import Subsystem\nfrom pants.option.option_types import BoolOption\nfrom pants.util.strutil import softwrap\n\nclass FortranLint(Subsystem):\n    config_discovery = BoolOption(\n        default=True,\n        advanced=True,\n        help=lambda cls: softwrap(\n            f"""\n            If true, Pants will include all relevant config files during runs.\n\n            Use `[{cls.options_scope}].config` and `[{cls.options_scope}].custom_check_dir` instead if your config is in a non-standard location.\n            """\n        ),\n    )\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add an option for the configuration file itself. Several options are useful depending on what types of config files you need: ",(0,i.jsx)(n.code,{children:"FileOption"}),", ",(0,i.jsx)(n.code,{children:"FileListOption"}),", ",(0,i.jsx)(n.code,{children:"DirOption"}),", ",(0,i.jsx)(n.code,{children:"DirListOption"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from pants.option.subsystem import Subsystem\nfrom pants.option.option_types import FileOption\nfrom pants.util.strutil import softwrap\n\nclass FortranLint(Subsystem):\n    config = FileOption(\n        default=None,\n        advanced=True,\n        help=lambda cls: softwrap(\n            """\n            Path to the fortran-lint config file.\n\n            Setting this option will disable config discovery for the config file. Use this option if the config is located in a non-standard location.\n            """\n        ),\n    )\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Add a helper function to generate the ",(0,i.jsx)(n.code,{children:"ConfigFilesRequest"}),". The ",(0,i.jsx)(n.code,{children:"check_existence"})," field is used for config discovery. ",(0,i.jsx)(n.code,{children:"specified"})," can also be a list for using one of the list options."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from pants.core.util_rules.config_files import ConfigFilesRequest\nfrom pants.option.subsystem import Subsystem\n\nclass FortranLint(Subsystem):\n    def config_request(self) -> ConfigFilesRequest:\n        return ConfigFilesRequest(\n            specified=self.config,\n            specified_option_name=f"[{self.options_scope}].config",\n            discovery=self.config_discovery,\n            check_existence=["fortran_lint.ini"],\n        )\n'})}),"\n"]}),"\n",(0,i.jsxs)(n.li,{children:["\n",(0,i.jsxs)(n.p,{children:["Make a request for the config files in a rule for running the tool. Use a ",(0,i.jsx)(n.code,{children:"Get(ConfigFiles, ConfigFilesRequest)"})," to get the config files. This has a snapshot that contains the config files (or will be empty if none are found). You can merge these with the other digests to pass the files to your ",(0,i.jsx)(n.code,{children:"Process"}),". If a custom value was provided for the config file, you may need to pass that as an argument to the ",(0,i.jsx)(n.code,{children:"Process"}),". You may also need to register rules from ",(0,i.jsx)(n.code,{children:"pants.core.util_rules.config_files"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from pants.core.goals.lint import LintResult\nfrom pants.core.util_rules import config_files\nfrom pants.core.util_rules.config_files import ConfigFiles, ConfigFilesRequest\nfrom pants.core.util_rules.source_files import SourceFiles, SourceFilesRequest\nfrom pants.engine.fs import Digest, MergeDigests\nfrom pants.engine.rules import Get, MultiGet, collect_rules, rule\n\n@rule\nasync def run_fortran_lint(request: FortranlintRequest.Batch, subsystem: FortranLint) -> LintResult:\n    sources, config_file = await MultiGet(\n        Get(SourceFiles, SourceFilesRequest(fs.sources for fs in request.elements)),\n        Get(ConfigFiles, ConfigFilesRequest, subsystem.config_request()),\n    )\n\n    input_digest = await Get(\n        Digest, MergeDigests((sources.snapshot.digest, config_file.snapshot.digest))\n    )\n\n    args = []\n    if subsystem.config_request:\n        args.append(f"--config-file={subsystem.config}")\n\n    # run your process with the digest and args\n\ndef rules():\n    return [\n        *collect_rules(),\n        *config_files.rules(),\n    ]\n'})}),"\n"]}),"\n"]})]})}function p(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},848193(e,n,s){s.d(n,{R:()=>r,x:()=>l});var t=s(830758);let i={},o=t.createContext(i);function r(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),t.createElement(o.Provider,{value:n},e.children)}},489230(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-subsystem-tasks","title":"Common subsystem tasks","description":"Common tasks for Subsystems","source":"@site/versioned_docs/version-2.24/docs/writing-plugins/common-subsystem-tasks.mdx","sourceDirName":"docs/writing-plugins","slug":"/docs/writing-plugins/common-subsystem-tasks","permalink":"/2.24/docs/writing-plugins/common-subsystem-tasks","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-subsystem-tasks.mdx","tags":[],"version":"2.24","sidebarPosition":999,"frontMatter":{"title":"Common subsystem tasks","sidebar_position":999},"sidebar":"docsSidebar","previous":{"title":"Making a tool exportable","permalink":"/2.24/docs/writing-plugins/common-plugin-tasks/allowing-tool-export"},"next":{"title":"Deprecation policy","permalink":"/2.24/docs/releases/deprecation-policy"}}')}}]);