"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["920480"],{146197(e,t,s){s.r(t),s.d(t,{assets:()=>o,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>n,toc:()=>c});var n=s(516938),a=s(886070),i=s(848193);let r={title:"Package code",sidebar_position:5},l,o={},c=[{value:"1. Set up a package target type (recommended)",id:"1-set-up-a-package-target-type-recommended",level:2},{value:"2. Set up a subclass of <code>PackageFieldSet</code>",id:"2-set-up-a-subclass-of-packagefieldset",level:2},{value:"3. Create a rule for your logic",id:"3-create-a-rule-for-your-logic",level:2},{value:"4. Add tests (optional)",id:"4-add-tests-optional",level:2}];function d(e){let t={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)(t.p,{children:["How to add a new implementation to the ",(0,a.jsx)(t.code,{children:"package"})," goal."]}),"\n",(0,a.jsx)(t.hr,{}),"\n",(0,a.jsxs)(t.p,{children:["The ",(0,a.jsx)(t.code,{children:"package"})," goal bundles all the relevant code and third-party dependencies into a single asset, such as a JAR, PEX, or zip file."]}),"\n",(0,a.jsx)(t.p,{children:"Often, the asset is executable, but it need not be."}),"\n",(0,a.jsxs)(t.admonition,{title:"Example repository",type:"note",children:[(0,a.jsxs)(t.p,{children:["This guide walks through adding a simple ",(0,a.jsx)(t.code,{children:"package"})," implementation for Bash that simply puts all the relevant source files into a ",(0,a.jsx)(t.code,{children:".zip"})," file."]}),(0,a.jsxs)(t.p,{children:["This duplicates the ",(0,a.jsx)(t.code,{children:"archive"})," target type, and is solely implemented for instructional purposes. See ",(0,a.jsx)(t.a,{href:"https://github.com/pantsbuild/example-plugin/blob/main/pants-plugins/examples/bash/package_binary.py",children:"here"})," for the final implementation."]})]}),"\n",(0,a.jsx)(t.h2,{id:"1-set-up-a-package-target-type-recommended",children:"1. Set up a package target type (recommended)"}),"\n",(0,a.jsxs)(t.p,{children:["Usually, you will want to add a new target type for your implementation, such as ",(0,a.jsx)(t.code,{children:"bash_binary"})," or ",(0,a.jsx)(t.code,{children:"python_distribution"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["If your package has a specific file as its entry point, you may want to subclass the ",(0,a.jsx)(t.code,{children:"Sources"})," field and set the class property ",(0,a.jsx)(t.code,{children:"expected_num_files = 1"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["Usually, you will want to include ",(0,a.jsx)(t.code,{children:"OutputPathField"})," from ",(0,a.jsx)(t.code,{children:"pants.core.goals.package"})," in your target's fields, which will allow the user to change where the package is built to."]}),"\n",(0,a.jsxs)(t.p,{children:["See ",(0,a.jsx)(t.a,{href:"/2.0/docs/writing-plugins/the-target-api/creating-new-targets",children:"Creating new targets"})," for a guide on how to define new target types."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'from pants.core.goals.package import OutputPathField\nfrom pants.engine.target import COMMON_TARGET_FIELDS, Dependencies, Sources, Target\n\nclass BashSources(Sources):\n    expected_file_extensions = (".sh",)\n\n\nclass BashBinarySources(BashSources):\n     required = True\n     expected_num_files = 1\n\n\n class BashBinary(Target):\n     """A Bash file that may be directly run."""\n\n     alias = "bash_binary"\n     core_fields = (*COMMON_TARGET_FIELDS, OutputPathField, Dependencies, BashBinarySources)\n'})}),"\n",(0,a.jsxs)(t.h2,{id:"2-set-up-a-subclass-of-packagefieldset",children:["2. Set up a subclass of ",(0,a.jsx)(t.code,{children:"PackageFieldSet"})]}),"\n",(0,a.jsxs)(t.p,{children:["As described in ",(0,a.jsx)(t.a,{href:"/2.0/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Rules and the Target API"}),", a ",(0,a.jsx)(t.code,{children:"FieldSet"})," is a way to tell Pants which ",(0,a.jsx)(t.code,{children:"Field"}),"s you care about targets having for your plugin to work."]}),"\n",(0,a.jsxs)(t.p,{children:["Create a new dataclass that subclasses ",(0,a.jsx)(t.code,{children:"PackageFieldSet"}),". Set the class property ",(0,a.jsx)(t.code,{children:"required_fields"})," to the fields your target must have registered to work. Usually, this is a field like ",(0,a.jsx)(t.code,{children:"BashEntryPoint"})," or ",(0,a.jsx)(t.code,{children:"BashBinarySources"}),"."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.core.goals.package import OutputPathField, PackageFieldSet\n\n@dataclass(frozen=True)\nclass BashBinaryFieldSet(PackageFieldSet):\n    required_fields = (BashBinarySources,)\n\n    sources: BashBinarySources\n    output_path: OutputPathField\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Then, register your new ",(0,a.jsx)(t.code,{children:"PackageFieldSet"})," with a ",(0,a.jsx)(t.a,{href:"/2.0/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,a.jsx)(t.code,{children:"UnionRule"})})," so that Pants knows your binary implementation exists:"]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:"from pants.engine.rules import collect_rules\nfrom pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(PackageFieldSet, BashBinaryFieldSet),\n    ]\n"})}),"\n",(0,a.jsx)(t.h2,{id:"3-create-a-rule-for-your-logic",children:"3. Create a rule for your logic"}),"\n",(0,a.jsxs)(t.p,{children:["Your rule should take as a parameter the ",(0,a.jsx)(t.code,{children:"PackageFieldSet"})," from Step 2. It should return ",(0,a.jsx)(t.code,{children:"BuiltPackage"}),", which has the fields ",(0,a.jsx)(t.code,{children:"digest: Digest"})," and ",(0,a.jsx)(t.code,{children:"artifacts: Tuple[BuiltPackageArtifact, ...]"}),", where each ",(0,a.jsx)(t.code,{children:"BuiltPackageArtifact"})," has the field ",(0,a.jsx)(t.code,{children:"relpath: str"})," and optional ",(0,a.jsx)(t.code,{children:"extra_log_lines: Tuple[str, ...]"}),"."]}),"\n",(0,a.jsxs)(t.p,{children:["Your package rule can have whatever logic you'd like to create a package. All that Pants cares about is that you return a valid ",(0,a.jsx)(t.code,{children:"BuiltPackage"})," object."]}),"\n",(0,a.jsxs)(t.p,{children:["In this example, we simply create a ",(0,a.jsx)(t.code,{children:".zip"})," file with the ",(0,a.jsx)(t.code,{children:"bash_binary"})," and all of its dependencies."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",children:'from dataclasses import dataclass\n\nfrom pants.core.goals.package import (\n    BuiltPackage,\n    BuiltPackageArtifact,\n    OutputPathField,\n    PackageFieldSet,\n)\nfrom pants.core.util_rules.source_files import SourceFiles, SourceFilesRequest\nfrom pants.engine.addresses import Addresses\nfrom pants.engine.process import BinaryPathRequest, BinaryPaths, Process, ProcessResult\nfrom pants.engine.rules import Get, rule\nfrom pants.engine.target import TransitiveTargets\nfrom pants.util.logging import LogLevel\n\nfrom examples.bash.target_types import BashBinarySources, BashSources\n\n...\n\n@rule(level=LogLevel.DEBUG)\nasync def package_bash_binary(field_set: BashBinaryFieldSet) -> BuiltPckage:\n    zip_program_paths = await Get(\n        BinaryPaths,\n        BinaryPathRequest(binary_name="zip", search_path=["/bin", "/usr/bin"]),\n    )\n    if not zip_program_paths.first_path:\n        raise ValueError(\n            "Could not find the `zip` program on `/bin` or `/usr/bin`, so cannot create a package "\n            f"for {field_set.address}."\n        )\n\n    transitive_targets = await Get(TransitiveTargets, Addresses([field_set.address]))\n    sources = await Get(\n        SourceFiles,\n        SourceFilesRequest(\n            tgt[BashSources]\n            for tgt in transitive_targets.closure\n            if tgt.has_field(BashSources)\n        ),\n    )\n\n    output_filename = field_set.output_path.value_or_default(\n        field_set.address, file_ending="zip"\n    )\n    result = await Get(\n        ProcessResult,\n        Process(\n            argv=(\n                zip_program_paths.first_path,\n                output_filename,\n                *sources.snapshot.files,\n            ),\n            input_digest=sources.snapshot.digest,\n            description=f"Zip {field_set.address} and its dependencies.",\n            output_files=(output_filename,),\n        ),\n    )\n    return BuiltPackage(\n        result.output_digest, artifacts=(BuiltPackageArtifact(output_filename),)\n    )\n\n'})}),"\n",(0,a.jsxs)(t.p,{children:["Note that we use ",(0,a.jsx)(t.code,{children:"field_set.output_path.value_or_default"})," to determine the output filename, which will use the ",(0,a.jsx)(t.code,{children:"output_path"})," field if defined, and will default to an unambiguous value otherwise."]}),"\n",(0,a.jsxs)(t.p,{children:["Finally, update your plugin's ",(0,a.jsx)(t.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,a.jsx)(t.pre,{children:(0,a.jsx)(t.code,{className:"language-python",metastring:'title="pants-plugins/bash/register.py"',children:"from bash import package_binary\n\n\ndef rules():\n    return [*package_binary.rules()]\n"})}),"\n",(0,a.jsxs)(t.p,{children:["Now, when you run ",(0,a.jsx)(t.code,{children:"./pants package ::"}),", Pants should create packages for all your package target types in the ",(0,a.jsx)(t.code,{children:"--pants-distdir"})," (defaults to ",(0,a.jsx)(t.code,{children:"dist/"}),")."]}),"\n",(0,a.jsx)(t.h2,{id:"4-add-tests-optional",children:"4. Add tests (optional)"}),"\n",(0,a.jsxs)(t.p,{children:["Refer to ",(0,a.jsx)(t.a,{href:"/2.0/docs/writing-plugins/the-rules-api/testing-plugins",children:"Testing rules"}),". TODO"]})]})}function p(e={}){let{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,a.jsx)(t,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},848193(e,t,s){s.d(t,{R:()=>r,x:()=>l});var n=s(830758);let a={},i=n.createContext(a);function r(e){let t=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),n.createElement(i.Provider,{value:t},e.children)}},516938(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/package-code","title":"Package code","description":"How to add a new implementation to the package goal.","source":"@site/versioned_docs/version-2.0/docs/writing-plugins/common-plugin-tasks/package-code.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/package-code","permalink":"/2.0/docs/writing-plugins/common-plugin-tasks/package-code","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/package-code.mdx","tags":[],"version":"2.0","sidebarPosition":5,"frontMatter":{"title":"Package code","sidebar_position":5},"sidebar":"docsSidebar","previous":{"title":"Run programs","permalink":"/2.0/docs/writing-plugins/common-plugin-tasks/run-programs"},"next":{"title":"Add a REPL","permalink":"/2.0/docs/writing-plugins/common-plugin-tasks/add-a-repl"}}')}}]);