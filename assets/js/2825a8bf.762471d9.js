"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["389234"],{258963(e,t,s){s.r(t),s.d(t,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>i,metadata:()=>n,toc:()=>d});var n=s(628485),o=s(886070),r=s(848193);let i={title:"Add a formatter",sidebar_position:1},l,a={},d=[{value:"1. Install your formatter",id:"1-install-your-formatter",level:2},{value:"2. Set up a <code>FieldSet</code> and <code>FmtTargetsRequest</code>",id:"2-set-up-a-fieldset-and-fmttargetsrequest",level:2},{value:"3. Create <code>fmt</code> rules",id:"3-create-fmt-rules",level:2},{value:"4. Add tests (optional)",id:"4-add-tests-optional",level:2},{value:"5. Make the tool exportable (optional)",id:"5-make-the-tool-exportable-optional",level:2}];function c(e){let t={a:"a",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)(t.p,{children:["How to add a new formatter to the ",(0,o.jsx)(t.code,{children:"fmt"})," and ",(0,o.jsx)(t.code,{children:"lint"})," goals."]}),"\n",(0,o.jsx)(t.hr,{}),"\n",(0,o.jsxs)(t.p,{children:["In Pants, every formatter is also a linter, meaning that if you can run a tool with ",(0,o.jsx)(t.code,{children:"pants fmt"}),", you can run the same tool in check-only mode with ",(0,o.jsx)(t.code,{children:"pants lint"}),". Start by skimming ",(0,o.jsx)(t.a,{href:"/2.28/docs/writing-plugins/common-plugin-tasks/add-a-linter",children:"Add a linter"})," to familiarize yourself with how linters work."]}),"\n",(0,o.jsx)(t.p,{children:"This guide assumes that you are running a formatter that already exists outside of Pants as a stand-alone binary, such as running Black or Prettier."}),"\n",(0,o.jsxs)(t.p,{children:["If you are instead writing your own formatting logic inline, you can skip Step 1. In Step 4, you will not need to use ",(0,o.jsx)(t.code,{children:"Process"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"1-install-your-formatter",children:"1. Install your formatter"}),"\n",(0,o.jsxs)(t.p,{children:["There are several ways for Pants to install your formatter. See ",(0,o.jsx)(t.a,{href:"/2.28/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),". This example will use ",(0,o.jsx)(t.code,{children:"ExternalTool"})," because there is already a pre-compiled binary for shfmt."]}),"\n",(0,o.jsxs)(t.p,{children:["You will also likely want to register some options, like ",(0,o.jsx)(t.code,{children:"--config"}),", ",(0,o.jsx)(t.code,{children:"--skip"}),", and ",(0,o.jsx)(t.code,{children:"--args"}),". Options are registered through a ",(0,o.jsx)(t.a,{href:"/2.28/docs/writing-plugins/the-rules-api/options-and-subsystems",children:(0,o.jsx)(t.code,{children:"Subsystem"})}),". If you are using ",(0,o.jsx)(t.code,{children:"ExternalTool"}),", this is already a subclass of ",(0,o.jsx)(t.code,{children:"Subsystem"}),". Otherwise, create a subclass of ",(0,o.jsx)(t.code,{children:"Subsystem"}),". Then, set the class property ",(0,o.jsx)(t.code,{children:"options_scope"})," to the name of the tool, e.g. ",(0,o.jsx)(t.code,{children:'"shfmt"'})," or ",(0,o.jsx)(t.code,{children:'"prettier"'}),". Finally, add options from ",(0,o.jsx)(t.code,{children:"pants.option.option_types"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'from pants.core.util_rules.external_tool import ExternalTool\nfrom pants.engine.platform import Platform\nfrom pants.option.option_types import ArgsListOption, SkipOption\n\n\nclass Shfmt(ExternalTool):\n    """An autoformatter for shell scripts (https://github.com/mvdan/sh)."""\n\n    options_scope = "shfmt"\n    name = "Shfmt"\n    default_version = "v3.2.4"\n    default_known_versions = [\n        "v3.2.4|macos_arm64 |e70fc42e69debe3e400347d4f918630cdf4bf2537277d672bbc43490387508ec|2998546",\n        "v3.2.4|macos_x86_64|43a0461a1b54070ddc04fbbf1b78f7861ee39a65a61f5466d15a39c4aba4f917|2980208",\n        "v3.2.4|linux_arm64 |6474d9cc08a1c9fe2ef4be7a004951998e3067d46cf55a011ddd5ff7bfab3de6|2752512",\n        "v3.2.4|linux_x86_64|3f5a47f8fec27fae3e06d611559a2063f5d27e4b9501171dde9959b8c60a3538|2797568",\n    ]\n\n    # We set this because we need the mapping for both `generate_exe` and `generate_url`.\n    platform_mapping = {\n        "macos_arm64": "darwin_arm64",\n        "macos_x86_64": "darwin_amd64",\n        "linux_arm64": "linux_arm64",\n        "linux_x86_64": "linux_amd64",\n    }\n\n    skip = SkipOption("fmt", "lint")\n    args = ArgsListOption(example="-i 2")\n\n    def generate_url(self, plat: Platform) -> str:\n        plat_str = self.platform_mapping[plat.value]\n        return (\n            f"https://github.com/mvdan/sh/releases/download/{self.version}/"\n            f"shfmt_{self.version}_{plat_str}"\n        )\n\n    def generate_exe(self, plat: Platform) -> str:\n        plat_str = self.platform_mapping[plat.value]\n        return f"./shfmt_{self.version}_{plat_str}"\n'})}),"\n",(0,o.jsxs)(t.h2,{id:"2-set-up-a-fieldset-and-fmttargetsrequest",children:["2. Set up a ",(0,o.jsx)(t.code,{children:"FieldSet"})," and ",(0,o.jsx)(t.code,{children:"FmtTargetsRequest"})]}),"\n",(0,o.jsxs)(t.p,{children:["As described in ",(0,o.jsx)(t.a,{href:"/2.28/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Rules and the Target API"}),", a ",(0,o.jsx)(t.code,{children:"FieldSet"})," is a way to tell Pants which ",(0,o.jsx)(t.code,{children:"Field"}),"s you care about targets having for your plugin to work."]}),"\n",(0,o.jsxs)(t.p,{children:["Usually, you should add a subclass of ",(0,o.jsx)(t.code,{children:"SourcesField"})," to the class property ",(0,o.jsx)(t.code,{children:"required_fields"}),", such as ",(0,o.jsx)(t.code,{children:"ShellSourceField"})," or ",(0,o.jsx)(t.code,{children:"PythonSourceField"}),". This means that your linter will run on any target with that sources field or a subclass of it."]}),"\n",(0,o.jsxs)(t.p,{children:["Create a new dataclass that subclasses ",(0,o.jsx)(t.code,{children:"FieldSet"}),":"]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.engine.target import FieldSet\n\n...\n\n@dataclass(frozen=True)\nclass ShfmtFieldSet(FieldSet):\n    required_fields = (ShellSourceField,)\n\n    sources: ShellSourceField\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Then, hook this up to a new subclass of ",(0,o.jsx)(t.code,{children:"FmtTargetsRequest"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"from pants.core.goals.fmt import FmtTargetsRequest\n\n\nclass ShfmtRequest(FmtTargetsRequest):\n    field_set_type = ShfmtFieldSet\n    tool_subsystem = Shfmt\n"})}),"\n",(0,o.jsxs)(t.h2,{id:"3-create-fmt-rules",children:["3. Create ",(0,o.jsx)(t.code,{children:"fmt"})," rules"]}),"\n",(0,o.jsxs)(t.p,{children:["You will need a rule for ",(0,o.jsx)(t.code,{children:"fmt"})," which takes the ",(0,o.jsx)(t.code,{children:"FmtTargetsRequest.Batch"})," from step 3 (e.g. ",(0,o.jsx)(t.code,{children:"ShfmtRequest"}),") as a parameter and returns a ",(0,o.jsx)(t.code,{children:"FmtResult"}),"."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:'@rule(desc="Format with shfmt", level=LogLevel.DEBUG)\nasync def shfmt_fmt(request: ShfmtRequest.Batch, shfmt: Shfmt, platform: Platform) -> FmtResult:\n    download_shfmt_get = Get(\n        DownloadedExternalTool,\n        ExternalToolRequest,\n        shfmt.get_request(platform),\n    )\n\n    # If the user specified `--shfmt-config`, we must search for the file they specified with\n    # `PathGlobs` to include it in the `input_digest`. We error if the file cannot be found.\n    config_digest_get = Get(\n        Digest,\n        PathGlobs(\n            globs=[shfmt.config] if shfmt.config else [],\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n            description_of_origin="the option `--shfmt-config`",\n        ),\n    )\n\n    downloaded_shfmt, config_digest = await MultiGet(\n        download_shfmt_get, config_digest_get\n    )\n\n    input_digest = await Get(\n        Digest,\n        MergeDigests(\n            (request.snapshot.digest, downloaded_shfmt.digest, config_digest)\n        ),\n    )\n\n    argv = [\n        downloaded_shfmt.exe,\n        "-w",\n        *shfmt.args,\n        *request.snapshot.files,\n    ]\n    process = Process(\n        argv=argv,\n        input_digest=input_digest,\n        output_files=request.snapshot.files,\n        description=f"Run shfmt on {pluralize(len(request.snapshot.files), \'file\')}.",\n        level=LogLevel.DEBUG,\n    )\n\n    result = await Get(ProcessResult, Process, process)\n    return await FmtResult.create(request, result, output_snapshot)\n'})}),"\n",(0,o.jsxs)(t.p,{children:["The ",(0,o.jsx)(t.code,{children:"ShfmtRequest.Batch"})," object has ",(0,o.jsx)(t.code,{children:".snapshot"}),", which stores the list of files and the ",(0,o.jsx)(t.code,{children:"Digest"})," for each source file."]}),"\n",(0,o.jsxs)(t.p,{children:["If you used ",(0,o.jsx)(t.code,{children:"ExternalTool"})," in step 1, you will use ",(0,o.jsx)(t.code,{children:"Get(DownloadedExternalTool, ExternalToolRequest)"})," to ensure that the tool is fetched."]}),"\n",(0,o.jsxs)(t.p,{children:["Use ",(0,o.jsx)(t.code,{children:"Get(Digest, MergeDigests)"})," to combine the different inputs together, such as merging the source files and downloaded tool."]}),"\n",(0,o.jsx)(t.p,{children:"At the bottom of your file, tell Pants about your rules:"}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",children:"def rules():\n    return [\n      	*collect_rules(),\n        *ShfmtRequest.rules(partitioner_type=PartitionerType.DEFAULT_SINGLE_PARTITION),\n    ]\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Finally, update your plugin's ",(0,o.jsx)(t.code,{children:"register.py"})," to activate this file's rules. Note that we must register the rules added in Step 2, as well."]}),"\n",(0,o.jsx)(t.pre,{children:(0,o.jsx)(t.code,{className:"language-python",metastring:'title="pants-plugins/shell/register.py"',children:"from shell import shfmt\n\n\ndef rules():\n    return [*shfmt.rules()]\n"})}),"\n",(0,o.jsxs)(t.p,{children:["Now, when you run ",(0,o.jsx)(t.code,{children:"pants fmt ::"})," or ",(0,o.jsx)(t.code,{children:"pants lint ::"}),", your new formatter should run."]}),"\n",(0,o.jsx)(t.h2,{id:"4-add-tests-optional",children:"4. Add tests (optional)"}),"\n",(0,o.jsxs)(t.p,{children:["Refer to ",(0,o.jsx)(t.a,{href:"/2.28/docs/writing-plugins/the-rules-api/testing-plugins",children:"Testing rules"}),"."]}),"\n",(0,o.jsx)(t.h2,{id:"5-make-the-tool-exportable-optional",children:"5. Make the tool exportable (optional)"}),"\n",(0,o.jsxs)(t.p,{children:["Refer to ",(0,o.jsx)(t.a,{href:"/2.28/docs/writing-plugins/common-plugin-tasks/allowing-tool-export",children:"Allowing tool export"})," to allow users to export the tool for use in external programs."]})]})}function h(e={}){let{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,o.jsx)(t,{...e,children:(0,o.jsx)(c,{...e})}):c(e)}},848193(e,t,s){s.d(t,{R:()=>i,x:()=>l});var n=s(830758);let o={},r=n.createContext(o);function i(e){let t=n.useContext(r);return n.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function l(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:i(e.components),n.createElement(r.Provider,{value:t},e.children)}},628485(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-formatter","title":"Add a formatter","description":"How to add a new formatter to the fmt and lint goals.","source":"@site/versioned_docs/version-2.28/docs/writing-plugins/common-plugin-tasks/add-a-formatter.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-formatter","permalink":"/2.28/docs/writing-plugins/common-plugin-tasks/add-a-formatter","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-formatter.mdx","tags":[],"version":"2.28","sidebarPosition":1,"frontMatter":{"title":"Add a formatter","sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Add a linter","permalink":"/2.28/docs/writing-plugins/common-plugin-tasks/add-a-linter"},"next":{"title":"Add a typechecker","permalink":"/2.28/docs/writing-plugins/common-plugin-tasks/add-a-typechecker"}}')}}]);