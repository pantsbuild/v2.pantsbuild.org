"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["227210"],{510052(e,n,i){i.r(n),i.d(n,{assets:()=>r,contentTitle:()=>d,default:()=>h,frontMatter:()=>a,metadata:()=>t,toc:()=>o});var t=i(915567),s=i(886070),l=i(848193);let a={title:"Creating new fields",sidebar_position:1},d,r={},o=[{value:"Defining a Field",id:"defining-a-field",level:2},{value:"Changing the <code>default</code>",id:"changing-the-default",level:3},{value:"Marking a field as <code>required</code>",id:"marking-a-field-as-required",level:3},{value:"FYI: Pants uses the Docstring to generate docs",id:"fyi-pants-uses-the-docstring-to-generate-docs",level:3},{value:"Adding custom validation",id:"adding-custom-validation",level:2},{value:"Available templates",id:"available-templates",level:2},{value:"<code>BoolField</code>",id:"boolfield",level:3},{value:"<code>IntField</code>",id:"intfield",level:3},{value:"<code>FloatField</code>",id:"floatfield",level:3},{value:"<code>StringField</code>",id:"stringfield",level:3},{value:"<code>ScalarField</code> (advanced)",id:"scalarfield-advanced",level:3},{value:"<code>StringSequenceField</code>",id:"stringsequencefield",level:3},{value:"<code>SequenceField</code>",id:"sequencefield",level:3},{value:"<code>DictStringToStringField</code>",id:"dictstringtostringfield",level:3},{value:"<code>DictStringToStringSequenceField</code>",id:"dictstringtostringsequencefield",level:3},{value:"<code>PrimitiveField</code> - the fallback class",id:"primitivefield---the-fallback-class",level:3},{value:"Examples",id:"examples",level:2}];function c(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"How to create a Field, including the available templates."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:"Before creating a new target type, the first step is to create all of the target type's fields."}),"\n",(0,s.jsx)(n.h2,{id:"defining-a-field",children:"Defining a Field"}),"\n",(0,s.jsx)(n.p,{children:"To define a new field:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Subclass one of the below field templates, like ",(0,s.jsx)(n.code,{children:"IntField"})," or ",(0,s.jsx)(n.code,{children:"BoolField"}),"; or, subclass a pre-existing field, like ",(0,s.jsx)(n.code,{children:"Sources"}),"."]}),"\n",(0,s.jsxs)(n.li,{children:["Define the class property ",(0,s.jsx)(n.code,{children:"alias"}),". This is the symbol that people use in BUILD files."]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from pants.engine.target import IntField\n\nclass TimeoutField(IntField):\n    """How long to run until timing out."""\n\n    alias = "timeout"\n'})}),"\n",(0,s.jsxs)(n.h3,{id:"changing-the-default",children:["Changing the ",(0,s.jsx)(n.code,{children:"default"})]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"default"})," is used whenever a user does not explicitly specify the field in a BUILD file."]}),"\n",(0,s.jsxs)(n.p,{children:["Set the class property ",(0,s.jsx)(n.code,{children:"default = $val"}),", where ",(0,s.jsx)(n.code,{children:"$val"})," is the value you want."]}),"\n",(0,s.jsxs)(n.p,{children:["If you don't override this property, ",(0,s.jsx)(n.code,{children:"default"})," will be set to ",(0,s.jsx)(n.code,{children:"None"}),", which signals that the value was undefined."]}),"\n",(0,s.jsxs)(n.h3,{id:"marking-a-field-as-required",children:["Marking a field as ",(0,s.jsx)(n.code,{children:"required"})]}),"\n",(0,s.jsxs)(n.p,{children:["Set the class property ",(0,s.jsx)(n.code,{children:"required = True"})," to enforce that users must explicitly define the field."]}),"\n",(0,s.jsxs)(n.p,{children:["If you set ",(0,s.jsx)(n.code,{children:"required = True"}),", the ",(0,s.jsx)(n.code,{children:"default"})," value will be ignored."]}),"\n",(0,s.jsx)(n.h3,{id:"fyi-pants-uses-the-docstring-to-generate-docs",children:"FYI: Pants uses the Docstring to generate docs"}),"\n",(0,s.jsxs)(n.p,{children:["When you run ",(0,s.jsx)(n.code,{children:"./pants help my_target"}),", Pants will use your field definition to generate the output. It will look at the class's docstring, the field template used, and whether ",(0,s.jsx)(n.code,{children:"required = True"}),"."]}),"\n",(0,s.jsxs)(n.admonition,{title:"Reminder: subclass pre-existing fields to modify their behavior",type:"note",children:[(0,s.jsx)(n.p,{children:"If you want to change how a pre-existing field behaves, you should subclass the original field. For example, if you want to change a default value, subclass the original field."}),(0,s.jsxs)(n.p,{children:["See ",(0,s.jsx)(n.a,{href:"/2.1/docs/writing-plugins/the-target-api/concepts",children:"Concepts"})," for how subclassing plays a key role in the Target API."]})]}),"\n",(0,s.jsx)(n.h2,{id:"adding-custom-validation",children:"Adding custom validation"}),"\n",(0,s.jsxs)(n.p,{children:["The field templates will validate that users are using the correct ",(0,s.jsx)(n.em,{children:"types"}),", like ints or strings. But you may want to add additional validation, such as banning certain values."]}),"\n",(0,s.jsxs)(n.p,{children:["To do this, override the classmethod ",(0,s.jsx)(n.code,{children:"compute_value"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from pants.engine.target import IntField, InvalidFieldException\n\nclass UploadTimeout(IntField):\n    ...\n\n    @classmethod\n    def compute_value(\n        cls, raw_value: Optional[int], *, address: Address\n    ) -> int:\n      value_or_default = super().compute_value(raw_value, address=address)\n      if value_or_default < 10 or value_or_default > 300:\n          raise InvalidFieldException(\n              f"The {repr(cls.alias)} field in target {address} must "\n              f"be between 10 and 300, but was {value_or_default}."\n          )\n      return value_or_default\n'})}),"\n",(0,s.jsxs)(n.p,{children:["Be careful to use the same type hint for the parameter ",(0,s.jsx)(n.code,{children:"raw_value"})," as used in the template. This is used to generate the documentation in ",(0,s.jsx)(n.code,{children:"./pants help my_target"}),"."]}),"\n",(0,s.jsx)(n.h2,{id:"available-templates",children:"Available templates"}),"\n",(0,s.jsxs)(n.p,{children:["All templates are defined in ",(0,s.jsx)(n.code,{children:"pants.engine.target"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"boolfield",children:(0,s.jsx)(n.code,{children:"BoolField"})}),"\n",(0,s.jsx)(n.p,{children:"Use this when the option is a boolean toggle."}),"\n",(0,s.jsxs)(n.p,{children:["If you do not set ",(0,s.jsx)(n.code,{children:"required = True"})," or give a default, the default will be ",(0,s.jsx)(n.code,{children:"None"}),". This can be useful to represent three states: unspecified, ",(0,s.jsx)(n.code,{children:"False"}),", and ",(0,s.jsx)(n.code,{children:"True"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"intfield",children:(0,s.jsx)(n.code,{children:"IntField"})}),"\n",(0,s.jsx)(n.p,{children:"Use this when you expect an integer. This will reject floats."}),"\n",(0,s.jsx)(n.h3,{id:"floatfield",children:(0,s.jsx)(n.code,{children:"FloatField"})}),"\n",(0,s.jsx)(n.p,{children:"Use this when you expect a float. This will reject integers."}),"\n",(0,s.jsx)(n.h3,{id:"stringfield",children:(0,s.jsx)(n.code,{children:"StringField"})}),"\n",(0,s.jsx)(n.p,{children:"Use this when you expect a single string."}),"\n",(0,s.jsxs)(n.admonition,{type:"note",children:[(0,s.jsxs)(n.mdxAdmonitionTitle,{children:[(0,s.jsx)(n.code,{children:"StringField"})," can be like an enum"]}),(0,s.jsxs)(n.p,{children:["You can set the class property ",(0,s.jsx)(n.code,{children:"valid_choices"})," to limit what strings are acceptable. This class property can either be a tuple of strings or an ",(0,s.jsx)(n.code,{children:"enum.Enum"}),"."]}),(0,s.jsx)(n.p,{children:"For example:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class LeafyGreensField(StringField):\n    alias = "leafy_greens"\n    valid_choices = ("kale", "spinach", "chard")\n'})}),(0,s.jsx)(n.p,{children:"or:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class LeafyGreens(Enum):\n    KALE = "kale"\n    SPINACH = "spinach"\n    CHARD = "chard"\n\nclass LeafyGreensField(StringField):\n    alias = "leafy_greens"\n    valid_choices = LeafyGreens\n'})})]}),"\n",(0,s.jsxs)(n.h3,{id:"scalarfield-advanced",children:[(0,s.jsx)(n.code,{children:"ScalarField"})," (advanced)"]}),"\n",(0,s.jsxs)(n.p,{children:["Use this when you expect a single value, but it is a non-primitive type. For example, use this with any ",(0,s.jsx)(n.a,{href:"/2.1/docs/writing-plugins/macros",children:(0,s.jsx)(n.code,{children:"objects"})})," you defined."]}),"\n",(0,s.jsxs)(n.p,{children:["You must set the class properties ",(0,s.jsx)(n.code,{children:"expected_type"})," and ",(0,s.jsx)(n.code,{children:"expected_type_description"}),". You should also change the type signature of the classmethod ",(0,s.jsx)(n.code,{children:"compute_value"})," so that Pants can show the correct types when running ",(0,s.jsx)(n.code,{children:"./pants help $target_type"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"For example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class DemoScalarField(ScalarField):\n    alias = "demo_scalar"\n    expected_type = MyObject\n    expected_type_description = "a `my_object()` instance"\n\n    @classmethod\n    def compute_value(\n        raw_value: Optional[MyObject], *, address: Address\n    ) -> Optional[MyObject]:\n        return super().compute_value(raw_value, address=address)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"stringsequencefield",children:(0,s.jsx)(n.code,{children:"StringSequenceField"})}),"\n",(0,s.jsx)(n.p,{children:"Use this when you expect 0-n strings."}),"\n",(0,s.jsx)(n.p,{children:"The user may use a tuple, set, or list in their BUILD file; Pants will convert the value to an immutable tuple."}),"\n",(0,s.jsx)(n.h3,{id:"sequencefield",children:(0,s.jsx)(n.code,{children:"SequenceField"})}),"\n",(0,s.jsx)(n.p,{children:"Use this when you expect a homogenous sequence of values other than strings, such as a sequence of integers."}),"\n",(0,s.jsx)(n.p,{children:"The user may use a tuple, set, or list in their BUILD file; Pants will convert the value to an immutable tuple."}),"\n",(0,s.jsxs)(n.p,{children:["You must set the class properties ",(0,s.jsx)(n.code,{children:"expected_element_type"})," and ",(0,s.jsx)(n.code,{children:"expected_type_description"}),". You should also change the type signature of the classmethod ",(0,s.jsx)(n.code,{children:"compute_value"})," so that Pants can show the correct types when running ",(0,s.jsx)(n.code,{children:"./pants help $target_type"}),"."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'class ExampleIntSequence(SequenceField):\n    alias = "int_sequence"\n    expected_element_type = int\n    expected_type_description = "a sequence of integers"\n\n    @classmethod\n    def compute_value(\n        raw_value: Optional[Iterable[int]], *, address: Address\n    ) -> Optional[Tuple[int, ...]]:\n        return super().compute_value(raw_value, address=address)\n'})}),"\n",(0,s.jsx)(n.h3,{id:"dictstringtostringfield",children:(0,s.jsx)(n.code,{children:"DictStringToStringField"})}),"\n",(0,s.jsxs)(n.p,{children:["Use this when you expect a dictionary of string keys with strings values, such as ",(0,s.jsx)(n.code,{children:'{"k": "v"}'}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The user may use a normal Python dictionary in their BUILD file. Pants will convert this into an instance of ",(0,s.jsx)(n.code,{children:"pants.util.frozendict.FrozenDict"}),", which is a light-weight wrapper around the native ",(0,s.jsx)(n.code,{children:"dict"})," type that simply removes all mechanisms to mutate the dictionary."]}),"\n",(0,s.jsx)(n.h3,{id:"dictstringtostringsequencefield",children:(0,s.jsx)(n.code,{children:"DictStringToStringSequenceField"})}),"\n",(0,s.jsxs)(n.p,{children:["Use this when you expect a dictionary of string keys with a sequence of strings values, such as ",(0,s.jsx)(n.code,{children:'{"k": ["v1", "v2"]}'}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["The user may use a normal Python dictionary in their BUILD file, and they may use a tuple, set, or list for the dictionary values. Pants will convert this into an instance of ",(0,s.jsx)(n.code,{children:"pants.util.frozendict.FrozenDict"}),", which is a light-weight wrapper around the native ",(0,s.jsx)(n.code,{children:"dict"})," type that simply removes all mechanisms to mutate the dictionary. Pants will also convert the values into immutable tuples, resulting in a type hint of ",(0,s.jsx)(n.code,{children:"FrozenDict[str, Tuple[str, ...]]"}),"."]}),"\n",(0,s.jsxs)(n.h3,{id:"primitivefield---the-fallback-class",children:[(0,s.jsx)(n.code,{children:"PrimitiveField"})," - the fallback class"]}),"\n",(0,s.jsxs)(n.p,{children:["If none of these templates work for you, you can subclass ",(0,s.jsx)(n.code,{children:"PrimitiveField"}),", which is the superclass of all of these templates."]}),"\n",(0,s.jsxs)(n.p,{children:["You must give a type hint for ",(0,s.jsx)(n.code,{children:"value"}),", define the classmethod ",(0,s.jsx)(n.code,{children:"compute_value"}),", and either set ",(0,s.jsx)(n.code,{children:"required = True"})," or define the class property ",(0,s.jsx)(n.code,{children:"default"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, we could define a ",(0,s.jsx)(n.code,{children:"StringField"})," explicitly like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from typing import Optional\n\nfrom pants.engine.addresses import Address\nfrom pants.engine.target import InvalidFieldTypeException, PrimitiveField\n\n\nclass VersionField(PrimitiveField):\n    alias = "version"\n    value: Optional[str]\n    default = None\n\n   @classmethod\n   def compute_value(\n       cls, raw_value: Optional[str], *, address: Address\n   ) -> Optional[str]:\n       value_or_default = super().compute_value(raw_value, address=address)\n       if value_or_default is not None and not isinstance(value, str):\n           # A helper exception message to generate nice error messages\n           # automatically. You can use another exception if you prefer.\n           raise InvalidFieldTypeException(\n                address, cls.alias, raw_value, expected_type="a string",\n           )\n       return value_or_default\n'})}),"\n",(0,s.jsx)(n.admonition,{title:"Asking for help",type:"tip",children:(0,s.jsxs)(n.p,{children:["Have a tricky field you're trying to write? We would love to help! See ",(0,s.jsx)(n.a,{href:"/community/members",children:"Getting Help"}),"."]})}),"\n",(0,s.jsx)(n.h2,{id:"examples",children:"Examples"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="plugins/target_types.py"',children:'from typing import Optional\n\nfrom pants.engine.target import (\n    BoolField,\n    IntField,\n    InvalidFieldException,\n    Sources,\n    StringField\n)\n\n\nclass FortranVersion(StringField):\n    """Which version of Fortran should this use?"""\n\n    alias = "fortran_version"\n    required = True\n    valid_choices = ("f95", "f98")\n\n\nclass CompressToggle(BoolField):\n    """Whether to compress the generated file."""\n\n    alias = "compress"\n    default = False\n\n\nclass UploadTimeout(IntField):\n    """How long to upload (in seconds) before timing out.\n\n    This must be between 10 and 300 seconds.\n    """\n\n    alias = "upload_timeout"\n    default = 100\n\n    @classmethod\n    def compute_value(\n        cls, raw_value: Optional[int], *, address: Address\n    ) -> int:\n      value_or_default = super().compute_value(raw_value, address=address)\n      if value_or_default < 10 or value_or_default > 300:\n          raise InvalidFieldException(\n              f"The {repr(cls.alias)} field in target {address} must "\n              f"be between 10 and 300, but was {value_or_default}."\n          )\n      return value_or_default\n\n\n# Example of subclassing a pre-existing field.\n# We don\'t need to define `alias = sources` because the\n# parent class does this already.\nclass FortranSources(Sources):\n    default = ("*.f95",)\n'})})]})}function h(e={}){let{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},848193(e,n,i){i.d(n,{R:()=>a,x:()=>d});var t=i(830758);let s={},l=t.createContext(s);function a(e){let n=t.useContext(l);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(l.Provider,{value:n},e.children)}},915567(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-target-api/creating-new-fields","title":"Creating new fields","description":"How to create a Field, including the available templates.","source":"@site/versioned_docs/version-2.1/docs/writing-plugins/the-target-api/creating-new-fields.mdx","sourceDirName":"docs/writing-plugins/the-target-api","slug":"/docs/writing-plugins/the-target-api/creating-new-fields","permalink":"/2.1/docs/writing-plugins/the-target-api/creating-new-fields","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-target-api/creating-new-fields.mdx","tags":[],"version":"2.1","sidebarPosition":1,"frontMatter":{"title":"Creating new fields","sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Concepts","permalink":"/2.1/docs/writing-plugins/the-target-api/concepts"},"next":{"title":"Creating new targets","permalink":"/2.1/docs/writing-plugins/the-target-api/creating-new-targets"}}')}}]);