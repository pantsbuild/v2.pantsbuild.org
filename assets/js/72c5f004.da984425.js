"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["340403"],{22894(e,t,n){n.r(t),n.d(t,{assets:()=>o,contentTitle:()=>r,default:()=>u,frontMatter:()=>a,metadata:()=>i,toc:()=>d});var i=n(606580),s=n(886070),l=n(848193);let a={title:"Migrating from Get",sidebar_position:11},r,o={},d=[{value:"<code>Get</code> and <code>MultiGet</code>",id:"get-and-multiget",level:2},{value:"<code>Get</code> and <code>MultiGet</code> are deprecated",id:"get-and-multiget-are-deprecated",level:2},{value:"Migrating to call-by-name",id:"migrating-to-call-by-name",level:2},{value:"Migrating union <code>Get</code>s to call-by-name",id:"migrating-union-gets-to-call-by-name",level:2}];function c(e){let t={a:"a",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.p,{children:"Migrating away from the old call-by-type Rules API."}),"\n",(0,s.jsx)(t.hr,{}),"\n",(0,s.jsxs)(t.h2,{id:"get-and-multiget",children:[(0,s.jsx)(t.code,{children:"Get"})," and ",(0,s.jsx)(t.code,{children:"MultiGet"})]}),"\n",(0,s.jsxs)(t.p,{children:["As ",(0,s.jsx)(t.a,{href:"/stable/docs/writing-plugins/the-rules-api/concepts",children:"we've seen"}),", rules invoke other rules directly by name:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'from pants.engine.fs import NativeDownloadFile\nfrom pants.engine.intrinsics import download_file\nfrom pants.engine.rules import rule\n...\n\n@rule\nasync def my_rule() -> MyResult:\n    downloaded_file = await download_file(\n        NativeDownloadFile("https://www.google.com/robots.txt")\n    )\n    ...\n'})}),"\n",(0,s.jsxs)(t.p,{children:["However, a previous version of the Rules API had a different idiom, call-by-type. This was achieved using a construct called ",(0,s.jsx)(t.code,{children:"Get"}),":"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:'from pants.engine.fs import Digest, NativeDownloadFile\nfrom pants.engine.rules import Get, rule\n...\n\n@rule\nasync def my_rule() -> MyResult:\n    downloaded_file = await Get(Digest, NativeDownloadFile("https://www.google.com/robots.txt"))\n    ...\n'})}),"\n",(0,s.jsxs)(t.p,{children:["A ",(0,s.jsx)(t.code,{children:"Get(OutputType, InputType, input)"})," or ",(0,s.jsx)(t.code,{children:"Get(OutputType, InputType(...))"}),' invoked the engine\'s "fill in the blanks" mechanism to find a rule or a cascade of rules that could produce a value of OutputType from the given input type (plus any contextual parameters).']}),"\n",(0,s.jsxs)(t.p,{children:["To achieve concurrency you could ",(0,s.jsx)(t.code,{children:"await MultiGet(<iterable of Gets>)"}),"."]}),"\n",(0,s.jsxs)(t.h2,{id:"get-and-multiget-are-deprecated",children:[(0,s.jsx)(t.code,{children:"Get"})," and ",(0,s.jsx)(t.code,{children:"MultiGet"})," are deprecated"]}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.code,{children:"Get"})," and ",(0,s.jsx)(t.code,{children:"MultiGet"})," are now deprecated, and will be removed entirely soon. Pants itself no longer uses them internally, but external plugins still might. Plugin authors must migrate from ",(0,s.jsx)(t.code,{children:"Get"}),"/",(0,s.jsx)(t.code,{children:"MultiGet"})," to call-by-name syntax as soon as possible."]}),"\n",(0,s.jsx)(t.h2,{id:"migrating-to-call-by-name",children:"Migrating to call-by-name"}),"\n",(0,s.jsx)(t.p,{children:"Migrating to call-by-name is fairly straightforward:"}),"\n",(0,s.jsxs)(t.p,{children:["First, replace all ",(0,s.jsx)(t.code,{children:"MultiGet"}),"s with ",(0,s.jsx)(t.code,{children:"concurrently"}),", imported from from ",(0,s.jsx)(t.code,{children:"pants.engine.rules"}),". ",(0,s.jsx)(t.code,{children:"MultiGet"})," is now just an alias for ",(0,s.jsx)(t.code,{children:"concurrently"}),", so this is trivial to do with a find/replace."]}),"\n",(0,s.jsxs)(t.p,{children:["Then, replace ",(0,s.jsx)(t.code,{children:"await Get(OutputType, InputType, input)"})," with ",(0,s.jsx)(t.code,{children:"await rule_name(...)"})," where ",(0,s.jsx)(t.code,{children:"rule_name"})," is the rule that returns a value ",(0,s.jsx)(t.code,{children:"OutputType"}),"."]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If the rule has exactly one parameter, of type ",(0,s.jsx)(t.code,{children:"InputType"}),", then this as simple as:"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:"val = await rule_name(input)\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If the rule has other parameters that should be passed implicitly, then add an empty ",(0,s.jsx)(t.code,{children:"**implicitly()"}),":"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:"val = await rule_name(input, **implicitly())\n"})}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsxs)(t.li,{children:["If the rule that returns ",(0,s.jsx)(t.code,{children:"OutputType"})," does not take ",(0,s.jsx)(t.code,{children:"InputType"})," directly, but rather some ",(0,s.jsx)(t.code,{children:"IntermediateType"}),", then we need to tell the Pants engine to fill in the blanks, just as the ",(0,s.jsx)(t.code,{children:"Get"})," would have:"]}),"\n"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-python",children:"val = await rule_name(**implicitly({input: InputType}))\n"})}),"\n",(0,s.jsxs)(t.p,{children:["There may be various corner cases that require slightly more refactoring. We encourage you to ask for help on ",(0,s.jsx)(t.a,{href:"/community/getting-help",children:"Slack"})," with those."]}),"\n",(0,s.jsxs)(t.p,{children:["For examples of migrations, you can review ",(0,s.jsx)(t.a,{href:"https://github.com/pantsbuild/pants/pulls?q=is%3Apr+%22call-by-name%22+is%3Aclosed",children:"pull requests"})," made to the Pants repository. Additionally, there are some simplified examples in the form of ",(0,s.jsx)(t.a,{href:"https://github.com/pantsbuild/pants/blob/main/src/python/pants/goal/migrate_call_by_name_integration_test.py",children:"Pants integration tests"}),"."]}),"\n",(0,s.jsxs)(t.h2,{id:"migrating-union-gets-to-call-by-name",children:["Migrating union ",(0,s.jsx)(t.code,{children:"Get"}),"s to call-by-name"]}),"\n",(0,s.jsxs)(t.p,{children:["If you're relying on polymorphic dispatch via a ",(0,s.jsx)(t.a,{href:"/stable/docs/writing-plugins/the-rules-api/union-rules-advanced",children:"union"}),', then you must make sure that your implementation rule has the same signature as the "base" rule (the ',(0,s.jsx)(t.code,{children:"@rule(polymorphic=True)"})," rule) - the same type annotations for parameters and return value - except with your subtype in place of the union type. If things aren't working and the base rule is a standard Pants rule, you can examine its signature in the Pants source code."]})]})}function u(e={}){let{wrapper:t}={...(0,l.R)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},848193(e,t,n){n.d(t,{R:()=>a,x:()=>r});var i=n(830758);let s={},l=i.createContext(s);function a(e){let t=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),i.createElement(l.Provider,{value:t},e.children)}},606580(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-rules-api/migrating-gets","title":"Migrating from Get","description":"Migrating away from the old call-by-type Rules API.","source":"@site/versioned_docs/version-2.30/docs/writing-plugins/the-rules-api/migrating-gets.mdx","sourceDirName":"docs/writing-plugins/the-rules-api","slug":"/docs/writing-plugins/the-rules-api/migrating-gets","permalink":"/stable/docs/writing-plugins/the-rules-api/migrating-gets","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-rules-api/migrating-gets.mdx","tags":[],"version":"2.30","sidebarPosition":11,"frontMatter":{"title":"Migrating from Get","sidebar_position":11},"sidebar":"docsSidebar","previous":{"title":"Tips and debugging","permalink":"/stable/docs/writing-plugins/the-rules-api/tips-and-debugging"},"next":{"title":"Common plugin tasks","permalink":"/stable/docs/writing-plugins/common-plugin-tasks/"}}')}}]);