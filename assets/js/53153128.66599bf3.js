"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["737524"],{44363(e,n,r){r.r(n),r.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>l,metadata:()=>t,toc:()=>h});var t=r(90060),a=r(886070),i=r(848193),o=r(685008),s=r(637180);let l={title:"Overview",sidebar_position:0},c,d={},h=[{value:"Enabling the Docker backend",id:"enabling-the-docker-backend",level:2},{value:"Adding <code>docker_image</code> targets",id:"adding-docker_image-targets",level:2},{value:"Adding dependencies to your <code>docker_image</code> targets",id:"adding-dependencies-to-your-docker_image-targets",level:2},{value:"Building a Docker image",id:"building-a-docker-image",level:2},{value:"Example",id:"example",level:2},{value:"Tagging the image",id:"tagging-the-image",level:2},{value:"Linting Dockerfiles",id:"linting-dockerfiles",level:2}];function u(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.p,{children:"How to build Docker images containing artifacts built by Pants"}),"\n",(0,a.jsx)(n.hr,{}),"\n",(0,a.jsxs)(n.p,{children:[(0,a.jsx)(n.a,{href:"https://www.docker.com/",children:"Docker"})," images are a common deployment format."]}),"\n",(0,a.jsx)(n.p,{children:"Docker images typically bundle build artifacts, such as PEX files, wheels, loose files, and so on, with other runtime requirements, such as a Python interpreter."}),"\n",(0,a.jsx)(n.p,{children:"Pants makes it easy to embed the artifacts it builds into your Docker images, for easy deployment."}),"\n",(0,a.jsx)(n.h2,{id:"enabling-the-docker-backend",children:"Enabling the Docker backend"}),"\n",(0,a.jsx)(n.p,{children:"To use Pants's Docker support you must enable the appropriate backend:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'backend_packages = [\n  ...\n  "pants.backend.experimental.docker",\n  ...\n]\n'})}),"\n",(0,a.jsx)(n.p,{children:'We expect the Docker backend to graduate out of the "experimental" area soon!'}),"\n",(0,a.jsxs)(n.h2,{id:"adding-docker_image-targets",children:["Adding ",(0,a.jsx)(n.code,{children:"docker_image"})," targets"]}),"\n",(0,a.jsxs)(n.p,{children:["A docker image is built from a recipe specified by a ",(0,a.jsx)(n.a,{href:"https://docs.docker.com/engine/reference/builder/",children:"Dockerfile"}),". When you build docker images with Pants, instead of running ",(0,a.jsx)(n.code,{children:"docker"})," on the Dockerfile directly, you let Pants do that for you."]}),"\n",(0,a.jsxs)(n.p,{children:["Pants uses ",(0,a.jsx)(n.code,{children:"docker_image"})," ",(0,a.jsx)(n.a,{href:"/2.7/docs/using-pants/key-concepts/targets-and-build-files",children:"targets"})," to indicate which Dockerfiles you want Pants to know about, and to add any necessary metadata."]}),"\n",(0,a.jsxs)(n.p,{children:["You can autogenerate initial BUILD files for your Docker images, using ",(0,a.jsx)(n.a,{href:"/2.7/docs/python/goals/tailor",children:"tailor"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"$ ./pants tailor\nCreated src/docker/app1/BUILD:\n  - Added docker_image target src/docker/app1:docker\nCreated src/docker/app2/BUILD:\n  - Added docker_image target src/docker/app2:docker\n"})}),"\n",(0,a.jsx)(n.p,{children:"Or you can add them manually, such as:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'title="src/docker/app1/BUILD"',children:"docker_image(name='docker')\n"})}),"\n",(0,a.jsxs)(n.h2,{id:"adding-dependencies-to-your-docker_image-targets",children:["Adding dependencies to your ",(0,a.jsx)(n.code,{children:"docker_image"})," targets"]}),"\n",(0,a.jsxs)(n.p,{children:["A Dockerfile executes in a ",(0,a.jsx)(n.em,{children:"context"})," - a set of files that the commands in the Dockerfile can reference, e.g., by copying them into the image)."]}),"\n",(0,a.jsxs)(n.p,{children:["When you run ",(0,a.jsx)(n.code,{children:"docker"})," directly, the context is usually a directory within your repo. That directory must contain the Dockerfile (typically at the root of the context) and any files that the build requires. If those files are themselves the product of a build step, or if they are sources from elsewhere in the repo, then you have to copy them into the context."]}),"\n",(0,a.jsxs)(n.p,{children:["Pants, however, takes care of assembling the context for you. It does so using the dependencies of the ",(0,a.jsx)(n.code,{children:"docker_image"})," target."]}),"\n",(0,a.jsxs)(n.p,{children:["A ",(0,a.jsx)(n.code,{children:"docker_image"})," can depend on loose files belonging to ",(0,a.jsx)(n.a,{href:"/2.7/docs/using-pants/resources-and-archives#files",children:"files targets"}),", and on artifacts packaged from a variety of targets, such as ",(0,a.jsx)(n.a,{href:"/2.7/reference/targets/pex_binary",children:"pex_binary"})," , ",(0,a.jsx)(n.a,{href:"/2.7/reference/targets/python_distribution",children:"python_distribution"}),", ",(0,a.jsx)(n.a,{href:"/2.7/reference/targets/archive",children:"archive"}),", or any other target that can be built via the ",(0,a.jsx)(n.a,{href:"/2.7/reference/goals/package",children:"package"})," goal."]}),"\n",(0,a.jsx)(n.p,{children:"The context is assembled as follows:"}),"\n",(0,a.jsxs)(n.ul,{children:["\n",(0,a.jsxs)(n.li,{children:["The sources of ",(0,a.jsx)(n.code,{children:"files"})," targets are assembled at their relative path from the repo root."]}),"\n",(0,a.jsxs)(n.li,{children:["The artifacts of any packageable targets are built, as if by running ",(0,a.jsx)(n.code,{children:"./pants package"}),", and placed in the context under a subdirectory named for the target's path from the repo root."]}),"\n"]}),"\n",(0,a.jsx)(n.h2,{id:"building-a-docker-image",children:"Building a Docker image"}),"\n",(0,a.jsxs)(n.p,{children:["You build Docker images using the ",(0,a.jsx)(n.code,{children:"package"})," goal:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"$ ./pants package path/to/Dockerfile\n"})}),"\n",(0,a.jsx)(n.h2,{id:"example",children:"Example"}),"\n",(0,a.jsx)(n.p,{children:"To see this in action, look at the following example:"}),"\n",(0,a.jsxs)(o.A,{groupId:"code-examples",children:[(0,a.jsx)(s.A,{value:"src/docker/hw/build",label:"src/docker/hw/BUILD",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/docker/hw/BUILD"}',children:'files(\n    name="msg",\n    sources=["msg.txt"]\n)\n\ndocker_image(\n    name="helloworld",\n    dependencies=[":msg", "src/python/hw:bin"],\n)\n'})})}),(0,a.jsx)(s.A,{value:"src/docker/hw/dockerfile",label:"src/docker/hw/Dockerfile",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-dockerfile",metastring:'tab={"label":"src/docker/hw/Dockerfile"}',children:'FROM python:3.8\nENTRYPOINT ["/bin/helloworld"]\nCOPY msg.txt /var/msg\nCOPY src.python.hw/bin.pex /bin/helloworld\n'})})}),(0,a.jsx)(s.A,{value:"src/docker/hw/msg.txt",label:"src/docker/hw/msg.txt",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-text",metastring:'tab={"label":"src/docker/hw/msg.txt"}',children:"Hello, Docker!\n"})})}),(0,a.jsx)(s.A,{value:"src/python/hw/build",label:"src/python/hw/BUILD",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/python/hw/BUILD"}',children:'python_library(interpreter_constraints=["=3.8"])\n\npex_binary(\n    name="bin",\n    entry_point="main.py",\n)\n'})})}),(0,a.jsx)(s.A,{value:"src/python/hw/main.py",label:"src/python/hw/main.py",children:(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/python/hw/main.py"}',children:'import os\n\nif os.path.exists("/var/msg"):\n    with open("/var/msg") as fp:\n        msg = fp.read().strip()\nelse:\n    msg = "Hello"\nprint(msg)\n'})})})]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"$ ./pants package src/docker/hw/Dockerfile\n[...]\n18:07:29.66 [INFO] Completed: Building src.python.hw/bin.pex\n18:07:31.83 [INFO] Completed: Building docker image helloworld:latest\n18:07:31.83 [INFO] Built docker image: helloworld:latest\nTo try out the image interactively:\n    docker run -it --rm helloworld:latest [entrypoint args...]\nTo push your image:\n    docker push helloworld:latest\n$ docker run -it --rm helloworld:latest\nHello, Docker!\n"})}),"\n",(0,a.jsx)(n.h2,{id:"tagging-the-image",children:"Tagging the image"}),"\n",(0,a.jsxs)(n.p,{children:["By default the built image gets a ",(0,a.jsx)(n.code,{children:"latest"})," tag. To select another value to use, provide a ",(0,a.jsx)(n.code,{children:"version"})," value to ",(0,a.jsx)(n.code,{children:"docker_image"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",children:'docker_image(\n    name="helloworld",\n    version="1.2.0",\n    dependencies=[":msg", "src/python/hw:bin"],\n)\n'})}),"\n",(0,a.jsx)(n.admonition,{title:"Generating Tags",type:"note",children:(0,a.jsxs)(n.p,{children:["Generating custom tags at runtime based on Git state or image inputs requires you to write some custom plugin code. Don't hesitate to ",(0,a.jsx)(n.a,{href:"/community/getting-help",children:"reach out"})," for help with this.\nWe are looking into adding this functionality into the core Docker plugin in the future."]})}),"\n",(0,a.jsx)(n.h2,{id:"linting-dockerfiles",children:"Linting Dockerfiles"}),"\n",(0,a.jsxs)(n.p,{children:["Pants can run ",(0,a.jsx)(n.code,{children:"hadolint"})," on your Dockerfiles to check for errors and mistakes:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"$ ./pants lint src/docker/hw/Dockerfile\n"})}),"\n",(0,a.jsx)(n.p,{children:"This must first be enabled by adding the following configuration:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages.add = ["pants.backend.experimental.docker.lint.hadolint"]\n'})})]})}function p(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(u,{...e})}):u(e)}},753348(e,n,r){r.d(n,{A:()=>t});let t={tabItem:"tabItem_mHvh"}},618264(e,n,r){r.d(n,{A:()=>t});let t={tabList:"tabList_sFbf",tabItem:"tabItem_UVfV"}},637180(e,n,r){r.d(n,{A:()=>o});var t=r(886070);r(830758);var a=r(313526),i=r(753348);function o({children:e,hidden:n,className:r}){return(0,t.jsx)("div",{role:"tabpanel",className:(0,a.A)(i.A.tabItem,r),hidden:n,children:e})}},685008(e,n,r){r.d(n,{A:()=>g});var t=r(886070),a=r(830758),i=r(313526),o=r(911212),s=r(274875),l=r(106632),c=r(189223),d=r(618264);function h({className:e,block:n,selectedValue:r,selectValue:a,tabValues:o}){let l=[],{blockElementScrollPositionUntilNextRender:c}=(0,s.a_)(),h=e=>{let n=e.currentTarget,t=o[l.indexOf(n)].value;t!==r&&(c(n),a(t))},u=e=>{let n=null;switch(e.key){case"Enter":h(e);break;case"ArrowRight":{let r=l.indexOf(e.currentTarget)+1;n=l[r]??l[0];break}case"ArrowLeft":{let r=l.indexOf(e.currentTarget)-1;n=l[r]??l[l.length-1]}}n?.focus()};return(0,t.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},e),children:o.map(({value:e,label:n,attributes:a})=>(0,t.jsx)("li",{role:"tab",tabIndex:r===e?0:-1,"aria-selected":r===e,ref:e=>{l.push(e)},onKeyDown:u,onClick:h,...a,className:(0,i.A)("tabs__item",d.A.tabItem,a?.className,{"tabs__item--active":r===e}),children:n??e},e))})}function u({lazy:e,children:n,selectedValue:r}){let o=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){let e=o.find(e=>e.props.value===r);return e?(0,a.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,t.jsx)("div",{className:"margin-top--md",children:o.map((e,n)=>(0,a.cloneElement)(e,{key:n,hidden:e.props.value!==r}))})}function p(e){let n=(0,l.u)(e);return(0,t.jsxs)("div",{className:(0,i.A)(o.G.tabs.container,"tabs-container",d.A.tabList),children:[(0,t.jsx)(h,{...n,...e}),(0,t.jsx)(u,{...n,...e})]})}function g(e){let n=(0,c.A)();return(0,t.jsx)(p,{...e,children:(0,l.v)(e.children)},String(n))}},106632(e,n,r){r.d(n,{u:()=>h,v:()=>c});var t=r(830758),a=r(325557),i=r(363717),o=r(125740),s=r(574229),l=r(270367);function c(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){let{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function d({value:e,tabValues:n}){return n.some(n=>n.value===e)}function h(e){let n,{defaultValue:r,queryString:h=!1,groupId:u}=e,p=function(e){let{values:n,children:r}=e;return(0,t.useMemo)(()=>{let e=n??c(r).map(({props:{value:e,label:n,attributes:r,default:t}})=>({value:e,label:n,attributes:r,default:t})),t=(0,s.XI)(e,(e,n)=>e.value===n.value);if(t.length>0)throw Error(`Docusaurus error: Duplicate values "${t.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[n,r])}(e),[g,m]=(0,t.useState)(()=>(function({defaultValue:e,tabValues:n}){if(0===n.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!d({value:e,tabValues:n}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let r=n.find(e=>e.default)??n[0];if(!r)throw Error("Unexpected error: 0 tabValues");return r.value})({defaultValue:r,tabValues:p})),[f,x]=function({queryString:e=!1,groupId:n}){let r=(0,a.W6)(),i=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,o.aZ)(i),(0,t.useCallback)(e=>{if(!i)return;let n=new URLSearchParams(r.location.search);n.set(i,e),r.replace({...r.location,search:n.toString()})},[i,r])]}({queryString:h,groupId:u}),[b,k]=function({groupId:e}){let n=e?`docusaurus.tab.${e}`:null,[r,a]=(0,l.Dv)(n);return[r,(0,t.useCallback)(e=>{n&&a.set(e)},[n,a])]}({groupId:u}),v=d({value:n=f??b,tabValues:p})?n:null;return(0,i.A)(()=>{v&&m(v)},[v]),{selectedValue:g,selectValue:(0,t.useCallback)(e=>{if(!d({value:e,tabValues:p}))throw Error(`Can't select invalid tab value=${e}`);m(e),x(e),k(e)},[x,k,p]),tabValues:p}}},848193(e,n,r){r.d(n,{R:()=>o,x:()=>s});var t=r(830758);let a={},i=t.createContext(a);function o(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),t.createElement(i.Provider,{value:n},e.children)}},90060(e){e.exports=JSON.parse('{"id":"docs/docker/overview","title":"Overview","description":"How to build Docker images containing artifacts built by Pants","source":"@site/versioned_docs/version-2.7/docs/docker/overview.mdx","sourceDirName":"docs/docker","slug":"/docs/docker/overview","permalink":"/2.7/docs/docker/overview","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/docker/overview.mdx","tags":[],"version":"2.7","sidebarPosition":0,"frontMatter":{"title":"Overview","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"Overview","permalink":"/2.7/docs/shell/overview"},"next":{"title":"Overview","permalink":"/2.7/docs/writing-plugins/overview"}}')}}]);