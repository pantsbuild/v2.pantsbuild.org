"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["260080"],{560786(e,o,t){t.r(o),t.d(o,{assets:()=>c,contentTitle:()=>d,default:()=>p,frontMatter:()=>i,metadata:()=>r,toc:()=>l});var r=t(413881),n=t(886070),s=t(848193);let i={title:"Protobuf and gRPC",sidebar_position:0},d,c={},l=[{value:"Step 1: Activate the Protobuf Python backend",id:"step-1-activate-the-protobuf-python-backend",level:2},{value:"Step 2: Set up the <code>protobuf</code> and <code>grpcio</code> runtime libraries",id:"step-2-set-up-the-protobuf-and-grpcio-runtime-libraries",level:2},{value:"Step 3: Generate <code>protobuf_sources</code> target",id:"step-3-generate-protobuf_sources-target",level:2},{value:"Step 4: Confirm Python imports are working",id:"step-4-confirm-python-imports-are-working",level:2},{value:"Protobuf and source roots",id:"protobuf-and-source-roots",level:2},{value:"Multiple resolves",id:"multiple-resolves",level:2},{value:"Buf: format and lint Protobuf",id:"buf-format-and-lint-protobuf",level:2}];function a(e){let o={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(o.p,{children:"How to generate Python from Protocol Buffers."}),"\n",(0,n.jsx)(o.hr,{}),"\n",(0,n.jsx)(o.p,{children:"When your Python code imports Protobuf generated files, Pants will detect the imports and run the Protoc compiler to generate those files."}),"\n",(0,n.jsx)(o.admonition,{title:"Example repository",type:"note",children:(0,n.jsxs)(o.p,{children:["See ",(0,n.jsx)(o.a,{href:"https://github.com/pantsbuild/example-codegen",children:"the codegen example repository"})," for an example of using Protobuf to generate Python."]})}),"\n",(0,n.jsxs)(o.admonition,{title:"Benefit of Pants: generated files are always up-to-date",type:"tip",children:[(0,n.jsx)(o.p,{children:"With Pants, there's no need to manually regenerate your code or check it into version control. Pants will ensure you are always using up-to-date files in your builds."}),(0,n.jsx)(o.p,{children:"Thanks to fine-grained caching, Pants will regenerate the minimum amount of code required when you do make changes."})]}),"\n",(0,n.jsx)(o.h2,{id:"step-1-activate-the-protobuf-python-backend",children:"Step 1: Activate the Protobuf Python backend"}),"\n",(0,n.jsxs)(o.p,{children:["Add this to your ",(0,n.jsx)(o.code,{children:"pants.toml"}),":"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages.add = [\n  "pants.backend.codegen.protobuf.python",\n  "pants.backend.python",\n]\n'})}),"\n",(0,n.jsxs)(o.p,{children:["This adds the new ",(0,n.jsx)(o.a,{href:"/2.14/reference/targets/protobuf_source",children:(0,n.jsx)(o.code,{children:"protobuf_source"})})," target, which you can confirm by running ",(0,n.jsx)(o.code,{children:"./pants help protobuf_source"}),"."]}),"\n",(0,n.jsxs)(o.p,{children:["To reduce boilerplate, you can also use the ",(0,n.jsx)(o.a,{href:"/2.14/reference/targets/protobuf_sources",children:(0,n.jsx)(o.code,{children:"protobuf_sources"})})," target, which generates one ",(0,n.jsx)(o.code,{children:"protobuf_source"})," target per file in the ",(0,n.jsx)(o.code,{children:"sources"})," field."]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-python",metastring:'title="BUILD"',children:'protobuf_sources(name="protos", sources=["user.proto", "admin.proto"])\n\n# Spiritually equivalent to:\nprotobuf_source(name="user", source="user.proto")\nprotobuf_source(name="admin", source="admin.proto")\n\n# Thanks to the default `sources` value of \'*.proto\', spiritually equivalent to:\nprotobuf_sources(name="protos")\n'})}),"\n",(0,n.jsxs)(o.admonition,{title:"Enable the MyPy Protobuf plugin",type:"note",children:[(0,n.jsxs)(o.p,{children:["The ",(0,n.jsx)(o.a,{href:"https://github.com/dropbox/mypy-protobuf",children:"MyPy Protobuf plugin"})," generates ",(0,n.jsxs)(o.a,{href:"https://mypy.readthedocs.io/en/stable/stubs.html",children:[(0,n.jsx)(o.code,{children:".pyi"})," type stubs"]}),". If you use MyPy through Pants's ",(0,n.jsx)(o.a,{href:"/2.14/docs/python/goals/check",children:"check goal"}),", this will ensure MyPy understands your generated code."]}),(0,n.jsxs)(o.p,{children:["To activate, set ",(0,n.jsx)(o.code,{children:"mypy_plugin = true"})," in the ",(0,n.jsx)(o.code,{children:"[python-protobuf]"})," scope:"]}),(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-toml",children:"[python-protobuf]\nmypy_plugin = true\n"})}),(0,n.jsxs)(o.p,{children:["MyPy will use the generated ",(0,n.jsx)(o.code,{children:".pyi"})," type stub file, rather than looking at the ",(0,n.jsx)(o.code,{children:".py"})," implementation file."]})]}),"\n",(0,n.jsxs)(o.h2,{id:"step-2-set-up-the-protobuf-and-grpcio-runtime-libraries",children:["Step 2: Set up the ",(0,n.jsx)(o.code,{children:"protobuf"})," and ",(0,n.jsx)(o.code,{children:"grpcio"})," runtime libraries"]}),"\n",(0,n.jsxs)(o.p,{children:["Generated Python files require the ",(0,n.jsxs)(o.a,{href:"https://pypi.org/project/protobuf/",children:[(0,n.jsx)(o.code,{children:"protobuf"})," dependency"]})," for their imports to work properly. If you're using gRPC, you also need the ",(0,n.jsxs)(o.a,{href:"https://pypi.org/project/grpcio/",children:[(0,n.jsx)(o.code,{children:"grpcio"})," dependency"]}),"."]}),"\n",(0,n.jsxs)(o.p,{children:["Add ",(0,n.jsx)(o.code,{children:"protobuf"}),"\u2014and ",(0,n.jsx)(o.code,{children:"grpcio"}),", if relevant\u2014 to your project, e.g. your ",(0,n.jsx)(o.code,{children:"requirements.txt"})," (see ",(0,n.jsx)(o.a,{href:"/2.14/docs/python/overview/third-party-dependencies",children:"Third-party dependencies"}),")."]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-text",metastring:'title="requirements.txt"',children:"grpcio==1.32.0\nprotobuf>=3.12.1\n"})}),"\n",(0,n.jsxs)(o.p,{children:["Pants will then automatically add these dependencies to your ",(0,n.jsx)(o.code,{children:"protobuf_source"})," targets created in the next step."]}),"\n",(0,n.jsxs)(o.h2,{id:"step-3-generate-protobuf_sources-target",children:["Step 3: Generate ",(0,n.jsx)(o.code,{children:"protobuf_sources"})," target"]}),"\n",(0,n.jsxs)(o.p,{children:["Run ",(0,n.jsx)(o.a,{href:"/2.14/docs/getting-started/initial-configuration#5-generate-build-files",children:(0,n.jsx)(o.code,{children:"./pants tailor ::"})})," for Pants to create a ",(0,n.jsx)(o.code,{children:"protobuf_sources"})," target wherever you have ",(0,n.jsx)(o.code,{children:".proto"})," files:"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{children:"$ ./pants tailor ::\nCreated src/protos/BUILD:\n  - Add protobuf_sources target protos\n"})}),"\n",(0,n.jsxs)(o.p,{children:["Pants will use ",(0,n.jsx)(o.a,{href:"/2.14/docs/using-pants/key-concepts/targets-and-build-files",children:"dependency inference"})," for any ",(0,n.jsx)(o.code,{children:"import"})," statements in your ",(0,n.jsx)(o.code,{children:".proto"})," files, which you can confirm by running ",(0,n.jsx)(o.code,{children:"./pants dependencies path/to/file.proto"}),". You should also see the ",(0,n.jsx)(o.code,{children:"python_requirement"})," target for the ",(0,n.jsx)(o.code,{children:"protobuf"})," library from the previous step."]}),"\n",(0,n.jsxs)(o.p,{children:["If you want gRPC code generated for all files in the folder, set ",(0,n.jsx)(o.code,{children:"grpc=True"}),"."]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-python",metastring:'title="src/proto/example/BUILD"',children:'protobuf_sources(\n    name="protos",\n    grpc=True,\n)\n'})}),"\n",(0,n.jsxs)(o.p,{children:["If you only want gRPC generated for some files in the folder, you can use the ",(0,n.jsx)(o.code,{children:"overrides"})," field:"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-python",metastring:'title="src/proto/example/BUILD"',children:'protobuf_sources(\n    name="protos",\n    overrides={\n        "admin.proto": {"grpc": True},\n        # You can also use a tuple for multiple files.\n        ("user.proto", "org.proto"): {"grpc": True},\n    },\n)\n'})}),"\n",(0,n.jsx)(o.h2,{id:"step-4-confirm-python-imports-are-working",children:"Step 4: Confirm Python imports are working"}),"\n",(0,n.jsxs)(o.p,{children:["Now, you can import the generated Python module in your Python code. For example, to import ",(0,n.jsx)(o.code,{children:"project/example/f.proto"}),", add ",(0,n.jsx)(o.code,{children:"import project.example.f_pb2"})," to your code."]}),"\n",(0,n.jsxs)(o.p,{children:["If you have ",(0,n.jsx)(o.a,{href:"/2.14/docs/using-pants/key-concepts/source-roots",children:"source roots"})," other than the repository root, remove the source root from the import. For example, ",(0,n.jsx)(o.code,{children:"src/protos/example/f.proto"})," gets stripped to ",(0,n.jsx)(o.code,{children:"import example.f_pb2"}),". See the below section on source roots for more info."]}),"\n",(0,n.jsxs)(o.p,{children:["Pants's dependency inference will detect Python imports of Protobuf modules, which you can confirm by running ",(0,n.jsx)(o.code,{children:"./pants dependencies path/to/file.py"}),"."]}),"\n",(0,n.jsxs)(o.p,{children:["If gRPC is activated, you can also import the module with ",(0,n.jsx)(o.code,{children:"_pb2_grpc"})," at the end, e.g. ",(0,n.jsx)(o.code,{children:"project.example.f_pb2_grpc"}),"."]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-python",children:"from project.example.f_pb2 import HelloReply\nfrom project.example.f_pb2_grcp import GreeterServicer\n"})}),"\n",(0,n.jsxs)(o.admonition,{type:"note",children:[(0,n.jsxs)(o.mdxAdmonitionTitle,{children:["Run ",(0,n.jsx)(o.code,{children:"./pants export-codegen ::"})," to inspect the files"]}),(0,n.jsxs)(o.p,{children:[(0,n.jsx)(o.code,{children:"./pants export-codegen ::"})," will run all relevant code generators and write the files to ",(0,n.jsx)(o.code,{children:"dist/codegen"})," using the same paths used normally by Pants."]}),(0,n.jsxs)(o.p,{children:["You do not need to run this goal for codegen to work when using Pants; ",(0,n.jsx)(o.code,{children:"export-codegen"})," is only for external consumption outside of Pants."]})]}),"\n",(0,n.jsxs)(o.admonition,{type:"caution",children:[(0,n.jsxs)(o.mdxAdmonitionTitle,{children:["You likely need to add empty ",(0,n.jsx)(o.code,{children:"__init__.py"})," files"]}),(0,n.jsxs)(o.p,{children:["By default, Pants will generate the Python files in the same directory as the ",(0,n.jsx)(o.code,{children:".proto"})," file. To get Python imports working properly, you will likely need to add an empty ",(0,n.jsx)(o.code,{children:"__init__.py"})," in the same location, and possibly in ancestor directories."]}),(0,n.jsxs)(o.p,{children:['See the below section "Protobuf and source roots" for how to generate into a different directory. If you use this option, you will still likely need an empty ',(0,n.jsx)(o.code,{children:"__init__.py"})," file in the destination directory."]})]}),"\n",(0,n.jsx)(o.h2,{id:"protobuf-and-source-roots",children:"Protobuf and source roots"}),"\n",(0,n.jsxs)(o.p,{children:["By default, generated code goes into the same ",(0,n.jsx)(o.a,{href:"/2.14/docs/using-pants/key-concepts/source-roots",children:"source root"})," as the ",(0,n.jsx)(o.code,{children:".proto"})," file from which it was generated. For example, a file ",(0,n.jsx)(o.code,{children:"src/proto/example/f.proto"})," will generate ",(0,n.jsx)(o.code,{children:"src/proto/example/f_pb2.py"}),"."]}),"\n",(0,n.jsxs)(o.p,{children:["However, this may not always be what you want. In particular, you may not want to have to add ",(0,n.jsx)(o.code,{children:"__init__py"})," files under ",(0,n.jsx)(o.code,{children:"src/proto"})," just so you can import Python code generated to that source root."]}),"\n",(0,n.jsxs)(o.p,{children:["You can configure a different source root for generated code by setting the ",(0,n.jsx)(o.code,{children:"python_source_root"})," field:"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-python",metastring:'title="src/proto/example/BUILD"',children:"protobuf_sources(\n    name=\"protos\",\n    python_source_root='src/python'\n)\n"})}),"\n",(0,n.jsxs)(o.p,{children:["Now ",(0,n.jsx)(o.code,{children:"src/proto/example/f.proto"})," will generate ",(0,n.jsx)(o.code,{children:"src/python/example/f_pb2.py"}),", i.e., the generated files will share a source root with your other Python code."]}),"\n",(0,n.jsxs)(o.admonition,{type:"note",children:[(0,n.jsxs)(o.mdxAdmonitionTitle,{children:["Set the ",(0,n.jsx)(o.code,{children:".proto"})," file's ",(0,n.jsx)(o.code,{children:"package"})," relative to the source root"]}),(0,n.jsxs)(o.p,{children:["Remember that the ",(0,n.jsx)(o.code,{children:"package"})," directive in your ",(0,n.jsx)(o.code,{children:".proto"})," file should be relative to the source root."]}),(0,n.jsxs)(o.p,{children:["For example, if you have a file at ",(0,n.jsx)(o.code,{children:"src/proto/example/subdir/f.proto"}),", you'd set its ",(0,n.jsx)(o.code,{children:"package"})," to ",(0,n.jsx)(o.code,{children:"example.subdir"}),"; and in your Python code, ",(0,n.jsx)(o.code,{children:"from example.subdir import f_pb2"}),"."]})]}),"\n",(0,n.jsx)(o.h2,{id:"multiple-resolves",children:"Multiple resolves"}),"\n",(0,n.jsxs)(o.p,{children:["If you're using ",(0,n.jsx)(o.a,{href:"/2.14/docs/python/overview/third-party-dependencies",children:"multiple resolves"})," (i.e. multiple lockfiles), then you may need to set the ",(0,n.jsx)(o.code,{children:"python_resolve"})," field. ",(0,n.jsx)(o.code,{children:"protobuf_source"})," targets only work with a single resolve, meaning, for example, that a ",(0,n.jsx)(o.code,{children:"python_source"})," target that uses the resolve 'a' can only depend on Protobuf targets that also uses this same resolve."]}),"\n",(0,n.jsxs)(o.p,{children:["By default, ",(0,n.jsx)(o.code,{children:"protobuf_source"})," / ",(0,n.jsx)(o.code,{children:"protobuf_sources"})," targets use the resolve set by the option ",(0,n.jsx)(o.code,{children:"[python].default_resolve"}),". To use a different resolve, set the field ",(0,n.jsx)(o.code,{children:"python_resolve: str"})," to one of the values from the option ",(0,n.jsx)(o.code,{children:"[python].resolves"}),"."]}),"\n",(0,n.jsxs)(o.p,{children:["You must also make sure that any resolves that use codegen include ",(0,n.jsx)(o.code,{children:"python_requirement"})," targets for the ",(0,n.jsx)(o.code,{children:"protobuf"})," and ",(0,n.jsx)(o.code,{children:"grpcio"})," runtime libraries from Step 2. Pants will eagerly validate this for you."]}),"\n",(0,n.jsxs)(o.p,{children:["If the same Protobuf files should work with multiple resolves, you can use the\n",(0,n.jsx)(o.a,{href:"/2.14/docs/using-pants/key-concepts/targets-and-build-files#parametrizing-targets",children:(0,n.jsx)(o.code,{children:"parametrize"})})," mechanism."]}),"\n",(0,n.jsx)(o.p,{children:"For example:"}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-python",metastring:'title="BUILD"',children:'python_requirement(\n    name="protobuf",\n    # Here, we use the same version of Protobuf in both resolves. You could instead create\n    # a distinct target per resolve so that they have different versions.\n    requirements=["protobuf==3.19.4"],\n    resolve=parametrize("resolve-a", "resolve-b"),\n)\n\nprotobuf_sources(\n    name="protos",\n    python_resolve=parametrize("resolve-a", "resolve-b")\n)\n'})}),"\n",(0,n.jsx)(o.h2,{id:"buf-format-and-lint-protobuf",children:"Buf: format and lint Protobuf"}),"\n",(0,n.jsxs)(o.p,{children:["Pants integrates with the ",(0,n.jsx)(o.a,{href:"https://buf.build/blog/introducing-buf-format",children:(0,n.jsx)(o.code,{children:"Buf"})})," formatter and linter for Protobuf files."]}),"\n",(0,n.jsxs)(o.p,{children:["To activate, add this to ",(0,n.jsx)(o.code,{children:"pants.toml"}),":"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = [\n  "pants.backend.codegen.protobuf.lint.buf",\n]\n'})}),"\n",(0,n.jsxs)(o.p,{children:["Now you can run ",(0,n.jsx)(o.code,{children:"./pants fmt"})," and ",(0,n.jsx)(o.code,{children:"./pants lint"}),":"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{children:"\u276F ./pants lint src/protos/user.proto\n"})}),"\n",(0,n.jsxs)(o.p,{children:["Use ",(0,n.jsx)(o.code,{children:"./pants fmt lint dir:"})," to run on all files in the directory, and ",(0,n.jsx)(o.code,{children:"./pants fmt lint dir::"})," to run on all files in the directory and subdirectories."]}),"\n",(0,n.jsxs)(o.p,{children:["Temporarily disable Buf with ",(0,n.jsx)(o.code,{children:"--buf-fmt-skip"})," and ",(0,n.jsx)(o.code,{children:"--buf-lint-skip"}),":"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-bash",children:"\u276F ./pants --buf-fmt-skip fmt ::\n"})}),"\n",(0,n.jsxs)(o.p,{children:["Only run Buf with ",(0,n.jsx)(o.code,{children:"--lint-only=buf-fmt"})," or ",(0,n.jsx)(o.code,{children:"--lint-only=buf-lint"}),", and ",(0,n.jsx)(o.code,{children:"--fmt-only=buf-fmt"}),":"]}),"\n",(0,n.jsx)(o.pre,{children:(0,n.jsx)(o.code,{className:"language-bash",children:"\u276F ./pants fmt --only=buf-fmt ::\n"})})]})}function p(e={}){let{wrapper:o}={...(0,s.R)(),...e.components};return o?(0,n.jsx)(o,{...e,children:(0,n.jsx)(a,{...e})}):a(e)}},848193(e,o,t){t.d(o,{R:()=>i,x:()=>d});var r=t(830758);let n={},s=r.createContext(n);function i(e){let o=r.useContext(s);return r.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function d(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:i(e.components),r.createElement(s.Provider,{value:o},e.children)}},413881(e){e.exports=JSON.parse('{"id":"docs/python/integrations/protobuf-and-grpc","title":"Protobuf and gRPC","description":"How to generate Python from Protocol Buffers.","source":"@site/versioned_docs/version-2.14/docs/python/integrations/protobuf-and-grpc.mdx","sourceDirName":"docs/python/integrations","slug":"/docs/python/integrations/protobuf-and-grpc","permalink":"/2.14/docs/python/integrations/protobuf-and-grpc","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/python/integrations/protobuf-and-grpc.mdx","tags":[],"version":"2.14","sidebarPosition":0,"frontMatter":{"title":"Protobuf and gRPC","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"Integrations","permalink":"/2.14/docs/python/integrations/"},"next":{"title":"Thrift","permalink":"/2.14/docs/python/integrations/thrift"}}')}}]);