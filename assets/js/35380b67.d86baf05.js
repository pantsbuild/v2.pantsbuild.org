"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["568214"],{608481(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var s=t(66110),r=t(886070),i=t(848193);let o={title:"Add a formatter",sidebar_position:1},l,a={},d=[];function c(e){let n={a:"a",code:"code",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["How to add a new formatter to the ",(0,r.jsx)(n.code,{children:"fmt"})," and ",(0,r.jsx)(n.code,{children:"lint"})," goals."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["In Pants, every formatter is (typically) also a linter, meaning that if you can run a tool with ",(0,r.jsx)(n.code,{children:"./pants fmt"}),", you can run the same tool in check-only mode with ",(0,r.jsx)(n.code,{children:"./pants lint"}),". Start by skimming ",(0,r.jsx)(n.a,{href:"/2.13/docs/writing-plugins/common-plugin-tasks/add-a-linter",children:"Add a linter"})," to familiarize yourself with how linters work."]}),"\n",(0,r.jsx)(n.p,{children:"This guide assumes that you are running a formatter that already exists outside of Pants as a stand-alone binary, such as running Black or Prettier."}),"\n",(0,r.jsxs)(n.p,{children:["If you are instead writing your own formatting logic inline, you can skip Step 1. In Step 4, you will not need to use ",(0,r.jsx)(n.code,{children:"Process"}),"."]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsx)(n.li,{children:"Install your formatter"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["There are several ways for Pants to install your formatter. See ",(0,r.jsx)(n.a,{href:"/2.13/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),". This example will use ",(0,r.jsx)(n.code,{children:"ExternalTool"})," because there is already a pre-compiled binary for shfmt."]}),"\n",(0,r.jsxs)(n.p,{children:["You will also likely want to register some options, like ",(0,r.jsx)(n.code,{children:"--config"}),", ",(0,r.jsx)(n.code,{children:"--skip"}),", and ",(0,r.jsx)(n.code,{children:"--args"}),". Options are registered through a ",(0,r.jsx)(n.a,{href:"/2.13/docs/writing-plugins/the-rules-api/options-and-subsystems",children:(0,r.jsx)(n.code,{children:"Subsystem"})}),". If you are using ",(0,r.jsx)(n.code,{children:"ExternalTool"}),", this is already a subclass of ",(0,r.jsx)(n.code,{children:"Subsystem"}),". Otherwise, create a subclass of ",(0,r.jsx)(n.code,{children:"Subsystem"}),". Then, set the class property ",(0,r.jsx)(n.code,{children:"options_scope"})," to the name of the tool, e.g. ",(0,r.jsx)(n.code,{children:'"shfmt"'})," or ",(0,r.jsx)(n.code,{children:'"prettier"'}),". Finally, add options from ",(0,r.jsx)(n.code,{children:"pants.option.option_types"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from pants.core.util_rules.external_tool import ExternalTool\nfrom pants.engine.platform import Platform\nfrom pants.option.option_types import ArgsListOption, SkipOption\n\n\nclass Shfmt(ExternalTool):\n    """An autoformatter for shell scripts (https://github.com/mvdan/sh)."""\n\n    options_scope = "shfmt"\n    name = "Shfmt"\n    default_version = "v3.2.4"\n    default_known_versions = [\n        "v3.2.4|macos_arm64 |e70fc42e69debe3e400347d4f918630cdf4bf2537277d672bbc43490387508ec|2998546",\n        "v3.2.4|macos_x86_64|43a0461a1b54070ddc04fbbf1b78f7861ee39a65a61f5466d15a39c4aba4f917|2980208",\n        "v3.2.4|linux_arm64 |6474d9cc08a1c9fe2ef4be7a004951998e3067d46cf55a011ddd5ff7bfab3de6|2752512",\n        "v3.2.4|linux_x86_64|3f5a47f8fec27fae3e06d611559a2063f5d27e4b9501171dde9959b8c60a3538|2797568",\n    ]\n\n    # We set this because we need the mapping for both `generate_exe` and `generate_url`.\n    platform_mapping = {\n        "macos_arm64": "darwin_arm64",\n        "macos_x86_64": "darwin_amd64",\n        "linux_arm64": "linux_arm64",\n        "linux_x86_64": "linux_amd64",\n    }\n\n    skip = SkipOption("fmt", "lint")\n    args = ArgsListOption(example="-i 2")\n\n    def generate_url(self, plat: Platform) -> str:\n        plat_str = self.platform_mapping[plat.value]\n        return (\n            f"https://github.com/mvdan/sh/releases/download/{self.version}/"\n            f"shfmt_{self.version}_{plat_str}"\n        )\n\n    def generate_exe(self, plat: Platform) -> str:\n        plat_str = self.platform_mapping[plat.value]\n        return f"./shfmt_{self.version}_{plat_str}"\n'})}),"\n",(0,r.jsxs)(n.ol,{start:"2",children:["\n",(0,r.jsxs)(n.li,{children:["Set up a ",(0,r.jsx)(n.code,{children:"FieldSet"})," and ",(0,r.jsx)(n.code,{children:"FmtRequest"})]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["As described in ",(0,r.jsx)(n.a,{href:"/2.13/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Rules and the Target API"}),", a ",(0,r.jsx)(n.code,{children:"FieldSet"})," is a way to tell Pants which ",(0,r.jsx)(n.code,{children:"Field"}),"s you care about targets having for your plugin to work."]}),"\n",(0,r.jsxs)(n.p,{children:["Usually, you should add a subclass of ",(0,r.jsx)(n.code,{children:"SourcesField"})," to the class property ",(0,r.jsx)(n.code,{children:"required_fields"}),", such as ",(0,r.jsx)(n.code,{children:"ShellSourceField"})," or ",(0,r.jsx)(n.code,{children:"PythonSourceField"}),". This means that your linter will run on any target with that sources field or a subclass of it."]}),"\n",(0,r.jsxs)(n.p,{children:["Create a new dataclass that subclasses ",(0,r.jsx)(n.code,{children:"FieldSet"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.engine.target import FieldSet\n\n...\n\n@dataclass(frozen=True)\nclass ShfmtFieldSet(FieldSet):\n    required_fields = (ShellSourceField,)\n\n    sources: ShellSourceField\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Then, hook this up to a new subclass of ",(0,r.jsx)(n.code,{children:"FmtRequest"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from pants.core.goals.fmt import FmtRequest\n\nclass ShfmtRequest(FmtRequest):\n    field_set_type = ShfmtFieldSet\n    name = "shfmt"\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Finally, register your new ",(0,r.jsx)(n.code,{children:"FmtRequest"})," with a ",(0,r.jsx)(n.a,{href:"/2.13/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,r.jsx)(n.code,{children:"UnionRule"})})," so that Pants knows your formatter exists:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(FmtRequest, ShfmtRequest),\n    ]\n"})}),"\n",(0,r.jsxs)(n.ol,{start:"3",children:["\n",(0,r.jsxs)(n.li,{children:["Create ",(0,r.jsx)(n.code,{children:"fmt"})," rules"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["You will need a rule for ",(0,r.jsx)(n.code,{children:"fmt"})," which takes the ",(0,r.jsx)(n.code,{children:"FmtRequest"})," from step 3 (e.g. ",(0,r.jsx)(n.code,{children:"ShfmtRequest"}),") as a parameter and returns a ",(0,r.jsx)(n.code,{children:"FmtResult"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'@rule(desc="Format with shfmt", level=LogLevel.DEBUG)\nasync def shfmt_fmt(request: ShfmtRequest, shfmt: Shfmt) -> FmtResult:\n    if shfmt.skip:\n        return FmtResult.skip(formatter_name=request.name)\n\n    download_shfmt_get = Get(\n        DownloadedExternalTool,\n        ExternalToolRequest,\n        shfmt.get_request(Platform.current),\n    )\n\n    # If the user specified `--shfmt-config`, we must search for the file they specified with\n    # `PathGlobs` to include it in the `input_digest`. We error if the file cannot be found.\n    config_digest_get = Get(\n        Digest,\n        PathGlobs(\n            globs=[shfmt.config] if shfmt.config else [],\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n            description_of_origin="the option `--shfmt-config`",\n        ),\n    )\n\n    downloaded_shfmt, config_digest = await MultiGet(\n        download_shfmt_get, config_digest_get\n    )\n\n    input_digest = await Get(\n        Digest,\n        MergeDigests(\n            (request.snapshot.digest, downloaded_shfmt.digest, config_digest)\n        ),\n    )\n\n    argv = [\n        downloaded_shfmt.exe,\n        "-w",\n        *shfmt.args,\n        *request.snapshot.files,\n    ]\n    process = Process(\n        argv=argv,\n        input_digest=input_digest,\n        output_files=request.snapshot.files,\n        description=f"Run shfmt on {pluralize(len(request.field_sets), \'file\')}.",\n        level=LogLevel.DEBUG,\n    )\n\n    result = await Get(ProcessResult, Process, process)\n    output_snapshot = await Get(Snapshot, result.output_digest)\n    return FmtResult.create(request, result, output_snapshot)\n'})}),"\n",(0,r.jsxs)(n.p,{children:["The ",(0,r.jsx)(n.code,{children:"FmtRequest"})," has properties ",(0,r.jsx)(n.code,{children:".field_sets"})," and ",(0,r.jsx)(n.code,{children:".snapshot"}),", which store collections of the ",(0,r.jsx)(n.code,{children:"FieldSet"}),"s defined in step 2, and their sources. Each ",(0,r.jsx)(n.code,{children:"FieldSet"})," corresponds to a single target. Pants will have already validated that there is at least one valid ",(0,r.jsx)(n.code,{children:"FieldSet"}),", so you can expect ",(0,r.jsx)(n.code,{children:"ShfmtRequest.field_sets"})," to have 1-n ",(0,r.jsx)(n.code,{children:"FieldSet"})," instances."]}),"\n",(0,r.jsxs)(n.p,{children:["If you have a ",(0,r.jsx)(n.code,{children:"--skip"})," option, you should check if it was used at the beginning of your ",(0,r.jsx)(n.code,{children:"fmt"})," and ",(0,r.jsx)(n.code,{children:"lint"})," rules and, if so, to early return an empty ",(0,r.jsx)(n.code,{children:"LintResults()"})," and return ",(0,r.jsx)(n.code,{children:"FmtResult.skip()"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["If you used ",(0,r.jsx)(n.code,{children:"ExternalTool"})," in step 1, you will use ",(0,r.jsx)(n.code,{children:"Get(DownloadedExternalTool, ExternalToolRequest)"})," to ensure that the tool is fetched."]}),"\n",(0,r.jsxs)(n.p,{children:["Use ",(0,r.jsx)(n.code,{children:"Get(Digest, MergeDigests)"})," to combine the different inputs together, such as merging the source files and downloaded tool."]}),"\n",(0,r.jsxs)(n.p,{children:["Finally, update your plugin's ",(0,r.jsx)(n.code,{children:"register.py"})," to activate this file's rules. Note that we must register the rules added in Step 2, as well."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/shell/register.py"',children:"from shell import shfmt\n\n\ndef rules():\n    return [*shfmt.rules()]\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Now, when you run ",(0,r.jsx)(n.code,{children:"./pants fmt ::"})," or ",(0,r.jsx)(n.code,{children:"./pants lint ::"}),", your new formatter should run."]}),"\n",(0,r.jsxs)(n.ol,{start:"5",children:["\n",(0,r.jsx)(n.li,{children:"Add tests (optional)"}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsxs)(n.p,{children:["Refer to ",(0,r.jsx)(n.a,{href:"/2.13/docs/writing-plugins/the-rules-api/testing-plugins",children:"Testing rules"}),"."]})]})}function h(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},848193(e,n,t){t.d(n,{R:()=>o,x:()=>l});var s=t(830758);let r={},i=s.createContext(r);function o(e){let n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),s.createElement(i.Provider,{value:n},e.children)}},66110(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-formatter","title":"Add a formatter","description":"How to add a new formatter to the fmt and lint goals.","source":"@site/versioned_docs/version-2.13/docs/writing-plugins/common-plugin-tasks/add-a-formatter.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-formatter","permalink":"/2.13/docs/writing-plugins/common-plugin-tasks/add-a-formatter","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-formatter.mdx","tags":[],"version":"2.13","sidebarPosition":1,"frontMatter":{"title":"Add a formatter","sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Add a linter","permalink":"/2.13/docs/writing-plugins/common-plugin-tasks/add-a-linter"},"next":{"title":"Add a typechecker","permalink":"/2.13/docs/writing-plugins/common-plugin-tasks/add-a-typechecker"}}')}}]);