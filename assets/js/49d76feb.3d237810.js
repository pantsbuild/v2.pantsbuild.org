"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["188425"],{368167(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>h});var a=t(227018),s=t(886070),r=t(848193),l=t(685008),i=t(637180);let o={title:"Deployments",sidebar_position:1},c,d={},h=[{value:"Motivation",id:"motivation",level:2},{value:"Defining Helm deployments",id:"defining-helm-deployments",level:2},{value:"Dependencies with <code>docker_image</code> targets",id:"dependencies-with-docker_image-targets",level:2},{value:"Value files",id:"value-files",level:2},{value:"Inline values",id:"inline-values",level:2},{value:"Using dynamic values",id:"using-dynamic-values",level:2},{value:"Using custom resource definitions",id:"using-custom-resource-definitions",level:2},{value:"Third party chart artifacts",id:"third-party-chart-artifacts",level:2},{value:"Post-renderers",id:"post-renderers",level:2},{value:"Deploying",id:"deploying",level:2}];function m(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.admonition,{title:"Helm deployment support is in alpha stage",type:"caution",children:[(0,s.jsxs)(n.p,{children:["Pants has experimental support for managing deployments via the ",(0,s.jsx)(n.code,{children:"experimental-deploy"})," goal. Helm deployments provides with a basic implementation of this goal."]}),(0,s.jsxs)(n.p,{children:["Please share feedback for what you need to use Pants with your Helm deployments by either ",(0,s.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/issues/new/choose",children:"opening a GitHub issue"})," or ",(0,s.jsx)(n.a,{href:"/community/getting-help",children:"joining our Slack"}),"!"]})]}),"\n",(0,s.jsx)(n.h2,{id:"motivation",children:"Motivation"}),"\n",(0,s.jsx)(n.p,{children:"Helm's ultimate purpose is to simplify the deployment of Kubernetes resources and help in making these reproducible. However it is quite common to deploy the same software application into different kind of environments using slightly different configuration overrides."}),"\n",(0,s.jsx)(n.p,{children:"This hinders reproducibility since operators end up having a set of configuration files and additional shell scripts that ensure that the Helm command line used to deploy a piece of software into a given environment is always the same."}),"\n",(0,s.jsxs)(n.p,{children:["Pants solves this problem by providing with the ability to manage the configuration files and the different parameters of a deployment as single unit such that a simple command line as ",(0,s.jsx)(n.code,{children:"pants experimental-deploy ::"})," will always have the same effect on each of the deployments previously defined."]}),"\n",(0,s.jsx)(n.h2,{id:"defining-helm-deployments",children:"Defining Helm deployments"}),"\n",(0,s.jsxs)(n.p,{children:["Helm deployments are defined using the ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target which has a series of fields that can be used to guarantee the reproducibility of the given deployment. ",(0,s.jsx)(n.code,{children:"helm_deployment"})," targets need to be added by hand as there is no deterministic way of introspecting your repository to find sources that are specific to Helm:"]}),"\n",(0,s.jsxs)(l.A,{groupId:"code-examples",children:[(0,s.jsx)(i.A,{value:"src/chart/build",label:"src/chart/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/chart/BUILD"}',children:"helm_chart()\n"})})}),(0,s.jsx)(i.A,{value:"src/chart/chart.yaml",label:"src/chart/Chart.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/chart/Chart.yaml"}',children:"apiVersion: v2\ndescription: Example Helm chart\nname: example\nversion: 0.1.0\n"})})}),(0,s.jsx)(i.A,{value:"src/deployment/build",label:"src/deployment/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/deployment/BUILD"}',children:'helm_deployment(\n  name="dev",\n  chart="//src/chart",\n  sources=["common-values.yaml", "dev-override.yaml"]\n)\n\nhelm_deployment(\n  name="stage",\n  chart="//src/chart",\n  sources=["common-values.yaml", "stage-override.yaml"]\n)\n\nhelm_deployment(\n  name="prod",\n  chart="//src/chart",\n  sources=["common-values.yaml", "prod-override.yaml"]\n)\n'})})}),(0,s.jsx)(i.A,{value:"src/deployment/common-values.yaml",label:"src/deployment/common-values.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/deployment/common-values.yaml"}',children:"# Default values common to all deployments\nenv:\n  SERVICE_NAME: my-service\n"})})}),(0,s.jsx)(i.A,{value:"src/deployment/dev-override.yaml",label:"src/deployment/dev-override.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/deployment/dev-override.yaml"}',children:"# Specific values to the DEV environment\nenv:\n  ENV_ID: dev\n"})})}),(0,s.jsx)(i.A,{value:"src/deployment/stage-override.yaml",label:"src/deployment/stage-override.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/deployment/stage-override.yaml"}',children:"# Specific values to the STAGE environment\nenv:\n  ENV_ID: stage\n"})})}),(0,s.jsx)(i.A,{value:"src/deployment/prod-override.yaml",label:"src/deployment/prod-override.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/deployment/prod-override.yaml"}',children:"# Specific values to the PRODUCTION environment\nenv:\n  ENV_ID: prod\n"})})})]}),"\n",(0,s.jsx)(n.p,{children:"There are quite a few things to notice in the previous example:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["The ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target requires you to explicitly set the ",(0,s.jsx)(n.code,{children:"chart"})," field to specify which chart to use."]}),"\n",(0,s.jsx)(n.li,{children:"We have three different deployments using different sets of configuration files with the same chart."}),"\n",(0,s.jsxs)(n.li,{children:["One of those value files (",(0,s.jsx)(n.code,{children:"common-values.yaml"}),") provides with default values that are common to all deployments."]}),"\n",(0,s.jsxs)(n.li,{children:["Each deployment uses an additional ",(0,s.jsx)(n.code,{children:"xxx-override.yaml"})," file with values that are specific to the given deployment."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target has many additional fields including the target kubernetes namespace, adding inline override values (similar to using helm's ",(0,s.jsx)(n.code,{children:"--set"})," arg) and many others. Please run ",(0,s.jsx)(n.code,{children:"pants help helm_deployment"})," to see all the possibilities."]}),"\n",(0,s.jsxs)(n.h2,{id:"dependencies-with-docker_image-targets",children:["Dependencies with ",(0,s.jsx)(n.code,{children:"docker_image"})," targets"]}),"\n",(0,s.jsx)(n.p,{children:"A Helm deployment will in most cases deploy one or more Docker images into Kubernetes. Furthermore, it's quite likely there is going to be at least a few first party Docker images among those. Pants is capable of analysing the Helm chart being used in a deployment to detect those required first-party Docker images using Pants' target addresses to those Docker images."}),"\n",(0,s.jsxs)(n.p,{children:["To illustrate this, let's imagine the following scenario: Let's say we have a first-party Docker image that we want to deploy into Kubernetes as a ",(0,s.jsx)(n.code,{children:"Pod"})," resource kind. For achieving this we define the following workspace:"]}),"\n",(0,s.jsxs)(l.A,{groupId:"code-examples",children:[(0,s.jsx)(i.A,{value:"src/docker/build",label:"src/docker/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/docker/BUILD"}',children:"docker_image()\n"})})}),(0,s.jsx)(i.A,{value:"src/docker/dockerfile",label:"src/docker/Dockerfile",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",metastring:'tab={"label":"src/docker/Dockerfile"}',children:"FROM busybox:1.28\n"})})}),(0,s.jsx)(i.A,{value:"src/chart/build",label:"src/chart/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/chart/BUILD"}',children:"helm_chart()\n"})})}),(0,s.jsx)(i.A,{value:"src/chart/chart.yaml",label:"src/chart/Chart.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/chart/Chart.yaml"}',children:"apiVersion: v2\ndescription: Example Helm chart\nname: example\nversion: 0.1.0\n"})})}),(0,s.jsx)(i.A,{value:"src/chart/values.yaml",label:"src/chart/values.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/chart/values.yaml"}',children:"# Default image in case this chart is used by other tools after being published\nimage: example.com/registry/my-app:latest\n"})})}),(0,s.jsx)(i.A,{value:"src/chart/templates/pod.yaml",label:"src/chart/templates/pod.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/chart/templates/pod.yaml"}',children:'---\napiVersion: v1\nkind: Pod\nmetadata:\n  name: my-pod\n  labels:\n    chart: "{{ .Chart.Name }}-{{ .Chart.Version | replace "+" "_" }}"\nspec:\n  containers:\n    - name: my-app\n      # Uses the `image` value entry from the deployment inputs\n      image: {{ .Values.image }}\n'})})}),(0,s.jsx)(i.A,{value:"src/deployment/build",label:"src/deployment/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/deployment/BUILD"}',children:'# Overrides the `image` value for the chart using the target address for the first-party docker image.\nhelm_deployment(chart="src/chart", values={"image": "src/docker:docker"})\n'})})})]}),"\n",(0,s.jsx)(n.admonition,{title:"Docker image references VS Pants' target addresses",type:"note",children:(0,s.jsx)(n.p,{children:"You should use typical Docker registry addresses in your Helm charts. Because Helm charts are distributable artifacts and may be used with tools other than Pants, you should create your charts such that when that chart is being used, all Docker image addresses are valid references to images in accessible Docker registries. As shown in the example, we recommend that you make the image address value configurable, especially for charts that deploy first-party Docker images.\nYour chart resources can still use off-the-shelf images published with other means, and in those cases you will also be referencing the Docker image address. Usage of Pants' target addresses is intended for your own first-party images because the image reference of those is not known at the time we create the sources (they are computed later)."})}),"\n",(0,s.jsxs)(n.p,{children:["With this setup we should be able to run ",(0,s.jsx)(n.code,{children:"pants dependencies src/deployment"})," and Pants should give the following output:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-text",children:"src/chart\nsrc/docker\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This should work with any kind of Kubernetes resource that leads to Docker image being deployed into Kubernetes, such as ",(0,s.jsx)(n.code,{children:"Deployment"}),", ",(0,s.jsx)(n.code,{children:"StatefulSet"}),", ",(0,s.jsx)(n.code,{children:"ReplicaSet"}),", ",(0,s.jsx)(n.code,{children:"CronJob"}),", etc. Please get in touch with us in case you find Pants was not capable to infer dependencies in any of your ",(0,s.jsx)(n.code,{children:"helm_deployment"})," targets by either ",(0,s.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/issues/new/choose",children:"opening a GitHub issue"})," or ",(0,s.jsx)(n.a,{href:"/community/getting-help",children:"joining our Slack"}),"."]}),"\n",(0,s.jsx)(n.admonition,{title:"How the Docker image reference is calculated during deployment?",type:"note",children:(0,s.jsxs)(n.p,{children:["Pants' will rely on the behaviour of the ",(0,s.jsx)(n.code,{children:"docker_image"})," target when it comes down to generate the final image reference. Since a given image may have more than one valid image reference, ",(0,s.jsxs)(n.strong,{children:["Pants will try to use the first one that is not tagged as ",(0,s.jsx)(n.code,{children:"latest"})]}),", falling back to ",(0,s.jsx)(n.code,{children:"latest"})," if none could be found.\nIt's good practice to publish your Docker images using tags other than ",(0,s.jsx)(n.code,{children:"latest"})," and Pants preferred behaviour is to choose those as this guarantees that the ",(0,s.jsx)(n.em,{children:"version"})," of the Docker image being deployed is the expected one."]})}),"\n",(0,s.jsx)(n.h2,{id:"value-files",children:"Value files"}),"\n",(0,s.jsxs)(n.p,{children:["It's very common that Helm deployments use a series of files providing with values that customise the given chart. When using deployments that may have more than one YAML file as the source of configuration values, the Helm backend needs to sort the file names in a way that is consistent across different machines, as the order in which those files are passed to the Helm command is relevant. The final order depends on the same order in which those files are specified in the ",(0,s.jsx)(n.code,{children:"sources"})," field of the ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target. For example, given the following ",(0,s.jsx)(n.code,{children:"BUILD"})," file:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="src/deployment/BUILD"',children:'helm_deployment(name="dev", chart="//src/chart", sources=["first.yaml", "second.yaml", "last.yaml"])\n'})}),"\n",(0,s.jsx)(n.p,{children:"This will result in the Helm command receiving the value files as in that exact order."}),"\n",(0,s.jsxs)(n.p,{children:["If using any glob pattern in the ",(0,s.jsx)(n.code,{children:"sources"})," field, the plugin will first group the files according to the order in which those glob patterns are listed. In this grouping, files that are resolved by more than one pattern will be part of the most specific group. Then we use alphanumeric ordering for the files that correspond to each of the previous groups. To illustrate this scenario, consider the following list of files:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"src/deployment/002-config_maps.yaml\nsrc/deployment/001-services.yaml\nsrc/deployment/first.yaml\nsrc/deployment/dev/daemon_sets.yaml\nsrc/deployment/dev/services-override.yaml\nsrc/deployment/last.yaml\n"})}),"\n",(0,s.jsxs)(n.p,{children:["And also the following ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target definition:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="src/deployment/BUILD"',children:'helm_deployment(\n  name="dev",\n  chart="//src/chart",\n  sources=["first.yaml", "*.yaml", "dev/*-override.yaml", "dev/*.yaml", "last.yaml"]\n)\n'})}),"\n",(0,s.jsx)(n.p,{children:"In this case, the final ordering of the files would be as follows:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"src/deployment/first.yaml\nsrc/deployment/001-services.yaml\nsrc/deployment/002-config_maps.yaml\nsrc/deployment/dev/services-override.yaml\nsrc/deployment/dev/daemon_sets.yaml\nsrc/deployment/last.yaml\n"})}),"\n",(0,s.jsx)(n.p,{children:"We believe that this approach gives a very consistent and predictable ordering while at the same time total flexibility to the end user to organise their files as they best fit each particular case of a deployment."}),"\n",(0,s.jsx)(n.h2,{id:"inline-values",children:"Inline values"}),"\n",(0,s.jsxs)(n.p,{children:["In addition to value files, you can also use inline values in your ",(0,s.jsx)(n.code,{children:"helm_deployment"})," targets by means of the ",(0,s.jsx)(n.code,{children:"values"})," field. All inlines values that are set this way will override any entry that may come from value files."]}),"\n",(0,s.jsx)(n.p,{children:"Inline values are defined as a key-value dictionary, like in the following example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="src/deployment/BUILD"',children:'helm_deployment(\n  name="dev",\n  chart="//src/chart",\n  values={\n    "nameOverride": "my_custom_name",\n    "image.pullPolicy": "Always",\n  },\n)\n'})}),"\n",(0,s.jsx)(n.h2,{id:"using-dynamic-values",children:"Using dynamic values"}),"\n",(0,s.jsxs)(n.p,{children:["Pants has support for value interpolation in your BUILD files and you can make use of it when defining some of the values of your ",(0,s.jsx)(n.code,{children:"helm_deployment"}),". This is not exclusive to the Helm backend but it's illustrated here to showcase how it could be leveraged to inject environment variables into your charts."]}),"\n",(0,s.jsx)(n.p,{children:"Consider the following example:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="src/deployment/BUILD"',children:'helm_deployment(\n  name="dev",\n  chart="//src/chart",\n  values={\n    "configmap.deployedAt": f"{env(\'DEPLOY_TIME\')}",\n  },\n)\n'})}),"\n",(0,s.jsxs)(n.p,{children:["In the previous example, Pants will use the value of the ",(0,s.jsx)(n.code,{children:"DEPLOY_TIME"})," environment variable in your inline values, which will be then forwarded to your chart. Now you can launch a deployment using the following command:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"DEPLOY_TIME=$(date) pants experimental-deploy src/deployment:dev\n"})}),"\n",(0,s.jsxs)(n.p,{children:["This isn't restricted to just the ",(0,s.jsx)(n.code,{children:"values"})," field and it can be used in others like shown in the following example:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'title="src/deployment/BUILD"',children:'helm_deployment(\n  name="dev",\n  chart="//src/chart",\n  release=f"{env(\'ORGANIZATION_ID\')}-dev",\n  namespace=f"product-{env(\'NAMESPACE_SUFFIX\')}"\n)\n'})}),"\n",(0,s.jsxs)(n.p,{children:["As shown above, now the ",(0,s.jsx)(n.code,{children:"release"})," and ",(0,s.jsx)(n.code,{children:"namespace"})," fields are calculated at deploy-time by Pants and, as in the previous example, they will be forwarded to the Helm chart accordingly."]}),"\n",(0,s.jsx)(n.admonition,{title:"Ensuring repeatable deployments",type:"caution",children:(0,s.jsx)(n.p,{children:"You should always favor using static values (or value files) VS dynamic values in your deployments. Using interpolated environment variables in your deployments can render your deployments non-repeatable anymore if those values can affect the behaviour of the system deployed, or what gets deployed (i.e. Docker image addresses).\nBe careful when chossing the values that are going to be calculated dynamically."})}),"\n",(0,s.jsx)(n.h2,{id:"using-custom-resource-definitions",children:"Using custom resource definitions"}),"\n",(0,s.jsxs)(n.p,{children:["Pants uses ",(0,s.jsx)(n.a,{href:"https://github.com/haxsaw/hikaru",children:"hikaru"})," to analyze Helm charts and detect required first-party Docker images by resolving Pants' target addresses. However, by default, hikaru cannot parse custom resource definitions (CRDs), so Pants will not automatically detect Docker images referenced within CRDs."]}),"\n",(0,s.jsxs)(n.p,{children:["To enable Pants to recognize Docker images in your CRDs, you need to extend hikaru with your custom resource definitions. This process is documented in the ",(0,s.jsx)(n.a,{href:"https://hikaru.readthedocs.io/en/latest/crd.html",children:"hikaru CRD guide"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"For example, consider the following CRD manifest:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-apiVersion:",metastring:"pants/v1alpha1",children:"   kind: CustomResourceDefinition\n   metadata:\n     name: crd_foo\n   spec:\n    containers:\n      - name: myapp-container\n          image: busybox:1.28\n    initContainers:\n      - name: init-service\n        image: busybox:1.29\n"})}),"\n",(0,s.jsx)(n.p,{children:"By default, Pants will not be able to parse Docker image references inside your CRDs, because the CRD is not registered with Hikaru. To enable Pants to recognize these images, you need to define and register your custom resource with Hikaru."}),"\n",(0,s.jsxs)(n.p,{children:["Create a Python file at ",(0,s.jsx)(n.code,{children:"pantsbuild/crd.py"})," with content similar to:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'\n        from __future__ import annotations\n        from hikaru.model.rel_1_28.v1 import *\n\n        from hikaru import (HikaruBase, HikaruDocumentBase,\n                            set_default_release)\n        from hikaru.crd import HikaruCRDDocumentMixin\n        from typing import Optional, List\n        from dataclasses import dataclass\n\n        set_default_release("rel_1_28")\n\n        @dataclass\n        class ContainersSpec(HikaruBase):\n            containers: List[Container]\n            initContainers: List[Container]\n\n        @dataclass\n        class CRD(HikaruDocumentBase, HikaruCRDDocumentMixin):\n            spec: ContainersSpec\n            metadata: ObjectMeta\n            apiVersion: str = f"pants/v1alpha1"\n            kind: str = "CustomResourceDefinition"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["For more details on extending Hikaru with your CRDs, see the official documentation: ",(0,s.jsx)(n.a,{href:"https://hikaru.readthedocs.io/en/latest/crd.html",children:"https://hikaru.readthedocs.io/en/latest/crd.html"}),"."]}),"\n",(0,s.jsx)(n.p,{children:"After defining your CRD Python class, you must register the new file and class name with Pants:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'[helm-k8s-parser.crd]\n"pantsbuild/crd.py"="CRD"\n"pantsbuild/crd_cron2.py"="CRD2"\n'})}),"\n",(0,s.jsx)(n.h2,{id:"third-party-chart-artifacts",children:"Third party chart artifacts"}),"\n",(0,s.jsxs)(n.p,{children:["Previous examples on the usage of the ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target are all based on the fact that the deployment declares a dependency on a Helm chart that is also part of the same repository. Since charts support having dependencies with other charts in the same repository or with external 3rd party Helm artifacts (declared as ",(0,s.jsx)(n.code,{children:"helm_artifact"}),"), all that dependency resolution is handled for us."]}),"\n",(0,s.jsxs)(n.p,{children:["However, ",(0,s.jsx)(n.code,{children:"helm_deployment"}),"s are not limited to only first party charts, as it is also possible to declare a deployment having a dependency on a 3rd party Helm artifact instead. As an example, consider the following workspace layout:"]}),"\n",(0,s.jsxs)(l.A,{groupId:"code-examples",children:[(0,s.jsx)(i.A,{value:"3rdparty/helm/jetstack/build",label:"3rdparty/helm/jetstack/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"3rdparty/helm/jetstack/BUILD"}',children:'helm_artifact(\n  name="cert-manager",\n  artifact="cert-manager",\n  version="v0.7.0",\n  repository="https://charts.jetstack.io",\n)\n'})})}),(0,s.jsx)(i.A,{value:"src/deploy/build",label:"src/deploy/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/deploy/BUILD"}',children:'helm_deployment(\n  name="main",\n  chart="//3rdparty/helm/jetstack:cert-manager",\n  values={\n    "installCRDs": "true"\n  },\n)\n'})})})]}),"\n",(0,s.jsxs)(n.p,{children:["In this example, the deployment at ",(0,s.jsx)(n.code,{children:"src/deploy:main"})," declares a dependency on a 3rd party Helm artifact instead of a chart in the same repository. The only difference in this case when compared to first party charts is that Pants will resolve and fetch the third party artifact automatically. Once the artifact has been resolved, there is no difference to Pants."]}),"\n",(0,s.jsx)(n.h2,{id:"post-renderers",children:"Post-renderers"}),"\n",(0,s.jsxs)(n.p,{children:["User-defined ",(0,s.jsx)(n.a,{href:"https://helm.sh/docs/topics/advanced/#post-rendering",children:"Helm post-renderers"})," are supported by the Helm backend by means of the ",(0,s.jsx)(n.code,{children:"post_renderers"})," field in the ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target. This field takes addresses to other runnable targets (any target that can be run using ",(0,s.jsx)(n.code,{children:"pants run [address]"}),") and will build and run those targets as part of ",(0,s.jsx)(n.code,{children:"experimental-deploy"})," goal. The referenced targets can be either shell commands or custom-made in any of the other languages supported by Pants."]}),"\n",(0,s.jsxs)(n.p,{children:["As an example, let's show how we can use the tool ",(0,s.jsx)(n.a,{href:"https://github.com/variantdev/vals",children:(0,s.jsx)(n.code,{children:"vals"})})," as a post-renderer and replace all references to secret values stored in HashiCorp Vault by their actual values. The following example is composed of a Helm chart that creates a secret resource in Kubernetes and a Helm deployment that is configured to use ",(0,s.jsx)(n.code,{children:"vals"})," as a post-renderer:"]}),"\n",(0,s.jsxs)(l.A,{groupId:"code-examples",children:[(0,s.jsx)(i.A,{value:"src/chart/build",label:"src/chart/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/chart/BUILD"}',children:"helm_chart()\n"})})}),(0,s.jsx)(i.A,{value:"src/chart/chart.yaml",label:"src/chart/Chart.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/chart/Chart.yaml"}',children:"apiVersion: v2\ndescription: Example Helm chart with vals\nname: example\nversion: 0.1.0\n"})})}),(0,s.jsx)(i.A,{value:"src/chart/templates/secret.yaml",label:"src/chart/templates/secret.yaml",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'tab={"label":"src/chart/templates/secret.yaml"}',children:"apiVersion: v1\nkind: Secret\nmetadata:\n  name: mysecret\n  namespace: default\ndata:\n  username: admin\n  # This should be replaced by `vals` during the post-rendering\n  password: ref+vault://path/to/admin#/password\ntype: Opaque\n"})})}),(0,s.jsx)(i.A,{value:"src/deploy/build",label:"src/deploy/BUILD",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"src/deploy/BUILD"}',children:'run_shell_command(\n  name="vals",\n  command="vals eval -f -",\n)\n\nhelm_deployment(\n  chart="//src/chart",\n  post_renderers=[":vals"],\n)\n'})})})]}),"\n",(0,s.jsxs)(n.p,{children:["In the previous example we define a ",(0,s.jsx)(n.code,{children:"run_shell_command"})," target that will invoke the ",(0,s.jsx)(n.code,{children:"vals eval"})," command (",(0,s.jsx)(n.code,{children:"vals"})," needs to be installed in the local machine) as part of the Helm post-rendering machinery, which will result on the ",(0,s.jsx)(n.code,{children:"ref+vault"})," reference being replaced by the actual value stored in Vault at the given path."]}),"\n",(0,s.jsx)(n.admonition,{title:"Using multiple post-renderers",type:"note",children:(0,s.jsxs)(n.p,{children:["If more than one target address is given in the ",(0,s.jsx)(n.code,{children:"post_renderers"})," field, then they will be invoked in the same order given piping the output of one them into the input of the next one."]})}),"\n",(0,s.jsx)(n.h2,{id:"deploying",children:"Deploying"}),"\n",(0,s.jsxs)(n.p,{children:["Continuing with the example in the previous section, we can deploy it into Kubernetes using the command ",(0,s.jsx)(n.code,{children:"pants experimental-deploy src/deployment"}),". This will trigger the following steps:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Analyse the dependencies of the given deployment."}),"\n",(0,s.jsx)(n.li,{children:"Build and publish any first-party Docker image and Helm charts that are part of those dependencies."}),"\n",(0,s.jsx)(n.li,{children:"Post-process the Kubernetes manifests generated by Helm by replacing all references to first-party Docker images by their real final registry destination."}),"\n",(0,s.jsx)(n.li,{children:"Initiate the deployment of the final Kubernetes resources resulting from the post-processing."}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"experimental-deploy"})," goal also supports default Helm pass-through arguments that allow to change the deployment behaviour to be atomic or even what is the Kubernetes config file (the ",(0,s.jsx)(n.code,{children:"kubeconfig"})," file) and target context to be used in the deployment."]}),"\n",(0,s.jsxs)(n.p,{children:["Please note that the list of valid pass-through arguments has been limited to those that do not alter the reproducibility of the deployment (i.e. ",(0,s.jsx)(n.code,{children:"--create-namespace"})," is not a valid pass-through argument). Those arguments will have equivalent fields in the ",(0,s.jsx)(n.code,{children:"helm_deployment"})," target."]}),"\n",(0,s.jsx)(n.p,{children:"For example, to make an atomic deployment into a non-default Kubernetes context you can use a command like the following one:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pants experimental-deploy src/deployments:prod -- --kube-context my-custom-kube-context --atomic\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To perform a dry run, use the ",(0,s.jsx)(n.code,{children:"--dry-run"})," flag of the ",(0,s.jsx)(n.code,{children:"experimental-deploy"})," goal."]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"pants experimental-deploy --dry-run src/deployments:prod\n"})}),"\n",(0,s.jsx)(n.admonition,{title:"How does Pants authenticate with the Kubernetes cluster?",type:"note",children:(0,s.jsxs)(n.p,{children:["Short answer is: it doesn't.\nPants will invoke Helm under the hood with the appropriate arguments to only perform the deployment. Any authentication steps that may be needed to perform the given deployment have to be done before invoking the ",(0,s.jsx)(n.code,{children:"experimental-deploy"})," goal. If you are planning to run the deployment procedure from your CI/CD pipelines, ensure that all necessary preliminary steps (including authentication with the cluster) are done before the one that triggers the deployment."]})})]})}function p(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(m,{...e})}):m(e)}},753348(e,n,t){t.d(n,{A:()=>a});let a={tabItem:"tabItem_mHvh"}},618264(e,n,t){t.d(n,{A:()=>a});let a={tabList:"tabList_sFbf",tabItem:"tabItem_UVfV"}},637180(e,n,t){t.d(n,{A:()=>l});var a=t(886070);t(830758);var s=t(313526),r=t(753348);function l({children:e,hidden:n,className:t}){return(0,a.jsx)("div",{role:"tabpanel",className:(0,s.A)(r.A.tabItem,t),hidden:n,children:e})}},685008(e,n,t){t.d(n,{A:()=>u});var a=t(886070),s=t(830758),r=t(313526),l=t(911212),i=t(274875),o=t(106632),c=t(189223),d=t(618264);function h({className:e,block:n,selectedValue:t,selectValue:s,tabValues:l}){let o=[],{blockElementScrollPositionUntilNextRender:c}=(0,i.a_)(),h=e=>{let n=e.currentTarget,a=l[o.indexOf(n)].value;a!==t&&(c(n),s(a))},m=e=>{let n=null;switch(e.key){case"Enter":h(e);break;case"ArrowRight":{let t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{let t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1]}}n?.focus()};return(0,a.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,r.A)("tabs",{"tabs--block":n},e),children:l.map(({value:e,label:n,attributes:s})=>(0,a.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{o.push(e)},onKeyDown:m,onClick:h,...s,className:(0,r.A)("tabs__item",d.A.tabItem,s?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function m({lazy:e,children:n,selectedValue:t}){let l=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){let e=l.find(e=>e.props.value===t);return e?(0,s.cloneElement)(e,{className:(0,r.A)("margin-top--md",e.props.className)}):null}return(0,a.jsx)("div",{className:"margin-top--md",children:l.map((e,n)=>(0,s.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function p(e){let n=(0,o.u)(e);return(0,a.jsxs)("div",{className:(0,r.A)(l.G.tabs.container,"tabs-container",d.A.tabList),children:[(0,a.jsx)(h,{...n,...e}),(0,a.jsx)(m,{...n,...e})]})}function u(e){let n=(0,c.A)();return(0,a.jsx)(p,{...e,children:(0,o.v)(e.children)},String(n))}},106632(e,n,t){t.d(n,{u:()=>h,v:()=>c});var a=t(830758),s=t(325557),r=t(363717),l=t(125740),i=t(574229),o=t(270367);function c(e){return a.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,a.isValidElement)(e)&&function(e){let{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function d({value:e,tabValues:n}){return n.some(n=>n.value===e)}function h(e){let n,{defaultValue:t,queryString:h=!1,groupId:m}=e,p=function(e){let{values:n,children:t}=e;return(0,a.useMemo)(()=>{let e=n??c(t).map(({props:{value:e,label:n,attributes:t,default:a}})=>({value:e,label:n,attributes:t,default:a})),a=(0,i.XI)(e,(e,n)=>e.value===n.value);if(a.length>0)throw Error(`Docusaurus error: Duplicate values "${a.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[n,t])}(e),[u,y]=(0,a.useState)(()=>(function({defaultValue:e,tabValues:n}){if(0===n.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!d({value:e,tabValues:n}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let t=n.find(e=>e.default)??n[0];if(!t)throw Error("Unexpected error: 0 tabValues");return t.value})({defaultValue:t,tabValues:p})),[g,f]=function({queryString:e=!1,groupId:n}){let t=(0,s.W6)(),r=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(r),(0,a.useCallback)(e=>{if(!r)return;let n=new URLSearchParams(t.location.search);n.set(r,e),t.replace({...t.location,search:n.toString()})},[r,t])]}({queryString:h,groupId:m}),[x,v]=function({groupId:e}){let n=e?`docusaurus.tab.${e}`:null,[t,s]=(0,o.Dv)(n);return[t,(0,a.useCallback)(e=>{n&&s.set(e)},[n,s])]}({groupId:m}),b=d({value:n=g??x,tabValues:p})?n:null;return(0,r.A)(()=>{b&&y(b)},[b]),{selectedValue:u,selectValue:(0,a.useCallback)(e=>{if(!d({value:e,tabValues:p}))throw Error(`Can't select invalid tab value=${e}`);y(e),f(e),v(e)},[f,v,p]),tabValues:p}}},848193(e,n,t){t.d(n,{R:()=>l,x:()=>i});var a=t(830758);let s={},r=a.createContext(s);function l(e){let n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),a.createElement(r.Provider,{value:n},e.children)}},227018(e){e.exports=JSON.parse('{"id":"docs/helm/deployments","title":"Deployments","description":"---","source":"@site/versioned_docs/version-2.31/docs/helm/deployments.mdx","sourceDirName":"docs/helm","slug":"/docs/helm/deployments","permalink":"/prerelease/docs/helm/deployments","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/helm/deployments.mdx","tags":[],"version":"2.31","sidebarPosition":1,"frontMatter":{"title":"Deployments","sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Helm Overview","permalink":"/prerelease/docs/helm/"},"next":{"title":"Kubeconform","permalink":"/prerelease/docs/helm/kubeconform"}}')}}]);