"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["961228"],{370046(e,n,t){t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>a});var s=t(420854),i=t(886070),o=t(848193);let r={title:"Developing Rust",sidebar_position:2},l,c={},a=[{value:"Code organization",id:"code-organization",level:2},{value:"Rust &lt;-&gt; Python interaction",id:"rust---python-interaction",level:2},{value:"Common commands",id:"common-commands",level:2},{value:"Compile",id:"compile",level:3},{value:"Run tests",id:"run-tests",level:3},{value:"Autoformat",id:"autoformat",level:3},{value:"Run Clippy",id:"run-clippy",level:3},{value:"Cargo commands",id:"cargo-commands",level:3},{value:"IDE setup (optional)",id:"ide-setup-optional",level:2},{value:"IntelliJ",id:"intellij",level:3},{value:"The <code>fs_util</code> tool",id:"the-fs_util-tool",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Hacking on the Pants engine in Rust."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:"We welcome contributions to Rust! We use Rust to implement the Pants engine in a performant, safe, and ergonomic way."}),"\n",(0,i.jsx)(n.admonition,{title:"Still learning Rust? Ask to get added to reviews",type:"note",children:(0,i.jsxs)(n.p,{children:["We'd be happy to ping you on Rust changes we make for you to see how Rust is used in the wild. Please message us on the #engine channel in ",(0,i.jsx)(n.a,{href:"/community/members",children:"Slack"})," to let us know your interest."]})}),"\n",(0,i.jsx)(n.admonition,{title:"Recommendation: share your plan first",type:"caution",children:(0,i.jsxs)(n.p,{children:["Because changes to Rust deeply impact how Pants runs, it is especially helpful to share any plans to work on Rust before making changes. Please message us on ",(0,i.jsx)(n.a,{href:"/community/members",children:"Slack"})," in the #engine channel or open a ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/issues",children:"GitHub issue"}),"."]})}),"\n",(0,i.jsx)(n.h2,{id:"code-organization",children:"Code organization"}),"\n",(0,i.jsxs)(n.p,{children:["The code for the top-level Pants Rust crate lives in ",(0,i.jsx)(n.code,{children:"src/rust/engine"}),". The top-level ",(0,i.jsx)(n.code,{children:"Cargo.toml"})," file at ",(0,i.jsx)(n.code,{children:"src/rust/engine/Cargo.toml"})," defines a cargo workspace containing a number of other subcrates, which live in subdirectories of ",(0,i.jsx)(n.code,{children:"src/rust/engine"}),". Defining multiple subcrates in this way allows changes affecting one subcrate to avoid affecting other subcrates and triggering more recompilation than is necessary."]}),"\n",(0,i.jsx)(n.p,{children:"Several of the particularly important subcrates are:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"graph"}),": the core of Pants's rule graph implementation."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"ui"}),": the dynamic UI."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"sharded_lmdb"}),": custom wrappers around the ",(0,i.jsx)(n.code,{children:"crates.io"})," ",(0,i.jsx)(n.code,{children:"lmdb"})," crate, which provides bindings to ",(0,i.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Lightning_Memory-Mapped_Database",children:"lmdb"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"fs"}),": manipulating the filesystem."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"process_execution"}),": running local and remote processes."]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"rust---python-interaction",children:"Rust <-> Python interaction"}),"\n",(0,i.jsx)(n.p,{children:"Pants is best conceptualized as a Python program that makes frequent foreign function interface (FFI) calls into Rust code."}),"\n",(0,i.jsxs)(n.p,{children:["The top-level ",(0,i.jsx)(n.code,{children:"engine"})," Rust crate gets compiled into a library named ",(0,i.jsx)(n.code,{children:"native_engine.so"}),", which Python code knows how to interact with. We use the Rust ",(0,i.jsx)(n.a,{href:"https://crates.io/crates/cpython",children:"cpython"})," crate to manage foreign function interaction."]}),"\n",(0,i.jsxs)(n.p,{children:["The C FFI functions that Rust code exposes as a public interface live in ",(0,i.jsx)(n.code,{children:"src/rust/engine/src/externs/interface.rs"}),". On the Python side, the ",(0,i.jsx)(n.code,{children:"native"})," module at ",(0,i.jsx)(n.code,{children:"src/python/pants/engine/internals/native.py"})," contains wrappers around invocations of Rust functions and other FFI boilerplate."]}),"\n",(0,i.jsxs)(n.p,{children:["Rust can also invoke Python functions and object constructors thanks to the ",(0,i.jsx)(n.a,{href:"https://crates.io/crates/cpython",children:"cpython"})," crate. Most of our helper code lives in ",(0,i.jsx)(n.code,{children:"src/rust/engine/src/externs/mod.rs"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"We are planning to port additional functionality from Python to Rust, generally for performance reasons."}),"\n",(0,i.jsx)(n.h2,{id:"common-commands",children:"Common commands"}),"\n",(0,i.jsx)(n.h3,{id:"compile",children:"Compile"}),"\n",(0,i.jsxs)(n.p,{children:["Run ",(0,i.jsx)(n.code,{children:"./pants"})," or ",(0,i.jsx)(n.code,{children:"build-support/bin/native/cargo check --manifest-path src/rust/engine/Cargo.toml"}),"."]}),"\n",(0,i.jsxs)(n.admonition,{type:"caution",children:[(0,i.jsxs)(n.mdxAdmonitionTitle,{children:["Set ",(0,i.jsx)(n.code,{children:"MODE=debug"})," when iterating"]}),(0,i.jsxs)(n.p,{children:["As described in ",(0,i.jsx)(n.a,{href:"/2.0/docs/contributions/development/setting-up-pants",children:"Setting up Pants"}),", we default to compiling Rust in release mode, rather than debug mode."]}),(0,i.jsxs)(n.p,{children:["When working on Rust, you typically should set the environment variable ",(0,i.jsx)(n.code,{children:"MODE=debug"})," for substantially faster compiles."]})]}),"\n",(0,i.jsx)(n.h3,{id:"run-tests",children:"Run tests"}),"\n",(0,i.jsx)(n.p,{children:"To run tests for all crates, run:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"build-support/bin/native/cargo test --manifest-path src/rust/engine/Cargo.toml\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To run for a specific crate, such as the ",(0,i.jsx)(n.code,{children:"fs"})," create, run:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"build-support/bin/native/cargo test --manifest-path src/rust/engine/fs/Cargo.toml\n"})}),"\n",(0,i.jsx)(n.p,{children:"To run for a specific test, use Cargo's filtering mechanism, e.g.:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"build-support/bin/native/cargo test --manifest-path src/rust/engine/Cargo.toml read_file_missing\n"})}),"\n",(0,i.jsx)(n.h3,{id:"autoformat",children:"Autoformat"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"build-support/bin/check_rust_formatting.sh -f\n"})}),"\n",(0,i.jsxs)(n.p,{children:["To run in lint mode, rather than format mode, do not pass the ",(0,i.jsx)(n.code,{children:"-f"})," flag."]}),"\n",(0,i.jsx)(n.h3,{id:"run-clippy",children:"Run Clippy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"build-support/bin/check_clippy.sh\n"})}),"\n",(0,i.jsx)(n.h3,{id:"cargo-commands",children:"Cargo commands"}),"\n",(0,i.jsxs)(n.p,{children:["We have a wrapper script around ",(0,i.jsx)(n.code,{children:"cargo"})," at ",(0,i.jsx)(n.code,{children:"build_support/bin/native/cargo"}),". Use this for all Cargo operations in the Pants codebase."]}),"\n",(0,i.jsx)(n.h2,{id:"ide-setup-optional",children:"IDE setup (optional)"}),"\n",(0,i.jsx)(n.h3,{id:"intellij",children:"IntelliJ"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Bootstrap Pants's Rust toolchain by running ",(0,i.jsx)(n.code,{children:"./pants"}),"."]}),"\n",(0,i.jsx)(n.li,{children:"Install the Rust plugin (see IntelliJ Preferences)."}),"\n",(0,i.jsxs)(n.li,{children:["Set Rust's ",(0,i.jsx)(n.code,{children:"Toolchain location"})," to ",(0,i.jsx)(n.code,{children:"build-support/bin/native"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Set the ",(0,i.jsx)(n.code,{children:"Standard library"})," to ",(0,i.jsx)(n.code,{children:"build-support/bin/native/src"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(n.h2,{id:"the-fs_util-tool",children:["The ",(0,i.jsx)(n.code,{children:"fs_util"})," tool"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.code,{children:"fs_util"})," is a utility that enables you to interact with ",(0,i.jsx)(n.code,{children:"Snapshot"}),"s from the command line. You can use it to help debug issues with snapshotted files."]}),"\n",(0,i.jsx)(n.p,{children:"To build it, run this from the root of the repository:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ cd src/rust/engine && ../../../build-support/bin/native/cargo build -p fs_util\n"})}),"\n",(0,i.jsxs)(n.p,{children:["That will produce ",(0,i.jsx)(n.code,{children:"src/rust/engine/target/debug/fs_util"}),"."]}),"\n",(0,i.jsxs)(n.p,{children:["To inspect a particular snapshot, you'll need to tell fs_util where the storage is and the digest and length of the snapshot to inspect. You can use the ",(0,i.jsx)(n.code,{children:"--local-store-path"})," flag for that."]}),"\n",(0,i.jsx)(n.p,{children:"For example, this command pretty prints the recursive file list of a directory through the directory subcommand."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"$ src/rust/engine/target/debug/fs_util --local-store-path=${HOME}/.cache/pants/lmdb_store directory cat-proto --output-format=recursive-file-list <digesh> <len>\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Pass the ",(0,i.jsx)(n.code,{children:"--help"})," flag to see other ways of using ",(0,i.jsx)(n.code,{children:"fs_util"}),", along with its subcommands. Each subcommand can be passed the ",(0,i.jsx)(n.code,{children:"--help"})," flag."]})]})}function h(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},848193(e,n,t){t.d(n,{R:()=>r,x:()=>l});var s=t(830758);let i={},o=s.createContext(i);function r(e){let n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:n},e.children)}},420854(e){e.exports=JSON.parse('{"id":"docs/contributions/development/developing-rust","title":"Developing Rust","description":"Hacking on the Pants engine in Rust.","source":"@site/versioned_docs/version-2.0/docs/contributions/development/developing-rust.mdx","sourceDirName":"docs/contributions/development","slug":"/docs/contributions/development/developing-rust","permalink":"/2.0/docs/contributions/development/developing-rust","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/contributions/development/developing-rust.mdx","tags":[],"version":"2.0","sidebarPosition":2,"frontMatter":{"title":"Developing Rust","sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"Style guide","permalink":"/2.0/docs/contributions/development/style-guide"},"next":{"title":"Internal Architecture","permalink":"/2.0/docs/contributions/development/internal-architecture"}}')}}]);