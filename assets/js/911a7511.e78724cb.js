"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["699238"],{172704(e,n,s){s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var r=s(157697),t=s(886070),i=s(848193);let o={title:"Add a REPL",sidebar_position:5},l,a={},d=[];function c(e){let n={a:"a",code:"code",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["How to add a new implementation to the ",(0,t.jsx)(n.code,{children:"repl"})," goal."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"repl"})," goal opens up an interactive Read-Eval-Print Loop that runs in the foreground."]}),"\n",(0,t.jsx)(n.p,{children:"Typically, the REPL is loaded with the transitive closure of the files and targets that the user provided, so that users may import their code and resources in the REPL."}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"Install your REPL"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:["There are several ways for Pants to install your REPL. See ",(0,t.jsx)(n.a,{href:"/prerelease/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["In this example, we simply find the program ",(0,t.jsx)(n.code,{children:"bash"})," on the user's machine, but often you will want to install a tool like Ammonite or iPython instead."]}),"\n",(0,t.jsxs)(n.p,{children:["You may want to also add options for your REPL implementation, such as allowing users to change the version of the tool. See ",(0,t.jsx)(n.a,{href:"/prerelease/docs/writing-plugins/the-rules-api/options-and-subsystems",children:"Options and subsystems"}),"."]}),"\n",(0,t.jsxs)(n.ol,{start:"2",children:["\n",(0,t.jsxs)(n.li,{children:["Set up a subclass of ",(0,t.jsx)(n.code,{children:"ReplImplementation"})]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:["Subclass ",(0,t.jsx)(n.code,{children:"ReplImplementation"})," and define the class property ",(0,t.jsx)(n.code,{children:"name: str"})," with the name of your REPL, e.g. ",(0,t.jsx)(n.code,{children:'"bash"'})," or ",(0,t.jsx)(n.code,{children:'"ipython"'}),". Users can then set the option ",(0,t.jsx)(n.code,{children:"--repl-shell"})," to this option to choose your REPL implementation."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from pants.core.goals.repl import ReplImplementation\n\nclass BashRepl(ReplImplementation):\n    name = "bash"\n'})}),"\n",(0,t.jsxs)(n.p,{children:["Then, register your new ",(0,t.jsx)(n.code,{children:"ReplImplementation"})," with a ",(0,t.jsx)(n.a,{href:"/prerelease/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,t.jsx)(n.code,{children:"UnionRule"})})," so that Pants knows your REPL implementation exists:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import collect_rules\nfrom pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(ReplImplementation, BashRepl),\n    ]\n"})}),"\n",(0,t.jsxs)(n.ol,{start:"3",children:["\n",(0,t.jsx)(n.li,{children:"Create a rule for your REPL logic"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:["Your rule should take as a parameter the ",(0,t.jsx)(n.code,{children:"ReplImplementation "})," from Step 2, which has a field ",(0,t.jsx)(n.code,{children:"targets: Targets"})," containing the targets specified by the user. It also has a convenience property ",(0,t.jsx)(n.code,{children:"addresses: Addresses"})," with the addresses of what was specified."]}),"\n",(0,t.jsxs)(n.p,{children:["Your rule should return ",(0,t.jsx)(n.code,{children:"ReplRequest"}),", which has the fields ",(0,t.jsx)(n.code,{children:"digest: Digest"}),", ",(0,t.jsx)(n.code,{children:"args: Iterable[str]"}),", and ",(0,t.jsx)(n.code,{children:"extra_env: Optional[Mapping[str, str]]"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"ReplRequest "})," will get converted into an ",(0,t.jsx)(n.code,{children:"InteractiveProcess"})," that will run in the foreground."]}),"\n",(0,t.jsxs)(n.p,{children:["The process will run in a temporary directory in the build root, which means that the script/program can access files that would normally need to be declared by adding a ",(0,t.jsx)(n.code,{children:"file"})," / ",(0,t.jsx)(n.code,{children:"files"})," or ",(0,t.jsx)(n.code,{children:"resource"})," / ",(0,t.jsx)(n.code,{children:"resources"})," target to the ",(0,t.jsx)(n.code,{children:"dependencies"})," field."]}),"\n",(0,t.jsxs)(n.p,{children:["The process will not be hermetic, meaning that it will inherit the environment variables used by the ",(0,t.jsx)(n.code,{children:"pants"})," process. Any values you set in ",(0,t.jsx)(n.code,{children:"extra_env"})," will add or update the specified environment variables."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from dataclasses import dataclass\n\nfrom pants.core.goals.repl import ReplRequest\nfrom pants.core.target_types import FileSourceField, ResourceSourceField\nfrom pants.core.util_rules.source_files import SourceFilesRequest, determine_source_files\nfrom pants.core.util_rules.system_binaries import BinaryPathRequest, find_binary\nfrom pants.engine.internals.graph import TransitiveTargetsRequest, transitive_targets\nfrom pants.engine.rules import implicitly, rule\nfrom pants.engine.target import SourcesField\nfrom pants.util.logging import LogLevel\n\n...\n\n@rule(level=LogLevel.DEBUG)\nasync def create_bash_repl_request(repl: BashRepl) -> ReplRequest:\n    # First, we find the `bash` program.\n    bash_program_paths =  await find_binary(\n         BinaryPathRequest(binary_name="bash", search_path=("/bin", "/usr/bin")),\n    )\n    if not bash_program_paths.first_path:\n        raise EnvironmentError("Could not find the `bash` program on /bin or /usr/bin.")\n    bash_program = bash_program_paths.first_path\n\n    transitive_tgts = await transitive_targets(\n        TransitiveTargetsRequest(repl.addresses), **implicitly()\n    )\n    sources = await determine_source_files(\n        SourceFilesRequest(\n            (tgt.get(SourcesField) for tgt in transitive_tgts.closure),\n            for_sources_types=(FileSourceField, ResourceSourceField),\n        ),\n    )\n    return ReplRequest(\n        digest=sources.snapshot.digest, args=(bash_program.exe,)\n    )\n'})}),"\n",(0,t.jsxs)(n.p,{children:["If you use any relative paths in ",(0,t.jsx)(n.code,{children:"args"})," or ",(0,t.jsx)(n.code,{children:"extra_env"}),", you should call ",(0,t.jsx)(n.code,{children:'repl.in_chroot("./example_relative_path")'})," on the values. This ensures that you run on the correct file in the temporary directory created by Pants."]}),"\n",(0,t.jsxs)(n.p,{children:["Finally, update your plugin's ",(0,t.jsx)(n.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/bash/register.py"',children:"from bash import repl\n\n\ndef rules():\n    return [*repl.rules()]\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Now, when you run ",(0,t.jsx)(n.code,{children:"pants repl --shell=bash ::"}),", your new REPL should be used."]})]})}function p(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},848193(e,n,s){s.d(n,{R:()=>o,x:()=>l});var r=s(830758);let t={},i=r.createContext(t);function o(e){let n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),r.createElement(i.Provider,{value:n},e.children)}},157697(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-repl","title":"Add a REPL","description":"How to add a new implementation to the repl goal.","source":"@site/versioned_docs/version-2.31/docs/writing-plugins/common-plugin-tasks/add-a-repl.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-repl","permalink":"/prerelease/docs/writing-plugins/common-plugin-tasks/add-a-repl","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-repl.mdx","tags":[],"version":"2.31","sidebarPosition":5,"frontMatter":{"title":"Add a REPL","sidebar_position":5},"sidebar":"docsSidebar","previous":{"title":"Add codegen","permalink":"/prerelease/docs/writing-plugins/common-plugin-tasks/add-codegen"},"next":{"title":"Run tests","permalink":"/prerelease/docs/writing-plugins/common-plugin-tasks/run-tests"}}')}}]);