"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["903589"],{229963(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var s=t(959967),r=t(886070),i=t(848193),l=t(685008),a=t(637180);let o={title:"Concepts",sidebar_position:0},c,d={},u=[{value:"Rules",id:"rules",level:2},{value:"The rule graph",id:"the-rule-graph",level:2},{value:"<code>await Get</code> - awaiting results in a rule body",id:"await-get---awaiting-results-in-a-rule-body",level:2},{value:"<code>MultiGet</code> for concurrency",id:"multiget-for-concurrency",level:3},{value:"Valid types",id:"valid-types",level:2},{value:"Dataclasses",id:"dataclasses",level:3},{value:"<code>Collection</code>: a newtype for <code>tuple</code>",id:"collection-a-newtype-for-tuple",level:3},{value:"<code>DeduplicatedCollection</code>: a newtype for <code>FrozenOrderedSet</code>",id:"deduplicatedcollection-a-newtype-for-frozenorderedset",level:3},{value:"Registering rules in <code>register.py</code>",id:"registering-rules-in-registerpy",level:2}];function h(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.p,{children:"The core concepts of the Rules API."}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"rules",children:"Rules"}),"\n",(0,r.jsxs)(n.p,{children:["Plugin logic is defined in ",(0,r.jsx)(n.em,{children:"rules"}),": ",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Pure_function",children:"pure functions"})," that map a set of statically-declared input types to a statically-declared output type."]}),"\n",(0,r.jsxs)(n.p,{children:["Each rule is an ",(0,r.jsx)(n.code,{children:"async"})," Python function annotated with the decorator ",(0,r.jsx)(n.code,{children:"@rule"}),", which takes any number of parameters (including zero) and returns a value of one specific type. Rules must be annotated with ",(0,r.jsx)(n.a,{href:"https://www.python.org/dev/peps/pep-0484/",children:"type hints"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:["For example, this rule maps ",(0,r.jsx)(n.code,{children:"(int) -> str"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import rule\n\n@rule\nasync def int_to_str(i: int) -> str:\n    return str(i)\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Although any Python type, including builtin types like ",(0,r.jsx)(n.code,{children:"int"}),", can be a parameter or return type of a rule, in almost all cases rules will deal with values of custom Python classes."]}),"\n",(0,r.jsxs)(n.p,{children:["Generally, rules correspond to a step in your build process. For example, when adding a new linter, you may have a rule that maps ",(0,r.jsx)(n.code,{children:"(Target, Shellcheck) -> LintResult"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'@rule\nasync def run_shellcheck(target: Target, shellcheck: Shellcheck) -> LintResult:\n    # Your logic.\n    return LintResult(stdout="", stderr="", exit_code=0)\n'})}),"\n",(0,r.jsxs)(n.p,{children:["You do not call a rule like you would a normal function. In the above examples, you would not say ",(0,r.jsx)(n.code,{children:"int_to_str(26)"})," or ",(0,r.jsx)(n.code,{children:"run_shellcheck(tgt, shellcheck)"}),". Instead, the Pants engine determines when rules are used and calls the rules for you."]}),"\n",(0,r.jsxs)(n.p,{children:["Each rule should be pure; you should not use side effects like ",(0,r.jsx)(n.code,{children:"subprocess.run()"}),", ",(0,r.jsx)(n.code,{children:"print()"}),", or the ",(0,r.jsx)(n.code,{children:"requests"})," library. Instead, the Rules API has its own alternatives that are understood by the Pants engine and which work properly with its caching and parallelism."]}),"\n",(0,r.jsx)(n.h2,{id:"the-rule-graph",children:"The rule graph"}),"\n",(0,r.jsx)(n.p,{children:"All the registered rules create a rule graph, with each type as a node and the edges being dependencies used to compute those types."}),"\n",(0,r.jsxs)(n.p,{children:["For example, the ",(0,r.jsx)(n.code,{children:"list"})," goal uses this rule definition and results in the below graph:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"@goal_rule\nasync def list_targets(\n    console: Console, addresses: Addresses, list_subsystem: ListSubsystem\n) -> ListGoal:\n    ...\n    return ListGoal(exit_code=0)\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{src:"https://files.readme.io/7d5163f-Rule_graph_example-2.png",alt:""})}),"\n",(0,r.jsxs)(n.p,{children:["At the top of the graph will always be the goals that Pants runs, such as ",(0,r.jsx)(n.code,{children:"list"})," and ",(0,r.jsx)(n.code,{children:"test"}),". These goals are the entry-point into the graph. When a user runs ",(0,r.jsx)(n.code,{children:"pants list"}),", the engine looks for a special type of rule, called a ",(0,r.jsx)(n.code,{children:"@goal_rule"}),", that implements the respective goal. From there, the ",(0,r.jsx)(n.code,{children:"@goal_rule"})," might request certain types like ",(0,r.jsx)(n.code,{children:"Console"})," and ",(0,r.jsx)(n.code,{children:"Addresses"}),", which will cause other helper ",(0,r.jsx)(n.code,{children:"@rule"}),"s to be used. To view the graph for a goal, see: ",(0,r.jsx)(n.a,{href:"/2.25/docs/writing-plugins/the-rules-api/tips-and-debugging#debugging-visualize-the-rule-graph",children:"Visualize the rule graph"}),"."]}),"\n",(0,r.jsxs)(n.p,{children:['The graph also has several "roots", such as ',(0,r.jsx)(n.code,{children:"Console"}),", ",(0,r.jsx)(n.code,{children:"Specs"}),", and ",(0,r.jsx)(n.code,{children:"OptionsBootstrapper"})," in this example. Those roots are injected into the graph as the initial input, whereas all other types are derived from those roots."]}),"\n",(0,r.jsxs)(n.p,{children:["The engine will find a path through the rules to satisfy the types that you are requesting. In this example, we do not need to explicitly specify ",(0,r.jsx)(n.code,{children:"Specs"}),"; we only specify ",(0,r.jsx)(n.code,{children:"Addresses"})," in our rule's parameters, and the engine finds a path from ",(0,r.jsx)(n.code,{children:"Specs"})," to ",(0,r.jsx)(n.code,{children:"Addresses"})," for us. This is similar to ",(0,r.jsx)(n.a,{href:"https://www.freecodecamp.org/news/a-quick-intro-to-dependency-injection-what-it-is-and-when-to-use-it-7578c84fa88f/",children:"Dependency Injection"}),", but with a typed and validated graph."]}),"\n",(0,r.jsx)(n.p,{children:"If the engine cannot find a path, or if there is ambiguity due to multiple possible paths, the rule graph will fail to compile. This ensures that the rule graph is always unambiguous."}),"\n",(0,r.jsxs)(n.admonition,{title:"Rule graph errors can be confusing",type:"caution",children:[(0,r.jsxs)(n.p,{children:["We know that rule graph errors can be intimidating and confusing to understand. We are planning to improve them. In the meantime, please do not hesitate to ask for help in the #plugins channel on ",(0,r.jsx)(n.a,{href:"/community/getting-help",children:"Slack"}),"."]}),(0,r.jsxs)(n.p,{children:["Also see ",(0,r.jsx)(n.a,{href:"/2.25/docs/writing-plugins/the-rules-api/tips-and-debugging#debugging-rule-graph-issues",children:"Tips and debugging"})," for some tips for how to approach these errors."]})]}),"\n",(0,r.jsxs)(n.h2,{id:"await-get---awaiting-results-in-a-rule-body",children:[(0,r.jsx)(n.code,{children:"await Get"})," - awaiting results in a rule body"]}),"\n",(0,r.jsx)(n.p,{children:"In addition to requesting types in your rule's parameters, you can request types in the body of your rule."}),"\n",(0,r.jsxs)(n.p,{children:["Add ",(0,r.jsx)(n.code,{children:"await Get(OutputType, InputType, input)"}),", where the output type is what you are requesting and the input is what you're giving the engine for it to be able to compute the output. For example:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from pants.engine.rules import Get, rule\n\n@rule\nasync def run_shellcheck(target: Target, shellcheck: Shellcheck) -> LintResult:\n    ...\n    process_request = Process(\n        ["/bin/echo", str(target.address)],\n        description=f"Echo {target.address}",\n    )\n    process_result = await Get(ProcessResult, Process, process_request)\n    return LintResult(stdout=process_result.stdout, stderr=process_result.stderr, exit_code=0)\n'})}),"\n",(0,r.jsxs)(n.p,{children:["Pants will run your rule like normal Python code until encountering the ",(0,r.jsx)(n.code,{children:"await"}),", which will yield execution to the engine. The engine will look in the pre-compiled rule graph to determine how to go from ",(0,r.jsx)(n.code,{children:"Process -> ProcessResult"}),". Once the engine gives back the resulting ",(0,r.jsx)(n.code,{children:"ProcessResult"})," object, control will be returned back to your Python code."]}),"\n",(0,r.jsxs)(n.p,{children:["In this example, we could not have requested the type ",(0,r.jsx)(n.code,{children:"ProcessResult"})," as a parameter to our rule because we needed to dynamically create a ",(0,r.jsx)(n.code,{children:"Process"})," object."]}),"\n",(0,r.jsxs)(n.p,{children:["Thanks to ",(0,r.jsx)(n.code,{children:"await Get"}),", we can write a recursive rule to compute a ",(0,r.jsx)(n.a,{href:"https://en.wikipedia.org/wiki/Fibonacci_number",children:"Fibonacci number"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"@dataclass(frozen=True)\nclass Fibonacci:\n    val: int\n\n@rule\nasync def compute_fibonacci(n: int) -> Fibonacci:\n    if n < 2:\n        return Fibonacci(n)\n    x = await Get(Fibonacci, int, n - 2)\n    y = await Get(Fibonacci, int, n - 1)\n    return Fibonacci(x.val + y.val)\n"})}),"\n",(0,r.jsxs)(n.p,{children:['Another rule could then "call" our Fibonacci rule by using its own ',(0,r.jsx)(n.code,{children:"Get"}),":"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"@rule\nasync def call_fibonacci(...) -> Foo:\n    fib = await Get(Fibonnaci, int, 4)\n    ...\n"})}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsxs)(n.mdxAdmonitionTitle,{children:[(0,r.jsx)(n.code,{children:"Get"})," constructor shorthand"]}),(0,r.jsxs)(n.p,{children:["The verbose constructor for a ",(0,r.jsx)(n.code,{children:"Get"})," object takes three parameters: ",(0,r.jsx)(n.code,{children:"Get(OutputType, InputType, input)"}),", where ",(0,r.jsx)(n.code,{children:"OutputType"})," and ",(0,r.jsx)(n.code,{children:"InputType"})," are both types, and ",(0,r.jsx)(n.code,{children:"input"})," is an instance of ",(0,r.jsx)(n.code,{children:"InputType"}),"."]}),(0,r.jsxs)(n.p,{children:["Instead, you can use ",(0,r.jsx)(n.code,{children:"Get(OutputType, InputType(constructor arguments))"}),". These two are equivalent:"]}),(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:'Get(ProcessResult, Process, Process(["/bin/echo"]))'})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.code,{children:'Get(ProcessResult, Process(["/bin/echo"]))'})}),"\n"]}),(0,r.jsxs)(n.p,{children:["However, the below is invalid because Pants's AST parser will not be able to see what the ",(0,r.jsx)(n.code,{children:"InputType"})," is:"]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'process = Process(["/bin/echo"])\nGet(ProcessResult, process)\n'})})]}),"\n",(0,r.jsxs)(n.admonition,{title:"Why only one input?",type:"note",children:[(0,r.jsxs)(n.p,{children:["Currently, you can only give a single input. It is not possible to do something like ",(0,r.jsx)(n.code,{children:"Get(OutputType, InputType1(...), InputType2(...))"}),"."]}),(0,r.jsxs)(n.p,{children:['Instead, it\'s common for rules to create a "Request" data class, such as ',(0,r.jsx)(n.code,{children:"PexRequest"})," or ",(0,r.jsx)(n.code,{children:"SourceFilesRequest"}),". This request centralizes all the data it needs to operate into one data structure, which allows for call sites to say ",(0,r.jsx)(n.code,{children:"await Get(SourceFiles, SourceFilesRequest, my_request)"}),", for example."]}),(0,r.jsxs)(n.p,{children:["See ",(0,r.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/issues/7490",children:"https://github.com/pantsbuild/pants/issues/7490"})," for the tracking issue."]})]}),"\n",(0,r.jsxs)(n.h3,{id:"multiget-for-concurrency",children:[(0,r.jsx)(n.code,{children:"MultiGet"})," for concurrency"]}),"\n",(0,r.jsxs)(n.p,{children:["Every time your rule has the ",(0,r.jsx)(n.code,{children:"await"})," keyword, the engine will pause execution until the result is returned. This means that if you have two ",(0,r.jsx)(n.code,{children:"await Get"}),"s, the engine will evaluate them sequentially, rather than concurrently."]}),"\n",(0,r.jsxs)(n.p,{children:["You can use ",(0,r.jsx)(n.code,{children:"await MultiGet"})," to instead get multiple results in parallel."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import Get, MultiGet, rule\n\n@rule\nasync def call_fibonacci(...) -> Foo:\n    results = await MultiGet(Get(Fibonnaci, int, n) for n in range(100))\n    ...\n"})}),"\n",(0,r.jsxs)(n.p,{children:["The result of ",(0,r.jsx)(n.code,{children:"MultiGet"})," is a tuple with each individual result, in the same order as the requests."]}),"\n",(0,r.jsxs)(n.p,{children:["You should rarely use a ",(0,r.jsx)(n.code,{children:"for"})," loop with ",(0,r.jsx)(n.code,{children:"await Get"})," - use ",(0,r.jsx)(n.code,{children:"await MultiGet"})," instead, as shown above."]}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"MultiGet"})," can either take a single iterable of ",(0,r.jsx)(n.code,{children:"Get"})," objects or take multiple individual arguments of ",(0,r.jsx)(n.code,{children:"Get"})," objects. Thanks to this, we can rewrite our Fibonacci rule to parallelize the two recursive calls:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import Get, MultiGet, rule\n\n@rule\nasync def compute_fibonacci(n: int) -> Fibonacci:\n    if n < 2:\n        return Fibonacci(n)\n    x, y = await MultiGet(\n        Get(Fibonacci, int, n - 2),\n        Get(Fibonacci, int, n - 1),\n    )\n    return Fibonacci(x.val + y.val)\n"})}),"\n",(0,r.jsx)(n.h2,{id:"valid-types",children:"Valid types"}),"\n",(0,r.jsxs)(n.p,{children:["Types used as inputs to ",(0,r.jsx)(n.code,{children:"Get"}),"s or ",(0,r.jsx)(n.code,{children:"Query"}),"s must be hashable, and therefore should be immutable. Specifically, the type must have implemented ",(0,r.jsx)(n.code,{children:"__hash__()"})," and ",(0,r.jsx)(n.code,{children:"__eq__()"}),". While the engine will not validate that your type is immutable, you should be careful to ensure this so that the cache works properly."]}),"\n",(0,r.jsx)(n.p,{children:"Because you should use immutable types, use these collection types:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"tuple"})," instead of ",(0,r.jsx)(n.code,{children:"list"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pants.util.frozendict.FrozenDict"})," instead of the built-in ",(0,r.jsx)(n.code,{children:"dict"}),"."]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"pants.util.ordered_set.FrozenOrderedSet"})," instead of the built-in ",(0,r.jsx)(n.code,{children:"set"}),". This will also preserve the insertion order, which is important for determinism."]}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["Unlike Python in general, the engine uses exact type matches, rather than considering inheritance; even if ",(0,r.jsx)(n.code,{children:"Truck"})," subclasses ",(0,r.jsx)(n.code,{children:"Vehicle"}),", the engine will view these types as completely separate when deciding which rules to use."]}),"\n",(0,r.jsxs)(n.p,{children:["You cannot use generic Python type hints in a rule's parameters or in a ",(0,r.jsx)(n.code,{children:"Get()"}),". For example, a rule cannot return ",(0,r.jsx)(n.code,{children:"Optional[Foo]"}),", or take as a parameter ",(0,r.jsx)(n.code,{children:"Tuple[Foo, ...]"}),". To express generic type hints, you should instead create a class that stores that value."]}),"\n",(0,r.jsxs)(n.p,{children:['To disambiguate between different uses of the same type, you will usually want to "newtype" the types that you use. Rather than using the builtin ',(0,r.jsx)(n.code,{children:"str"})," or ",(0,r.jsx)(n.code,{children:"int"}),", for example, you should define a new, declarative class like ",(0,r.jsx)(n.code,{children:"Name"})," or ",(0,r.jsx)(n.code,{children:"Age"}),"."]}),"\n",(0,r.jsx)(n.h3,{id:"dataclasses",children:"Dataclasses"}),"\n",(0,r.jsxs)(n.p,{children:["Python 3's ",(0,r.jsx)(n.a,{href:"https://docs.python.org/3/library/dataclasses.html",children:"dataclasses"})," work well with the engine because:"]}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["If ",(0,r.jsx)(n.code,{children:"frozen=True"})," is set, they are immutable and hashable."]}),"\n",(0,r.jsx)(n.li,{children:"Dataclasses use type hints."}),"\n",(0,r.jsx)(n.li,{children:"Dataclasses are declarative and ergonomic."}),"\n"]}),"\n",(0,r.jsxs)(n.p,{children:["You do not need to use dataclasses. You can use alternatives like ",(0,r.jsx)(n.code,{children:"attrs"})," or normal Python classes. However, dataclasses are a nice default."]}),"\n",(0,r.jsxs)(n.p,{children:["You should set ",(0,r.jsx)(n.code,{children:"@dataclass(frozen=True)"})," for Python to autogenerate ",(0,r.jsx)(n.code,{children:"__hash__()"})," and to ensure that the type is immutable."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from __future__ import annotations\n\nfrom dataclasses import dataclass\n\n@dataclass(frozen=True)\nclass Name:\n    first: str\n    last: str | None\n\n@rule\nasync def demo(name: Name) -> Foo:\n    ...\n"})}),"\n",(0,r.jsxs)(n.admonition,{type:"caution",children:[(0,r.jsxs)(n.mdxAdmonitionTitle,{children:["Don't use ",(0,r.jsx)(n.code,{children:"NamedTuple"})]}),(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"NamedTuple"})," behaves similarly to dataclasses, but it should not be used because the ",(0,r.jsx)(n.code,{children:"__eq__()"})," implementation uses structural equality, rather than the nominal equality used by the engine."]})]}),"\n",(0,r.jsxs)(n.admonition,{type:"note",children:[(0,r.jsxs)(n.mdxAdmonitionTitle,{children:["Custom dataclass ",(0,r.jsx)(n.code,{children:"__init__()"})]}),(0,r.jsxs)(n.p,{children:["Sometimes, you may want to have a custom ",(0,r.jsx)(n.code,{children:"__init__()"})," constructor. For example, you may want your dataclass to store a ",(0,r.jsx)(n.code,{children:"tuple[str, ...]"}),", but for your constructor to take the more flexible ",(0,r.jsx)(n.code,{children:"Iterable[str]"})," which you then convert to an immutable tuple sequence."]}),(0,r.jsxs)(n.p,{children:["The Python docs suggest using ",(0,r.jsx)(n.code,{children:"object.__setattr__"})," to set attributes in your ",(0,r.jsx)(n.code,{children:"__init__"})," for frozen dataclasses."]}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from __future__ import annotations\n\nfrom dataclasses import dataclass\nfrom typing import Iterable\n\n@dataclass(frozen=True)\nclass Example:\n    args: tuple[str, ...]\n\n    def __init__(self, args: Iterable[str]) -> None:\n        object.__setattr__(self, "args", tuple(args))\n'})})]}),"\n",(0,r.jsxs)(n.h3,{id:"collection-a-newtype-for-tuple",children:[(0,r.jsx)(n.code,{children:"Collection"}),": a newtype for ",(0,r.jsx)(n.code,{children:"tuple"})]}),"\n",(0,r.jsxs)(n.p,{children:["If you want a rule to use a homogenous sequence, you can use ",(0,r.jsx)(n.code,{children:"pants.engine.collection.Collection"}),' to "newtype" a tuple. This will behave the same as a tuple, but will have a distinct type.']}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pants.engine.collection import Collection\n\n@dataclass(frozen=True)\nclass LintResult:\n    stdout: str\n    stderr: str\n    exit_code: int\n\n\nclass LintResults(Collection[LintResult]):\n    pass\n\n\n@rule\nasync def demo(results: LintResults) -> Foo:\n    for result in results:\n        print(result.stdout)\n    ...\n"})}),"\n",(0,r.jsxs)(n.h3,{id:"deduplicatedcollection-a-newtype-for-frozenorderedset",children:[(0,r.jsx)(n.code,{children:"DeduplicatedCollection"}),": a newtype for ",(0,r.jsx)(n.code,{children:"FrozenOrderedSet"})]}),"\n",(0,r.jsxs)(n.p,{children:["If you want a rule to use a homogenous set, you can use ",(0,r.jsx)(n.code,{children:"pants.engine.collection.DeduplicatedCollection"}),' to "newtype" a ',(0,r.jsx)(n.code,{children:"FrozenOrderedSet"}),". This will behave the same as a ",(0,r.jsx)(n.code,{children:"FrozenOrderedSet"}),", but will have a distinct type."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:"from pants.engine.collection import DeduplicatedCollection\n\nclass RequirementStrings(DeduplicatedCollection[str]):\n    sort_input = True\n\n\n@rule\nasync def demo(requirements: RequirementStrings) -> Foo:\n    for requirement in requirements:\n        print(requirement)\n    ...\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can optionally set the class property ",(0,r.jsx)(n.code,{children:"sort_input"}),", which will often result in more cache hits with the Pantsd daemon."]}),"\n",(0,r.jsxs)(n.h2,{id:"registering-rules-in-registerpy",children:["Registering rules in ",(0,r.jsx)(n.code,{children:"register.py"})]}),"\n",(0,r.jsxs)(n.p,{children:["To register a new rule, use the ",(0,r.jsx)(n.code,{children:"rules()"})," hook in your ",(0,r.jsxs)(n.a,{href:"/2.25/docs/writing-plugins/overview",children:[(0,r.jsx)(n.code,{children:"register.py"})," file"]}),". This function expects a list of functions annotated with ",(0,r.jsx)(n.code,{children:"@rule"}),"."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/plugin1/register.py"',children:"def rules():\n    return [rule1, rule2]\n"})}),"\n",(0,r.jsxs)(n.p,{children:["Conventionally, each file will have a function called ",(0,r.jsx)(n.code,{children:"rules()"})," and then ",(0,r.jsx)(n.code,{children:"register.py"})," will re-export them. This is meant to make imports more organized. Within each file, you can use ",(0,r.jsx)(n.code,{children:"collect_rules()"})," to automatically find the rules in the file."]}),"\n",(0,r.jsxs)(l.A,{groupId:"code-examples",children:[(0,r.jsx)(a.A,{value:"pants-plugins/fortran/register.py",label:"pants-plugins/fortran/register.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"pants-plugins/fortran/register.py"}',children:"from fortran import fmt, test\n\ndef rules():\n    return [*fmt.rules(), *test.rules()]\n"})})}),(0,r.jsx)(a.A,{value:"pants-plugins/fortran/fmt.py",label:"pants-plugins/fortran/fmt.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"pants-plugins/fortran/fmt.py"}',children:"from pants.engine.rules import collect_rules, rule\n\n@rule\nasync def setup_formatter(...) -> Formatter:\n    ...\n\n@rule\nasync def fmt_fortran(...) -> FormatResult:\n    ...\n\ndef rules():\n    return collect_rules()\n"})})}),(0,r.jsx)(a.A,{value:"pants-plugins/fortran/test.py",label:"pants-plugins/fortran/test.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label":"pants-plugins/fortran/test.py"}',children:"from pants.engine.rules import collect_rules, rule\n\n@rule\nasync def run_fotran_test(...) -> TestResult:\n    ...\n\ndef rules():\n    return collect_rules()\n"})})})]})]})}function p(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},753348(e,n,t){t.d(n,{A:()=>s});let s={tabItem:"tabItem_mHvh"}},618264(e,n,t){t.d(n,{A:()=>s});let s={tabList:"tabList_sFbf",tabItem:"tabItem_UVfV"}},637180(e,n,t){t.d(n,{A:()=>l});var s=t(886070);t(830758);var r=t(313526),i=t(753348);function l({children:e,hidden:n,className:t}){return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.A)(i.A.tabItem,t),hidden:n,children:e})}},685008(e,n,t){t.d(n,{A:()=>x});var s=t(886070),r=t(830758),i=t(313526),l=t(911212),a=t(274875),o=t(106632),c=t(189223),d=t(618264);function u({className:e,block:n,selectedValue:t,selectValue:r,tabValues:l}){let o=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.a_)(),u=e=>{let n=e.currentTarget,s=l[o.indexOf(n)].value;s!==t&&(c(n),r(s))},h=e=>{let n=null;switch(e.key){case"Enter":u(e);break;case"ArrowRight":{let t=o.indexOf(e.currentTarget)+1;n=o[t]??o[0];break}case"ArrowLeft":{let t=o.indexOf(e.currentTarget)-1;n=o[t]??o[o.length-1]}}n?.focus()};return(0,s.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.A)("tabs",{"tabs--block":n},e),children:l.map(({value:e,label:n,attributes:r})=>(0,s.jsx)("li",{role:"tab",tabIndex:t===e?0:-1,"aria-selected":t===e,ref:e=>{o.push(e)},onKeyDown:h,onClick:u,...r,className:(0,i.A)("tabs__item",d.A.tabItem,r?.className,{"tabs__item--active":t===e}),children:n??e},e))})}function h({lazy:e,children:n,selectedValue:t}){let l=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){let e=l.find(e=>e.props.value===t);return e?(0,r.cloneElement)(e,{className:(0,i.A)("margin-top--md",e.props.className)}):null}return(0,s.jsx)("div",{className:"margin-top--md",children:l.map((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==t}))})}function p(e){let n=(0,o.u)(e);return(0,s.jsxs)("div",{className:(0,i.A)(l.G.tabs.container,"tabs-container",d.A.tabList),children:[(0,s.jsx)(u,{...n,...e}),(0,s.jsx)(h,{...n,...e})]})}function x(e){let n=(0,c.A)();return(0,s.jsx)(p,{...e,children:(0,o.v)(e.children)},String(n))}},106632(e,n,t){t.d(n,{u:()=>u,v:()=>c});var s=t(830758),r=t(325557),i=t(363717),l=t(125740),a=t(574229),o=t(270367);function c(e){return s.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,s.isValidElement)(e)&&function(e){let{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function d({value:e,tabValues:n}){return n.some(n=>n.value===e)}function u(e){let n,{defaultValue:t,queryString:u=!1,groupId:h}=e,p=function(e){let{values:n,children:t}=e;return(0,s.useMemo)(()=>{let e=n??c(t).map(({props:{value:e,label:n,attributes:t,default:s}})=>({value:e,label:n,attributes:t,default:s})),s=(0,a.XI)(e,(e,n)=>e.value===n.value);if(s.length>0)throw Error(`Docusaurus error: Duplicate values "${s.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[n,t])}(e),[x,m]=(0,s.useState)(()=>(function({defaultValue:e,tabValues:n}){if(0===n.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!d({value:e,tabValues:n}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let t=n.find(e=>e.default)??n[0];if(!t)throw Error("Unexpected error: 0 tabValues");return t.value})({defaultValue:t,tabValues:p})),[g,j]=function({queryString:e=!1,groupId:n}){let t=(0,r.W6)(),i=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(i),(0,s.useCallback)(e=>{if(!i)return;let n=new URLSearchParams(t.location.search);n.set(i,e),t.replace({...t.location,search:n.toString()})},[i,t])]}({queryString:u,groupId:h}),[f,y]=function({groupId:e}){let n=e?`docusaurus.tab.${e}`:null,[t,r]=(0,o.Dv)(n);return[t,(0,s.useCallback)(e=>{n&&r.set(e)},[n,r])]}({groupId:h}),b=d({value:n=g??f,tabValues:p})?n:null;return(0,i.A)(()=>{b&&m(b)},[b]),{selectedValue:x,selectValue:(0,s.useCallback)(e=>{if(!d({value:e,tabValues:p}))throw Error(`Can't select invalid tab value=${e}`);m(e),j(e),y(e)},[j,y,p]),tabValues:p}}},848193(e,n,t){t.d(n,{R:()=>l,x:()=>a});var s=t(830758);let r={},i=s.createContext(r);function l(e){let n=s.useContext(i);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),s.createElement(i.Provider,{value:n},e.children)}},959967(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-rules-api/concepts","title":"Concepts","description":"The core concepts of the Rules API.","source":"@site/versioned_docs/version-2.25/docs/writing-plugins/the-rules-api/concepts.mdx","sourceDirName":"docs/writing-plugins/the-rules-api","slug":"/docs/writing-plugins/the-rules-api/concepts","permalink":"/2.25/docs/writing-plugins/the-rules-api/concepts","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-rules-api/concepts.mdx","tags":[],"version":"2.25","sidebarPosition":0,"frontMatter":{"title":"Concepts","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"The Rules API","permalink":"/2.25/docs/writing-plugins/the-rules-api/"},"next":{"title":"Goal rules","permalink":"/2.25/docs/writing-plugins/the-rules-api/goal-rules"}}')}}]);