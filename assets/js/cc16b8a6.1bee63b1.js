"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["757396"],{452697(e,i,n){n.r(i),n.d(i,{assets:()=>a,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var s=n(480410),t=n(886070),r=n(848193);let o={title:"Tips and debugging",sidebar_position:10},l,a={},d=[{value:"Tip: Use <code>MultiGet</code> for increased concurrency",id:"tip-use-multiget-for-increased-concurrency",level:2},{value:"Tip: Add logging",id:"tip-add-logging",level:2},{value:"FYI: Caching semantics",id:"fyi-caching-semantics",level:2},{value:"Debugging: Look inside the chroot",id:"debugging-look-inside-the-chroot",level:2},{value:"Debugging: Visualize the rule graph",id:"debugging-visualize-the-rule-graph",level:2}];function c(e){let i={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(i.hr,{}),"\n",(0,t.jsxs)(i.admonition,{title:"Reminder: ask for help",type:"note",children:[(0,t.jsxs)(i.p,{children:["We would love to help you with your plugin. Please reach out through ",(0,t.jsx)(i.a,{href:"/community/members",children:"Slack"}),"."]}),(0,t.jsx)(i.p,{children:"We also appreciate any feedback on the Rules API. If you find certain things confusing or are looking for additional mechanisms, please let us know."})]}),"\n",(0,t.jsxs)(i.h2,{id:"tip-use-multiget-for-increased-concurrency",children:["Tip: Use ",(0,t.jsx)(i.code,{children:"MultiGet"})," for increased concurrency"]}),"\n",(0,t.jsxs)(i.p,{children:["Every time your rule has ",(0,t.jsx)(i.code,{children:"await"}),", Python will yield execution to the engine and not resume until the engine returns the result. So, you can improve concurrency by instead bundling multiple ",(0,t.jsx)(i.code,{children:"Get"})," requests into a single ",(0,t.jsx)(i.code,{children:"MultiGet"}),", which will allow each request to be resolved through a separate thread."]}),"\n",(0,t.jsx)(i.p,{children:"Okay:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-python",children:'from pants.core.util_rules.determine_source_files import AllSourceFilesRequest, SourceFiles\nfrom pants.engine.fs import AddPrefix, Digest\nfrom pants.engine.selectors import Get, MultiGet\n\n@rule\nasync def demo(...) -> Foo:\n    new_digest = await Get(Digest, AddPrefix(original_digest, "new_prefix"))\n    source_files = await Get(SourceFiles, AllSourceFilesRequest(sources_fields))\n'})}),"\n",(0,t.jsx)(i.p,{children:"Better:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{className:"language-python",children:'from pants.core.util_rules.determine_source_files import AllSourceFilesRequest, SourceFiles\nfrom pants.engine.fs import AddPrefix, Digest\nfrom pants.engine.selectors import Get, MultiGet\n\n@rule\nasync def demo(...) -> Foo:\n    new_digest, source_files = await MultiGet(\n        Get(Digest, AddPrefix(original_digest, "new_prefix")),\n        Get(SourceFiles, AllSourceFilesRequest(sources_fields)),\n    )\n'})}),"\n",(0,t.jsx)(i.h2,{id:"tip-add-logging",children:"Tip: Add logging"}),"\n",(0,t.jsxs)(i.p,{children:["As explained in ",(0,t.jsx)(i.a,{href:"/2.7/docs/writing-plugins/the-rules-api/logging-and-dynamic-output",children:"Logging and dynamic output"}),", you can add logging to any ",(0,t.jsx)(i.code,{children:"@rule"})," by using Python's ",(0,t.jsx)(i.code,{children:"logging"})," module like you normally would."]}),"\n",(0,t.jsx)(i.h2,{id:"fyi-caching-semantics",children:"FYI: Caching semantics"}),"\n",(0,t.jsxs)(i.p,{children:["There are two layers to Pants caching: in-memory memoization and caching written to disk via the ",(0,t.jsx)(i.a,{href:"https://en.wikipedia.org/wiki/Lightning_Memory-Mapped_Database",children:"LMDB store"}),"."]}),"\n",(0,t.jsxs)(i.p,{children:["Pants will write to the LMDB store\u2014usually at ",(0,t.jsx)(i.code,{children:"~/.cache/pants/lmdb_store"}),"\u2014for any ",(0,t.jsx)(i.code,{children:"Process"})," execution and when ",(0,t.jsx)(i.a,{href:"/2.7/docs/writing-plugins/the-rules-api/file-system",children:'"digesting" files'}),", such as downloading a file or reading from the filesystem. The cache is based on inputs; for example, if the input ",(0,t.jsx)(i.code,{children:"Process"})," is identical to a previous run, then the cache will use the corresponding cached ",(0,t.jsx)(i.code,{children:"ProcessResult"}),". Writing to and reading from LMDB store is very fast, and reads are concurrent. The cache will be occasionally garbage collected by Pantsd, and users may also use ",(0,t.jsx)(i.code,{children:"--no-process-execution-local-cache"})," or manually delete ",(0,t.jsx)(i.code,{children:"~/.cache/pants/lmdb_store"}),"."]}),"\n",(0,t.jsxs)(i.p,{children:["Pants will also memoize in-memory the evaluation of all ",(0,t.jsx)(i.code,{children:"@rule"}),"s. This means that once a rule runs, if the inputs are identical to a prior run, the cache will be used instead of re-evaluating the rule. If the user uses Pantsd (the Pants daemon), this memoization will persist across distinct Pants runs, until the daemon is shut down or restarted. This memoization happens automatically."]}),"\n",(0,t.jsx)(i.h2,{id:"debugging-look-inside-the-chroot",children:"Debugging: Look inside the chroot"}),"\n",(0,t.jsxs)(i.p,{children:["When Pants runs most processes, it runs in a ",(0,t.jsx)(i.code,{children:"chroot"})," (temporary directory). Usually, this gets cleaned up after the ",(0,t.jsx)(i.code,{children:"Process"})," finishes. You can instead run ",(0,t.jsx)(i.code,{children:"./pants --no-process-execution-local-cleanup"}),", which will keep around the folder."]}),"\n",(0,t.jsx)(i.p,{children:"Pants will log the path to the chroot, e.g.:"}),"\n",(0,t.jsx)(i.pre,{children:(0,t.jsx)(i.code,{children:'\u25B6 ./pants --no-process-execution-local-cleanup test src/python/pants/util/strutil_test.py\n...\n12:29:45.08 [INFO] preserving local process execution dir `"/private/var/folders/sx/pdpbqz4x5cscn9hhfpbsbqvm0000gn/T/process-executionN9Kdk0"` for "Test binary /Users/pantsbuild/.pyenv/shims/python3."\n...\n'})}),"\n",(0,t.jsxs)(i.p,{children:["Inside the preserved sandbox there will be a ",(0,t.jsx)(i.code,{children:"__run.sh"})," script which can be used to inspect or re-run the ",(0,t.jsx)(i.code,{children:"Process"})," precisely as Pants did when creating the sandbox."]}),"\n",(0,t.jsx)(i.h2,{id:"debugging-visualize-the-rule-graph",children:"Debugging: Visualize the rule graph"}),"\n",(0,t.jsxs)(i.p,{children:["You can create a visual representation of the rule graph through the option ",(0,t.jsx)(i.code,{children:"--native-engine-visualize-to=$dir_path $goal"}),". This will create the files ",(0,t.jsx)(i.code,{children:"rule_graph.dot"}),", ",(0,t.jsx)(i.code,{children:"rule_graph.$goal.dot"}),", and ",(0,t.jsx)(i.code,{children:"graph.000.dot"}),", which are ",(0,t.jsxs)(i.a,{href:"https://en.wikipedia.org/wiki/DOT_%28graph_description_language%29",children:[(0,t.jsx)(i.code,{children:".dot"})," files"]}),". ",(0,t.jsx)(i.code,{children:"rule_graph.$goal.dot"})," contains only the rules used during your run, ",(0,t.jsx)(i.code,{children:"rule_graph.dot"})," contains all rules, and ",(0,t.jsx)(i.code,{children:"graph.000.dot"})," contains the actual runtime results of all rules (it can be quite large!)."]}),"\n",(0,t.jsxs)(i.p,{children:["To open up the ",(0,t.jsx)(i.code,{children:".dot"})," file, you can install the ",(0,t.jsx)(i.a,{href:"https://graphviz.org",children:(0,t.jsx)(i.code,{children:"graphviz"})})," program, then run ",(0,t.jsx)(i.code,{children:"dot -Tpdf -O $destination"}),". We recommend opening up the PDF in Google Chrome or OSX Preview, which do a good job of zooming in large PDF files."]})]})}function u(e={}){let{wrapper:i}={...(0,r.R)(),...e.components};return i?(0,t.jsx)(i,{...e,children:(0,t.jsx)(c,{...e})}):c(e)}},848193(e,i,n){n.d(i,{R:()=>o,x:()=>l});var s=n(830758);let t={},r=s.createContext(t);function o(e){let i=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function l(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),s.createElement(r.Provider,{value:i},e.children)}},480410(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-rules-api/tips-and-debugging","title":"Tips and debugging","description":"---","source":"@site/versioned_docs/version-2.7/docs/writing-plugins/the-rules-api/tips-and-debugging.mdx","sourceDirName":"docs/writing-plugins/the-rules-api","slug":"/docs/writing-plugins/the-rules-api/tips-and-debugging","permalink":"/2.7/docs/writing-plugins/the-rules-api/tips-and-debugging","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-rules-api/tips-and-debugging.mdx","tags":[],"version":"2.7","sidebarPosition":10,"frontMatter":{"title":"Tips and debugging","sidebar_position":10},"sidebar":"docsSidebar","previous":{"title":"Testing plugins","permalink":"/2.7/docs/writing-plugins/the-rules-api/testing-plugins"},"next":{"title":"Common plugin tasks","permalink":"/2.7/docs/writing-plugins/common-plugin-tasks/"}}')}}]);