"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["87632"],{164113(e,s,n){n.r(s),n.d(s,{assets:()=>l,contentTitle:()=>c,default:()=>h,frontMatter:()=>o,metadata:()=>r,toc:()=>d});var r=n(679006),i=n(886070),t=n(848193);let o={title:"Processes",sidebar_position:4},c,l={},d=[{value:"<code>Process</code>",id:"process",level:2},{value:"Overview",id:"overview",level:3},{value:"Input Files",id:"input-files",level:3},{value:"Environment Variables",id:"environment-variables",level:3},{value:"Output Files",id:"output-files",level:3},{value:"Timeouts",id:"timeouts",level:3},{value:"FallibleProcessResult",id:"fallibleprocessresult",level:3},{value:"<code>InteractiveProcess</code>",id:"interactiveprocess",level:2}];function a(e){let s={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(s.p,{children:"How to safely run subprocesses in your plugin."}),"\n",(0,i.jsx)(s.hr,{}),"\n",(0,i.jsxs)(s.p,{children:["It is not safe to use ",(0,i.jsx)(s.code,{children:"subprocess.run()"})," like you normally would because this can break caching and will not leverage Pants's parallelism. Instead, Pants has safe alternatives with ",(0,i.jsx)(s.code,{children:"Process"})," and ",(0,i.jsx)(s.code,{children:"InteractiveProcess"}),"."]}),"\n",(0,i.jsx)(s.h2,{id:"process",children:(0,i.jsx)(s.code,{children:"Process"})}),"\n",(0,i.jsx)(s.h3,{id:"overview",children:"Overview"}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.code,{children:"Process"})," is similar to ",(0,i.jsx)(s.code,{children:"subprocess.Popen()"}),". The process will run in the background, and you can run multiple processes in parallel."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'from pants.engine.process import Process, ProcessResult\nfrom pants.engine.rules import Get, rule\n\n@rule\nasync def demo(...) -> Foo:\n    result = await Get(\n        ProcessResult,\n        Process(\n            argv=["/bin/echo", "hello world"],\n            description="Demonstrate processes.",\n        )\n    )\n    logger.info(result.stdout.decode())\n    logger.info(result.stderr.decode())\n'})}),"\n",(0,i.jsxs)(s.p,{children:["This will return a ",(0,i.jsx)(s.code,{children:"ProcessResult"})," object, which has the fields ",(0,i.jsx)(s.code,{children:"stdout: bytes"}),", ",(0,i.jsx)(s.code,{children:"stderr: bytes"}),", and ",(0,i.jsx)(s.code,{children:"output_digest: Digest"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["The process will run in a temporary directory and is hermetic, meaning that it cannot read any arbitrary file from your project and that it will be stripped of environment variables. This sandbox is important for reproducibility and to allow running your ",(0,i.jsx)(s.code,{children:"Process"})," anywhere, such as through remote execution."]}),"\n",(0,i.jsxs)(s.admonition,{type:"note",children:[(0,i.jsxs)(s.mdxAdmonitionTitle,{children:["Debugging a ",(0,i.jsx)(s.code,{children:"Process"})]}),(0,i.jsxs)(s.p,{children:["Setting the ",(0,i.jsx)(s.a,{href:"docs:rules-api-tips#debugging-look-inside-the-chroot",children:(0,i.jsx)(s.code,{children:"--no-process-execution-cleanup-local-dirs"})})," flag will cause the sandboxes of ",(0,i.jsx)(s.code,{children:"Process"}),"es to be preserved and logged to the console for inspection."]}),(0,i.jsxs)(s.p,{children:["It can be very helpful while editing ",(0,i.jsx)(s.code,{children:"Process"})," definitions!"]})]}),"\n",(0,i.jsx)(s.h3,{id:"input-files",children:"Input Files"}),"\n",(0,i.jsxs)(s.p,{children:["To populate the temporary directory with files, use the parameter ",(0,i.jsx)(s.code,{children:"input_digest: Digest"}),". It's common to use ",(0,i.jsx)(s.a,{href:"docs:rules-api-file-system",children:(0,i.jsx)(s.code,{children:"MergeDigests"})})," to combine multiple ",(0,i.jsx)(s.code,{children:"Digest"}),"s into one single ",(0,i.jsx)(s.code,{children:"input_digest"}),"."]}),"\n",(0,i.jsx)(s.h3,{id:"environment-variables",children:"Environment Variables"}),"\n",(0,i.jsxs)(s.p,{children:["To set environment variables, use the parameter ",(0,i.jsx)(s.code,{children:"env: Mapping[str, str]"}),". ",(0,i.jsx)(s.code,{children:"@rules"})," are prevented from accessing ",(0,i.jsx)(s.code,{children:"os.environ"})," (it will always be empty) because this reduces reproducibility and breaks caching. Instead, either hardcode the value or add a ",(0,i.jsxs)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/options-and-subsystems",children:[(0,i.jsx)(s.code,{children:"Subsystem"})," option"]})," for the environment variable in question, or request the ",(0,i.jsx)(s.code,{children:"Environment"})," or ",(0,i.jsx)(s.code,{children:"CompleteEnvironment"})," types in your ",(0,i.jsx)(s.code,{children:"@rule"}),"."]}),"\n",(0,i.jsxs)(s.p,{children:["The ",(0,i.jsx)(s.code,{children:"Environment"})," type contains a subset of the environment that Pants was run in, and is requested via a ",(0,i.jsx)(s.code,{children:"EnvironmentRequest"})," that lists the variables to consume. The ",(0,i.jsx)(s.code,{children:"CompleteEnvironment"})," type contains the full environment of the Pants run. The vast majority of the time, ",(0,i.jsx)(s.code,{children:"@rule"}),"s should prefer to use ",(0,i.jsx)(s.code,{children:"Environment"}),", to avoid re-running for every environment change."]}),"\n",(0,i.jsxs)(s.p,{children:["Requesting an ",(0,i.jsx)(s.code,{children:"Environment"})," subset:"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'from pants.engine.environment import Environment, EnvironmentRequest\nfrom pants.engine.rules import Get, rule\n\n@rule\nasync def partial_env(...) -> Foo:\n    relevant_env = await Get(Environment, EnvironmentRequest(["RELEVANT_VAR", "PATH"]))\n    ..\n'})}),"\n",(0,i.jsxs)(s.p,{children:["Requesting the ",(0,i.jsx)(s.code,{children:"CompleteEnvironment"}),":"]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:"from pants.engine.environment import CompleteEnvironment\nfrom pants.engine.rules import rule\n\n@rule\nasync def complete_env(env: CompleteEnvironment) -> Foo:\n    ...\n"})}),"\n",(0,i.jsx)(s.h3,{id:"output-files",children:"Output Files"}),"\n",(0,i.jsxs)(s.p,{children:["To capture output files from the process, set ",(0,i.jsx)(s.code,{children:"output_files: Iterable[str]"})," and/or ",(0,i.jsx)(s.code,{children:"output_directories: Iterable[str]"}),". Then, you can use the ",(0,i.jsx)(s.code,{children:"ProcessResult.output_digest"})," field to get a ",(0,i.jsx)(s.a,{href:"docs:rules-api-file-system",children:(0,i.jsx)(s.code,{children:"Digest"})})," of the result."]}),"\n",(0,i.jsx)(s.h3,{id:"timeouts",children:"Timeouts"}),"\n",(0,i.jsxs)(s.p,{children:["To use a timeout, set the ",(0,i.jsx)(s.code,{children:"timeout_fields: int"})," field. Otherwise, the process will never time out, unless the user cancels Pants."]}),"\n",(0,i.jsxs)(s.admonition,{type:"note",children:[(0,i.jsxs)(s.mdxAdmonitionTitle,{children:[(0,i.jsx)(s.code,{children:"Process"})," caching"]}),(0,i.jsxs)(s.p,{children:["By default, a ",(0,i.jsx)(s.code,{children:"Process"})," will be cached to ",(0,i.jsx)(s.code,{children:"~/.cache/pants/lmdb_store"})," if the ",(0,i.jsx)(s.code,{children:"exit_code"})," is ",(0,i.jsx)(s.code,{children:"0"}),"."]}),(0,i.jsxs)(s.p,{children:["If it not safe to cache your ",(0,i.jsx)(s.code,{children:"Process"}),"\u2014usually the case when you know that a process accesses files outside of its sandbox\u2014you can change the cacheability of your ",(0,i.jsx)(s.code,{children:"Process"})," using the ",(0,i.jsx)(s.code,{children:"ProcessCacheScope"})," parameter:"]}),(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'from pants.engine.process import Process, ProcessCacheScope, ProcessResult\n\n@rule\nasync def demo(...) -> Foo:\n    process = Process(\n        argv=["/bin/echo", "hello world"],\n        description="Never cached.",\n        cache_scope=ProcessCacheScope.NEVER,\n    )\n    ..\n'})}),(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.code,{children:"ProcessCacheScope"})," supports other options as well, including ",(0,i.jsx)(s.code,{children:"PER_RESTART"}),"."]})]}),"\n",(0,i.jsx)(s.h3,{id:"fallibleprocessresult",children:"FallibleProcessResult"}),"\n",(0,i.jsxs)(s.p,{children:["Normally, a ",(0,i.jsx)(s.code,{children:"ProcessResult"})," will raise an exception if the return code is not ",(0,i.jsx)(s.code,{children:"0"}),". Instead, a ",(0,i.jsx)(s.code,{children:"FallibleProcessResult"})," allows for any return code."]}),"\n",(0,i.jsxs)(s.p,{children:["Use ",(0,i.jsx)(s.code,{children:"Get(FallibleProcessResult, Process)"})," if you expect that the process may fail, such as when running a linter or tests."]}),"\n",(0,i.jsxs)(s.p,{children:["Like ",(0,i.jsx)(s.code,{children:"ProcessResult"}),", ",(0,i.jsx)(s.code,{children:"FallibleProcessResult"})," has the attributes ",(0,i.jsx)(s.code,{children:"stdout: bytes"}),", ",(0,i.jsx)(s.code,{children:"stderr: bytes"}),", and ",(0,i.jsx)(s.code,{children:"output_digest: Digest"}),", and it adds ",(0,i.jsx)(s.code,{children:"exit_code: int"}),"."]}),"\n",(0,i.jsx)(s.h2,{id:"interactiveprocess",children:(0,i.jsx)(s.code,{children:"InteractiveProcess"})}),"\n",(0,i.jsxs)(s.p,{children:[(0,i.jsx)(s.code,{children:"InteractiveProcess"})," is similar to ",(0,i.jsx)(s.code,{children:"subprocess.run()"}),". The process will run in the foreground and it is blocking."]}),"\n",(0,i.jsxs)(s.p,{children:["Because the process is blocking, you may only run an ",(0,i.jsx)(s.code,{children:"InteractiveProcess"})," in an ",(0,i.jsx)(s.a,{href:"/2.7/docs/writing-plugins/the-rules-api/goal-rules",children:(0,i.jsx)(s.code,{children:"@goal_rule"})}),". Your ",(0,i.jsx)(s.code,{children:"@goal_rule"})," must request ",(0,i.jsx)(s.code,{children:"InteractiveRunner"}),", and then use its method ",(0,i.jsx)(s.code,{children:".run()"}),". Typically, you should only use ",(0,i.jsx)(s.code,{children:"InteractiveProcess"})," for things that may require user input, such as running a REPL."]}),"\n",(0,i.jsx)(s.pre,{children:(0,i.jsx)(s.code,{className:"language-python",children:'from pants.engine.rules import goal_rule\nfrom pants.engine.process import InteractiveRunner, InteractiveProcess\n\n@goal_rule\nasync def hello_world(interactive_runner: InteractiveRunner) -> HelloWorld:\n    # This demonstrates opening a Python REPL.\n    result = interactive_runner.run(\n        InteractiveProcess(argv=["/usr/bin/python"])\n    )\n    return HelloWorld(exit_code=result.exit_code)\n'})}),"\n",(0,i.jsxs)(s.p,{children:["You may either set the parameter ",(0,i.jsx)(s.code,{children:"input_digest: Digest"}),", or you may set ",(0,i.jsx)(s.code,{children:"run_in_workspace=True"}),". When running in the workspace, you will have access to any file in the build root."]}),"\n",(0,i.jsxs)(s.p,{children:["To set environment variables, use the parameter ",(0,i.jsx)(s.code,{children:"env: Mapping[str, str]"}),", like you would with ",(0,i.jsx)(s.code,{children:"Process"}),". You can also set ",(0,i.jsx)(s.code,{children:"hermetic_env=False"})," to inherit the environment variables from the parent ",(0,i.jsx)(s.code,{children:"./pants"})," process."]}),"\n",(0,i.jsxs)(s.p,{children:["The method will return an ",(0,i.jsx)(s.code,{children:"InteractiveProcessResult"}),", which has a single field ",(0,i.jsx)(s.code,{children:"exit_code: int"}),"."]})]})}function h(e={}){let{wrapper:s}={...(0,t.R)(),...e.components};return s?(0,i.jsx)(s,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},848193(e,s,n){n.d(s,{R:()=>o,x:()=>c});var r=n(830758);let i={},t=r.createContext(i);function o(e){let s=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function c(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(t.Provider,{value:s},e.children)}},679006(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-rules-api/processes","title":"Processes","description":"How to safely run subprocesses in your plugin.","source":"@site/versioned_docs/version-2.7/docs/writing-plugins/the-rules-api/processes.mdx","sourceDirName":"docs/writing-plugins/the-rules-api","slug":"/docs/writing-plugins/the-rules-api/processes","permalink":"/2.7/docs/writing-plugins/the-rules-api/processes","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-rules-api/processes.mdx","tags":[],"version":"2.7","sidebarPosition":4,"frontMatter":{"title":"Processes","sidebar_position":4},"sidebar":"docsSidebar","previous":{"title":"File system","permalink":"/2.7/docs/writing-plugins/the-rules-api/file-system"},"next":{"title":"Installing tools","permalink":"/2.7/docs/writing-plugins/the-rules-api/installing-tools"}}')}}]);