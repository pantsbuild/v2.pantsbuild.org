"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["166498"],{786873(e,n,t){t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>l,default:()=>d,frontMatter:()=>o,metadata:()=>s,toc:()=>c});var s=t(618991),i=t(886070),r=t(848193);let o={title:"Union rules (advanced)",sidebar_position:7},l,a={},c=[{value:"How to create a new Union",id:"how-to-create-a-new-union",level:2}];function u(e){let n={a:"a",code:"code",h2:"h2",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.p,{children:"Polymorphism for the engine."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.p,{children:"Union rules solve the same problem that polymorphism solves in general: how to write generic code that operates on types not known about at the time of writing."}),"\n",(0,i.jsxs)(n.p,{children:["For example, Pants has many generic goals like ",(0,i.jsx)(n.code,{children:"lint"})," and ",(0,i.jsx)(n.code,{children:"test"}),". Those ",(0,i.jsx)(n.code,{children:"@goal_rule"})," definitions cannot know about every concrete linter or test implementation ahead of time."]}),"\n",(0,i.jsx)(n.p,{children:"The solution involves two related declarations:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["A registration mechanism, ",(0,i.jsx)(n.code,{children:"UnionRule"}),", that declares a specific class to be a member of a generic union."]}),"\n",(0,i.jsxs)(n.li,{children:["A ",(0,i.jsx)(n.code,{children:"polymorphic"})," keyword on the ",(0,i.jsx)(n.code,{children:"@rule"})," decorator, that tells the engine that calls to the rule should be dispatched to some other rule based on the runtime type of the union member provided."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"This is best understood via example:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="pants/core/goals/lint.py"',children:'from dataclasses import dataclass\nfrom pants.engine.rules import concurrently, goal_rule, rule\nfrom pants.engine.target import Targets\nfrom pants.engine.unions import UnionMembership\n\n\n@union\nclass LintTargetsRequest(ABC):\n    # The union base for all specific linters.\n    # Can have fields common to all linter requests here.\n    ...\n\n\n@dataclass(frozen=True)\nclass LintResults:\n    ...\n\n\n@rule(polymorphic=True)\nasync def lint_target(req: LintTargetsRequest) -> LintResults:\n    # If no implementation for the member type is found, this generic\n    # implementation will be invoked. In this case that is not useful,\n    # so we raise.\n    raise NotImplementedError(f"Must be implemented for {type(req)}")\n\n\n@goal_rule\nasync def lint(targets: Targets, union_membership: UnionMembership) -> Lint:\n    lint_request_types = union_membership[LintTargetsRequest]\n    concrete_requests = [\n        request_type(\n            request_type.field_set_type.create(target)\n            for target in targets\n            if request_type.field_set_type.is_valid(target)\n        )\n        for request_type in lint_request_types\n    ]\n    results = await concurrently(\n        lint_target(**implicitly({concrete_request: LintTargetsRequest}))\n        for concrete_request in concrete_requests\n    )\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/bash/shellcheck.py"',children:"from pants.core.goals.lint import LintResults, LintTargetsRequest\nfrom pants.engine.rules import collect_rules, rule\n\n\n# It is common for the union member to also subclass the union base.\n# It's not strictly required, but it may be in the future, so it is\n# good practice today.\nclass ShellcheckRequest(LintTargetsRequest):\n    ...\n\n\n@rule\nasync def shellcheck_target(req: ShellcheckRequest) -> LintResults:\n    # At runtime, calls to the generic `lint_target()` on a\n    # `ShellcheckRequest` will be dispatched here.\n    ...\n\n\ndef rules():\n    return [\n        *collect_rules(),\n        UnionRule(LintTargetsRequest, ShellcheckRequest),\n    ]\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This example will find all registered linter implementations by looking up ",(0,i.jsx)(n.code,{children:"union_membership[LintTargetsRequest]"}),", which returns a tuple of all ",(0,i.jsx)(n.code,{children:"LintTargetsRequest"})," members that were registered with a ",(0,i.jsx)(n.code,{children:"UnionRule"}),", such as ",(0,i.jsx)(n.code,{children:"ShellcheckRequest"})," or ",(0,i.jsx)(n.code,{children:"Flake8Request"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"how-to-create-a-new-union",children:"How to create a new Union"}),"\n",(0,i.jsxs)(n.p,{children:["To set up a new union, create a class for the union base. Typically, this should be an ",(0,i.jsx)(n.a,{href:"https://docs.python.org/3/library/abc.html",children:"abstract class"})," that is subclassed by the union members. Mark the class with ",(0,i.jsx)(n.code,{children:"@union"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from abc import ABC, abstractmethod\n\nfrom pants.engine.unions import UnionRule, union\n\n\n@union\nclass Vehicle(ABC):\n   @abstractmethod\n   def num_wheels(self) -> int:\n        pass\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then, register every implementation of your union with ",(0,i.jsx)(n.code,{children:"UnionRule"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"class Truck(Vehicle):\n    def num_wheels(self) -> int:\n        return 4\n\n\ndef rules():\n    return [UnionRule(Vehicle, Truck)]\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Now, your rules can request ",(0,i.jsx)(n.code,{children:"UnionMembership"})," as a parameter in the ",(0,i.jsx)(n.code,{children:"@rule"}),", and then look up ",(0,i.jsx)(n.code,{children:"union_membership[Vehicle]"})," to get a tuple of all relevant types that are registered via ",(0,i.jsx)(n.code,{children:"UnionRule"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"There are many instructive examples of Union use in the Pants codebase."}),"\n",(0,i.jsx)(n.p,{children:"We hope to simplify this mechanism in the future to rely more heavily on Python subclassing, instead of the Pants-specific boilerplate currently required. This is why we strongly recommend making your union members subclasses of the union base."})]})}function d(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(u,{...e})}):u(e)}},848193(e,n,t){t.d(n,{R:()=>o,x:()=>l});var s=t(830758);let i={},r=s.createContext(i);function o(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},618991(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-rules-api/union-rules-advanced","title":"Union rules (advanced)","description":"Polymorphism for the engine.","source":"@site/docs/docs/writing-plugins/the-rules-api/union-rules-advanced.mdx","sourceDirName":"docs/writing-plugins/the-rules-api","slug":"/docs/writing-plugins/the-rules-api/union-rules-advanced","permalink":"/dev/docs/writing-plugins/the-rules-api/union-rules-advanced","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-rules-api/union-rules-advanced.mdx","tags":[],"version":"current","sidebarPosition":7,"frontMatter":{"title":"Union rules (advanced)","sidebar_position":7},"sidebar":"docsSidebar","previous":{"title":"Rules and the Target API","permalink":"/dev/docs/writing-plugins/the-rules-api/rules-and-the-target-api"},"next":{"title":"Logging and dynamic output","permalink":"/dev/docs/writing-plugins/the-rules-api/logging-and-dynamic-output"}}')}}]);