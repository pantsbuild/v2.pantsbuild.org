"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["909458"],{261809(e,o,n){n.r(o),n.d(o,{assets:()=>d,contentTitle:()=>a,default:()=>p,frontMatter:()=>i,metadata:()=>t,toc:()=>c});var t=n(360017),r=n(886070),s=n(848193);let i={title:"Protobuf",sidebar_position:0},a,d={},c=[{value:"Step 1: Activate the Protobuf Go backend",id:"step-1-activate-the-protobuf-go-backend",level:2},{value:"Step 2: Set up your <code>go.mod</code> and <code>go.sum</code>",id:"step-2-set-up-your-gomod-and-gosum",level:2},{value:"Step 3: Add <code>option go_package</code> to <code>.proto</code> files",id:"step-3-add-option-go_package-to-proto-files",level:2},{value:"Step 4: Generate <code>protobuf_sources</code> targets",id:"step-4-generate-protobuf_sources-targets",level:2},{value:"Step 5: Confirm Go imports are working",id:"step-5-confirm-go-imports-are-working",level:2},{value:"Buf: format and lint Protobuf",id:"buf-format-and-lint-protobuf",level:2}];function l(e){let o={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(o.p,{children:"How to generate Go from Protocol Buffers."}),"\n",(0,r.jsx)(o.hr,{}),"\n",(0,r.jsx)(o.p,{children:"When your Go code imports Protobuf generated files, Pants will detect the imports and run the Protoc compiler to generate then compile those files."}),"\n",(0,r.jsx)(o.admonition,{title:"Example repository",type:"note",children:(0,r.jsxs)(o.p,{children:["See ",(0,r.jsx)(o.a,{href:"https://github.com/pantsbuild/example-codegen",children:"the codegen example repository"})," for an example of using Protobuf to generate Go."]})}),"\n",(0,r.jsxs)(o.admonition,{title:"Benefit of Pants: generated files are always up-to-date",type:"tip",children:[(0,r.jsx)(o.p,{children:"With Pants, there's no need to manually regenerate your code or check it into version control. Pants will ensure you are always using up-to-date files in your builds."}),(0,r.jsx)(o.p,{children:"Thanks to fine-grained caching, Pants will regenerate the minimum amount of code required when you do make changes."})]}),"\n",(0,r.jsxs)(o.admonition,{type:"caution",children:[(0,r.jsxs)(o.mdxAdmonitionTitle,{children:[(0,r.jsx)(o.code,{children:"go mod tidy"})," will complain about missing modules"]}),(0,r.jsxs)(o.p,{children:["Because Pants does not save generated code to disk, ",(0,r.jsx)(o.code,{children:"go mod tidy"})," will error that it cannot find the generated packages."]}),(0,r.jsxs)(o.p,{children:["One workaround is to run ",(0,r.jsx)(o.code,{children:"./pants export-codegen ::"})," to save the generated files."]})]}),"\n",(0,r.jsx)(o.h2,{id:"step-1-activate-the-protobuf-go-backend",children:"Step 1: Activate the Protobuf Go backend"}),"\n",(0,r.jsxs)(o.p,{children:["Add this to your ",(0,r.jsx)(o.code,{children:"pants.toml"}),":"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = [\n  "pants.backend.experimental.codegen.protobuf.go",\n  "pants.backend.experimental.go",\n]\n'})}),"\n",(0,r.jsxs)(o.p,{children:["This adds the new ",(0,r.jsx)(o.a,{href:"/2.12/reference/targets/protobuf_source",children:(0,r.jsx)(o.code,{children:"protobuf_source"})})," target, which you can confirm by running ",(0,r.jsx)(o.code,{children:"./pants help protobuf_source"}),"."]}),"\n",(0,r.jsxs)(o.p,{children:["To reduce boilerplate, you can also use the ",(0,r.jsx)(o.a,{href:"/2.12/reference/targets/protobuf_sources",children:(0,r.jsx)(o.code,{children:"protobuf_sources"})})," target, which generates one ",(0,r.jsx)(o.code,{children:"protobuf_source"})," target per file in the ",(0,r.jsx)(o.code,{children:"sources"})," field."]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-python",metastring:'title="BUILD"',children:'protobuf_sources(name="protos", sources=["user.proto", "admin.proto"])\n\n# Spiritually equivalent to:\nprotobuf_source(name="user", source="user.proto")\nprotobuf_source(name="admin", source="admin.proto")\n\n# Thanks to the default `sources` value of \'*.proto\', spiritually equivalent to:\nprotobuf_sources(name="protos")\n'})}),"\n",(0,r.jsxs)(o.h2,{id:"step-2-set-up-your-gomod-and-gosum",children:["Step 2: Set up your ",(0,r.jsx)(o.code,{children:"go.mod"})," and ",(0,r.jsx)(o.code,{children:"go.sum"})]}),"\n",(0,r.jsxs)(o.p,{children:["The generated Go code requires ",(0,r.jsx)(o.code,{children:"google.golang.org/protobuf"})," to compile. Add it to your ",(0,r.jsx)(o.code,{children:"go.mod"})," with the version you'd like. Then run ",(0,r.jsx)(o.code,{children:"go mod download all"})," to update your ",(0,r.jsx)(o.code,{children:"go.sum"}),"."]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-text",metastring:'title="go.mod"',children:"require google.golang.org/protobuf v1.27.1\n"})}),"\n",(0,r.jsxs)(o.h2,{id:"step-3-add-option-go_package-to-proto-files",children:["Step 3: Add ",(0,r.jsx)(o.code,{children:"option go_package"})," to ",(0,r.jsx)(o.code,{children:".proto"})," files"]}),"\n",(0,r.jsxs)(o.p,{children:["Every Protobuf file that should work with Go must set ",(0,r.jsx)(o.code,{children:"option go_package"})," with the name of its Go package. For example:"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-text",metastring:'title="src/protos/example/v1/person.proto"',children:'syntax = "proto3";\n\npackage simple_example.v1;\n\noption go_package = "github.com/pantsbuild/example-codegen/gen";\n'})}),"\n",(0,r.jsxs)(o.p,{children:["Multiple Protobuf files can set the same ",(0,r.jsx)(o.code,{children:"go_package"})," if their code should show up in the same package."]}),"\n",(0,r.jsxs)(o.h2,{id:"step-4-generate-protobuf_sources-targets",children:["Step 4: Generate ",(0,r.jsx)(o.code,{children:"protobuf_sources"})," targets"]}),"\n",(0,r.jsxs)(o.p,{children:["Run ",(0,r.jsx)(o.a,{href:"/2.12/docs/getting-started/initial-configuration#5-generate-build-files",children:(0,r.jsx)(o.code,{children:"./pants tailor"})})," for Pants to create a ",(0,r.jsx)(o.code,{children:"protobuf_sources"})," target wherever you have ",(0,r.jsx)(o.code,{children:".proto"})," files:"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{children:"$ ./pants tailor\nCreated src/protos/BUILD:\n  - Add protobuf_sources target protos\n"})}),"\n",(0,r.jsxs)(o.p,{children:["Pants will use ",(0,r.jsx)(o.a,{href:"/2.12/docs/using-pants/key-concepts/targets-and-build-files",children:"dependency inference"})," for any ",(0,r.jsx)(o.code,{children:"import"})," statements in your ",(0,r.jsx)(o.code,{children:".proto"})," files, which you can confirm by running ",(0,r.jsx)(o.code,{children:"./pants dependencies path/to/file.proto"}),"."]}),"\n",(0,r.jsxs)(o.p,{children:["If you want gRPC code generated for all files in the folder, set ",(0,r.jsx)(o.code,{children:"grpc=True"}),"."]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-python",metastring:'title="src/proto/example/BUILD"',children:'protobuf_sources(\n    name="protos",\n    grpc=True,\n)\n'})}),"\n",(0,r.jsxs)(o.p,{children:["If you only want gRPC generated for some files in the folder, you can use the ",(0,r.jsx)(o.code,{children:"overrides"})," field:"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-python",metastring:'title="src/proto/example/BUILD"',children:'protobuf_sources(\n    name="protos",\n    overrides={\n        "admin.proto": {"grpc": True},\n        # You can also use a tuple for multiple files.\n        ("user.proto", "org.proto"): {"grpc": True},\n    },\n)\n'})}),"\n",(0,r.jsx)(o.h2,{id:"step-5-confirm-go-imports-are-working",children:"Step 5: Confirm Go imports are working"}),"\n",(0,r.jsxs)(o.p,{children:["Now, you can import the generated Go package in your Go code like normal, using whatever you set with ",(0,r.jsx)(o.code,{children:"option go_package"})," from Step 3."]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-go",metastring:'title="src/go/examples/proto_test.go"',children:'package examples\n\nimport "testing"\nimport "github.com/pantsbuild/example-codegen/gen"\n\nfunc TestGenerateUuid(t *testing.T) {\n	person := gen.Person{\n		Name:  "Thomas the Train",\n		Id:    1,\n		Email: "allaboard@trains.build",\n	}\n	if person.Name != "Thomas the Train" {\n		t.Fail()\n	}\n}\n'})}),"\n",(0,r.jsxs)(o.p,{children:["Pants's dependency inference will detect Go imports of Protobuf packages, which you can confirm by running ",(0,r.jsx)(o.code,{children:"./pants dependencies path/to/file.go"}),". You can also run ",(0,r.jsx)(o.code,{children:"./pants check path/to/file.go"})," to confirm that everything compiles."]}),"\n",(0,r.jsxs)(o.admonition,{type:"note",children:[(0,r.jsxs)(o.mdxAdmonitionTitle,{children:["Run ",(0,r.jsx)(o.code,{children:"./pants export-codegen ::"})," to inspect the files"]}),(0,r.jsxs)(o.p,{children:[(0,r.jsx)(o.code,{children:"./pants export-codegen ::"})," will run all relevant code generators and write the files to ",(0,r.jsx)(o.code,{children:"dist/codegen"})," using the same paths used normally by Pants."]}),(0,r.jsxs)(o.p,{children:["You do not need to run this goal for codegen to work when using Pants; ",(0,r.jsx)(o.code,{children:"export-codegen"})," is only for external consumption outside of Pants, e.g. to get ",(0,r.jsx)(o.code,{children:"go mod tidy"})," working."]})]}),"\n",(0,r.jsx)(o.h2,{id:"buf-format-and-lint-protobuf",children:"Buf: format and lint Protobuf"}),"\n",(0,r.jsxs)(o.p,{children:["Pants integrates with the ",(0,r.jsx)(o.a,{href:"https://buf.build/blog/introducing-buf-format",children:(0,r.jsx)(o.code,{children:"Buf"})})," formatter and linter for Protobuf files."]}),"\n",(0,r.jsxs)(o.p,{children:["To activate, add this to ",(0,r.jsx)(o.code,{children:"pants.toml"}),":"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = [\n  "pants.backend.codegen.protobuf.lint.buf",\n]\n'})}),"\n",(0,r.jsxs)(o.p,{children:["Now you can run ",(0,r.jsx)(o.code,{children:"./pants fmt"})," and ",(0,r.jsx)(o.code,{children:"./pants lint"}),":"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{children:"\u276F ./pants lint src/protos/user.proto\n"})}),"\n",(0,r.jsxs)(o.p,{children:["Use ",(0,r.jsx)(o.code,{children:"./pants fmt lint dir:"})," to run on all files in the directory, and ",(0,r.jsx)(o.code,{children:"./pants fmt lint dir::"})," to run on all files in the directory and subdirectories."]}),"\n",(0,r.jsxs)(o.p,{children:["Temporarily disable Buf with ",(0,r.jsx)(o.code,{children:"--buf-fmt-skip"})," and ",(0,r.jsx)(o.code,{children:"--buf-lint-skip"}),":"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"\u276F ./pants --buf-fmt-skip fmt ::\n"})}),"\n",(0,r.jsxs)(o.p,{children:["Only run Buf with ",(0,r.jsx)(o.code,{children:"--lint-only=buf-fmt"})," or ",(0,r.jsx)(o.code,{children:"--lint-only=buf-lint"}),", and ",(0,r.jsx)(o.code,{children:"--fmt-only=buf-fmt"}),":"]}),"\n",(0,r.jsx)(o.pre,{children:(0,r.jsx)(o.code,{className:"language-bash",children:"\u276F ./pants fmt --only=buf-fmt ::\n"})})]})}function p(e={}){let{wrapper:o}={...(0,s.R)(),...e.components};return o?(0,r.jsx)(o,{...e,children:(0,r.jsx)(l,{...e})}):l(e)}},848193(e,o,n){n.d(o,{R:()=>i,x:()=>a});var t=n(830758);let r={},s=t.createContext(r);function i(e){let o=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(o):{...o,...e}},[o,e])}function a(e){let o;return o=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),t.createElement(s.Provider,{value:o},e.children)}},360017(e){e.exports=JSON.parse('{"id":"docs/go/integrations/protobuf","title":"Protobuf","description":"How to generate Go from Protocol Buffers.","source":"@site/versioned_docs/version-2.12/docs/go/integrations/protobuf.mdx","sourceDirName":"docs/go/integrations","slug":"/docs/go/integrations/protobuf","permalink":"/2.12/docs/go/integrations/protobuf","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/go/integrations/protobuf.mdx","tags":[],"version":"2.12","sidebarPosition":0,"frontMatter":{"title":"Protobuf","sidebar_position":0},"sidebar":"docsSidebar","previous":{"title":"Integrations","permalink":"/2.12/docs/go/integrations/"},"next":{"title":"Java and Scala","permalink":"/2.12/docs/java-and-scala/"}}')}}]);