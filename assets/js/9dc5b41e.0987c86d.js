"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["627981"],{207584(e,n,s){s.r(n),s.d(n,{assets:()=>u,contentTitle:()=>c,default:()=>f,frontMatter:()=>i,metadata:()=>t,toc:()=>d});var t=s(230746),r=s(886070),o=s(848193),l=s(685008),a=s(637180);let i={title:"Add lockfiles",sidebar_position:7},c,u={},d=[{value:"1. Expose your lockfiles to Pants",id:"1-expose-your-lockfiles-to-pants",level:2},{value:"2. Connect resolve names to requests to generate lockfiles",id:"2-connect-resolve-names-to-requests-to-generate-lockfiles",level:2},{value:"3. Generate lockfiles",id:"3-generate-lockfiles",level:2},{value:"4. Register rules",id:"4-register-rules",level:2},{value:"5. Use lockfiles for fetching dependencies",id:"5-use-lockfiles-for-fetching-dependencies",level:2}];function p(e){let n={code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(n.p,{children:["How to add lockfiles and the ",(0,r.jsx)(n.code,{children:"generate-lockfiles"})," goal."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.p,{children:"Lockfiles are a way to pin to exact versions of dependencies, often including hashes to guarantee integrity between the version pinned and the version downloaded."}),"\n",(0,r.jsxs)(n.p,{children:["This guide will walk you through implementing lockfiles and hooking them into the ",(0,r.jsx)(n.code,{children:"generate-lockfiles"})," goal. It assumes that your language has a tool that supports generating and using lockfiles or that you have written code which does these."]}),"\n",(0,r.jsx)(n.h2,{id:"1-expose-your-lockfiles-to-pants",children:"1. Expose your lockfiles to Pants"}),"\n",(0,r.jsxs)(n.p,{children:["Create subclasses of ",(0,r.jsx)(n.code,{children:"KnownUserResolveNamesRequest"})," to inform Pants about which resolves exist, and a subclass of ",(0,r.jsx)(n.code,{children:"RequestedUserResolveNames"})," for Pants to request those resolves later. Implement the resolve-finding logic in a Rule from your subclass of ",(0,r.jsx)(n.code,{children:"KnownUserResolveNamesRequest"})," to ",(0,r.jsx)(n.code,{children:"KnownUserResolveNames"}),". Set ",(0,r.jsx)(n.code,{children:"KnownResolveNames.requested_resolve_names_cls"})," to your subclass of ",(0,r.jsx)(n.code,{children:"RequestedUserResolveNames"}),"."]}),"\n",(0,r.jsx)(l.A,{groupId:"code-examples",children:(0,r.jsx)(a.A,{value:"pants-plugins/fortran/lockfiles.py",label:"pants-plugins/fortran/lockfiles.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label": "pants-plugins/fortran/lockfiles.py"}',children:"from pants.core.goals.generate_lockfiles import KnownUserResolveNamesRequest, RequestedUserResolveNames, KnownUserResolveNames\nfrom pants.engine.rules import rule\nfrom pants.engine.target import AllTargets\n\n\nclass KnownFortranResolveNamesRequest(KnownUserResolveNamesRequest):\n    pass\n\n\nclass RequestedFortranResolveNames(RequestedUserResolveNames):\n    pass\n\n\n@rule\nasync def identify_user_resolves_from_fortran_files(\n        _: KnownFortranResolveNamesRequest,\n        all_targets: AllTargets,\n) -> KnownUserResolveNames:\n    ...\n    return KnownUserResolveNames(\n        ...,\n        requested_resolve_names_cls=RequestedFortranResolveNames\n    )\n"})})})}),"\n",(0,r.jsx)(n.h2,{id:"2-connect-resolve-names-to-requests-to-generate-lockfiles",children:"2. Connect resolve names to requests to generate lockfiles"}),"\n",(0,r.jsxs)(n.p,{children:["Create a subclass of ",(0,r.jsx)(n.code,{children:"GenerateLockfile"}),". Pants will use this to represent a lockfile to generate. Then create a rule from your subclass of ",(0,r.jsx)(n.code,{children:"RequestedUserResolveNames"})," to ",(0,r.jsx)(n.code,{children:"UserGenerateLockfiles"}),". Pants will use this rule to convert from a user's request to export a resolve by name into the information needed to export the resolve."]}),"\n",(0,r.jsx)(l.A,{groupId:"code-examples",children:(0,r.jsx)(a.A,{value:"pants-plugins/fortran/lockfiles.py",label:"pants-plugins/fortran/lockfiles.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label": "pants-plugins/fortran/lockfiles.py"}',children:"from dataclasses import dataclass\n\nfrom pants.backend.fortran.target_types import FortranDeploymentTarget\nfrom pants.core.goals.generate_lockfiles import GenerateLockfile, UserGenerateLockfiles\nfrom pants.engine.rules import rule\n\n\n@dataclass(frozen=True)\nclass GenerateFortranLockfile(GenerateLockfile):\n    target: FortranDeploymentTarget\n\n\n@rule\nasync def setup_user_lockfile_requests(\n        requested: RequestedFortranResolveNames,\n) -> UserGenerateLockfiles:\n    ...\n    return UserGenerateLockfiles(\n        [\n            GenerateFortranLockfile(\n                ...\n            )\n        ]\n    )\n"})})})}),"\n",(0,r.jsx)(n.h2,{id:"3-generate-lockfiles",children:"3. Generate lockfiles"}),"\n",(0,r.jsxs)(n.p,{children:["Create a rule from your subclass of ",(0,r.jsx)(n.code,{children:"GenerateLockfile"})," to ",(0,r.jsx)(n.code,{children:"GenerateLockfileResult"}),". This rule generates the lockfile. In the common case that you're running a process to generate this lockfile, you can use the ",(0,r.jsx)(n.code,{children:"Process.output_files"})," to gather those files from the execution sandbox."]}),"\n",(0,r.jsx)(l.A,{groupId:"code-examples",children:(0,r.jsx)(a.A,{value:"pants-plugins/fortran/lockfiles.py",label:"pants-plugins/fortran/lockfiles.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label": "pants-plugins/fortran/lockfiles.py"}',children:"from pants.backend.fortran.tool import FortranProcess\nfrom pants.core.goals.generate_lockfiles import GenerateLockfileResult\nfrom pants.engine.internals.selectors import Get\nfrom pants.engine.process import ProcessResult\nfrom pants.engine.rules import rule\n\n\n@rule\nasync def generate_lockfile_from_sources(\n        request: GenerateFortranLockfile,\n) -> GenerateLockfileResult:\n    ...\n\n    result = await Get(\n        ProcessResult,\n        FortranProcess(...),\n    )\n\n    return GenerateLockfileResult(result.output_digest, request.resolve_name, request.lockfile_dest)\n\n"})})})}),"\n",(0,r.jsx)(n.h2,{id:"4-register-rules",children:"4. Register rules"}),"\n",(0,r.jsxs)(n.p,{children:["At the bottom of the file, let Pants know what your rules and types do. Update your plugin's ",(0,r.jsx)(n.code,{children:"register.py"})," to tell Pants about them/"]}),"\n",(0,r.jsxs)(l.A,{groupId:"code-examples",children:[(0,r.jsx)(a.A,{value:"pants-plugins/fortran/lockfiles.py",label:"pants-plugins/fortran/lockfiles.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label": "pants-plugins/fortran/lockfiles.py"}',children:"\n\nfrom pants.core.goals.generate_lockfiles import GenerateLockfile, KnownUserResolveNamesRequest, RequestedUserResolveNames\nfrom pants.engine.rules import collect_rules\nfrom pants.engine.unions import UnionRule\n\n\ndef rules():\n    return (\n        *collect_rules(),\n        UnionRule(GenerateLockfile, GenerateFortranLockfile),\n        UnionRule(KnownUserResolveNamesRequest, KnownFortranResolveNamesRequest),\n        UnionRule(RequestedUserResolveNames, RequestedFortranResolveNames),\n    )\n"})})}),(0,r.jsx)(a.A,{value:"pants-plugins/fortran/register.py",label:"pants-plugins/fortran/register.py",children:(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",metastring:'tab={"label": "pants-plugins/fortran/register.py"}',children:"from fortran import lockfiles\n\ndef rules():\n    return [\n        ...,\n        *lockfiles.rules()\n    ]\n"})})})]}),"\n",(0,r.jsx)(n.h2,{id:"5-use-lockfiles-for-fetching-dependencies",children:"5. Use lockfiles for fetching dependencies"}),"\n",(0,r.jsx)(n.p,{children:"If you have a tool that supports lockfiles, the easiest way to get the lockfile to it is to simply use a glob to pull the file into a digest."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-python",children:'from pathlib import Path\n\nfrom pants.engine.fs import PathGlobs\nfrom pants.engine.internals.native_engine import Snapshot\nfrom pants.engine.internals.selectors import Get\nfrom pants.engine.rules import rule\n\n\n@rule\nasync def init_fortran(request: FortranInitRequest) -> FortranInitResponse:\n    ...\n    Get(Snapshot, PathGlobs([(Path(request.root_module.address.spec_path) / ".fortran.lock").as_posix()])),\n'})})]})}function f(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},753348(e,n,s){s.d(n,{A:()=>t});let t={tabItem:"tabItem_mHvh"}},618264(e,n,s){s.d(n,{A:()=>t});let t={tabList:"tabList_sFbf",tabItem:"tabItem_UVfV"}},637180(e,n,s){s.d(n,{A:()=>l});var t=s(886070);s(830758);var r=s(313526),o=s(753348);function l({children:e,hidden:n,className:s}){return(0,t.jsx)("div",{role:"tabpanel",className:(0,r.A)(o.A.tabItem,s),hidden:n,children:e})}},685008(e,n,s){s.d(n,{A:()=>m});var t=s(886070),r=s(830758),o=s(313526),l=s(911212),a=s(274875),i=s(106632),c=s(189223),u=s(618264);function d({className:e,block:n,selectedValue:s,selectValue:r,tabValues:l}){let i=[],{blockElementScrollPositionUntilNextRender:c}=(0,a.a_)(),d=e=>{let n=e.currentTarget,t=l[i.indexOf(n)].value;t!==s&&(c(n),r(t))},p=e=>{let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{let s=i.indexOf(e.currentTarget)+1;n=i[s]??i[0];break}case"ArrowLeft":{let s=i.indexOf(e.currentTarget)-1;n=i[s]??i[i.length-1]}}n?.focus()};return(0,t.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,o.A)("tabs",{"tabs--block":n},e),children:l.map(({value:e,label:n,attributes:r})=>(0,t.jsx)("li",{role:"tab",tabIndex:s===e?0:-1,"aria-selected":s===e,ref:e=>{i.push(e)},onKeyDown:p,onClick:d,...r,className:(0,o.A)("tabs__item",u.A.tabItem,r?.className,{"tabs__item--active":s===e}),children:n??e},e))})}function p({lazy:e,children:n,selectedValue:s}){let l=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){let e=l.find(e=>e.props.value===s);return e?(0,r.cloneElement)(e,{className:(0,o.A)("margin-top--md",e.props.className)}):null}return(0,t.jsx)("div",{className:"margin-top--md",children:l.map((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==s}))})}function f(e){let n=(0,i.u)(e);return(0,t.jsxs)("div",{className:(0,o.A)(l.G.tabs.container,"tabs-container",u.A.tabList),children:[(0,t.jsx)(d,{...n,...e}),(0,t.jsx)(p,{...n,...e})]})}function m(e){let n=(0,c.A)();return(0,t.jsx)(f,{...e,children:(0,i.v)(e.children)},String(n))}},106632(e,n,s){s.d(n,{u:()=>d,v:()=>c});var t=s(830758),r=s(325557),o=s(363717),l=s(125740),a=s(574229),i=s(270367);function c(e){return t.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,t.isValidElement)(e)&&function(e){let{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function u({value:e,tabValues:n}){return n.some(n=>n.value===e)}function d(e){let n,{defaultValue:s,queryString:d=!1,groupId:p}=e,f=function(e){let{values:n,children:s}=e;return(0,t.useMemo)(()=>{let e=n??c(s).map(({props:{value:e,label:n,attributes:s,default:t}})=>({value:e,label:n,attributes:s,default:t})),t=(0,a.XI)(e,(e,n)=>e.value===n.value);if(t.length>0)throw Error(`Docusaurus error: Duplicate values "${t.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[n,s])}(e),[m,h]=(0,t.useState)(()=>(function({defaultValue:e,tabValues:n}){if(0===n.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!u({value:e,tabValues:n}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let s=n.find(e=>e.default)??n[0];if(!s)throw Error("Unexpected error: 0 tabValues");return s.value})({defaultValue:s,tabValues:f})),[g,k]=function({queryString:e=!1,groupId:n}){let s=(0,r.W6)(),o=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(o),(0,t.useCallback)(e=>{if(!o)return;let n=new URLSearchParams(s.location.search);n.set(o,e),s.replace({...s.location,search:n.toString()})},[o,s])]}({queryString:d,groupId:p}),[v,b]=function({groupId:e}){let n=e?`docusaurus.tab.${e}`:null,[s,r]=(0,i.Dv)(n);return[s,(0,t.useCallback)(e=>{n&&r.set(e)},[n,r])]}({groupId:p}),x=u({value:n=g??v,tabValues:f})?n:null;return(0,o.A)(()=>{x&&h(x)},[x]),{selectedValue:m,selectValue:(0,t.useCallback)(e=>{if(!u({value:e,tabValues:f}))throw Error(`Can't select invalid tab value=${e}`);h(e),k(e),b(e)},[k,b,f]),tabValues:f}}},848193(e,n,s){s.d(n,{R:()=>l,x:()=>a});var t=s(830758);let r={},o=t.createContext(r);function l(e){let n=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),t.createElement(o.Provider,{value:n},e.children)}},230746(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/plugin-lockfiles","title":"Add lockfiles","description":"How to add lockfiles and the generate-lockfiles goal.","source":"@site/versioned_docs/version-2.25/docs/writing-plugins/common-plugin-tasks/plugin-lockfiles.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/plugin-lockfiles","permalink":"/2.25/docs/writing-plugins/common-plugin-tasks/plugin-lockfiles","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/plugin-lockfiles.mdx","tags":[],"version":"2.25","sidebarPosition":7,"frontMatter":{"title":"Add lockfiles","sidebar_position":7},"sidebar":"docsSidebar","previous":{"title":"Run tests","permalink":"/2.25/docs/writing-plugins/common-plugin-tasks/run-tests"},"next":{"title":"Custom `python_artifact()` kwargs","permalink":"/2.25/docs/writing-plugins/common-plugin-tasks/custom-python-artifact-kwargs"}}')}}]);