"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["362113"],{344244(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>p,frontMatter:()=>o,metadata:()=>s,toc:()=>d});var s=t(522205),i=t(886070),r=t(848193);let o={title:"Custom `python_artifact()` kwargs",sidebar_position:9},a,l={},d=[];function c(e){let n={a:"a",admonition:"admonition",code:"code",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["How to add your own logic to ",(0,i.jsx)(n.code,{children:"python_artifact()"}),"."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["Pants can build ",(0,i.jsx)(n.a,{href:"/2.24/docs/python/overview/building-distributions",children:"Python distributions"}),", such as wheels and sdists, from information you provide in a ",(0,i.jsx)(n.a,{href:"/2.24/reference/targets/python_distribution",children:(0,i.jsx)(n.code,{children:"python_distribution"})})," target."]}),"\n",(0,i.jsxs)(n.p,{children:["When doing so, and if you don't provide your own ",(0,i.jsx)(n.code,{children:"setup.py"})," file, Pants generates one and passes it the kwargs provided in the ",(0,i.jsx)(n.code,{children:"provides=python_artifact(...)"})," field to the ",(0,i.jsx)(n.code,{children:"setup(...)"})," call (Pants also generates some of the kwargs, such as ",(0,i.jsx)(n.code,{children:"install_requires"})," and ",(0,i.jsx)(n.code,{children:"namespace_packages"})," by analyzing your code)."]}),"\n",(0,i.jsx)(n.p,{children:"It's fairly common to want to generate more of the kwargs dynamically. For example, you may want to:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Reduce boilerplate by not repeating common kwargs across BUILD files."}),"\n",(0,i.jsxs)(n.li,{children:["Read from the file system to dynamically determine kwargs, such as the ",(0,i.jsx)(n.code,{children:"long_description"})," or ",(0,i.jsx)(n.code,{children:"version"}),"."]}),"\n",(0,i.jsxs)(n.li,{children:["Run processes like ",(0,i.jsx)(n.code,{children:"git"})," to dynamically determine kwargs like ",(0,i.jsx)(n.code,{children:"version"}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"You can write a plugin to add custom kwarg generation logic."}),"\n",(0,i.jsxs)(n.p,{children:["Note: there may only be at most one applicable plugin per target customizing the kwargs for the ",(0,i.jsx)(n.code,{children:"setup()"})," function."]}),"\n",(0,i.jsx)(n.admonition,{title:"Example",type:"note",children:(0,i.jsxs)(n.p,{children:["See ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/blob/master/pants-plugins/internal_plugins/releases/register.py",children:"here"})," for an example that Pants uses internally for its ",(0,i.jsx)(n.code,{children:"python_distribution"})," targets. This plugin demonstrates reading from the file system to set the ",(0,i.jsx)(n.code,{children:"version"})," and ",(0,i.jsx)(n.code,{children:"long_description"})," kwargs, along with adding hardcoded kwargs."]})}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["Set up a subclass of ",(0,i.jsx)(n.code,{children:"SetupKwargsRequest"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["Set the class method ",(0,i.jsx)(n.code,{children:"is_applicable()"})," to determine whether your implementation should be used for the particular ",(0,i.jsx)(n.code,{children:"python_distribution"})," target. If ",(0,i.jsx)(n.code,{children:"False"}),", Pants will use the default implementation which simply uses the explicitly provided ",(0,i.jsx)(n.code,{children:"python_artifact"})," from the BUILD file."]}),"\n",(0,i.jsx)(n.p,{children:"In this example, we will always use our custom implementation:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from pants.backend.python.util_rules.package_dists import SetupKwargsRequest\nfrom pants.engine.target import Target\n\nclass CustomSetupKwargsRequest(SetupKwargsRequest):\n    @classmethod\n    def is_applicable(cls, _: Target) -> bool:\n        return True\n"})}),"\n",(0,i.jsxs)(n.p,{children:["This example will only use our plugin implementation for ",(0,i.jsx)(n.code,{children:"python_distribution"})," targets defined in the folder ",(0,i.jsx)(n.code,{children:"src/python/project1"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class CustomSetupKwargsRequest(SetupKwargsRequest):\n    @classmethod\n    def is_applicable(cls, target: Target) -> bool:\n        return target.address.spec.startswith("src/python/project1")\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Then, register your new ",(0,i.jsx)(n.code,{children:"SetupKwargsRequest "})," with a ",(0,i.jsx)(n.a,{href:"/2.24/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,i.jsx)(n.code,{children:"UnionRule"})})," so that Pants knows your implementation exists:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import collect_rules\nfrom pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(SetupKwargsRequest, CustomSetupKwargsRequest),\n    ]\n"})}),"\n",(0,i.jsxs)(n.admonition,{type:"note",children:[(0,i.jsxs)(n.mdxAdmonitionTitle,{children:["Consider defining custom ",(0,i.jsx)(n.code,{children:"python_distribution"})," target types"]}),(0,i.jsxs)(n.p,{children:["If you don't want to always use a single custom implementation, an effective approach could be to create custom ",(0,i.jsx)(n.code,{children:"python_distribution"})," target types so that your users decide which implementation they want to use in their BUILD files."]}),(0,i.jsx)(n.p,{children:"For example, a user could do this:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'pants_python_distribution(\n   name="my-dist",\n   dependencies=[...],\n   provides=python_artifact(...)\n)\n\npants_contrib_python_distribution(\n   name="my-dist",\n   dependencies=[...],\n   provides=python_artifact(...)\n)\n'})}),(0,i.jsxs)(n.p,{children:["To support this workflow, ",(0,i.jsx)(n.a,{href:"/2.24/docs/writing-plugins/the-target-api/creating-new-targets",children:"create new target types"}),"."]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'class PantsPythonDistribution(Target):\n   alias = "pants_python_distribution"\n   core_fields = PythonDistribution.core_fields\n\nclass PantsContribPythonDistribution(Target):\n   alias = "pants_contrib_python_distribution"\n   core_fields = PythonDistribution.core_fields\n'})}),(0,i.jsxs)(n.p,{children:["Then, for each ",(0,i.jsx)(n.code,{children:"SetupKwargsRequest"})," subclass, check which target type was used:"]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:"class PantsSetupKwargsRequest(SetupKwargsRequest):\n    @classmethod\n    def is_applicable(cls, target: Target) -> bool:\n        return isinstance(target, PantsPythonDistribution)\n"})})]}),"\n",(0,i.jsxs)(n.ol,{start:"2",children:["\n",(0,i.jsx)(n.li,{children:"Create a rule with your logic"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:["Your rule should take as a parameter the ",(0,i.jsx)(n.code,{children:"SetupKwargsRequest "})," from step 1. This type has two fields: ",(0,i.jsx)(n.code,{children:"target: Target"})," and ",(0,i.jsx)(n.code,{children:"explicit_kwargs: dict[str, Any]"}),". You can use these fields to get more information on the target you are generating a ",(0,i.jsx)(n.code,{children:"setup.py"})," for."]}),"\n",(0,i.jsxs)(n.p,{children:["Your rule should return ",(0,i.jsx)(n.code,{children:"SetupKwargs"}),", which takes two arguments: ",(0,i.jsx)(n.code,{children:"kwargs: dict[str, Any]"})," and ",(0,i.jsx)(n.code,{children:"address: Address"}),"."]}),"\n",(0,i.jsx)(n.p,{children:"For example, this will simply hardcode a kwarg:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from pants.backend.python.util_rules.package_dists import SetupKwargs\nfrom pants.engine.rules import rule\n\n@rule\nasync def setup_kwargs_plugin(request: CustomSetupKwargsRequest) -> SetupKwargs:\n    return SetupKwargs(\n        {**request.explicit_kwargs, "plugin_demo": "hello world"}, address=request.target.address\n    )\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Update your plugin's ",(0,i.jsx)(n.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/python_plugins/register.py"',children:"from python_plugins import custom_python_artifact\n\ndef rules():\n   return custom_python_artifact.rules()\n"})}),"\n",(0,i.jsxs)(n.p,{children:["Then, run ",(0,i.jsx)(n.code,{children:"pants package path/to:python_distribution"})," and inspect the generated ",(0,i.jsx)(n.code,{children:"setup.py"}),"to confirm that your plugin worked correctly."]}),"\n",(0,i.jsxs)(n.p,{children:["Often, you will want to read from a file in your project to set kwargs like ",(0,i.jsx)(n.code,{children:"version"})," or ",(0,i.jsx)(n.code,{children:"long_description"}),". Use ",(0,i.jsx)(n.code,{children:"await Get(DigestContents, PathGlobs)"})," to do this (see ",(0,i.jsx)(n.a,{href:"/2.24/docs/writing-plugins/the-rules-api/file-system",children:"File system"}),"):"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'from pants.backend.python.util_rules.package_dists import SetupKwargs\nfrom pants.engine.fs import DigestContents, GlobMatchErrorBehavior, PathGlobs\nfrom pants.engine.rules import rule\n\n@rule\nasync def setup_kwargs_plugin(request: CustomSetupKwargsRequest) -> SetupKwargs:\n    digest_contents = await Get(\n        DigestContents,\n        PathGlobs(\n            ["project/ABOUT.rst"],\n            description_of_origin="`python_artifact()` plugin",\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n        ),\n    )\n    about_page_content = digest_contents[0].content.decode()\n    return SetupKwargs(\n        {**request.explicit_kwargs, "long_description": "\\n".join(about_page_content)},\n        address=request.target.address\n    )\n'})}),"\n",(0,i.jsxs)(n.p,{children:["It can be helpful to allow users to add additional kwargs to their BUILD files for you to consume in your plugin. For example, this plugin adds a custom ",(0,i.jsx)(n.code,{children:"long_description_path"})," field, which gets popped and replaced by the plugin with a normalized ",(0,i.jsx)(n.code,{children:"long_description"})," kwarg:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'python_distribution(\n    name="mydist",\n    dependencies=[...],\n    provides=python_artifact(\n        name="mydist",\n        ...\n        long_description_path="README.md",\n    ),\n    generate_setup = True,\n    sdist = False,\n)\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-python",children:'import os.path\n\nfrom pants.backend.python.util_rules.package_dists import SetupKwargs\nfrom pants.engine.fs import DigestContents, GlobMatchErrorBehavior, PathGlobs\nfrom pants.engine.rules import rule\n\n@rule\nasync def setup_kwargs_plugin(request: CustomSetupKwargsRequest) -> SetupKwargs:\n    original_kwargs = request.explicit_kwargs.copy()\n    long_description_relpath = original_kwargs.pop("long_description_file", None)\n    if not long_description_relpath:\n        raise ValueError(\n            f"The python_distribution target {request.target.address} did not include "\n            "`long_description_file` in its python_artifact\'s kwargs. Our plugin requires this! "\n            "Please set to a path relative to the BUILD file, e.g. `ABOUT.md`."\n        )\n\n    build_file_path = request.target.address.spec_path\n    long_description_path = os.path.join(build_file_path, long_description_relpath)\n    digest_contents = await Get(\n        DigestContents,\n        PathGlobs(\n            [long_description_path],\n            description_of_origin=f"the \'long_description_file\' kwarg in {request.target.address}",\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n        ),\n    )\n    description_content = digest_contents[0].content.decode()\n    return SetupKwargs(\n        {**original_kwargs, "long_description": "\\n".join(description_content)},\n        address=request.target.address\n    )\n'})}),"\n",(0,i.jsx)(n.p,{children:"Refer to these guides for additional things you may want to do in your plugin:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/2.24/docs/writing-plugins/the-rules-api/options-and-subsystems",children:"Read from options"}),". Also see ",(0,i.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/blob/master/pants-plugins/internal_plugins/releases/register.py",children:"here"})," for an example."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/2.24/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Read values from the target"})," using the Target API."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.a,{href:"/2.24/docs/writing-plugins/the-rules-api/processes",children:["Run a ",(0,i.jsx)(n.code,{children:"Process"})]}),", such as ",(0,i.jsx)(n.code,{children:"git"}),". Also see ",(0,i.jsx)(n.a,{href:"/2.24/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),"."]}),"\n"]})]})}function p(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},848193(e,n,t){t.d(n,{R:()=>o,x:()=>a});var s=t(830758);let i={},r=s.createContext(i);function o(e){let n=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:n},e.children)}},522205(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/custom-python-artifact-kwargs","title":"Custom `python_artifact()` kwargs","description":"How to add your own logic to python_artifact().","source":"@site/versioned_docs/version-2.24/docs/writing-plugins/common-plugin-tasks/custom-python-artifact-kwargs.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/custom-python-artifact-kwargs","permalink":"/2.24/docs/writing-plugins/common-plugin-tasks/custom-python-artifact-kwargs","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/custom-python-artifact-kwargs.mdx","tags":[],"version":"2.24","sidebarPosition":9,"frontMatter":{"title":"Custom `python_artifact()` kwargs","sidebar_position":9},"sidebar":"docsSidebar","previous":{"title":"Add lockfiles","permalink":"/2.24/docs/writing-plugins/common-plugin-tasks/plugin-lockfiles"},"next":{"title":"Plugin upgrade guide","permalink":"/2.24/docs/writing-plugins/common-plugin-tasks/plugin-upgrade-guide"}}')}}]);