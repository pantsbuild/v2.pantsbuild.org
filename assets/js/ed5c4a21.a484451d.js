"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["793403"],{646897(e,t,n){n.r(t),n.d(t,{assets:()=>a,contentTitle:()=>d,default:()=>h,frontMatter:()=>r,metadata:()=>s,toc:()=>c});var s=n(939281),i=n(886070),o=n(848193);let r={title:"Integrating new tools without plugins",sidebar_position:999},d,a={},c=[{value:"Integrating new tools without plugins",id:"integrating-new-tools-without-plugins",level:2},{value:"<code>runnable</code> targets",id:"runnable-targets",level:3},{value:"Specifying dependencies",id:"specifying-dependencies",level:3},{value:"Specifying outputs",id:"specifying-outputs",level:3},{value:"Chaining processes together",id:"chaining-processes-together",level:3},{value:"Wrapping generated sources for use by other targets",id:"wrapping-generated-sources-for-use-by-other-targets",level:3},{value:"Using externally-managed tools",id:"using-externally-managed-tools",level:3},{value:"Running shell scripts",id:"running-shell-scripts",level:3}];function l(e){let t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",hr:"hr",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",p:"p",pre:"pre",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.hr,{}),"\n",(0,i.jsx)(t.h2,{id:"integrating-new-tools-without-plugins",children:"Integrating new tools without plugins"}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"adhoc_tool"}),' target allows you to execute "runnable" targets inside the Pants sandbox. Runnable targets include first-party sources that can be run with ',(0,i.jsx)(t.code,{children:"pants run"}),", 3rd-party dependencies like ",(0,i.jsx)(t.code,{children:"python_requirement"})," or ",(0,i.jsx)(t.code,{children:"jvm_artifact"}),", or even executables that exist on your system and managed externally to Pants."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"adhoc_tool"})," provides you with the building blocks needed to put together a custom build process without needing to develop and maintain a plugin. The level of initial effort involved in using ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," is significantly lower than that of ",(0,i.jsx)(t.a,{href:"/2.27/docs/writing-plugins/overview",children:"writing a plugin"}),", so it's well-suited to consuming one-off scripts, or for rapidly prototyping a process before actually writing a plugin. The tradeoff is that there is more manual work involved in defining build processes that reflect your codebase's structure, and that the targets that define the tools you consume are less easy to reuse."]}),"\n",(0,i.jsxs)(t.p,{children:["The ",(0,i.jsx)(t.code,{children:"antlr"})," demo in the ",(0,i.jsxs)(t.a,{href:"https://github.com/pantsbuild/example-adhoc",children:[(0,i.jsx)(t.code,{children:"example-adhoc"})," repository"]})," shows an example of running a JVM-based tool to transparently generate Python code that can be used in another language:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{children:'adhoc_tool(\n    name="run_antlr",\n    runnable=":antlr4",\n    args=["Expr.g4", "-Dlanguage=Python3", "-o", "expr_parser", "-package", "expr_parser",],\n    output_directories=["expr_parser",],\n    # These are consumed by `antlr`, but are not relevant to this target\'s dependents.\n    execution_dependencies=[":grammars"],\n    # These are needed by the code that is output by this target\n    output_dependencies=[":antlr4-python3-runtime",],\n    root_output_directory=".",\n    log_output=True,\n)\n'})}),"\n",(0,i.jsxs)(t.h3,{id:"runnable-targets",children:[(0,i.jsx)(t.code,{children:"runnable"})," targets"]}),"\n",(0,i.jsxs)(t.p,{children:['"Runnable" targets are targets that Pants knows how to execute within its sandbox. Generally, these correspond to targets that can be executed with the ',(0,i.jsx)(t.code,{children:"pants run"})," goal, and include first-party source files, as well as third-party dependencies."]}),"\n",(0,i.jsxs)(t.p,{children:["The tool will be run with values from ",(0,i.jsx)(t.code,{children:"args"})," specified as arguments. By default, the process' working directory will be the directory where the ",(0,i.jsx)(t.code,{children:"BUILD"})," file is defined. This can be adjusted using the ",(0,i.jsx)(t.code,{children:"workdir"})," field."]}),"\n",(0,i.jsxs)(t.admonition,{type:"caution",children:[(0,i.jsxs)(t.mdxAdmonitionTitle,{children:[(0,i.jsx)(t.code,{children:"runnable"})," targets must be pure functions"]}),(0,i.jsxs)(t.p,{children:["When run by ",(0,i.jsx)(t.code,{children:"adhoc_tool"}),", Pants assumes that the inputs provided to the process -- that is, the values of the ",(0,i.jsx)(t.code,{children:"adhoc_tool"}),"'s fields, and the contents of the runnable and execution dependencies -- fully describe the output. Output values will be ",(0,i.jsx)(t.a,{href:"/2.27/docs/introduction/how-does-pants-work#caching",children:"cached"})," by Pants, and future invocations with identical inputs will be retrieved from the cache instead of being re-executed. If your process has behavior that is not fully defined by its inputs, Pants' behavior may be unexpected or inconsistent."]})]}),"\n",(0,i.jsxs)(t.admonition,{type:"caution",children:[(0,i.jsxs)(t.mdxAdmonitionTitle,{children:[(0,i.jsx)(t.code,{children:"runnable"})," targets must be idempotent"]}),(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"adhoc_tool"})," processes may be cancelled or retried any number of times, so it is important that any side effects are idempotent. That is, it should not matter if it is run several times, or only partially."]})]}),"\n",(0,i.jsx)(t.h3,{id:"specifying-dependencies",children:"Specifying dependencies"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"adhoc_tool"})," has more complexity surrounding dependencies compared with Pants' first-class targets. This is because you need to do manual work to set up the execution environment, which is usually taken care of by plugin code."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"adhoc_tool"})," has three dependencies fields:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"output_dependencies"}),", which defines dependencies that are required to effectively consume the output of the tool, ",(0,i.jsx)(t.em,{children:"e.g."})," runtime libraries for generated code bindings. Any targets that (transitively) depend on the ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," target will also transitively depend on these dependencies."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"execution_dependencies"}),", which define data dependencies required for the tool to produce its output. These are not considered when resolving transitive dependencies that include this ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," target."]}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.code,{children:"runnable_dependencies"}),", which define runnables that the ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," needs on its ",(0,i.jsx)(t.code,{children:"PATH"})," to execute as a subprocess. These are also not considered when resolving transitive dependencies. The discussion of ",(0,i.jsx)(t.code,{children:"system_binary"})," later in this page shows one key use of ",(0,i.jsx)(t.code,{children:"runnable_dependencies"}),"."]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["In the ",(0,i.jsx)(t.code,{children:"antlr"})," example, ",(0,i.jsx)(t.code,{children:"output_dependencies"})," is used because the tool produces Python-based bindings that depend on a runtime library. ",(0,i.jsx)(t.code,{children:"execution_dependencies"})," specifies the sources that are consumed by the tool, but do not need to be consumed by subsequent build steps."]}),"\n",(0,i.jsx)(t.h3,{id:"specifying-outputs",children:"Specifying outputs"}),"\n",(0,i.jsxs)(t.p,{children:["Generally, ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," targets are run to produce outputs that can be supplied to other targets. These can be in the form of files or directories that are output directly by the tools: use the ",(0,i.jsx)(t.code,{children:"output_files"})," field to capture individual files, or ",(0,i.jsx)(t.code,{children:"output_directories"})," to capture entire directories as output."]}),"\n",(0,i.jsxs)(t.p,{children:["Files are captured relative to the build root by default: this is useful when passing results to further ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," targets defined in the same ",(0,i.jsx)(t.code,{children:"BUILD"})," file. If this behavior is not right for you, for example, if you are producing an artifact for packaging, you can change the root of the outputs using the ",(0,i.jsx)(t.code,{children:"root_output_directory"})," field."]}),"\n",(0,i.jsxs)(t.p,{children:["Finally, if you want to capture ",(0,i.jsx)(t.code,{children:"stdout"})," or ",(0,i.jsx)(t.code,{children:"stderr"})," from your tool, you can use the ",(0,i.jsx)(t.code,{children:"stdout"})," or ",(0,i.jsx)(t.code,{children:"stderr"})," fields. These specify filenames where those streams will be dumped once the process completes. Note that these files are specified in addition to those from the ",(0,i.jsx)(t.code,{children:"output_files"})," field, and an error will occur if the filename occurs in the outputs arising from ",(0,i.jsx)(t.code,{children:"output_files"})," or ",(0,i.jsx)(t.code,{children:"output_directories"})," and the contents of that file are different."]}),"\n",(0,i.jsx)(t.h3,{id:"chaining-processes-together",children:"Chaining processes together"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.em,{children:["Our ",(0,i.jsx)(t.a,{href:"https://github.com/pantsbuild/example-adhoc/tree/main/javascript",children:"JavaScript demo"})," demonstrates a string of ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," targets that's used to produce a resource file."]})}),"\n",(0,i.jsxs)(t.p,{children:["To get the best cache efficiency, it can make sense to break your ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," into smaller incremental steps. For example, if your process needs to fetch dependencies and then build a library based on those dependencies and some first-party source files, having one ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," for each of those steps means that the dependency-fetching stage will only be re-run when your requirements change, and not when the first-party source files change."]}),"\n",(0,i.jsxs)(t.p,{children:["Generally, if you are chaining ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," targets together , it will be easier to use the default ",(0,i.jsx)(t.code,{children:"workdir"})," and ",(0,i.jsx)(t.code,{children:"root_output_directory"})," fields for each step that will be consumed by an ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," in the same ",(0,i.jsx)(t.code,{children:"BUILD"})," file. Change the ",(0,i.jsx)(t.code,{children:"root_output_directory"})," only for targets that are intended to be used in other places or ways."]}),"\n",(0,i.jsx)(t.h3,{id:"wrapping-generated-sources-for-use-by-other-targets",children:"Wrapping generated sources for use by other targets"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.em,{children:["Our ",(0,i.jsx)(t.a,{href:"https://github.com/pantsbuild/example-adhoc/tree/main/antlr",children:"Antlr demo"})," demonstrates wrapping the outputs of ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," targets for use as Python sources."]})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"adhoc_tool"})," generates ",(0,i.jsx)(t.code,{children:"file"})," sources by default. This can be acceptable if generating assets that do not need to be consumed as source files for another Pants backend. Other Pants backends need generated sources to be marked as actual source files."]}),"\n",(0,i.jsxs)(t.p,{children:["There are several targets included in Pants with the prefix ",(0,i.jsx)(t.code,{children:"experimental_wrap_as_"}),". These act as a source target that can be used as a dependency in a given language backend, with the caveat that dependency inference is not available."]}),"\n",(0,i.jsx)(t.h3,{id:"using-externally-managed-tools",children:"Using externally-managed tools"}),"\n",(0,i.jsx)(t.p,{children:(0,i.jsxs)(t.em,{children:["Our ",(0,i.jsx)(t.a,{href:"https://github.com/pantsbuild/example-adhoc/tree/main/javascript",children:"JavaScript demo"})," demonstrates the use of externally-managed binaries."]})}),"\n",(0,i.jsxs)(t.p,{children:["Some build processes need to make use of tools that can't be modeled within a Pants codebase. The ",(0,i.jsx)(t.code,{children:"system_binary"})," target lets you make use of a binary that is installed on the system. ",(0,i.jsx)(t.code,{children:"system_binary"})," targets may be specified as ",(0,i.jsx)(t.code,{children:"runnable"})," or ",(0,i.jsx)(t.code,{children:"runnable_dependency"})," values for ",(0,i.jsx)(t.code,{children:"adhoc_tool"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"system_binary"})," will search for a binary in pre-defined or user-supplied search paths with a given ",(0,i.jsx)(t.code,{children:"binary_name"}),". To improve reproducibility, it's possible to test matching binaries with sample arguments, to see if its output matches a given regular expression. This can be used to match against version strings. If a such a binary does not exist on the system where Pants is being run, any build involving this ",(0,i.jsx)(t.code,{children:"system_binary"})," target will fail."]}),"\n",(0,i.jsxs)(t.p,{children:["When specified as a ",(0,i.jsx)(t.code,{children:"runnable_dependency"}),", the binary will be available on the ",(0,i.jsx)(t.code,{children:"PATH"})," with the target name of the dependency. This can be important if the ",(0,i.jsx)(t.code,{children:"runnable"})," field invokes a subprocess (for example, ",(0,i.jsx)(t.code,{children:"yarn"})," tries to invoke a binary called ",(0,i.jsx)(t.code,{children:"node"})," as its interpreter)."]}),"\n",(0,i.jsx)(t.h3,{id:"running-shell-scripts",children:"Running shell scripts"}),"\n",(0,i.jsxs)(t.p,{children:["Currently, ",(0,i.jsx)(t.code,{children:"shell_source"})," targets are not runnable. In the meantime, it is possible to run a shell script as an ",(0,i.jsx)(t.code,{children:"adhoc_tool"})," through the following approach:"]}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["Declare a ",(0,i.jsx)(t.code,{children:"system_binary"})," target referring to your preferred shell (e.g. ",(0,i.jsx)(t.code,{children:"bash"}),", ",(0,i.jsx)(t.code,{children:"zsh"}),", ",(0,i.jsx)(t.code,{children:"fish"}),")"]}),"\n",(0,i.jsxs)(t.li,{children:["Declare an ",(0,i.jsx)(t.code,{children:"adhoc_tool"}),", with the ",(0,i.jsx)(t.code,{children:"runnable"})," field pointing at your ",(0,i.jsx)(t.code,{children:"system_binary"})," target, add your ",(0,i.jsx)(t.code,{children:"shell_source"})," as an ",(0,i.jsx)(t.code,{children:"execution_dependency"}),", and provide your script's path relative to the buildroot as the first value in ",(0,i.jsx)(t.code,{children:"args"})]}),"\n"]}),"\n",(0,i.jsxs)(t.p,{children:["This is clearly not as convenient as directly running a ",(0,i.jsx)(t.code,{children:"shell_source"})," target, and we anticipate adding support in a future version of Pants."]})]})}function h(e={}){let{wrapper:t}={...(0,o.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},848193(e,t,n){n.d(t,{R:()=>r,x:()=>d});var s=n(830758);let i={},o=s.createContext(i);function r(e){let t=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function d(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),s.createElement(o.Provider,{value:t},e.children)}},939281(e){e.exports=JSON.parse('{"id":"docs/ad-hoc-tools/integrating-new-tools-without-plugins","title":"Integrating new tools without plugins","description":"---","source":"@site/versioned_docs/version-2.27/docs/ad-hoc-tools/integrating-new-tools-without-plugins.mdx","sourceDirName":"docs/ad-hoc-tools","slug":"/docs/ad-hoc-tools/integrating-new-tools-without-plugins","permalink":"/2.27/docs/ad-hoc-tools/integrating-new-tools-without-plugins","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/ad-hoc-tools/integrating-new-tools-without-plugins.mdx","tags":[],"version":"2.27","sidebarPosition":999,"frontMatter":{"title":"Integrating new tools without plugins","sidebar_position":999},"sidebar":"docsSidebar","previous":{"title":"SQL","permalink":"/2.27/docs/sql/"},"next":{"title":"Javascript overview","permalink":"/2.27/docs/javascript/overview/"}}')}}]);