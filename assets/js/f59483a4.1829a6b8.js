"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["700756"],{788490(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>r,metadata:()=>t,toc:()=>o});var t=s(239336),a=s(886070),i=s(848193);let r={title:"Kubernetes Overview",sidebar_position:999},l,c={},o=[{value:"Initial setup",id:"initial-setup",level:2},{value:"Deploying objects to a cluster",id:"deploying-objects-to-a-cluster",level:2},{value:"Simple templates",id:"simple-templates",level:2},{value:"Docker images",id:"docker-images",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.hr,{}),"\n",(0,a.jsxs)(n.admonition,{title:"Kubernetes support is in alpha stage",type:"caution",children:[(0,a.jsx)(n.p,{children:"Pants is currently building support for Kubernetes. Simple use cases might be\nsupported, but many options are missing."}),(0,a.jsxs)(n.p,{children:["Please share feedback for what you need to use Pants with your Kubernetes queries by\neither ",(0,a.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/issues/new/choose",children:"opening a GitHub\nissue"})," or ",(0,a.jsx)(n.a,{href:"/community/getting-help",children:"joining our\nSlack"}),"!"]})]}),"\n",(0,a.jsx)(n.h2,{id:"initial-setup",children:"Initial setup"}),"\n",(0,a.jsxs)(n.p,{children:["First, activate the relevant backend in ",(0,a.jsx)(n.code,{children:"pants.toml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = [\n  ...\n  "pants.backend.experimental.k8s",\n]\n'})}),"\n",(0,a.jsxs)(n.p,{children:["The Kubernetes backend adds ",(0,a.jsx)(n.a,{href:"/2.27/reference/targets/k8s_source",children:(0,a.jsx)(n.code,{children:"k8s_source"})})," and\n",(0,a.jsx)(n.a,{href:"/2.27/reference/targets/k8s_sources",children:(0,a.jsx)(n.code,{children:"k8s_sources"})})," target types for Kubernetes object\nfiles."]}),"\n",(0,a.jsxs)(n.p,{children:["For example, create a file ",(0,a.jsx)(n.code,{children:"src/k8s/webpages.yaml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="src/k8s/webpages.yaml"',children:"---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: webpages\ndata:\n  index.html: |\n    <html>\n      <head>Hello pants!</head>\n      <body>Hello pants!</body>\n    </html>\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now add a ",(0,a.jsx)(n.code,{children:"k8s_sources"})," target in ",(0,a.jsx)(n.code,{children:"src/k8s/BUILD"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'title="src/k8s/BUILD"',children:"k8s_sources()\n"})}),"\n",(0,a.jsx)(n.h2,{id:"deploying-objects-to-a-cluster",children:"Deploying objects to a cluster"}),"\n",(0,a.jsxs)(n.p,{children:["We'll be using a local ",(0,a.jsx)(n.a,{href:"https://kind.sigs.k8s.io/",children:"kind"})," cluster throughout the\ntutorial. First, spin up a cluster:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"kind create cluster\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:'Creating cluster "kind" ...\n \u2713 Ensuring node image (kindest/node:v1.25.3) \u{1F5BC} \n \u2713 Preparing nodes \u{1F4E6}  \n \u2713 Writing configuration \u{1F4DC} \n \u2713 Starting control-plane \u{1F579}\uFE0F \n \u2713 Installing CNI \u{1F50C} \n \u2713 Installing StorageClass \u{1F4BE} \nSet kubectl context to "kind-kind"\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Second, configure the list of available contexts in ",(0,a.jsx)(n.code,{children:"pants.toml"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'...\n\n[k8s]\navailable_contexts = [\n  "kind-kind",\n]\n'})}),"\n",(0,a.jsxs)(n.p,{children:["Third, create a deployable target ",(0,a.jsx)(n.code,{children:"k8s_bundle"})," in ",(0,a.jsx)(n.code,{children:"src/k8s/BUILD"}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'title="src/k8s/BUILD"',children:'k8s_sources()\nk8s_bundle(\n    name="webpages",\n    sources=("src/k8s/webpages.yaml",),\n    context="kind-kind",\n)\n'})}),"\n",(0,a.jsx)(n.p,{children:"Now you can deploy the target:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pants experimental-deploy src/k8s:webpages\n"})}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{children:"\u2713 src/k8s:webpages deployed to context kind-kind\n"})}),"\n",(0,a.jsx)(n.admonition,{title:"Explicitly set kubectl contexts",type:"note",children:(0,a.jsxs)(n.p,{children:["To prevent accidentally deploying kubernetes manifests to the wrong cluster,\nthe context field is required on ",(0,a.jsx)(n.code,{children:"k8s_bundle"})," for deployment. For deploying the\nsame ",(0,a.jsx)(n.code,{children:"k8s_bundle"})," to multiple contexts, consider using ",(0,a.jsxs)(n.a,{href:"/2.27/docs/using-pants/key-concepts/targets-and-build-files#parametrizing-targets",children:[(0,a.jsx)(n.code,{children:"parametrize"}),"\nbuiltin"]}),"\nlike ",(0,a.jsx)(n.code,{children:'k8s_bundle(..., context=parametrize("stage", "prod"))'}),". For CI agents\nwhich will only have access to a single context, set the\n",(0,a.jsx)(n.code,{children:"[kubectl].pass_context"})," to false in ",(0,a.jsx)(n.code,{children:"pants.toml"})," to have them use their\ndefault context."]})}),"\n",(0,a.jsx)(n.h2,{id:"simple-templates",children:"Simple templates"}),"\n",(0,a.jsxs)(n.p,{children:["At some point, you may need to inject variables from a BUILD file into\nKubernetes resources \u2014 also known as templating. The simplest way to achieve\nthis is by using the ",(0,a.jsx)(n.code,{children:"python_format_string"})," target, which generates\n",(0,a.jsx)(n.code,{children:"k8s_sources"})," by substituting the values you specify in the BUILD file."]}),"\n",(0,a.jsx)(n.p,{children:"First, add the codegen backend:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'backend_packages = [\n    ...\n    "pants.backend.experimental.k8s",\n    "pants.backend.experimental.codegen.python_format_string",\n    "pants.backend.experimental.codegen.python_format_string.k8s",\n]\n'})}),"\n",(0,a.jsx)(n.p,{children:"Then parametrize the yaml using python format string syntax, e.g. the\nnamespace:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="src/k8s/webpages.yaml',children:"---\napiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: webpages\n  namespace: {namespace}\ndata:\n  index.html: |\n    <html>\n      <head>Hello pants!</head>\n      <body>Hello pants!</body>\n    </html>\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Now replace ",(0,a.jsx)(n.code,{children:"k8s_sources"})," with a ",(0,a.jsx)(n.code,{children:"python_format_string"})," target and pass the\nnamespace value:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'title="src/k8s/BUILD"',children:'python_format_string(\n    name="webpages-template",\n    source="webpages.yaml",\n    values={"namespace": "web"},\n)\nk8s_bundle(\n    name="webpages",\n    sources=("src/k8s:webpages-template",),\n    context="kind-kind",\n)\n'})}),"\n",(0,a.jsx)(n.p,{children:"Now you can deploy the bundle:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pants experimental-deploy src/k8s/:webpages\n"})}),"\n",(0,a.jsxs)(n.p,{children:["This setup can now be used to deploy the same resource to multiple namespaces\nwith ",(0,a.jsxs)(n.a,{href:"/2.27/docs/using-pants/key-concepts/targets-and-build-files#parametrizing-targets",children:[(0,a.jsx)(n.code,{children:"parametrize"}),"\nbuiltin"]}),":"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'title="src/k8s/BUILD"',children:'python_format_string(\n    name="webpages-template",\n    source="webpages.yaml",\n    **parametrize("default", values={"namespace": "default"}),\n    **parametrize("web", values={"namespace": "web"}),\n)\nk8s_bundle(\n    name="webpages",\n    context="kind-kind",\n    **parametrize("default", sources=("src/k8s:webpages-template@parametrize=default",)),\n    **parametrize("web", sources=("src/k8s:webpages-template@parametrize=web",)),\n)\n'})}),"\n",(0,a.jsx)(n.h2,{id:"docker-images",children:"Docker images"}),"\n",(0,a.jsx)(n.p,{children:"Before we continue, add the docker backend:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-toml",metastring:'title="pants.toml"',children:'[GLOBAL]\nbackend_packages = [\n  ...\n  "pants.backend.docker",\n]\n\n[dockerfile-parser]\nuse_rust_parser = true\n'})}),"\n",(0,a.jsx)(n.p,{children:"To use docker images you most likely will need some templating. This is because\nyour docker image tags will be probably versioned."}),"\n",(0,a.jsxs)(n.p,{children:["You might want to use git to generate the version for your images, but you\ncan't directly run git commands in a BUILD file. You can use a\n",(0,a.jsx)(n.code,{children:".pants.bootstrap"})," file as a workaround:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'title=".pants.bootstrap"',children:'#!/bin/sh\n\nVERSION="${VERSION:-$(git describe --tags --dirty --match "[0-9\\.]*" || echo 0.0.1)}"\nexport VERSION\n'})}),"\n",(0,a.jsxs)(n.p,{children:["This script will run before every pants command, so you can now use the\n",(0,a.jsx)(n.code,{children:"VERSION"})," env var in the BUILD file:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-python",metastring:'title="src/k8s/BUILD"',children:'...\ndocker_image(\n    name="custom-nginx",\n    instructions=["FROM nginx"],\n    image_tags=[env("VERSION")],\n)\npython_format_string(\n    name="webserver-template",\n    source="deployment.yaml",\n    values={"VERSION": env("VERSION")},\n)\nk8s_bundle(\n    name="webserver",\n    context="kind-kind",\n    sources=("src/k8s:webserver-template",),\n    dependencies=(":custom-nginx",),\n)\n'})}),"\n",(0,a.jsx)(n.p,{children:"Create the deployment:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-yaml",metastring:'title="src/k8s/deployment.yaml"',children:"---\napiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: webserver\n  namespace: web\nspec:\n  replicas: 1\n  selector:\n    matchLabels:\n      app: webserver\n  template:\n    metadata:\n      labels:\n        app: webserver\n    spec:\n      containers:\n        - name: nginx\n          image: custom-nginx:{VERSION}\n"})}),"\n",(0,a.jsx)(n.p,{children:"Now deploy the bundle:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pants experimental-deploy src/k8s:webserver\n"})}),"\n",(0,a.jsxs)(n.p,{children:["Notice, that pants will automatically publish the image. This happens because\nwe've configured ",(0,a.jsx)(n.code,{children:'dependencies=(":custom-nginx",)'})," field on ",(0,a.jsx)(n.code,{children:"k8s_bundle"}),"\ntarget. You can disable this behaviour and publish the image manually:"]}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-bash",children:"pants publish src/k8s:custom-nginx\npants experimental-deploy --no-publish-dependencies src/k8s:webserver\n"})})]})}function p(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},848193(e,n,s){s.d(n,{R:()=>r,x:()=>l});var t=s(830758);let a={},i=t.createContext(a);function r(e){let n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:r(e.components),t.createElement(i.Provider,{value:n},e.children)}},239336(e){e.exports=JSON.parse('{"id":"docs/kubernetes/index","title":"Kubernetes Overview","description":"---","source":"@site/versioned_docs/version-2.27/docs/kubernetes/index.mdx","sourceDirName":"docs/kubernetes","slug":"/docs/kubernetes/","permalink":"/2.27/docs/kubernetes/","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/kubernetes/index.mdx","tags":[],"version":"2.27","sidebarPosition":999,"frontMatter":{"title":"Kubernetes Overview","sidebar_position":999},"sidebar":"docsSidebar","previous":{"title":"Tagging Docker images","permalink":"/2.27/docs/docker/tagging-docker-images"},"next":{"title":"Helm Overview","permalink":"/2.27/docs/helm/"}}')}}]);