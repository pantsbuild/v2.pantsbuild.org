"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["47766"],{533880(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>c});var r=s(670781),t=s(886070),i=s(848193);let a={title:"Run programs",sidebar_position:4},o,l={},c=[{value:"1. Set up a binary target type",id:"1-set-up-a-binary-target-type",level:2},{value:"2. Set up a subclass of <code>RunFieldSet</code>",id:"2-set-up-a-subclass-of-runfieldset",level:2},{value:"3. Create a rule for your logic",id:"3-create-a-rule-for-your-logic",level:2},{value:"4. Add tests (optional)",id:"4-add-tests-optional",level:2}];function d(e){let n={a:"a",admonition:"admonition",code:"code",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(n.p,{children:["How to add a new implementation to the ",(0,t.jsx)(n.code,{children:"run"})," goal."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"run"})," goal runs a single interactive process in the foreground, such as running a script or a program."]}),"\n",(0,t.jsx)(n.admonition,{title:"Example repository",type:"note",children:(0,t.jsxs)(n.p,{children:["This guide walks through adding a simple ",(0,t.jsx)(n.code,{children:"run"})," implementation for Bash that runs the equivalent ",(0,t.jsx)(n.code,{children:"/bin/bash ./script.sh"}),". See ",(0,t.jsx)(n.a,{href:"https://github.com/pantsbuild/example-plugin/blob/main/pants-plugins/examples/bash/run_binary.py",children:"here"})," for the final implementation."]})}),"\n",(0,t.jsx)(n.h2,{id:"1-set-up-a-binary-target-type",children:"1. Set up a binary target type"}),"\n",(0,t.jsxs)(n.p,{children:['Usually, you will want to add a "binary" target type for your language, such as ',(0,t.jsx)(n.code,{children:"bash_binary"})," or ",(0,t.jsx)(n.code,{children:"python_binary"}),". Typically, both the ",(0,t.jsx)(n.code,{children:"run"})," and ",(0,t.jsx)(n.code,{children:"package"})," goals operate on binary target types."]}),"\n",(0,t.jsxs)(n.p,{children:["When creating a binary target, you should usually subclass the ",(0,t.jsx)(n.code,{children:"Sources"})," field and set the class property ",(0,t.jsx)(n.code,{children:"expected_num_files = 1"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["See ",(0,t.jsx)(n.a,{href:"/2.4/docs/writing-plugins/the-target-api/creating-new-targets",children:"Creating new targets"})," for a guide on how to define new target types."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from pants.engine.target import COMMON_TARGET_FIELDS, Dependencies, Sources, Target\n\nclass BashSources(Sources):\n    expected_file_extensions = (".sh",)\n\n\nclass BashBinarySources(BashSources):\n     required = True\n     expected_num_files = 1\n\n\n class BashBinary(Target):\n     """A Bash file that may be directly run."""\n\n     alias = "bash_binary"\n     core_fields = (*COMMON_TARGET_FIELDS, Dependencies, BashBinarySources)\n'})}),"\n",(0,t.jsxs)(n.h2,{id:"2-set-up-a-subclass-of-runfieldset",children:["2. Set up a subclass of ",(0,t.jsx)(n.code,{children:"RunFieldSet"})]}),"\n",(0,t.jsxs)(n.p,{children:["As described in ",(0,t.jsx)(n.a,{href:"/2.4/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Rules and the Target API"}),", a ",(0,t.jsx)(n.code,{children:"FieldSet"})," is a way to tell Pants which ",(0,t.jsx)(n.code,{children:"Field"}),"s you care about targets having for your plugin to work."]}),"\n",(0,t.jsxs)(n.p,{children:["Usually, you will require the binary target's ",(0,t.jsx)(n.code,{children:"Sources"})," subclass from Step 1, such as ",(0,t.jsx)(n.code,{children:"BashBinarySources"})," or ",(0,t.jsx)(n.code,{children:"PythonBinarySources"}),". Add this ",(0,t.jsx)(n.code,{children:"Sources"})," subclass to the class property ",(0,t.jsx)(n.code,{children:"required_fields"})," of your new ",(0,t.jsx)(n.code,{children:"FieldSet"}),". This means that your binary implementation will run on any target with that sources field or a subclass of it."]}),"\n",(0,t.jsxs)(n.p,{children:["Create a new dataclass that subclasses ",(0,t.jsx)(n.code,{children:"RunFieldSet"}),":"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.core.goals.binary import BinaryFieldSet\n\n@dataclass(frozen=True)\nclass BashRunFieldSet(BinaryFieldSet):\n    required_fields = (BashBinarySources,)\n\n    sources: BashBinarySources\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Then, register your new ",(0,t.jsx)(n.code,{children:"RunFieldSet"})," with a ",(0,t.jsx)(n.a,{href:"/2.4/docs/writing-plugins/the-rules-api/union-rules-advanced",children:(0,t.jsx)(n.code,{children:"UnionRule"})})," so that Pants knows your binary implementation exists:"]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:"from pants.engine.rules import collect_rules\nfrom pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(RunFieldSet, BashRunFieldSet),\n    ]\n"})}),"\n",(0,t.jsx)(n.h2,{id:"3-create-a-rule-for-your-logic",children:"3. Create a rule for your logic"}),"\n",(0,t.jsxs)(n.p,{children:["Your rule should take as a parameter the ",(0,t.jsx)(n.code,{children:"RunFieldSet"})," from Step 1. It should return ",(0,t.jsx)(n.code,{children:"RunRequest"}),", which has the fields ",(0,t.jsx)(n.code,{children:"digest: Digest"}),", ",(0,t.jsx)(n.code,{children:"args: Iterable[str]"}),", and ",(0,t.jsx)(n.code,{children:"extra_env: Optional[Mapping[str, str]]"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["The ",(0,t.jsx)(n.code,{children:"RunRequest"})," will get converted into an ",(0,t.jsx)(n.code,{children:"InteractiveProcess"})," that will run in the foreground."]}),"\n",(0,t.jsxs)(n.p,{children:["The process will run in a temporary directory in the build root, which means that the script/program can access files that would normally need to be declared by adding a ",(0,t.jsx)(n.code,{children:"files"})," or ",(0,t.jsx)(n.code,{children:"resources"})," target to the ",(0,t.jsx)(n.code,{children:"dependencies"})," field."]}),"\n",(0,t.jsxs)(n.p,{children:["The process's environment will not be hermetic, meaning that it will inherit the environment used by the ",(0,t.jsx)(n.code,{children:"./pants process"}),". Any values you set in ",(0,t.jsx)(n.code,{children:"extra_env"})," will add or update the specified environment variables."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",children:'from dataclasses import dataclass\n\nfrom pants.core.goals.run import RunFieldSet, RunRequest\nfrom pants.core.target_types import FilesSources, ResourcesSources\nfrom pants.core.util_rules.source_files import SourceFiles, SourceFilesRequest\nfrom pants.engine.addresses import Addresses\nfrom pants.engine.rules import Get, MultiGet, rule\nfrom pants.engine.target import Sources, TransitiveTargets\nfrom pants.util.logging import LogLevel\n\nfrom examples.bash.target_types import BashBinarySources, BashSources\n\n...\n\n@rule(level=LogLevel.DEBUG)\nasync def run_bash_binary(field_set: BashRunFieldSet) -> RunRequest:\n    # First, we find the `bash` program.\n    bash_program_paths =  await Get(\n        BinaryPaths, BinaryPathRequest(binary_name="bash", search_path=("/bin", "/usr/bin")),\n    )\n    if not bash_program_paths.first_path:\n        raise EnvironmentError("Could not find the `bash` program on /bin or /usr/bin.")\n    bash_program = bash_program_paths.first_path\n\n    # We need to include all relevant transitive dependencies in the environment. We also get the\n    # binary\'s sources so that we know the script name.\n    transitive_targets = await Get(TransitiveTargets, Addresses([field_set.address]))\n    binary_sources_request = Get(SourceFiles, SourceFilesRequest([field_set.sources]))\n    all_sources_request = Get(\n        SourceFiles,\n        SourceFilesRequest(\n            (tgt.get(Sources) for tgt in transitive_targets.closure),\n            for_sources_types=(BashSources, FilesSources, ResourcesSources),\n        ),\n    )\n    binary_sources, all_sources = await MultiGet(\n        binary_sources_request, all_sources_request\n    )\n\n    # We join the relative path to our program with the template string "{chroot}", which will get\n    # substituted with the path to the temporary directory where our program runs. This ensures\n    # that we run the correct file.\n    # Note that `BashBinarySources` will have already validated that there is exactly one file in\n    # the sources field.\n    script_name = os.path.join("{chroot}", binary_sources.files[0])\n\n    return RunRequest(\n        digest=all_sources.snapshot.digest,\n        args=[bash_program.exe, script_name],\n    )\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In this example, we run the equivalent of ",(0,t.jsx)(n.code,{children:"/bin/bash ./my_script.sh"}),". Typically, your ",(0,t.jsx)(n.code,{children:"args"})," will include the program you're running, like ",(0,t.jsx)(n.code,{children:"/bin/bash"}),", and the relative path to the binary file. For some languages, you may use values other than the file name; for example, Pants's ",(0,t.jsx)(n.code,{children:"python_binary"})," target has an ",(0,t.jsx)(n.code,{children:"entry_point"})," field, and the ",(0,t.jsx)(n.code,{children:"run"})," implementation sets ",(0,t.jsx)(n.code,{children:"args"})," to the equivalent of ",(0,t.jsx)(n.code,{children:"python -m entry_point"}),"."]}),"\n",(0,t.jsxs)(n.p,{children:["When using relative paths in ",(0,t.jsx)(n.code,{children:"args"})," or ",(0,t.jsx)(n.code,{children:"extra_env"}),", you should join the values with the template string ",(0,t.jsx)(n.code,{children:'"{chroot}"'}),", e.g. ",(0,t.jsx)(n.code,{children:'os.path.join("{chroot}", binary_sources.files[0])'}),". This ensures that you run on the correct file in the temporary directory created by Pants."]}),"\n",(0,t.jsxs)(n.p,{children:["Finally, update your plugin's ",(0,t.jsx)(n.code,{children:"register.py"})," to activate this file's rules."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-python",metastring:'title="pants-plugins/bash/register.py"',children:"from bash import run_binary\n\n\ndef rules():\n    return [*run_binary.rules()]\n"})}),"\n",(0,t.jsxs)(n.p,{children:["Now, when you run ",(0,t.jsx)(n.code,{children:"./pants run path/to/binary.sh"}),", Pants should run the program."]}),"\n",(0,t.jsx)(n.h2,{id:"4-add-tests-optional",children:"4. Add tests (optional)"}),"\n",(0,t.jsxs)(n.p,{children:["Refer to ",(0,t.jsx)(n.a,{href:"/2.4/docs/writing-plugins/the-rules-api/testing-plugins",children:"Testing rules"}),". TODO"]})]})}function u(e={}){let{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},848193(e,n,s){s.d(n,{R:()=>a,x:()=>o});var r=s(830758);let t={},i=r.createContext(t);function a(e){let n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),r.createElement(i.Provider,{value:n},e.children)}},670781(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/run-programs","title":"Run programs","description":"How to add a new implementation to the run goal.","source":"@site/versioned_docs/version-2.4/docs/writing-plugins/common-plugin-tasks/run-programs.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/run-programs","permalink":"/2.4/docs/writing-plugins/common-plugin-tasks/run-programs","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/run-programs.mdx","tags":[],"version":"2.4","sidebarPosition":4,"frontMatter":{"title":"Run programs","sidebar_position":4},"sidebar":"docsSidebar","previous":{"title":"Add codegen","permalink":"/2.4/docs/writing-plugins/common-plugin-tasks/add-codegen"},"next":{"title":"Package code","permalink":"/2.4/docs/writing-plugins/common-plugin-tasks/package-code"}}')}}]);