"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["763431"],{132495(e,n,t){t.r(n),t.d(n,{assets:()=>d,contentTitle:()=>i,default:()=>c,frontMatter:()=>a,metadata:()=>r,toc:()=>l});var r=t(922922),s=t(886070),o=t(848193);let a={authors:["liam"],tags:["python"]},i="Poetry support for Pants 2.6",d={authorsImageUrls:[void 0]},l=[{value:"My experience as an intern",id:"my-experience-as-an-intern",level:2},{value:"Conclusion",id:"conclusion",level:2}];function p(e){let n={a:"a",code:"code",em:"em",figcaption:"figcaption",h2:"h2",hr:"hr",p:"p",pre:"pre",...(0,o.R)(),...e.components},{CaptionedImg:r}=n;return r||function(e,n){throw Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("CaptionedImg",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r,{src:t(872873).A,children:(0,s.jsxs)(n.p,{children:["Photo by ",(0,s.jsx)(n.a,{href:"https://unsplash.com/@iamtru?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit",children:'Trust "Tru"\nKatsande'}),"\n/\n",(0,s.jsx)(n.a,{href:"https://unsplash.com/?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit",children:"Unsplash"})]})}),"\n",(0,s.jsx)(n.p,{children:"Pants 2.6 can now understand Poetry's pyproject.toml configuration for third-party dependency management, addressing one of our most requested features in the last year!"}),"\n",(0,s.jsx)(n.p,{children:"Pants Contributor Liam Wilson delves into this new feature as well as his experiences developing the macro as a Toolchain intern."}),"\n","\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsxs)(n.em,{children:["Pants 2.6 can now understand Poetry's ",(0,s.jsx)(n.code,{children:"pyproject.toml"})," configuration for third-party dependency management, addressing one of our most requested features in the last year! Pants handles dependencies with more precision than Python projects using ",(0,s.jsx)(n.code,{children:"requirements.txt"})," or Poetry. Pants Contributor Liam Wilson delves into this new feature as well as his experiences developing the macro as a ",(0,s.jsx)(n.a,{href:"http://toolchain.com",children:"Toolchain"})," intern."]})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.a,{href:"https://www.pantsbuild.org/v2.6/",children:"Pants"})," handles dependencies with more precision than Python projects using ",(0,s.jsx)(n.code,{children:"requirements.txt"})," or ",(0,s.jsx)(n.a,{href:"https://python-poetry.org/",children:"Poetry"}),". Whereas normally you have a single virtual environment, Pants can understand precisely which 3rd-party dependendencies each file in your project uses, automatically, through ",(0,s.jsx)(n.a,{href:"https://www.pantsbuild.org/docs/how-does-pants-work#dependency-inference",children:"dependency inference"}),". When building your code \u2014 like running tests or packaging your code into wheel files \u2014 Pants only uses the third-party dependencies necessary for that particular file."]}),"\n",(0,s.jsx)(n.p,{children:"For example, given this file:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-py",metastring:'caption="Code for project/app.py"',children:'from django.http import HttpResponse\n\ndef index(request):\n    return HttpResponse("Hello, world. You\'re at the polls index.")\n'})}),"\n",(0,s.jsx)(n.figcaption,{"data-remark-code-caption":!0,children:"Code for project/app.py"}),"\n",(0,s.jsx)(n.p,{children:"Pants can infer that you depend on Django:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-shell-session",children:"$ ./pants dependencies --type=3rdparty project/app.py\nDjango==3.2.5\n"})}),"\n",(0,s.jsx)(n.p,{children:"Among other benefits, this precise and automatic understanding of your dependencies gives you fine-grained caching. This means, for example, that if none of the dependencies for a particular test file have changed, the cached result can be safely used."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.p,{children:["Normally, Pants learns about your third-party dependencies by parsing ",(0,s.jsx)(n.code,{children:"requirements.txt"})," files. Now, Pants can also parse your ",(0,s.jsx)(n.code,{children:"pyproject.toml"}),", including understanding Poetry's special operators like ",(0,s.jsx)(n.code,{children:"^"})," and ",(0,s.jsx)(n.code,{children:"~"}),"."]}),"\n",(0,s.jsxs)(n.p,{children:["For example, given this ",(0,s.jsx)(n.code,{children:"pyproject.toml"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-toml",children:'[tool.poetry]\nname = "my_project"\nversion = "0.1.0"\n\n[tool.poetry.dependencies]\npython = "^3.8"\nansicolors = "1.5"\nzipp = {git = "https://github.com/jaraco/zipp.git"}\nrequests = {version = "1.2.3", extras = ["security"],  python = ">2.7"}\n\n[tool.poetry.dev-dependencies]\ncomplex_req = [{version = ">=1.9", python = "^2.7"},{version = "^2.0", python = "3.4 || 3.5"}\nisort = ">=5.5.1,<5.6"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Pants will map to these 3rd-party dependencies:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:'ansicolors\nzipp@git+https://github.com/jaraco/zipp.git\nrequests[security] == 1.2.3; python_version >= 2.7\ncomplex_req>=1.9; python_version >= "2.7" and python_version < "3.0"\ncomplex_req<3.0.0,>=2.0; python_version == "3.4" or python_version == "3.5"\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This teaches Pants about the universe of all the third-party dependencies your project uses. Pants will then use dependency inference to determine exactly which subset of your dependencies are used by each file. This allows a single repository (i.e. a monorepo) to safely package multiple wheels/binaries for their project using a single ",(0,s.jsx)(n.code,{children:"pyproject.toml"}),", as opposed to having a unique requirements list for every package in their repo: Pants will use the proper subset of dependencies for each package, automatically."]}),"\n",(0,s.jsxs)(n.p,{children:["The new Poetry support makes it ",(0,s.jsx)(n.a,{href:"https://www.pantsbuild.org/docs/existing-repositories",children:"even easier to incrementally adopt Pants"})," for Poetry users. Adopting Pants now no longer requires rewriting these requirements to a ",(0,s.jsx)(n.code,{children:"requirements.txt"})," format and allows for consuming ",(0,s.jsx)(n.code,{children:"project.toml"})," as-is. You can also keep using Poetry to update your 3rd-party dependencies (e.g. ",(0,s.jsx)(n.code,{children:"poetry add"}),")."]}),"\n",(0,s.jsxs)(n.p,{children:["You can also teach Pants about your ",(0,s.jsx)(n.code,{children:"poetry.lock"})," by running ",(0,s.jsx)(n.code,{children:"poetry export"})," and pointing Pants to the generated file, ensuring that Pants uses the same pinned dependencies. (Note: Pants 2.7 will be getting more robust lockfile support)."]}),"\n",(0,s.jsxs)(n.p,{children:["See the ",(0,s.jsx)(n.a,{href:"https://www.pantsbuild.org/v2.6/docs/python-third-party-dependencies#poetry-integration",children:"docs"})," for how to get set up with Poetry."]}),"\n",(0,s.jsx)(n.h2,{id:"my-experience-as-an-intern",children:"My experience as an intern"}),"\n",(0,s.jsx)(n.p,{children:"As an intern developing a feature for Pants, I was surprised at how straightforward it was to introduce a Pants macro."}),"\n",(0,s.jsx)(n.p,{children:"Adding this functionality also highlighted how test-driven development can be extremely helpful, especially in instances where edge cases are very common. Having a firm idea about what cases need to be addressed and in what ways before development was something I already recognized, but I underestimated the value in having a concrete way to evaluate these cases prior to writing implementation details."}),"\n",(0,s.jsx)(n.p,{children:"With this particular project, a handful of bugs slipped through as I wrote tests in batches. Consider parsing for a requirement in the dictionary form: within that, there are several sub-cases, like handling a git requirement, or handling a version. Each of those consists of a new set of edge cases, and I initially focused first on the finest grain of edge case. In doing this, I let a handful of broader-scale edge cases slip through, and had to patch several bugs as a result."}),"\n",(0,s.jsx)(n.p,{children:'In retrospect, the better strategy would have been to work top-down, organizing each broad component, then after exhaustively addressing those cases, flesh out the stage below. In other words, considering the "feature" space as a m-ary tree, a breadth-first traversal makes more sense than a depth-first traversal when implementing a feature ridden with edge cases.'}),"\n",(0,s.jsx)(n.p,{children:"Lastly, I realized that having readable code is important not just for the feature itself, but also for test cases: deduplicating test cases (like using helper functions) can help highlight precisely what each test case addresses, which in turn can highlight gaps in coverage."}),"\n",(0,s.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,s.jsx)(n.p,{children:"I learned a great deal while implementing Poetry, and am very satisfied with my work. I hope you find the added feature helpful when adopting Pants."}),"\n",(0,s.jsxs)(n.p,{children:["Try out Pants today with your Poetry project, and ",(0,s.jsx)(n.a,{href:"https://www.pantsbuild.org/docs/getting-help",children:"let us know what you think in the Pants Slack"})," !"]}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.em,{children:"NB: The Poetry integration goal requires Pants 2.6+. The latest release is 2.6.0rc4, with a stable release coming this week!"})})]})}function c(e={}){let{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},872873(e,n,t){t.d(n,{A:()=>r});let r=t.p+"assets/images/splash-0c45f0de65af341b854169a8e9ba9b90.jpg"},848193(e,n,t){t.d(n,{R:()=>a,x:()=>i});var r=t(830758);let s={},o=r.createContext(s);function a(e){let n=r.useContext(o);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(o.Provider,{value:n},e.children)}},922922(e){e.exports=JSON.parse('{"permalink":"/blog/2021/07/29/poetry-support-for-pants-2-6","editUrl":"https://github.com/pantsbuild/pantsbuild.org/edit/main/blog/2021-07-29-poetry-support-for-pants-2-6/index.mdx","source":"@site/blog/2021-07-29-poetry-support-for-pants-2-6/index.mdx","title":"Poetry support for Pants 2.6","description":"Photo by [Trust \\"Tru\\"","date":"2021-07-29T00:00:00.000Z","tags":[{"inline":true,"label":"python","permalink":"/blog/tags/python"}],"readingTime":4.76,"hasTruncateMarker":true,"authors":[{"name":"Liam S Wilson","url":"https://github.com/wilsonliam","imageURL":"https://github.com/wilsonliam.png","key":"liam","page":null}],"frontMatter":{"authors":["liam"],"tags":["python"]},"unlisted":false,"prevItem":{"title":"Introducing Pants 2.6: Poetry support, third-party type stubs, and linter reports","permalink":"/blog/2021/08/02/introducing-pants-2-6"},"nextItem":{"title":"PyDev of the Week","permalink":"/blog/2021/06/28/pydev-of-the-week"}}')}}]);