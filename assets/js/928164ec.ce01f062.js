"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["303558"],{343231(e,s,t){t.r(s),t.d(s,{assets:()=>a,contentTitle:()=>o,default:()=>u,frontMatter:()=>l,metadata:()=>n,toc:()=>d});var n=t(236932),r=t(886070),i=t(848193);let l={title:"Add a formatter",sidebar_position:1},o,a={},d=[];function c(e){let s={a:"a",code:"code",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)(s.p,{children:["How to add a new formatter to the ",(0,r.jsx)(s.code,{children:"fmt"})," and ",(0,r.jsx)(s.code,{children:"lint"})," goals."]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.p,{children:["In Pants, every formatter is (typically) also a linter, meaning that if you can run a tool with ",(0,r.jsx)(s.code,{children:"./pants fmt"}),", you can run the same tool in check-only mode with ",(0,r.jsx)(s.code,{children:"./pants lint"}),". Start by skimming ",(0,r.jsx)(s.a,{href:"/2.11/docs/writing-plugins/common-plugin-tasks/add-a-linter",children:"Add a linter"})," to familiarize yourself with how linters work."]}),"\n",(0,r.jsx)(s.p,{children:"This guide assumes that you are running a formatter that already exists outside of Pants as a stand-alone binary, such as running Black or Prettier."}),"\n",(0,r.jsxs)(s.p,{children:["If you are instead writing your own formatting logic inline, you can skip Step 1. In Step 4, you will not need to use ",(0,r.jsx)(s.code,{children:"Process"}),"."]}),"\n",(0,r.jsxs)(s.ol,{children:["\n",(0,r.jsx)(s.li,{children:"Install your formatter"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.p,{children:["There are several ways for Pants to install your formatter. See ",(0,r.jsx)(s.a,{href:"/2.11/docs/writing-plugins/the-rules-api/installing-tools",children:"Installing tools"}),". This example will use ",(0,r.jsx)(s.code,{children:"ExternalTool"})," because there is already a pre-compiled binary for shfmt."]}),"\n",(0,r.jsxs)(s.p,{children:["You will also likely want to register some options, like ",(0,r.jsx)(s.code,{children:"--config"}),", ",(0,r.jsx)(s.code,{children:"--skip"}),", and ",(0,r.jsx)(s.code,{children:"--args"}),". Options are registered through a ",(0,r.jsx)(s.a,{href:"/2.11/docs/writing-plugins/the-rules-api/options-and-subsystems",children:(0,r.jsx)(s.code,{children:"Subsystem"})}),". If you are using ",(0,r.jsx)(s.code,{children:"ExternalTool"}),", this is already a subclass of ",(0,r.jsx)(s.code,{children:"Subsystem"}),". Otherwise, create a subclass of ",(0,r.jsx)(s.code,{children:"Subsystem"}),". Then, set the class property ",(0,r.jsx)(s.code,{children:"options_scope"})," to the name of the tool, e.g. ",(0,r.jsx)(s.code,{children:'"shfmt"'})," or ",(0,r.jsx)(s.code,{children:'"prettier"'}),". Finally, add options from ",(0,r.jsx)(s.code,{children:"pants.option.option_types"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'from pants.core.util_rules.external_tool import ExternalTool\nfrom pants.engine.platform import Platform\nfrom pants.option.option_types import ArgsListOption, SkipOption\n\n\nclass Shfmt(ExternalTool):\n    """An autoformatter for shell scripts (https://github.com/mvdan/sh)."""\n\n    options_scope = "shfmt"\n    name = "Shfmt"\n    default_version = "v3.2.4"\n    default_known_versions = [\n        "v3.2.4|macos_arm64 |e70fc42e69debe3e400347d4f918630cdf4bf2537277d672bbc43490387508ec|2998546",\n        "v3.2.4|macos_x86_64|43a0461a1b54070ddc04fbbf1b78f7861ee39a65a61f5466d15a39c4aba4f917|2980208",\n        "v3.2.4|linux_arm64 |6474d9cc08a1c9fe2ef4be7a004951998e3067d46cf55a011ddd5ff7bfab3de6|2752512",\n        "v3.2.4|linux_x86_64|3f5a47f8fec27fae3e06d611559a2063f5d27e4b9501171dde9959b8c60a3538|2797568",\n    ]\n\n    # We set this because we need the mapping for both `generate_exe` and `generate_url`.\n    platform_mapping = {\n        "macos_arm64": "darwin_arm64",\n        "macos_x86_64": "darwin_amd64",\n        "linux_arm64": "linux_arm64",\n        "linux_x86_64": "linux_amd64",\n    }\n\n    skip = SkipOption("fmt", "lint")\n    args = ArgsListOption(example="-i 2")\n\n    def generate_url(self, plat: Platform) -> str:\n        plat_str = self.platform_mapping[plat.value]\n        return (\n            f"https://github.com/mvdan/sh/releases/download/{self.version}/"\n            f"shfmt_{self.version}_{plat_str}"\n        )\n\n    def generate_exe(self, plat: Platform) -> str:\n        plat_str = self.platform_mapping[plat.value]\n        return f"./shfmt_{self.version}_{plat_str}"\n'})}),"\n",(0,r.jsxs)(s.ol,{start:"2",children:["\n",(0,r.jsxs)(s.li,{children:["Set up a ",(0,r.jsx)(s.code,{children:"FieldSet"})," and ",(0,r.jsx)(s.code,{children:"FmtRequest"}),"/",(0,r.jsx)(s.code,{children:"LintTargetsRequest"})]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.p,{children:["As described in ",(0,r.jsx)(s.a,{href:"/2.11/docs/writing-plugins/the-rules-api/rules-and-the-target-api",children:"Rules and the Target API"}),", a ",(0,r.jsx)(s.code,{children:"FieldSet"})," is a way to tell Pants which ",(0,r.jsx)(s.code,{children:"Field"}),"s you care about targets having for your plugin to work."]}),"\n",(0,r.jsxs)(s.p,{children:["Usually, you should add a subclass of ",(0,r.jsx)(s.code,{children:"SourcesField"})," to the class property ",(0,r.jsx)(s.code,{children:"required_fields"}),", such as ",(0,r.jsx)(s.code,{children:"ShellSourceField"})," or ",(0,r.jsx)(s.code,{children:"PythonSourceField"}),". This means that your linter will run on any target with that sources field or a subclass of it."]}),"\n",(0,r.jsxs)(s.p,{children:["Create a new dataclass that subclasses ",(0,r.jsx)(s.code,{children:"FieldSet"}),":"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"from dataclasses import dataclass\n\nfrom pants.engine.target import FieldSet\n\n...\n\n@dataclass(frozen=True)\nclass ShfmtFieldSet(FieldSet):\n    required_fields = (ShellSourceField,)\n\n    sources: ShellSourceField\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Then, hook this up to a new subclass of both ",(0,r.jsx)(s.code,{children:"LintTargetsRequest"})," and ",(0,r.jsx)(s.code,{children:"FmtRequest"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'from pants.core.goals.fmt import FmtRequest\nfrom pants.core.goals.lint import LintTargetsRequest\n\nclass ShfmtRequest(FmtRequest, LintRequest):\n    field_set_type = ShfmtFieldSet\n    name = "shfmt"\n'})}),"\n",(0,r.jsxs)(s.p,{children:["Finally, register your new ",(0,r.jsx)(s.code,{children:"LintTargetsRequest"}),"/",(0,r.jsx)(s.code,{children:"FmtRequest"})," with two ",(0,r.jsxs)(s.a,{href:"/2.11/docs/writing-plugins/the-rules-api/union-rules-advanced",children:[(0,r.jsx)(s.code,{children:"UnionRule"}),"s"]})," so that Pants knows your formatter exists:"]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:"from pants.engine.unions import UnionRule\n\n...\n\ndef rules():\n    return [\n      	*collect_rules(),\n        UnionRule(FmtRequest, ShfmtRequest),\n        UnionRule(LintTargetsRequest, ShfmtRequest),\n    ]\n"})}),"\n",(0,r.jsxs)(s.ol,{start:"3",children:["\n",(0,r.jsxs)(s.li,{children:["Create ",(0,r.jsx)(s.code,{children:"fmt"})," and ",(0,r.jsx)(s.code,{children:"lint"})," rules"]}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.p,{children:["You will need rules for both ",(0,r.jsx)(s.code,{children:"fmt"})," and ",(0,r.jsx)(s.code,{children:"lint"}),". Both rules should take the ",(0,r.jsx)(s.code,{children:"LintTargetsRequest"}),"/",(0,r.jsx)(s.code,{children:"FmtRequest"})," from step 3 (e.g. ",(0,r.jsx)(s.code,{children:"ShfmtRequest"}),") as a parameter. The ",(0,r.jsx)(s.code,{children:"fmt"})," rule should return ",(0,r.jsx)(s.code,{children:"FmtResult"}),", and the ",(0,r.jsx)(s.code,{children:"lint"})," rule should return ",(0,r.jsx)(s.code,{children:"LintResults"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'@rule(desc="Format with shfmt")\nasync def shfmt_fmt(request: ShfmtRequest, shfmt: Shfmt) -> FmtResult:\n    ...\n    return FmtResult(..., formatter_name=request.name)\n\n\n@rule(desc="Lint with shfmt")\nasync def shfmt_lint(request: ShfmtRequest, shfmt: Shfmt) -> LintResults:\n    ...\n    return LintResults([], linter_name=request.name)\n'})}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"fmt"})," and ",(0,r.jsx)(s.code,{children:"lint"})," rules will be very similar, except that a) the ",(0,r.jsx)(s.code,{children:"argv"})," to your ",(0,r.jsx)(s.code,{children:"Process"})," will be different, b) for ",(0,r.jsx)(s.code,{children:"lint"}),", you should use ",(0,r.jsx)(s.code,{children:"await Get(FallibleProcessResult, Process)"})," so that you tolerate failures, whereas ",(0,r.jsx)(s.code,{children:"fmt"})," should use ",(0,r.jsx)(s.code,{children:"await Get(ProcessResult, Process)"}),". To avoid duplication between the ",(0,r.jsx)(s.code,{children:"fmt"})," and ",(0,r.jsx)(s.code,{children:"lint"})," rules, you should set up a helper ",(0,r.jsx)(s.code,{children:"setup"})," rule, along with dataclasses for ",(0,r.jsx)(s.code,{children:"SetupRequest"})," and ",(0,r.jsx)(s.code,{children:"Setup"}),"."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",children:'@dataclass(frozen=True)\nclass SetupRequest:\n    request: ShfmtRequest\n    check_only: bool\n\n\n@dataclass(frozen=True)\nclass Setup:\n    process: Process\n    original_digest: Digest\n\n\n@rule(level=LogLevel.DEBUG)\nasync def setup_shfmt(setup_request: SetupRequest, shfmt: Shfmt) -> Setup:\n    download_shfmt_get = Get(\n        DownloadedExternalTool,\n        ExternalToolRequest,\n        shfmt.get_request(Platform.current),\n    )\n\n    # If the user specified `--shfmt-config`, we must search for the file they specified with\n    # `PathGlobs` to include it in the `input_digest`. We error if the file cannot be found.\n    config_digest_get = Get(\n        Digest,\n        PathGlobs(\n            globs=[shfmt.config] if shfmt.config else [],\n            glob_match_error_behavior=GlobMatchErrorBehavior.error,\n            description_of_origin="the option `--shfmt-config`",\n        ),\n    )\n\n    source_files_get= Get(\n        SourceFiles,\n        SourceFilesRequest(\n            field_set.source for field_set in setup_request.request.field_sets\n        ),\n    )\n\n    downloaded_shfmt, source_files = await MultiGet(\n        download_shfmt_get, source_files_get\n    )\n\n    # If we were given an input digest from a previous formatter for the source files, then we\n    # should use that input digest instead of the one we read from the filesystem.\n    source_files_snapshot = (\n        source_files.snapshot\n        if setup_request.request.prior_formatter_result is None\n        else setup_request.request.prior_formatter_result\n    )\n\n    input_digest = await Get(\n        Digest,\n        MergeDigests(\n            (source_files_snapshot.digest, downloaded_shfmt.digest)\n        ),\n    )\n\n    argv = [\n        downloaded_shfmt.exe,\n        "-d" if setup_request.check_only else "-w",\n        *shfmt.args,\n        *source_files_snapshot.files,\n    ]\n    process = Process(\n        argv=argv,\n        input_digest=input_digest,\n        output_files=source_files_snapshot.files,\n        description=f"Run shfmt on {pluralize(len(setup_request.request.field_sets), \'file\')}.",\n        level=LogLevel.DEBUG,\n    )\n    return Setup(process, original_digest=source_files_snapshot.digest)\n\n\n@rule(desc="Format with shfmt", level=LogLevel.DEBUG)\nasync def shfmt_fmt(request: ShfmtRequest, shfmt: Shfmt) -> FmtResult:\n    if shfm.skip:\n        return FmtResult.skip(formatter_name=request.name)\n    setup = await Get(Setup, SetupRequest(request, check_only=False))\n    result = await Get(ProcessResult, Process, setup.process)\n    return FmtResult.from_process_result(\n        result, original_digest=setup.original_digest, formatter_name=request.name\n    )\n\n\n@rule(desc="Lint with shfmt", level=LogLevel.DEBUG)\nasync def shfmt_lint(request: ShfmtRequest, shfmt: Shfmt) -> LintResults:\n    if shfmt..skip:\n        return LintResults([], linter_name=request.name)\n    setup = await Get(Setup, SetupRequest(request, check_only=True))\n    result = await Get(FallibleProcessResult, Process, setup.process)\n    return LintResults(\n        [LintResult.from_fallible_process_result(result)], linter_name=request.name\n    )\n'})}),"\n",(0,r.jsxs)(s.p,{children:["The ",(0,r.jsx)(s.code,{children:"FmtRequest"}),"/",(0,r.jsx)(s.code,{children:"LintRequest"})," has a property called ",(0,r.jsx)(s.code,{children:".field_sets"}),", which stores a collection of the ",(0,r.jsx)(s.code,{children:"FieldSet"}),"s defined in step 2. Each ",(0,r.jsx)(s.code,{children:"FieldSet"})," corresponds to a single target. Pants will have already validated that there is at least one valid ",(0,r.jsx)(s.code,{children:"FieldSet"}),", so you can expect ",(0,r.jsx)(s.code,{children:"ShfmtRequest.field_sets"})," to have 1-n ",(0,r.jsx)(s.code,{children:"FieldSet"})," instances."]}),"\n",(0,r.jsxs)(s.p,{children:["If you have a ",(0,r.jsx)(s.code,{children:"--skip"})," option, you should check if it was used at the beginning of your ",(0,r.jsx)(s.code,{children:"fmt"})," and ",(0,r.jsx)(s.code,{children:"lint"})," rules and, if so, to early return an empty ",(0,r.jsx)(s.code,{children:"LintResults()"})," and return ",(0,r.jsx)(s.code,{children:"FmtResult.skip()"}),"."]}),"\n",(0,r.jsxs)(s.p,{children:["Use ",(0,r.jsx)(s.code,{children:"Get(SourceFiles, SourceFilesRequest)"})," to get all the sources you want to run your linter on. However, you should check if the ",(0,r.jsx)(s.code,{children:"FmtRequest.prior_formatter_result"})," is set, and if so, use that value instead. This ensures that the result of any previous formatters is used, rather than the original source files."]}),"\n",(0,r.jsxs)(s.p,{children:["If you used ",(0,r.jsx)(s.code,{children:"ExternalTool"})," in step 1, you will use ",(0,r.jsx)(s.code,{children:"Get(DownloadedExternalTool, ExternalToolRequest)"})," in the ",(0,r.jsx)(s.code,{children:"setup"})," rule to install the tool."]}),"\n",(0,r.jsxs)(s.p,{children:["Use ",(0,r.jsx)(s.code,{children:"Get(Digest, MergeDigests)"})," to combine the different inputs together, such as merging the source files and downloaded tool."]}),"\n",(0,r.jsxs)(s.p,{children:["Finally, update your plugin's ",(0,r.jsx)(s.code,{children:"register.py"})," to activate this file's rules. Note that we must register the rules added in Step 2, as well."]}),"\n",(0,r.jsx)(s.pre,{children:(0,r.jsx)(s.code,{className:"language-python",metastring:'title="pants-plugins/shell/register.py"',children:"from shell import shfmt\n\n\ndef rules():\n    return [*shfmt.rules()]\n"})}),"\n",(0,r.jsxs)(s.p,{children:["Now, when you run ",(0,r.jsx)(s.code,{children:"./pants fmt ::"})," or ",(0,r.jsx)(s.code,{children:"./pants lint ::"}),", your new formatter should run."]}),"\n",(0,r.jsxs)(s.ol,{start:"5",children:["\n",(0,r.jsx)(s.li,{children:"Add tests (optional)"}),"\n"]}),"\n",(0,r.jsx)(s.hr,{}),"\n",(0,r.jsxs)(s.p,{children:["Refer to ",(0,r.jsx)(s.a,{href:"/2.11/docs/writing-plugins/the-rules-api/testing-plugins",children:"Testing rules"}),"."]})]})}function u(e={}){let{wrapper:s}={...(0,i.R)(),...e.components};return s?(0,r.jsx)(s,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},848193(e,s,t){t.d(s,{R:()=>l,x:()=>o});var n=t(830758);let r={},i=n.createContext(r);function l(e){let s=n.useContext(i);return n.useMemo(function(){return"function"==typeof e?e(s):{...s,...e}},[s,e])}function o(e){let s;return s=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:l(e.components),n.createElement(i.Provider,{value:s},e.children)}},236932(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/common-plugin-tasks/add-a-formatter","title":"Add a formatter","description":"How to add a new formatter to the fmt and lint goals.","source":"@site/versioned_docs/version-2.11/docs/writing-plugins/common-plugin-tasks/add-a-formatter.mdx","sourceDirName":"docs/writing-plugins/common-plugin-tasks","slug":"/docs/writing-plugins/common-plugin-tasks/add-a-formatter","permalink":"/2.11/docs/writing-plugins/common-plugin-tasks/add-a-formatter","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/common-plugin-tasks/add-a-formatter.mdx","tags":[],"version":"2.11","sidebarPosition":1,"frontMatter":{"title":"Add a formatter","sidebar_position":1},"sidebar":"docsSidebar","previous":{"title":"Add a linter","permalink":"/2.11/docs/writing-plugins/common-plugin-tasks/add-a-linter"},"next":{"title":"Add a typechecker","permalink":"/2.11/docs/writing-plugins/common-plugin-tasks/add-a-typechecker"}}')}}]);