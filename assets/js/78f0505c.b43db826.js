"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["974796"],{779687(e,n,t){t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>a,default:()=>u,frontMatter:()=>l,metadata:()=>i,toc:()=>d});var i=t(239586),s=t(886070),r=t(848193);let l={title:"Migrating from Get",sidebar_position:11},a,o={},d=[{value:"<code>Get</code> and <code>MultiGet</code>",id:"get-and-multiget",level:2},{value:"<code>Get</code> and <code>MultiGet</code> are deprecated",id:"get-and-multiget-are-deprecated",level:2},{value:"Migrating to call-by-name",id:"migrating-to-call-by-name",level:2},{value:"Migrating union <code>Get</code>s to call-by-name",id:"migrating-union-gets-to-call-by-name",level:2}];function c(e){let n={a:"a",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.p,{children:"Migrating away from the old call-by-type Rules API."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsxs)(n.h2,{id:"get-and-multiget",children:[(0,s.jsx)(n.code,{children:"Get"})," and ",(0,s.jsx)(n.code,{children:"MultiGet"})]}),"\n",(0,s.jsxs)(n.p,{children:["As ",(0,s.jsx)(n.a,{href:"/prerelease/docs/writing-plugins/the-rules-api/concepts",children:"we've seen"}),", rules invoke other rules directly by name:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from pants.engine.fs import NativeDownloadFile\nfrom pants.engine.intrinsics import download_file\nfrom pants.engine.rules import rule\n...\n\n@rule\nasync def my_rule() -> MyResult:\n    downloaded_file = await download_file(\n        NativeDownloadFile("https://www.google.com/robots.txt")\n    )\n    ...\n'})}),"\n",(0,s.jsxs)(n.p,{children:["However, a previous version of the Rules API had a different idiom, call-by-type. This was achieved using a construct called ",(0,s.jsx)(n.code,{children:"Get"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from pants.engine.fs import Digest, NativeDownloadFile\nfrom pants.engine.rules import Get, rule\n...\n\n@rule\nasync def my_rule() -> MyResult:\n    downloaded_file = await Get(Digest, NativeDownloadFile("https://www.google.com/robots.txt"))\n    ...\n'})}),"\n",(0,s.jsxs)(n.p,{children:["A ",(0,s.jsx)(n.code,{children:"Get(OutputType, InputType, input)"})," or ",(0,s.jsx)(n.code,{children:"Get(OutputType, InputType(...))"}),' invoked the engine\'s "fill in the blanks" mechanism to find a rule or a cascade of rules that could produce a value of OutputType from the given input type (plus any contextual parameters).']}),"\n",(0,s.jsxs)(n.p,{children:["To achieve concurrency you could ",(0,s.jsx)(n.code,{children:"await MultiGet(<iterable of Gets>)"}),"."]}),"\n",(0,s.jsxs)(n.h2,{id:"get-and-multiget-are-deprecated",children:[(0,s.jsx)(n.code,{children:"Get"})," and ",(0,s.jsx)(n.code,{children:"MultiGet"})," are deprecated"]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"Get"})," and ",(0,s.jsx)(n.code,{children:"MultiGet"})," are now deprecated, and will be removed entirely soon. Pants itself no longer uses them internally, but external plugins still might. Plugin authors must migrate from ",(0,s.jsx)(n.code,{children:"Get"}),"/",(0,s.jsx)(n.code,{children:"MultiGet"})," to call-by-name syntax as soon as possible."]}),"\n",(0,s.jsx)(n.h2,{id:"migrating-to-call-by-name",children:"Migrating to call-by-name"}),"\n",(0,s.jsx)(n.p,{children:"Migrating to call-by-name is fairly straightforward:"}),"\n",(0,s.jsxs)(n.p,{children:["First, replace all ",(0,s.jsx)(n.code,{children:"MultiGet"}),"s with ",(0,s.jsx)(n.code,{children:"concurrently"}),", imported from from ",(0,s.jsx)(n.code,{children:"pants.engine.rules"}),". ",(0,s.jsx)(n.code,{children:"MultiGet"})," is now just an alias for ",(0,s.jsx)(n.code,{children:"concurrently"}),", so this is trivial to do with a find/replace."]}),"\n",(0,s.jsxs)(n.p,{children:["Then, replace ",(0,s.jsx)(n.code,{children:"await Get(OutputType, InputType, input)"})," with ",(0,s.jsx)(n.code,{children:"await rule_name(...)"})," where ",(0,s.jsx)(n.code,{children:"rule_name"})," is the rule that returns a value ",(0,s.jsx)(n.code,{children:"OutputType"}),"."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If the rule has exactly one parameter, of type ",(0,s.jsx)(n.code,{children:"InputType"}),", then this as simple as:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"val = await rule_name(input)\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If the rule has other parameters that should be passed implicitly, then add an empty ",(0,s.jsx)(n.code,{children:"**implicitly()"}),":"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"val = await rule_name(input, **implicitly())\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["If the rule that returns ",(0,s.jsx)(n.code,{children:"OutputType"})," does not take ",(0,s.jsx)(n.code,{children:"InputType"})," directly, but rather some ",(0,s.jsx)(n.code,{children:"IntermediateType"}),", then we need to tell the Pants engine to fill in the blanks, just as the ",(0,s.jsx)(n.code,{children:"Get"})," would have:"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:"val = await rule_name(**implicitly({input: InputType}))\n"})}),"\n",(0,s.jsxs)(n.p,{children:["There may be various corner cases that require slightly more refactoring. We encourage you to ask for help on ",(0,s.jsx)(n.a,{href:"/community/getting-help",children:"Slack"})," with those."]}),"\n",(0,s.jsxs)(n.p,{children:["For examples of migrations, you can review ",(0,s.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/pulls?q=is%3Apr+%22call-by-name%22+is%3Aclosed",children:"pull requests"})," made to the Pants repository. Additionally, there are some simplified examples in the form of ",(0,s.jsx)(n.a,{href:"https://github.com/pantsbuild/pants/blob/main/src/python/pants/goal/migrate_call_by_name_integration_test.py",children:"Pants integration tests"}),"."]}),"\n",(0,s.jsxs)(n.h2,{id:"migrating-union-gets-to-call-by-name",children:["Migrating union ",(0,s.jsx)(n.code,{children:"Get"}),"s to call-by-name"]}),"\n",(0,s.jsxs)(n.p,{children:["If you're relying on polymorphic dispatch via a ",(0,s.jsx)(n.a,{href:"/prerelease/docs/writing-plugins/the-rules-api/union-rules-advanced",children:"union"}),', then you must make sure that your implementation rule has the same signature as the "base" rule (the ',(0,s.jsx)(n.code,{children:"@rule(polymorphic=True)"})," rule) - the same type annotations for parameters and return value - except with your subtype in place of the union type. If things aren't working and the base rule is a standard Pants rule, you can examine its signature in the Pants source code."]})]})}function u(e={}){let{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},848193(e,n,t){t.d(n,{R:()=>l,x:()=>a});var i=t(830758);let s={},r=i.createContext(s);function l(e){let n=i.useContext(r);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:l(e.components),i.createElement(r.Provider,{value:n},e.children)}},239586(e){e.exports=JSON.parse('{"id":"docs/writing-plugins/the-rules-api/migrating-gets","title":"Migrating from Get","description":"Migrating away from the old call-by-type Rules API.","source":"@site/versioned_docs/version-2.31/docs/writing-plugins/the-rules-api/migrating-gets.mdx","sourceDirName":"docs/writing-plugins/the-rules-api","slug":"/docs/writing-plugins/the-rules-api/migrating-gets","permalink":"/prerelease/docs/writing-plugins/the-rules-api/migrating-gets","draft":false,"unlisted":false,"editUrl":"https://github.com/pantsbuild/pants/edit/main/docs/docs/writing-plugins/the-rules-api/migrating-gets.mdx","tags":[],"version":"2.31","sidebarPosition":11,"frontMatter":{"title":"Migrating from Get","sidebar_position":11},"sidebar":"docsSidebar","previous":{"title":"Tips and debugging","permalink":"/prerelease/docs/writing-plugins/the-rules-api/tips-and-debugging"},"next":{"title":"Common plugin tasks","permalink":"/prerelease/docs/writing-plugins/common-plugin-tasks/"}}')}}]);