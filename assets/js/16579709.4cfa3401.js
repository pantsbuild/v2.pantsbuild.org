"use strict";(self.webpackChunkpantsbuild_org=self.webpackChunkpantsbuild_org||[]).push([["169900"],{107466(e,t,n){n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>r,metadata:()=>o,toc:()=>h});var o=n(374265),i=n(886070),s=n(848193);let r={authors:["eric"],tags:["announcement"]},a="How we added Apple Silicon support to Pants",l={authorsImageUrls:[void 0]},h=[{value:"Problem: Python native extensions",id:"problem-python-native-extensions",level:2},{value:"Original workaround: Rosetta",id:"original-workaround-rosetta",level:2},{value:"Rejected solution: cross-compilation",id:"rejected-solution-cross-compilation",level:2},{value:"Solution: build locally",id:"solution-build-locally",level:2},{value:"Other challenges",id:"other-challenges",level:2},{value:"Python 3.9+",id:"python-39",level:3},{value:"Docker and Apple Silicon",id:"docker-and-apple-silicon",level:3},{value:"Try out Pants",id:"try-out-pants",level:2}];function c(e){let t={a:"a",code:"code",h2:"h2",h3:"h3",hr:"hr",li:"li",p:"p",strong:"strong",ul:"ul",...(0,s.R)(),...e.components},{CaptionedImg:o}=t;return o||function(e,t){throw Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("CaptionedImg",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(o,{src:n(572192).A,children:(0,i.jsxs)(t.p,{children:["Photo by ",(0,i.jsx)(t.a,{href:"https://unsplash.com/@coc6?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit",children:"Thomas\nCiszewski"}),"\n/\n",(0,i.jsx)(t.a,{href:"https://unsplash.com/?utm_source=ghost&utm_medium=referral&utm_campaign=api-credit",children:"Unsplash"})]})}),"\n",(0,i.jsx)(t.p,{children:'Successful open source projects are full of tradeoffs between purity vs. pragmatism. We often remind ourselves "Do not let perfect be the enemy of good".'}),"\n","\n",(0,i.jsx)(t.hr,{}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org",children:"Pants"})," 2.5+ now supports Apple Silicon natively\u2014including the M1 processor on new MacBooks, Mac Minis, and iMacs\u2014without needing Rosetta."]}),"\n",(0,i.jsx)(t.h2,{id:"problem-python-native-extensions",children:"Problem: Python native extensions"}),"\n",(0,i.jsxs)(t.p,{children:["Pants is distributed as a Python program, but ",(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/docs/how-does-pants-work",children:"with a native extension"}),' written in Rust for performance and parallelism. This native code means that we must distribute a distinct binary\u2014as a Python "wheel" file\u2014for every platform we support: Linux x86_64, macOS x86_64, and now macOS arm64.']}),"\n",(0,i.jsxs)(t.p,{children:["(It's also possible to release Python programs as an \"sdist\", where the user builds the native extension locally. However, Pants's Rust extension can take up to 15-25 minutes to build and it requires having modern Rust installed locally, so we do not yet distribute an sdist. Although, we do provide a way for motivated users ",(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/docs/installation#building-pants-from-sources",children:"to build their own wheel"}),".)"]}),"\n",(0,i.jsxs)(t.p,{children:["Normally, we could simply build the wheel with GitHub Actions, which is how we build for macOS x86*64 and Linux. However, GitHub Actions and other CI providers ",(0,i.jsx)(t.a,{href:"https://github.com/actions/virtual-environments/issues/2187",children:"do not _yet* support Apple Silicon"}),"."]}),"\n",(0,i.jsx)(t.h2,{id:"original-workaround-rosetta",children:"Original workaround: Rosetta"}),"\n",(0,i.jsxs)(t.p,{children:["It has been possible to run Pants using Rosetta (by running ",(0,i.jsx)(t.code,{children:"arch -x86_64"}),"). However, Pants is the ergonomic build system, and it should Just Work out of the box."]}),"\n",(0,i.jsxs)(t.p,{children:["We also wanted to avoid the ",(0,i.jsx)(t.a,{href:"https://mjtsai.com/blog/2020/11/16/performance-of-rosetta-2-on-apple-m1/",children:"performance hit"})," from Rosetta, given that Pants aims to speed up your build experience."]}),"\n",(0,i.jsx)(t.h2,{id:"rejected-solution-cross-compilation",children:"Rejected solution: cross-compilation"}),"\n",(0,i.jsx)(t.p,{children:"Cross-compilation allows you to build a native binary for a platform different than the host platform, e.g. building for macOS ARM from macOS x86_64."}),"\n",(0,i.jsxs)(t.p,{children:["Rust has ",(0,i.jsx)(t.a,{href:"https://rust-lang.github.io/rustup/cross-compilation.html",children:"strong support for cross-compilation"}),"."]}),"\n",(0,i.jsxs)(t.p,{children:["However, cross-complication can be non-trivial. For example, the FFI library we use, ",(0,i.jsx)(t.a,{href:"https://pyo3.rs/v0.13.2/building_and_distribution.html#cross-compiling",children:"PyO3"}),", requires a compiled Python interpreter for the target platform."]}),"\n",(0,i.jsx)(t.p,{children:"While cross-compilation is promising, we decided to prioritize other project improvements instead of spending the time getting it working."}),"\n",(0,i.jsx)(t.h2,{id:"solution-build-locally",children:"Solution: build locally"}),"\n",(0,i.jsx)(t.p,{children:"Instead, we went with the simplest solution: build the Apple Silicon wheel locally with an M1 machine from one of our core contributors, rather than using CI."}),"\n",(0,i.jsx)(t.p,{children:"Admittedly, this solution is not very sustainable in the long run: we are coupling our release process to a single contributor's machine, along with increasing the risk that a misconfigured developer machine results in an incompatible wheel."}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.strong,{children:'However, successful open source projects are full of tradeoffs between purity vs. pragmatism. We often remind ourselves "Do not let perfect be the enemy of good"'}),", and we are passionate about prioritizing an excellent experience for users."]}),"\n",(0,i.jsx)(t.p,{children:"Here, we can provide a much better experience for Apple Silicon users for little work, while we wait for the CI ecosystem to improve."}),"\n",(0,i.jsx)(t.p,{children:"We took some steps to make this more sustainable:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:'Communicated with users that Apple Silicon support is "best-effort". The ARM wheel may take an extra 1-2 days to be published. This way, we do not ever block releases by having access to the contributor\'s M1 machine.'}),"\n",(0,i.jsxs)(t.li,{children:[(0,i.jsx)(t.a,{href:"https://github.com/pantsbuild/pants/pull/12229",children:"Expanded automation"})," of the build and publish process."]}),"\n",(0,i.jsx)(t.li,{children:"Sign the wheel from the contributor's trusted machine."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"Further, this situation is temporary: once GitHub Actions supports Apple Silicon, we will use CI to automate building ARM wheels."}),"\n",(0,i.jsx)(t.h2,{id:"other-challenges",children:"Other challenges"}),"\n",(0,i.jsx)(t.h3,{id:"python-39",children:"Python 3.9+"}),"\n",(0,i.jsxs)(t.p,{children:["When we first started this project, only Python 3.9+ worked natively with Apple Silicon. (Since then, the newest versions of Python 3.8 ",(0,i.jsx)(t.a,{href:"https://bugs.python.org/issue41100",children:"work too"}),".)"]}),"\n",(0,i.jsxs)(t.p,{children:["This meant that we had to first ",(0,i.jsx)(t.a,{href:"https://github.com/pantsbuild/pants/pull/11858",children:"update Pants"})," to be able to run with Python 3.9."]}),"\n",(0,i.jsx)(t.p,{children:"Even though we currently release wheels for Python 3.7, 3.8, and 3.9 for Linux and macOS x86_64, we only release a wheel for Python 3.9 for macOS arm64."}),"\n",(0,i.jsx)(t.h3,{id:"docker-and-apple-silicon",children:"Docker and Apple Silicon"}),"\n",(0,i.jsx)(t.p,{children:"The Docker team has done an amazing job bringing native support to Apple Silicon."}),"\n",(0,i.jsxs)(t.p,{children:["Unfortunately, however, Docker on Apple Silicon is fundamentally ",(0,i.jsxs)(t.a,{href:"https://github.com/docker/for-mac/issues/5321",children:["not able to support the ",(0,i.jsx)(t.code,{children:"inotify"})," syscall"]})," for amd64 containers, which is used for file watching. Pants uses the Rust ",(0,i.jsx)(t.code,{children:"notify"})," crate, which relies on this syscall, so that it knows when to invalidate builds due to changes on the filesystem. File watching is particularly important for the Pants daemon (pantsd) to safely memoize work across multiple Pants runs."]}),"\n",(0,i.jsxs)(t.p,{children:["To work around this limitation, we added an option ",(0,i.jsx)(t.code,{children:"--no-watch-filesystem"})," to Pants 2.6+ to disable file watching. We only allow you to disable file watching if you also disable the Pants daemon. There is a small risk that changing files halfway during a Pants run may invalidate the build and require you to re-run the command. However, this situation is unlikely when using Docker because it would be unusual to make edits to your code mid-run. So, we made a pragmatic choice to unblock using Pants with Docker on Apple Silicon."]}),"\n",(0,i.jsx)(t.h2,{id:"try-out-pants",children:"Try out Pants"}),"\n",(0,i.jsx)(t.p,{children:"Regardless of whether you use Apple Silicon, try out how Pants makes working on repositories with Python or Shell code a joy, even as they grow:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.youtube.com/watch?v=maK3_Ix5Z4I&list=PLwPRXwjURiOzXjgqydxZE9RVjZqaB6OXb",children:"Video tour"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/docs",children:"Docs"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://github.com/pantsbuild/example-python",children:"Example Python repository"})}),"\n",(0,i.jsx)(t.li,{children:(0,i.jsx)(t.a,{href:"https://www.pantsbuild.org/docs/getting-help#slack",children:"Slack"})}),"\n"]})]})}function d(e={}){let{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(c,{...e})}):c(e)}},572192(e,t,n){n.d(t,{A:()=>o});let o=n.p+"assets/images/splash-0d8b385f96ade4d4ca14ad42054ec4f9.jpg"},848193(e,t,n){n.d(t,{R:()=>r,x:()=>a});var o=n(830758);let i={},s=o.createContext(i);function r(e){let t=o.useContext(s);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:r(e.components),o.createElement(s.Provider,{value:t},e.children)}},374265(e){e.exports=JSON.parse('{"permalink":"/blog/2021/06/21/how-we-added-apple-silicon-support-to-pants","editUrl":"https://github.com/pantsbuild/pantsbuild.org/edit/main/blog/2021-06-21-how-we-added-apple-silicon-support-to-pants/index.mdx","source":"@site/blog/2021-06-21-how-we-added-apple-silicon-support-to-pants/index.mdx","title":"How we added Apple Silicon support to Pants","description":"Photo by [Thomas","date":"2021-06-21T00:00:00.000Z","tags":[{"inline":true,"label":"announcement","permalink":"/blog/tags/announcement"}],"readingTime":4.75,"hasTruncateMarker":true,"authors":[{"name":"Eric Arellano","title":"Pants Maintainer","url":"https://github.com/Eric-Arellano","imageURL":"https://github.com/Eric-Arellano.png","key":"eric","page":null}],"frontMatter":{"authors":["eric"],"tags":["announcement"]},"unlisted":false,"prevItem":{"title":"PyDev of the Week","permalink":"/blog/2021/06/28/pydev-of-the-week"},"nextItem":{"title":"Introducing Pants 2.5: Shell support, config autodiscovery, and incremental tool adoption","permalink":"/blog/2021/05/20/introducing-pants-2-5"}}')}}]);